{"file_contents":{"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/stat-card.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { LucideIcon } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\ninterface StatCardProps {\n  title: string;\n  value: string | number;\n  icon: LucideIcon;\n  description?: string;\n  isLoading?: boolean;\n}\n\nexport function StatCard({ title, value, icon: Icon, description, isLoading }: StatCardProps) {\n  return (\n    <Card data-testid={`card-stat-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium\">{title}</CardTitle>\n        <Icon className=\"w-4 h-4 text-muted-foreground\" />\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <>\n            <Skeleton className=\"h-8 w-24 mb-1\" />\n            {description && <Skeleton className=\"h-4 w-32\" />}\n          </>\n        ) : (\n          <>\n            <div className=\"text-3xl font-bold\" data-testid={`text-stat-value-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n              {value}\n            </div>\n            {description && (\n              <p className=\"text-xs text-muted-foreground mt-1\">{description}</p>\n            )}\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1319},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { xmlStorageService } from \"./xml-storage\";\n\nconst app = express();\n\n// Configuração: Permitir simulação SEFAZ em desenvolvimento\nif (process.env.NODE_ENV === \"development\" && !process.env.ALLOW_SEFAZ_SIMULATION) {\n  process.env.ALLOW_SEFAZ_SIMULATION = \"true\";\n  console.log(\"⚠️  ALLOW_SEFAZ_SIMULATION ativado para desenvolvimento\");\n}\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  // Inicializa bucket de XMLs no Supabase Storage (se necessário)\n  await xmlStorageService.ensureBucketExists();\n\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":2656},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/status-badge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\ntype SyncStatus = \"ativo\" | \"sincronizando\" | \"erro\" | \"pausado\" | \"inativo\";\n\ninterface StatusBadgeProps {\n  status: SyncStatus;\n  className?: string;\n}\n\nexport function StatusBadge({ status, className }: StatusBadgeProps) {\n  const configs = {\n    ativo: {\n      label: \"Ativo\",\n      dotColor: \"bg-green-500\",\n      variant: \"default\" as const,\n    },\n    sincronizando: {\n      label: \"Sincronizando\",\n      dotColor: \"bg-blue-500 animate-pulse\",\n      variant: \"default\" as const,\n    },\n    erro: {\n      label: \"Erro\",\n      dotColor: \"bg-red-500\",\n      variant: \"destructive\" as const,\n    },\n    pausado: {\n      label: \"Pausado\",\n      dotColor: \"bg-amber-500\",\n      variant: \"secondary\" as const,\n    },\n    inativo: {\n      label: \"Inativo\",\n      dotColor: \"bg-gray-400\",\n      variant: \"secondary\" as const,\n    },\n  };\n\n  const config = configs[status];\n\n  return (\n    <Badge variant={config.variant} className={cn(\"gap-1.5\", className)} data-testid={`badge-status-${status}`}>\n      <span className={cn(\"w-2 h-2 rounded-full\", config.dotColor)} />\n      {config.label}\n    </Badge>\n  );\n}\n","size_bytes":1190},"client/src/components/app-sidebar.tsx":{"content":"import {\n  Building2,\n  FileText,\n  Home,\n  ScrollText,\n  Settings,\n} from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\n\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\n\nconst menuItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/\",\n    icon: Home,\n  },\n  {\n    title: \"Empresas\",\n    url: \"/empresas\",\n    icon: Building2,\n  },\n  {\n    title: \"XMLs\",\n    url: \"/xmls\",\n    icon: FileText,\n  },\n  {\n    title: \"Logs\",\n    url: \"/logs\",\n    icon: ScrollText,\n  },\n  {\n    title: \"Configurações\",\n    url: \"/configuracoes\",\n    icon: Settings,\n  },\n];\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4 border-b border-sidebar-border\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"w-8 h-8 bg-primary rounded-md flex items-center justify-center\">\n            <FileText className=\"w-5 h-5 text-primary-foreground\" />\n          </div>\n          <div>\n            <h1 className=\"text-sm font-semibold text-sidebar-foreground\">SEFAZ XML Sync</h1>\n            <p className=\"text-xs text-muted-foreground\">Download Automático</p>\n          </div>\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-xs font-medium uppercase tracking-wide px-4\">\n            Navegação\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {menuItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"w-5 h-5\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n      <SidebarFooter className=\"p-4 border-t border-sidebar-border\">\n        <div className=\"text-xs text-muted-foreground\">\n          <p>Versão 1.0.0</p>\n          <p className=\"mt-1\">© 2025 SEFAZ XML Sync</p>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","size_bytes":2594},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"replit.md":{"content":"# SEFAZ XML Sync - Sistema de Download Automático de XMLs\n\n## Overview\nThis web application automates the download of XMLs (nfeProc) from SEFAZ, offering hourly synchronization for multiple registered companies. It provides a robust, multi-tenant solution for managing fiscal documents, aiming to streamline compliance and data access for businesses, reducing manual effort. Key features include automated manifestation of recipient events, hybrid storage options, and comprehensive handling of SEFAZ regulations. The project's ambition is to provide a reliable and efficient system for fiscal document management, reducing manual effort and ensuring compliance for businesses.\n\n## User Preferences\nI prefer clear and direct communication. When making changes or suggesting improvements, please explain the \"why\" behind them, focusing on the benefits and potential impact. I value iterative development and would like to be consulted before any major architectural shifts or significant code refactoring. Please ensure that all suggestions are actionable and provide code examples where appropriate. I prefer a coding style that emphasizes readability and maintainability, utilizing TypeScript's type safety effectively.\n\n## System Architecture\n\n### UI/UX Decisions\nThe frontend is built with React, TypeScript, Tailwind CSS, and Shadcn UI, ensuring a modern and responsive user experience. Navigation is managed by Wouter, and data fetching/caching is handled by React Query. The design prioritizes clarity and ease of use, with a dashboard for real-time statistics, intuitive interfaces for managing companies and XMLs, and a clear log viewer. Visual badges indicate the status of XML manifestations and download progress.\n\n### Technical Implementations\nThe application uses a modern full-stack approach:\n-   **Frontend**: React, TypeScript, Tailwind CSS, Shadcn UI, React Query, Wouter.\n-   **Backend**: Node.js with Express and TypeScript.\n-   **Database**: Supabase PostgreSQL with Row-Level Security (RLS).\n-   **Authentication**: Supabase Auth with JWT.\n-   **Scheduling**: `node-cron` for hourly synchronization and download processing.\n-   **XML Processing**: `fast-xml-parser` and `pako`.\n-   **File Storage**: Hybrid storage system configurable per company, supporting local filesystem or Supabase Storage, with automatic bucket creation and path normalization.\n-   **Certificate Handling**: `node-forge` for PKCS12 certificate validation.\n\n### Feature Specifications\n-   **Multi-tenant Support**: Data isolation per user via RLS.\n-   **Automated XML Download**: Hourly fetching of XMLs from SEFAZ, supporting `distNSU` and `consNSU` for full XML retrieval from summaries (resNFe to nfeProc).\n-   **Recipient Manifestation (NT 2020.001)**: Complete system for recipient manifestation with 4 event types, automatic tracking of legal deadlines, and configurable automatic manifestation with recipient validation.\n-   **Ordered Processing Flow**: Download service follows strict order: (1) Check if XML is manifested, (2) If not manifested, manifest first, (3) Only then attempt XML download, (4) All operations respect 20 queries/hour rate limit per company.\n-   **Hybrid Storage**: Configurable XML storage per company (local or Supabase Storage).\n-   **NSU Reconciliation**: Automatic discovery and alignment of the last NSU with SEFAZ, adhering to NT 2014.002 to prevent cStat=656 errors.\n-   **Comprehensive Logging**: Detailed logs for all synchronization activities.\n-   **API Endpoints**: Dedicated routes for dashboard metrics, company management, XML access, logs, manual synchronization, manifestation triggers, and configuration management.\n-   **Robust XML Handling**: Configures `fast-xml-parser` to maintain all values as strings, preserving 44-digit `chNFe` keys.\n-   **Duplicate XML Handling**: Gracefully handles attempts to insert duplicate XMLs by returning the existing record.\n-   **User Configuration Management**: Persisted user-specific settings for synchronization intervals, automatic processes, retries, timeouts, and notifications.\n-   **Company Management**: Full CRUD operations for companies, including certificate upload and configuration of automatic manifestation and storage type.\n-   **Automatic XML Download**: Service for processing pending XML downloads, including retry logic, batch processing, and PostgreSQL-based distributed locks. Now includes pre-download manifestation verification.\n-   **XML Digital Signature**: Corrected algorithm and namespace prefix to comply with SEFAZ requirements (SHA-1, classic C14N, no `ds:` prefix).\n-   **Infinite Retry for XMLs**: XMLs with download or manifestation errors are indefinitely retried, resetting their status to \"pending\" after each attempt, ensuring no XML is permanently abandoned while respecting SEFAZ rate limits.\n\n### System Design Choices\n-   **CRITICAL - Database Architecture**:\n    -   **SUPABASE PRODUCTION ONLY**: All database operations target Supabase Production database.\n    -   **NO LOCAL DATABASE**: Development/local PostgreSQL is NOT used.\n    -   **Schema Management**: All migrations are SQL scripts executed directly in Supabase Dashboard SQL Editor.\n    -   **No Drizzle Direct Connections**: Application uses Supabase client exclusively, never direct Drizzle connections.\n-   **Secure Authentication**: JWT-based authentication with server-side validation and automatic token refresh.\n-   **Data Isolation**: Strict multi-tenant data separation enforced by Supabase RLS.\n-   **Robust SEFAZ Integration**: Utilizes PKCS12 certificates for SOAP communication, handles various SEFAZ response codes, supports gzip decompression, and conforms to NT 2014.002 for NSU management.\n-   **Scalable Storage**: XMLs are saved in a structured path (`xmls/CNPJ/Ano/Mês/numeroNF.xml`).\n-   **Distributed Locks**: Implemented using PostgreSQL functions for atomic locking in multi-instance environments, particularly for XML download control.\n-   **Deployment**: Optimized for Docker with `docker-compose`, Nginx, and Certbot.\n\n## External Dependencies\n-   **Supabase**: PostgreSQL database, Authentication (Supabase Auth), and Storage services.\n-   **SEFAZ Web Service (NFeDistribuicaoDFe, NFeConsultaProtocolo, NFeRecepcaoEvento)**: External government services for distributing fiscal documents, consulting protocols, and receiving events, accessed via SOAP.\n-   **node-cron**: For scheduling recurring tasks.\n-   **fast-xml-parser**: For efficient XML parsing.\n-   **pako**: For decompressing gzipped data from SEFAZ.\n-   **multer**: For handling multipart form data (certificate uploads).\n-   **node-forge**: Used for parsing and validating PKCS12 digital certificates.\n-   **Let's Encrypt**: For automated SSL certificate provisioning via Certbot.","size_bytes":6764},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, integer, boolean, uuid } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Tabela de Perfis de Usuário (extends auth.users)\nexport const profiles = pgTable(\"profiles\", {\n  id: uuid(\"id\").primaryKey(), // references auth.users(id)\n  email: text(\"email\").notNull(),\n  nomeCompleto: text(\"nome_completo\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport type Profile = typeof profiles.$inferSelect;\n\n// Tabela de Empresas\nexport const empresas = pgTable(\"empresas\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull(), // references auth.users(id)\n  cnpj: text(\"cnpj\").notNull(),\n  razaoSocial: text(\"razao_social\").notNull(),\n  uf: text(\"uf\").notNull(),\n  ambiente: text(\"ambiente\").notNull().default(\"prod\"), // \"prod\" ou \"hom\"\n  certificadoPath: text(\"certificado_path\").notNull(), // caminho do arquivo .pfx\n  certificadoSenha: text(\"certificado_senha\").notNull(), // senha do certificado (criptografada)\n  ativo: boolean(\"ativo\").notNull().default(true),\n  ultimoNSU: text(\"ultimo_nsu\").notNull().default(\"000000000000000\"),\n  bloqueadoAte: timestamp(\"bloqueado_ate\", { withTimezone: true, mode: 'date' }), // Bloqueio temporário SEFAZ (cStat 656) até este timestamp (UTC)\n  tipoArmazenamento: text(\"tipo_armazenamento\").notNull().default(\"local\"), // \"local\" (filesystem) ou \"supabase\" (Supabase Storage)\n  manifestacaoAutomatica: boolean(\"manifestacao_automatica\").notNull().default(true), // Manifestar automaticamente com evento 210210 (Ciência)\n  createdAt: timestamp(\"created_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport const insertEmpresaSchema = createInsertSchema(empresas, {\n  cnpj: z.string().regex(/^\\d{14}$/, \"CNPJ deve conter 14 dígitos\"),\n  razaoSocial: z.string().min(1, \"Razão social é obrigatória\"),\n  uf: z.string().length(2, \"UF deve ter 2 caracteres\"),\n  ambiente: z.enum([\"prod\", \"hom\"]),\n  certificadoSenha: z.string().min(1, \"Senha do certificado é obrigatória\"),\n  tipoArmazenamento: z.enum([\"local\", \"supabase\"]).optional(),\n  manifestacaoAutomatica: z.boolean().optional(),\n}).omit({\n  id: true,\n  userId: true, // Preenchido pelo backend baseado no usuário autenticado\n  createdAt: true,\n  updatedAt: true,\n  ultimoNSU: true,\n  bloqueadoAte: true, // Gerenciado automaticamente pelo sistema\n});\n\nexport type InsertEmpresa = z.infer<typeof insertEmpresaSchema>;\nexport type Empresa = typeof empresas.$inferSelect;\n\n// Tabela de Sincronizações\nexport const sincronizacoes = pgTable(\"sincronizacoes\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull(), // references auth.users(id)\n  empresaId: uuid(\"empresa_id\").notNull().references(() => empresas.id, { onDelete: \"cascade\" }),\n  dataInicio: timestamp(\"data_inicio\", { withTimezone: true, mode: 'date' }).notNull(),\n  dataFim: timestamp(\"data_fim\", { withTimezone: true, mode: 'date' }),\n  status: text(\"status\").notNull(), // \"em_andamento\", \"concluida\", \"erro\"\n  nsuInicial: text(\"nsu_inicial\").notNull(),\n  nsuFinal: text(\"nsu_final\"),\n  xmlsBaixados: integer(\"xmls_baixados\").notNull().default(0),\n  mensagemErro: text(\"mensagem_erro\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport const insertSincronizacaoSchema = createInsertSchema(sincronizacoes).omit({\n  id: true,\n  userId: true,\n  createdAt: true,\n});\n\nexport type InsertSincronizacao = z.infer<typeof insertSincronizacaoSchema>;\nexport type Sincronizacao = typeof sincronizacoes.$inferSelect;\n\n// Tabela de XMLs\nexport const xmls = pgTable(\"xmls\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull(), // references auth.users(id)\n  empresaId: uuid(\"empresa_id\").notNull().references(() => empresas.id, { onDelete: \"cascade\" }),\n  sincronizacaoId: uuid(\"sincronizacao_id\").references(() => sincronizacoes.id, { onDelete: \"set null\" }),\n  chaveNFe: text(\"chave_nfe\").notNull(),\n  numeroNF: text(\"numero_nf\").notNull(),\n  modelo: text(\"modelo\").notNull().default(\"55\"), // \"55\" (NF-e) ou \"65\" (NFC-e) - MOC 7.0 §2.2\n  tipoDocumento: text(\"tipo_documento\").notNull().default(\"nfeProc\"), // \"nfeProc\", \"resNFe\", \"procEventoNFe\", \"resEvento\" - NT 2014.002 §3.3\n  dataEmissao: timestamp(\"data_emissao\", { withTimezone: true, mode: 'date' }).notNull(),\n  caminhoArquivo: text(\"caminho_arquivo\").notNull(),\n  tamanhoBytes: integer(\"tamanho_bytes\").notNull(),\n  // Controle de download automático de XML completo\n  statusDownload: text(\"status_download\").notNull().default(\"pendente\"), // \"pendente\", \"completo\", \"erro\"\n  tentativasDownload: integer(\"tentativas_download\").notNull().default(0),\n  ultimaTentativaDownload: timestamp(\"ultima_tentativa_download\", { withTimezone: true, mode: 'date' }),\n  erroDownload: text(\"erro_download\"), // Mensagem do último erro ao tentar download\n  // Status da NFe (baseado em cStat da SEFAZ)\n  statusNfe: text(\"status_nfe\").notNull().default(\"autorizada\"), // \"autorizada\" (100), \"cancelada\" (101), \"denegada\" (110/301/302), \"inutilizada\", \"uso_denegado\"\n  createdAt: timestamp(\"created_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport const insertXmlSchema = createInsertSchema(xmls).omit({\n  id: true,\n  userId: true,\n  createdAt: true,\n});\n\nexport type InsertXml = z.infer<typeof insertXmlSchema>;\nexport type Xml = typeof xmls.$inferSelect;\n\n// Tabela de Logs\nexport const logs = pgTable(\"logs\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\"), // nullable - logs do sistema não têm usuário\n  empresaId: uuid(\"empresa_id\").references(() => empresas.id, { onDelete: \"cascade\" }),\n  sincronizacaoId: uuid(\"sincronizacao_id\").references(() => sincronizacoes.id, { onDelete: \"cascade\" }),\n  nivel: text(\"nivel\").notNull(), // \"info\", \"warning\", \"error\"\n  mensagem: text(\"mensagem\").notNull(),\n  detalhes: text(\"detalhes\"), // JSON com detalhes adicionais\n  timestamp: timestamp(\"timestamp\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport const insertLogSchema = createInsertSchema(logs).omit({\n  id: true,\n  userId: true,\n  timestamp: true,\n});\n\nexport type InsertLog = z.infer<typeof insertLogSchema>;\nexport type Log = typeof logs.$inferSelect;\n\n// Tabela de Manifestações do Destinatário (NT 2020.001)\nexport const manifestacoes = pgTable(\"manifestacoes\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull(), // references auth.users(id)\n  empresaId: uuid(\"empresa_id\").notNull().references(() => empresas.id, { onDelete: \"cascade\" }),\n  chaveNFe: text(\"chave_nfe\").notNull(),\n  tipoEvento: text(\"tipo_evento\").notNull(), // \"210200\" (Confirmação), \"210210\" (Ciência), \"210220\" (Desconhecimento), \"210240\" (Operação Não Realizada)\n  status: text(\"status\").notNull().default(\"pendente\"), // \"pendente\", \"enviado\", \"confirmado\", \"erro\", \"expirado\"\n  dataAutorizacaoNFe: timestamp(\"data_autorizacao_nfe\", { withTimezone: true, mode: 'date' }).notNull(), // Data de autorização da NF-e\n  dataManifestacao: timestamp(\"data_manifestacao\", { withTimezone: true, mode: 'date' }), // Data em que o evento foi enviado à SEFAZ\n  prazoLegal: timestamp(\"prazo_legal\", { withTimezone: true, mode: 'date' }).notNull(), // Prazo limite para manifestar (calculado conforme NT 2020.001 §4)\n  nsuEvento: text(\"nsu_evento\"), // NSU do evento de manifestação quando retornado pela SEFAZ\n  protocoloEvento: text(\"protocolo_evento\"), // Protocolo de autorização do evento\n  cStat: text(\"c_stat\"), // Código de status de retorno da SEFAZ\n  xMotivo: text(\"x_motivo\"), // Descrição do status de retorno\n  justificativa: text(\"justificativa\"), // Justificativa (obrigatória para 210220 e 210240)\n  tentativas: integer(\"tentativas\").notNull().default(0), // Contador de tentativas de envio\n  ultimoErro: text(\"ultimo_erro\"), // Mensagem do último erro\n  createdAt: timestamp(\"created_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport const insertManifestacaoSchema = createInsertSchema(manifestacoes).omit({\n  id: true,\n  userId: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertManifestacao = z.infer<typeof insertManifestacaoSchema>;\nexport type Manifestacao = typeof manifestacoes.$inferSelect;\n\n// Schema para upload de certificado (multipart form)\nexport const uploadCertificadoSchema = z.object({\n  cnpj: z.string().regex(/^\\d{14}$/, \"CNPJ deve conter 14 dígitos\"),\n  razaoSocial: z.string().min(1, \"Razão social é obrigatória\"),\n  uf: z.string().length(2, \"UF deve ter 2 caracteres\"),\n  ambiente: z.enum([\"prod\", \"hom\"]),\n  certificadoSenha: z.string().min(1, \"Senha do certificado é obrigatória\"),\n  tipoArmazenamento: z.enum([\"local\", \"supabase\"]).optional().default(\"local\"),\n  manifestacaoAutomatica: z.string().optional().transform(val => val === \"true\").default(\"false\"),\n});\n\nexport type UploadCertificado = z.infer<typeof uploadCertificadoSchema>;\n\n// Schema para atualização de empresa (sem certificado obrigatório)\nexport const updateEmpresaSchema = z.object({\n  razaoSocial: z.string().min(1, \"Razão social é obrigatória\").optional(),\n  uf: z.string().length(2, \"UF deve ter 2 caracteres\").optional(),\n  ambiente: z.enum([\"prod\", \"hom\"]).optional(),\n  certificadoSenha: z.string().min(1, \"Senha do certificado é obrigatória\").optional(),\n  tipoArmazenamento: z.enum([\"local\", \"supabase\"]).optional(),\n  manifestacaoAutomatica: z.boolean().optional(),\n  ativo: z.boolean().optional(),\n});\n\nexport type UpdateEmpresa = z.infer<typeof updateEmpresaSchema>;\n\n// UFs do Brasil\nexport const UFS = [\n  \"AC\", \"AL\", \"AM\", \"AP\", \"BA\", \"CE\", \"DF\", \"ES\", \"GO\", \"MA\",\n  \"MG\", \"MS\", \"MT\", \"PA\", \"PB\", \"PE\", \"PI\", \"PR\", \"RJ\", \"RN\",\n  \"RO\", \"RR\", \"RS\", \"SC\", \"SE\", \"SP\", \"TO\"\n] as const;\n\nexport type UF = typeof UFS[number];\n\n// Schemas de Autenticação\nexport const registerSchema = z.object({\n  email: z.string().email(\"Email inválido\"),\n  password: z.string().min(6, \"Senha deve ter no mínimo 6 caracteres\"),\n  nomeCompleto: z.string().min(1, \"Nome completo é obrigatório\"),\n});\n\nexport const loginSchema = z.object({\n  email: z.string().email(\"Email inválido\"),\n  password: z.string().min(1, \"Senha é obrigatória\"),\n});\n\nexport type RegisterData = z.infer<typeof registerSchema>;\nexport type LoginData = z.infer<typeof loginSchema>;\n\n// Schema para manifestação manual\nexport const manifestacaoManualSchema = z.object({\n  chaveNFe: z.string().length(44, \"Chave de acesso deve ter 44 caracteres\"),\n  tipoEvento: z.enum([\"210200\", \"210210\", \"210220\", \"210240\"], {\n    errorMap: () => ({ message: \"Tipo de evento inválido\" })\n  }),\n  justificativa: z.string().min(15, \"Justificativa deve ter no mínimo 15 caracteres\").optional(),\n}).refine(\n  (data) => {\n    // Justificativa é obrigatória para Desconhecimento (210220) e Operação Não Realizada (210240)\n    if ((data.tipoEvento === \"210220\" || data.tipoEvento === \"210240\") && !data.justificativa) {\n      return false;\n    }\n    return true;\n  },\n  {\n    message: \"Justificativa é obrigatória para eventos de Desconhecimento e Operação Não Realizada\",\n    path: [\"justificativa\"],\n  }\n);\n\nexport type ManifestacaoManual = z.infer<typeof manifestacaoManualSchema>;\n\n// Tipos de Evento de Manifestação (NT 2020.001 §3)\nexport const TIPOS_EVENTO_MANIFESTACAO = {\n  CONFIRMACAO_OPERACAO: \"210200\",\n  CIENCIA_OPERACAO: \"210210\",\n  DESCONHECIMENTO_OPERACAO: \"210220\",\n  OPERACAO_NAO_REALIZADA: \"210240\",\n} as const;\n\nexport const DESCRICAO_EVENTOS_MANIFESTACAO: Record<string, string> = {\n  \"210200\": \"Confirmação da Operação\",\n  \"210210\": \"Ciência da Operação\",\n  \"210220\": \"Desconhecimento da Operação\",\n  \"210240\": \"Operação não Realizada\",\n};\n\n// Tabela de Configurações do Usuário\nexport const configuracoes = pgTable(\"configuracoes\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull().unique(), // references auth.users(id) - uma config por usuário\n  intervaloSincronizacao: text(\"intervalo_sincronizacao\").notNull().default(\"1h\"), // \"15m\", \"30m\", \"1h\", \"2h\", \"6h\", \"12h\", \"24h\"\n  sincronizacaoAutomatica: boolean(\"sincronizacao_automatica\").notNull().default(true),\n  sincronizarAoIniciar: boolean(\"sincronizar_ao_iniciar\").notNull().default(true),\n  retryAutomatico: boolean(\"retry_automatico\").notNull().default(true),\n  maxRetries: integer(\"max_retries\").notNull().default(3),\n  timeoutRequisicao: integer(\"timeout_requisicao\").notNull().default(60), // segundos\n  validarSSL: boolean(\"validar_ssl\").notNull().default(true),\n  logsDetalhados: boolean(\"logs_detalhados\").notNull().default(false),\n  notificarNovosXmls: boolean(\"notificar_novos_xmls\").notNull().default(true),\n  notificarErros: boolean(\"notificar_erros\").notNull().default(true),\n  relatorioDiario: boolean(\"relatorio_diario\").notNull().default(false),\n  emailNotificacoes: text(\"email_notificacoes\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true, mode: 'date' }).notNull().defaultNow(),\n});\n\nexport const insertConfiguracaoSchema = createInsertSchema(configuracoes).omit({\n  id: true,\n  userId: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateConfiguracaoSchema = z.object({\n  intervaloSincronizacao: z.enum([\"15m\", \"30m\", \"1h\", \"2h\", \"6h\", \"12h\", \"24h\"]).optional(),\n  sincronizacaoAutomatica: z.boolean().optional(),\n  sincronizarAoIniciar: z.boolean().optional(),\n  retryAutomatico: z.boolean().optional(),\n  maxRetries: z.number().int().min(1).max(10).optional(),\n  timeoutRequisicao: z.number().int().min(30).max(300).optional(),\n  validarSSL: z.boolean().optional(),\n  logsDetalhados: z.boolean().optional(),\n  notificarNovosXmls: z.boolean().optional(),\n  notificarErros: z.boolean().optional(),\n  relatorioDiario: z.boolean().optional(),\n  emailNotificacoes: z.string().email().optional().or(z.literal(\"\")),\n});\n\nexport type InsertConfiguracao = z.infer<typeof insertConfiguracaoSchema>;\nexport type UpdateConfiguracao = z.infer<typeof updateConfiguracaoSchema>;\nexport type Configuracao = typeof configuracoes.$inferSelect;\n","size_bytes":14630},"client/src/App.tsx":{"content":"import { Switch, Route, Redirect, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { AuthProvider, useAuth } from \"@/contexts/AuthContext\";\nimport { Button } from \"@/components/ui/button\";\nimport Dashboard from \"@/pages/dashboard\";\nimport Empresas from \"@/pages/empresas\";\nimport EmpresaForm from \"@/pages/empresa-form\";\nimport EmpresaEdit from \"@/pages/empresa-edit\";\nimport Xmls from \"@/pages/xmls\";\nimport Logs from \"@/pages/logs\";\nimport Configuracoes from \"@/pages/configuracoes\";\nimport Login from \"@/pages/login\";\nimport Register from \"@/pages/register\";\nimport AuthConfirm from \"@/pages/auth-confirm\";\nimport NotFound from \"@/pages/not-found\";\nimport { Loader2, LogOut } from \"lucide-react\";\n\nfunction ProtectedRoute({ component: Component }: { component: React.ComponentType }) {\n  const { user, isLoading } = useAuth();\n  const [location] = useLocation();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!user) {\n    return <Redirect to={`/login?redirect=${encodeURIComponent(location)}`} />;\n  }\n\n  return <Component />;\n}\n\nfunction PublicRoute({ component: Component }: { component: React.ComponentType }) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (user) {\n    return <Redirect to=\"/\" />;\n  }\n\n  return <Component />;\n}\n\nfunction AuthenticatedLayout() {\n  const { user, logout } = useAuth();\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1\">\n          <header className=\"flex items-center justify-between p-4 border-b\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-sm text-muted-foreground\">\n                  {user?.nomeCompleto}\n                </div>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={logout}\n                  data-testid=\"button-logout\"\n                >\n                  <LogOut className=\"h-4 w-4 mr-2\" />\n                  Sair\n                </Button>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-sm text-muted-foreground\">\n                  Sistema em execução\n                </div>\n                <div className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\n              </div>\n            </div>\n          </header>\n          <main className=\"flex-1 overflow-auto p-6\">\n            <div className=\"max-w-7xl mx-auto\">\n              <Switch>\n                <Route path=\"/\">{() => <ProtectedRoute component={Dashboard} />}</Route>\n                <Route path=\"/empresas\">{() => <ProtectedRoute component={Empresas} />}</Route>\n                <Route path=\"/empresas/nova\">{() => <ProtectedRoute component={EmpresaForm} />}</Route>\n                <Route path=\"/empresas/:id/editar\">\n                  {(params) => <ProtectedRoute component={() => <EmpresaEdit params={params} />} />}\n                </Route>\n                <Route path=\"/xmls\">{() => <ProtectedRoute component={Xmls} />}</Route>\n                <Route path=\"/logs\">{() => <ProtectedRoute component={Logs} />}</Route>\n                <Route path=\"/configuracoes\">{() => <ProtectedRoute component={Configuracoes} />}</Route>\n                <Route component={NotFound} />\n              </Switch>\n            </div>\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/login\">{() => <PublicRoute component={Login} />}</Route>\n      <Route path=\"/register\">{() => <PublicRoute component={Register} />}</Route>\n      <Route path=\"/auth/confirm\" component={AuthConfirm} />\n      <Route>{() => <AuthenticatedLayout />}</Route>\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <AuthProvider>\n          <Router />\n          <Toaster />\n        </AuthProvider>\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":4937},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5741},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"attached_assets/capturarXmlSefaz_1763056346624.py":{"content":"import argparse\nimport base64\nimport gzip\nimport io\nimport json\nimport logging\nimport os\nimport time\nimport re\nimport sys\nimport xml.etree.ElementTree as ET\nfrom datetime import datetime, timezone\nfrom typing import Optional, Tuple, List,Callable\nimport requests_pkcs12\n\nimport requests\nfrom requests_pkcs12 import Pkcs12Adapter\nfrom lxml import etree\nfrom dateutil import parser as dtparser\nfrom dateutil.relativedelta import relativedelta\n\n# ========= Configurações padrão =========\n\n\nSTATE_DIR = \"state\"\nNS_NFE = \"http://www.portalfiscal.inf.br/nfe\"\nNS_SOAP = \"http://www.w3.org/2003/05/soap-envelope\"\nSOAP_ACTION = \"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe/nfeDistDFeInteresse\"\n\n\nUF_CODE_MAP = {\n    # IBGE UF codes (cUFAutor). Ex.: SP=35, RJ=33, MG=31...\n    # Fonte: Tabela de códigos IBGE das UFs.\n    \"AC\": 12, \"AL\": 27, \"AM\": 13, \"AP\": 16, \"BA\": 29, \"CE\": 23,\n    \"DF\": 53, \"ES\": 32, \"GO\": 52, \"MA\": 21, \"MG\": 31, \"MS\": 50,\n    \"MT\": 51, \"PA\": 15, \"PB\": 25, \"PE\": 26, \"PI\": 22, \"PR\": 41,\n    \"RJ\": 33, \"RN\": 24, \"RO\": 11, \"RR\": 14, \"RS\": 43, \"SC\": 42,\n    \"SE\": 28, \"SP\": 35, \"TO\": 17,\n}\n\nENDPOINTS = {\n    # Produção/homologação do Ambiente Nacional (Portal Nacional NF-e)\n    \"prod\": \"https://www1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx\",\n    \"hom\": \"https://hom1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx\",\n}\n\nSOAP_NS = {\n    \"soap12\": \"http://www.w3.org/2003/05/soap-envelope\",\n    \"wsdl\": \"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe\",\n    \"nfe\": \"http://www.portalfiscal.inf.br/nfe\",\n}\n\n# ========= Utilidades =========\ndef _state_filepath(cnpj: str, ambiente: str) -> str:\n    fn = f\"{cnpj}_{ambiente}.json\"\n    return os.path.join(STATE_DIR, fn)\n\ndef load_state(cnpj: str, ambiente: str) -> dict:\n    path = _state_filepath(cnpj, ambiente)\n    if os.path.isfile(path):\n        with open(path, \"r\", encoding=\"utf-8\") as f:\n            return json.load(f)\n    return {\n        \"ult_nsu\": \"000000000000000\",\n        \"next_allowed_ts\": 0\n    }\n\ndef save_state(cnpj: str, ambiente: str, ult_nsu: str, next_allowed_ts: float) -> None:\n    path = _state_filepath(cnpj, ambiente)\n    os.makedirs(os.path.dirname(path), exist_ok=True)\n    state = {\n        \"ult_nsu\": ult_nsu,\n        \"next_allowed_ts\": next_allowed_ts\n    }\n    with open(path, \"w\", encoding=\"utf-8\") as f:\n        json.dump(state, f, indent=2)\n\ndef setup_logging(logfile: Optional[str], verbose: bool):\n    logger = logging.getLogger()\n    logger.setLevel(logging.DEBUG if verbose else logging.INFO)\n    fmt = logging.Formatter(\"%(asctime)s | %(levelname)s | %(message)s\", \"%Y-%m-%d %H:%M:%S\")\n\n    ch = logging.StreamHandler(sys.stdout)\n    ch.setLevel(logging.DEBUG if verbose else logging.INFO)\n    ch.setFormatter(fmt)\n    logger.handlers.clear()\n    logger.addHandler(ch)\n\n    if logfile:\n        fh = logging.FileHandler(logfile, encoding=\"utf-8\")\n        fh.setLevel(logging.DEBUG)\n        fh.setFormatter(fmt)\n        logger.addHandler(fh)\n\n\ndef ensure_dir(path: str):\n    os.makedirs(path, exist_ok=True)\n\n\ndef month_from_arg(mes_emissao: Optional[str], ultimo_mes: bool) -> Optional[Tuple[int, int]]:\n    \"\"\"\n    Resolve o filtro de mês: retorna (ano, mes) ou None (sem filtro).\n    \"\"\"\n    if mes_emissao:\n        # Formato esperado: AAAA-MM\n        try:\n            year, month = mes_emissao.split(\"-\")\n            return int(year), int(month)\n        except Exception:\n            raise SystemExit(\"--mes-emissao deve estar no formato AAAA-MM (ex.: 2025-11)\")\n\n    if ultimo_mes:\n        now_sp = datetime.now()  # sistema; se quiser, ajuste tz explicitamente\n        ref = (now_sp.replace(day=1) - relativedelta(days=1))\n        return ref.year, ref.month\n\n    return None\n\n\ndef parse_emission_dt(nfe_root: etree._Element) -> Optional[datetime]:\n    \"\"\"\n    Busca ide/dhEmi (ou dEmi) e retorna datetime (naive em UTC/local, tanto faz para ano/mês).\n    \"\"\"\n    ns = {\"nfe\": SOAP_NS[\"nfe\"]}\n    # dhEmi (v4.00) – pode vir com timezone\n    el = nfe_root.find(\".//{http://www.portalfiscal.inf.br/nfe}ide/{http://www.portalfiscal.inf.br/nfe}dhEmi\")\n    if el is not None and el.text:\n        try:\n            return dtparser.parse(el.text)\n        except Exception:\n            pass\n\n    # dEmi (formatos antigos)\n    el = nfe_root.find(\".//{http://www.portalfiscal.inf.br/nfe}ide/{http://www.portalfiscal.inf.br/nfe}dEmi\")\n    if el is not None and el.text:\n        try:\n            return dtparser.parse(el.text)\n        except Exception:\n            pass\n\n    return None\n\n\ndef localname(tag: str) -> str:\n    \"\"\"\n    Remove namespace do nome da tag.\n    \"\"\"\n    if \"}\" in tag:\n        return tag.split(\"}\", 1)[1]\n    return tag\n\n\ndef gzip_base64_to_xml(b64_text: str) -> bytes:\n    raw = base64.b64decode(b64_text)\n    try:\n        return gzip.decompress(raw)\n    except OSError:\n        # Algumas implantações já retornam descompactado; devolve como está\n        return raw\n\n\ndef extract_chave_e_nnf(nfeproc_root: etree._Element) -> Tuple[Optional[str], Optional[str]]:\n    \"\"\"\n    Extrai chNFe (do protNFe/infProt/chNFe) e nNF (NFe/infNFe/ide/nNF).\n    \"\"\"\n    ns = {\"nfe\": SOAP_NS[\"nfe\"]}\n    ch = nfeproc_root.find(\".//{http://www.portalfiscal.inf.br/nfe}protNFe/{http://www.portalfiscal.inf.br/nfe}infProt/{http://www.portalfiscal.inf.br/nfe}chNFe\")\n    nnf = nfeproc_root.find(\".//{http://www.portalfiscal.inf.br/nfe}NFe/{http://www.portalfiscal.inf.br/nfe}infNFe/{http://www.portalfiscal.inf.br/nfe}ide/{http://www.portalfiscal.inf.br/nfe}nNF\")\n    ch_text = ch.text.strip() if ch is not None and ch.text else None\n    nnf_text = nnf.text.strip() if nnf is not None and nnf.text else None\n    return ch_text, nnf_text\n\n\ndef save_nfeproc(xml_bytes: bytes, dest_root: str, cnpj: str, dh_emi: Optional[datetime]) -> Tuple[str, str]:\n    \"\"\"\n    Salva o nfeProc em DEST/CNPJ/AAAA/MM/nNF.xml (ou CHAVE.xml em conflito).\n    Retorna (dest_dir, filename).\n    \"\"\"\n    root = etree.fromstring(xml_bytes)\n    if localname(root.tag) != \"nfeProc\":\n        raise ValueError(\"XML não é nfeProc\")\n\n    # Data de emissão para path\n    dt_emi = parse_emission_dt(root) or dh_emi or datetime.now()\n    year = f\"{dt_emi.year:04d}\"\n    month = f\"{dt_emi.month:02d}\"\n\n    dest_dir = os.path.join(dest_root, cnpj, year, month)\n    ensure_dir(dest_dir)\n\n    ch, nnf = extract_chave_e_nnf(root)\n    if not nnf:\n        # fallback para chave\n        if not ch:\n            raise ValueError(\"Não foi possível extrair nNF nem chNFe.\")\n        base = f\"{ch}.xml\"\n    else:\n        base = f\"{int(nnf)}.xml\" if nnf.isdigit() else f\"{nnf}.xml\"  # lida com zeros à esquerda\n\n    filename = os.path.join(dest_dir, base)\n\n    if os.path.exists(filename):\n        if ch:\n            filename = os.path.join(dest_dir, f\"{ch}.xml\")\n        else:\n            # último recurso: sufixo\n            filename = os.path.join(dest_dir, f\"{base}.dup\")\n\n    with open(filename, \"wb\") as f:\n        f.write(xml_bytes)\n\n    return dest_dir, os.path.basename(filename)\n\n\ndef matches_month_filter(xml_bytes: bytes, month_filter: Optional[Tuple[int, int]]) -> bool:\n    if not month_filter:\n        return True\n    y, m = month_filter\n    try:\n        root = etree.fromstring(xml_bytes)\n        # Tenta pegar data de emissão do próprio nfeProc\n        dt = parse_emission_dt(root)\n        if dt:\n            return (dt.year == y and dt.month == m)\n    except Exception:\n        pass\n    return False\n\n\n# ========= SOAP: NFeDistribuicaoDFe =========\n\ndef build_envelope(cnpj: str, uf: str, ambiente: str, nsu: str = \"000000000000000\") -> bytes:\n    cuf_autor = UF_CODE_MAP.get(uf.upper(), 35)\n    tp_amb_str = \"1\" if ambiente.lower().startswith(\"prod\") else \"2\"\n    nsu15 = (nsu or \"0\").rjust(15, \"0\")\n\n    envelope = f\"\"\"<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap12:Envelope xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"\n                 xmlns:nfe=\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe\">\n  <soap12:Body>\n    <nfe:nfeDistDFeInteresse>\n      <nfe:nfeDadosMsg>\n        <distDFeInt xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.01\">\n          <tpAmb>{tp_amb_str}</tpAmb>\n          <cUFAutor>{cuf_autor}</cUFAutor>\n          <CNPJ>{cnpj}</CNPJ>\n          <consNSU><NSU>{nsu15}</NSU></consNSU>\n        </distDFeInt>\n      </nfe:nfeDadosMsg>\n    </nfe:nfeDistDFeInteresse>\n  </soap12:Body>\n</soap12:Envelope>\"\"\"\n    return envelope.encode(\"utf-8\")\n\n\ndef call_distdfe(\n    session: requests.Session,\n    url: str,\n    envelope_xml: bytes,\n    timeout: int = 60,\n    verbose: bool = False\n) -> ET.Element:\n    \"\"\"\n    Chama o serviço nfeDistDFeInteresse e retorna a raiz SOAP como Element.\n    Loga SOAP Fault (500) e responde com raise contendo mais contexto.\n    \"\"\"\n    headers = {\n        \"Content-Type\": \"application/soap+xml; charset=utf-8\",\n        \"Connection\": \"keep-alive\",\n    }\n\n    if verbose:\n        logging.debug(\">>> SOAP REQUEST to %s\\n%s\", url, envelope_xml.decode(\"utf-8\"))\n\n    resp = session.post(url, data=envelope_xml, headers=headers, timeout=timeout)\n\n    if verbose:\n        logging.debug(\"<<< HTTP %s\", resp.status_code)\n        logging.debug(\"<<< HEADERS: %s\", dict(resp.headers))\n        if resp.content:\n            logging.debug(\"<<< BODY:\\n%s\", resp.text[:10000])  # limita a 10k p/ não poluir\n\n    # Em caso de 500, muitas vezes há SOAP Fault com detalhes úteis.\n    if resp.status_code >= 400:\n        body_preview = resp.text.strip()[:4000]\n        raise requests.HTTPError(\n            f\"{resp.status_code} ao chamar Distribuição DF-e. \"\n            f\"URL={url} | Preview corpo:\\n{body_preview}\",\n            response=resp\n        )\n\n    # Parse do SOAP\n    try:\n        root = ET.fromstring(resp.content)\n    except ET.ParseError as e:\n        raise RuntimeError(f\"Falha ao parsear SOAP: {e}\\nCorpo:\\n{resp.text[:4000]}\")\n\n    # SOAP Fault explícito\n    fault = root.find(\".//{http://www.w3.org/2003/05/soap-envelope}Fault\")\n    if fault is not None:\n        fault_str = ET.tostring(fault, encoding=\"unicode\")\n        raise RuntimeError(f\"SOAP Fault recebido:\\n{fault_str}\")\n\n    return root\n\ndef iter_doczip_from_response(soap_root: etree._Element) -> Tuple[str, str, List[etree._Element]]:\n    \"\"\"\n    Retorna (cStat, xMotivo, lista de elementos <docZip>).\n    Também retorna ultNSU/maxNSU via tags.\n    \"\"\"\n    # Encontra retDistDFeInt\n    ret = soap_root.find(\".//{http://www.portalfiscal.inf.br/nfe}retDistDFeInt\")\n    if ret is None:\n        # alguns ambientes aninham resultado em nfeDistDFeInteresseResponse/nfeDistDFeInteresseResult\n        ret = soap_root.find(\".//retDistDFeInt\")\n        if ret is None:\n            raise ValueError(\"retDistDFeInt não encontrado na resposta.\")\n\n    cStat = ret.findtext(\"{http://www.portalfiscal.inf.br/nfe}cStat\") or ret.findtext(\"cStat\") or \"\"\n    xMotivo = ret.findtext(\"{http://www.portalfiscal.inf.br/nfe}xMotivo\") or ret.findtext(\"xMotivo\") or \"\"\n\n    lote = ret.find(\"{http://www.portalfiscal.inf.br/nfe}loteDistDFeInt\")\n    doczips = []\n    if lote is not None:\n        doczips = lote.findall(\"{http://www.portalfiscal.inf.br/nfe}docZip\")\n\n    ultNSU = ret.findtext(\"{http://www.portalfiscal.inf.br/nfe}ultNSU\") or \"\"\n    maxNSU = ret.findtext(\"{http://www.portalfiscal.inf.br/nfe}maxNSU\") or \"\"\n\n    return cStat, xMotivo, doczips, ultNSU, maxNSU\n\nimport xml.etree.ElementTree as ET\nimport base64\nimport gzip\nfrom io import BytesIO\nimport logging\nfrom typing import List, Tuple, Optional, Union\n\ndef _strip_ns(tag: str) -> str:\n    \"\"\"Remove namespace de uma tag XML (ex: '{…}cStat' → 'cStat').\"\"\"\n    if '}' in tag:\n        return tag.split('}', 1)[1]\n    return tag\n\ndef _find_text(root: ET.Element, path: str, nsmap: dict, required: bool = True) -> Optional[str]:\n    \"\"\"Busca elemento por xpath e retorna .text ou None.\"\"\"\n    elem = root.find(path, nsmap)\n    if elem is None:\n        if required:\n            logging.error(f\"Elemento obrigatório '{path}' não encontrado no XML.\")\n            raise ValueError(f\"Elemento obrigatório '{path}' não encontrado.\")\n        return None\n    return elem.text.strip() if elem.text is not None else ''\n\ndef parse_response_metadata(xml_bytes: bytes) -> Tuple[int, str, Optional[str]]:\n    \"\"\"\n    Extrai cStat (int), ultNSU (str) e maxNSU (str | None) da resposta.\n    Retorna: (cStat, ultNSU, maxNSU)\n    \"\"\"\n    root = ET.fromstring(xml_bytes)\n    ns = {'nfe': 'http://www.portalfiscal.inf.br/nfe'}  # pode haver mais\n    # localizar cStat\n    text_stat = _find_text(root, './/nfe:cStat', ns)\n    cstat = int(text_stat)\n    ult_nsu = _find_text(root, './/nfe:ultNSU', ns, required=False) or ''\n    max_nsu = _find_text(root, './/nfe:maxNSU', ns, required=False)\n    logging.debug(f\"parse_response_metadata → cStat={cstat}, ultNSU={ult_nsu}, maxNSU={max_nsu}\")\n    return cstat, ult_nsu, max_nsu\n\ndef parse_doczips(xml_bytes: bytes) -> List[Tuple[str, str, bytes]]:\n    \"\"\"\n    Extrai todos os docZip da resposta.\n    Cada tuple: (NSU, schema, raw_xml_bytes)\n    raw_xml_bytes: descompactado se necessário (gzip + base64).\n    \"\"\"\n    root = ET.fromstring(xml_bytes)\n    ns = {'nfe': 'http://www.portalfiscal.inf.br/nfe'}\n    docs = []\n    for dz in root.findall('.//nfe:docZip', ns):\n        nsu = dz.get('NSU')\n        schema = dz.get('schema')\n        raw_b64 = dz.text.strip() if dz.text else ''\n        logging.debug(f\"docZip encontrado → NSU={nsu}, schema={schema}, tamanho(base64)={len(raw_b64)}\")\n        try:\n            compressed = base64.b64decode(raw_b64)\n        except Exception as e:\n            logging.error(f\"Falha no base64 do NSU={nsu} schema={schema}: {e}\")\n            continue\n        try:\n            buf = BytesIO(compressed)\n            with gzip.GzipFile(fileobj=buf) as gz:\n                xml_raw = gz.read()\n            logging.debug(f\"Descompactado gzip NSU={nsu} (schema={schema}), tamanho={len(xml_raw)} bytes\")\n        except OSError:\n            # Se não for gzip\n            xml_raw = compressed\n            logging.debug(f\"Não era gzip (NSU={nsu}), usando raw direto, tamanho={len(xml_raw)} bytes\")\n        docs.append((nsu, schema, xml_raw))\n    return docs\n\ndef extract_chave_from_xml(raw_xml_bytes: bytes) -> str:\n    \"\"\"\n    Extrai a chave de acesso da NF-e dentro do XML bruto.\n    Procura infNFe/@Id ou tag chNFe.\n    \"\"\"\n    try:\n        root = ET.fromstring(raw_xml_bytes)\n    except Exception as e:\n        logging.error(f\"Falha ao parsear XML bruto para extração de chave: {e}\")\n        raise\n\n    # Remover namespace para facilitar\n    for elem in root.iter():\n        elem.tag = _strip_ns(elem.tag)\n\n    # Tentar infNFe @Id\n    infnfe = root.find('.//infNFe')\n    if infnfe is not None and 'Id' in infnfe.attrib:\n        id_val = infnfe.attrib['Id']\n        if id_val.startswith('NFe'):\n            chave = id_val[3:]\n        else:\n            chave = id_val\n        logging.debug(f\"Chave extraída via infNFe/@Id: {chave}\")\n        return chave\n\n    # Tentar tag chNFe\n    ch_elem = root.find('.//chNFe')\n    if ch_elem is not None and ch_elem.text:\n        chave = ch_elem.text.strip()\n        logging.debug(f\"Chave extraída via chNFe: {chave}\")\n        return chave\n\n    logging.error(\"Chave de acesso não encontrada no XML bruto\")\n    raise ValueError(\"Chave de acesso não encontrada no XML\")\n\n\n\ndef salvar_nfeproc_renomeando(xml_txt: str, _raw: bytes, dest_base: str, cnpj_alvo: str):\n    \"\"\"\n    Salva sob <dest_base>/<cnpj_alvo>/<AAAA>/<MM>/\n    Nome principal: nNF.xml; se já existir, salva como CHAVE.xml.\n    \"\"\"\n    import os, re, xml.etree.ElementTree as ET\n    ns = {\"nfe\": \"http://www.portalfiscal.inf.br/nfe\"}\n\n    root = ET.fromstring(xml_txt)\n    # Pega chave (chNFe) do prot, se existir\n    ch = root.find(\".//nfe:protNFe/nfe:infProt/nfe:chNFe\", ns)\n    chave = (ch.text or \"\").strip() if ch is not None else \"\"\n\n    # nNF\n    nnf = root.find(\".//nfe:NFe/nfe:infNFe/nfe:ide/nfe:nNF\", ns)\n    nNF = (nnf.text or \"\").strip() if nnf is not None else \"\"\n\n    # dhEmi → ano/mês\n    dh = root.find(\".//nfe:NFe/nfe:infNFe/nfe:ide/nfe:dhEmi\", ns)\n    em = (dh.text or \"\").strip() if dh is not None else \"\"\n    ano = em[0:4]\n    mes = em[5:7]\n\n    pasta = os.path.join(dest_base, cnpj_alvo, ano, mes)\n    os.makedirs(pasta, exist_ok=True)\n\n    # nome principal: nNF.xml (somente dígitos)\n    base_name = re.sub(r\"[^\\d]\", \"\", nNF) or (chave if chave else \"sem_nnf\")\n    primario = os.path.join(pasta, f\"{base_name}.xml\")\n\n    if os.path.exists(primario):\n        # fallback como CHAVE.xml (44 dígitos)\n        if not chave:\n            chave = \"sem_chave\"\n        alvo = os.path.join(pasta, f\"{chave}.xml\")\n    else:\n        alvo = primario\n\n    with open(alvo, \"w\", encoding=\"utf-8\") as f:\n        f.write(xml_txt)\n\ndef get_endpoint(ambiente: str) -> str:\n    key = \"prod\" if ambiente.lower().startswith(\"prod\") else \"hom\"\n    return ENDPOINTS[key]\n\ndef baixar_online(cnpj: str, uf: str, ambiente: str,\n                  cert_pfx: str, cert_pass: str,\n                  filtro_ano_mes: str | None,\n                  salvar_xml_fn: Callable[[str, bytes], None],\n                  verbose: bool = False) -> Tuple[int, int]:\n\n    state = load_state(cnpj, ambiente)\n    now_ts = time.time()\n    if now_ts < state[\"next_allowed_ts\"]:\n        wait = int(state[\"next_allowed_ts\"] - now_ts)\n        logging.info(f\"Aguardar {wait} segundos antes de nova consulta para {cnpj}/{ambiente}\")\n        return 0, 0\n\n    sess = requests.Session()\n    sess.mount('https://', requests_pkcs12.Pkcs12Adapter(\n        pkcs12_filename=cert_pfx,\n        pkcs12_password=cert_pass\n    ))\n\n    url = get_endpoint(ambiente)\n    total_processed = 0\n    total_saved = 0\n    ult_nsu = state[\"ult_nsu\"]\n\n    while True:\n        if verbose:\n            logging.info(f\"[NSU={ult_nsu}] POST {url}\")\n        envelope = build_envelope(cnpj=cnpj, uf=uf, ambiente=ambiente, nsu=ult_nsu)\n        headers = {\n            \"Content-Type\": \"application/soap+xml; charset=utf-8\",\n            \"Connection\": \"keep-alive\",\n        }\n        resp = sess.post(url, data=envelope, headers=headers, timeout=60)\n        resp.raise_for_status()\n        body = resp.content\n\n        # *** IMPORTANTE: adapte estas funções de parsing no seu projeto ***\n        cStat, new_ult_nsu, max_nsu = parse_response_metadata(body)\n        docs = [d[2] for d in parse_doczips(body)]\n\n        if verbose:\n            logging.info(f\"cStat={cStat} novoUltNSU={new_ult_nsu} maxNSU={max_nsu} docs={len(docs)}\")\n\n        if cStat == 138:\n            for raw in docs:\n                xml_txt = extract_chave(raw)\n                salvar_xml_fn(xml_txt, raw)\n                total_saved += 1\n            total_processed += len(docs)\n            ult_nsu = new_ult_nsu\n            if ult_nsu == max_nsu:\n                break\n        elif cStat == 137:\n            break\n        else:\n            logging.warning(f\"Código inesperado cStat={cStat} para CNPJ={cnpj}, NSU={ult_nsu}\")\n            break\n\n        time.sleep(1.2)\n\n    # Salvando estado para retomar depois\n    next_allowed = time.time() + 3600\n    save_state(cnpj, ambiente, ult_nsu, next_allowed)\n\n    return total_processed, total_saved\n\ndef process_doczips_locais(scan_dir: str,\n                           dest_root: str,\n                           cnpj: str,\n                           month_filter: Optional[Tuple[int, int]],\n                           apenas_nfeproc: bool) -> Tuple[int, int]:\n    \"\"\"\n    Lê todos os arquivos em scan_dir (docZip base64+gzip ou XML puro),\n    aplica filtros e salva nfeProc conforme regras.\n    \"\"\"\n    processados = 0\n    salvos = 0\n\n    for root_dir, _, files in os.walk(scan_dir):\n        for name in files:\n            path = os.path.join(root_dir, name)\n            try:\n                with open(path, \"rb\") as f:\n                    data = f.read()\n                # detecta se é docZip base64 ou xml já\n                xml_bytes = None\n                try:\n                    # tenta como base64+gzip\n                    xml_bytes = gzip_base64_to_xml(data.decode(\"utf-8\"))\n                except Exception:\n                    # pode ser xml puro\n                    xml_bytes = data\n\n                processados += 1\n                root = etree.fromstring(xml_bytes)\n                tag = localname(root.tag)\n\n                if tag == \"procEventoNFe\":\n                    logging.debug(f\"[local] Descartando procEventoNFe: {name}\")\n                    continue\n\n                if apenas_nfeproc and tag != \"nfeProc\":\n                    logging.debug(f\"[local] Descartando {tag} (apenas nfeProc): {name}\")\n                    continue\n\n                if not matches_month_filter(xml_bytes, month_filter):\n                    logging.debug(f\"[local] Fora do mês filtrado: {name}\")\n                    continue\n\n                dest_dir, fname = save_nfeproc(xml_bytes, dest_root=dest_root, cnpj=cnpj, dh_emi=None)\n                salvos += 1\n                logging.info(f\"[local] Salvo: {os.path.join(dest_dir, fname)}\")\n\n            except Exception as e:\n                logging.exception(f\"Falha ao processar {path}: {e}\")\n\n    return processados, salvos\n\n\n# ========= CLI =========\n\ndef build_arg_parser() -> argparse.ArgumentParser:\n    p = argparse.ArgumentParser(\n        description=\"Baixar/Processar NF-e (nfeProc) via NFeDistribuicaoDFe e/ou docZip local.\",\n        formatter_class=argparse.RawTextHelpFormatter,\n    )\n    p.add_argument(\"--cnpj\", required=True, help=\"CNPJ do interessado (apenas dígitos).\")\n    p.add_argument(\"--dest\", required=True, help=\"Diretório de destino (será organizado como DEST/CNPJ/AAAA/MM).\")\n\n    # Mês de emissão\n    p.add_argument(\"--mes-emissao\", help=\"Filtro do mês de emissão no formato AAAA-MM (ex.: 2025-11).\")\n    p.add_argument(\"--ultimo-mes\", action=\"store_true\", help=\"Filtrar pelo último mês (com base na data atual).\")\n\n    # Modo on-line\n    p.add_argument(\"--baixar-online\", action=\"store_true\", help=\"Ativa o download on-line via NFeDistribuicaoDFe.\")\n    p.add_argument(\"--uf\", help=\"UF do autor (ex.: SP, RJ, MG) – obrigatório com --baixar-online.\")\n    p.add_argument(\"--amb\", choices=[\"prod\", \"hom\"], default=\"prod\", help=\"Ambiente (prod|hom). Padrão: prod.\")\n    p.add_argument(\"--cert-pfx\", help=\"Caminho do certificado A1 (.pfx) – obrigatório com --baixar-online.\")\n    p.add_argument(\"--cert-pass\", help=\"Senha do .pfx – obrigatório com --baixar-online.\")\n    p.add_argument(\"--max-chamadas\", type=int, default=20, help=\"Limite de iterações da distribuição (default: 20).\")\n\n    # Modo local (docZip)\n    p.add_argument(\"--scan-dir\", help=\"Pasta contendo docZip (base64+gzip) ou XMLs para processamento local.\")\n\n    # Regras\n    p.add_argument(\"--apenas-nfeproc\", action=\"store_true\", help=\"Salvar somente nfeProc (descarta demais).\")\n    p.add_argument(\"--verbose\", action=\"store_true\", help=\"Logs detalhados.\")\n    p.add_argument(\"--log\", help=\"Arquivo de log.\")\n\n    return p\n\n\ndef main():\n    args = build_arg_parser().parse_args()\n    setup_logging(args.log, args.verbose)\n\n    if args.baixar_online:\n        for req in (\"uf\", \"cert_pfx\", \"cert_pass\"):\n            if getattr(args, req.replace(\"-\", \"_\"), None) is None:\n                logging.error(f\"--{req.replace('_','-')} é obrigatório com --baixar-online.\")\n                sys.exit(2)\n        if args.uf.upper() not in UF_CODE_MAP:\n            logging.error(f\"UF inválida: {args.uf}\")\n            sys.exit(2)\n\n    month_tuple = month_from_arg(args.mes_emissao, args.ultimo_mes)\n    filtro_ano_mes = f\"{month_tuple[0]:04d}-{month_tuple[1]:02d}\" if month_tuple else None\n\n    if month_tuple:\n        logging.info(f\"Filtro de emissão: {month_tuple[0]:04d}-{month_tuple[1]:02d}\")\n    else:\n        logging.info(\"Sem filtro de mês (trará todas as emissões).\")\n\n    ensure_dir(args.dest)\n    cnpj_digits = re.sub(r\"\\D\", \"\", args.cnpj)\n\n    total_proc = 0\n    total_save = 0\n\n    def _salvar(xml_txt: str, raw: bytes):\n        salvar_nfeproc_renomeando(xml_txt, raw, args.dest, cnpj_digits)\n\n    if args.baixar_online:\n        p, s = baixar_online(\n            cnpj=cnpj_digits,\n            uf=args.uf.upper(),\n            ambiente=args.amb,\n            cert_pfx=args.cert_pfx,\n            cert_pass=args.cert_pass,\n            filtro_ano_mes=filtro_ano_mes,\n            salvar_xml_fn=_salvar,\n            verbose=args.verbose,\n        )\n        total_proc += p\n        total_save += s\n\n    if args.scan_dir:\n        p, s = process_doczips_locais(\n            scan_dir=args.scan_dir,\n            dest_root=args.dest,\n            cnpj=cnpj_digits,\n            month_filter=month_tuple,\n            apenas_nfeproc=True,\n        )\n        total_proc += p\n        total_save += s\n\n    dest_preview = os.path.join(\n        args.dest,\n        cnpj_digits,\n        f\"{month_tuple[0]:04d}\" if month_tuple else \"\",\n        f\"{month_tuple[1]:02d}\" if month_tuple else \"\"\n    ).rstrip(\"\\\\/\")\n\n    logging.info(f\"Resumo: processados={total_proc}, salvos={total_save}, destino={dest_preview}\")\n\nif __name__ == \"__main__\":\n    main()\n\n","size_bytes":25030},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/pages/empresas.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Building2, Plus, Pencil, Trash2, Search, Play, RefreshCw, Filter, Unlock } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { StatusBadge } from \"@/components/status-badge\";\nimport { Link } from \"wouter\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { useState } from \"react\";\n\ninterface Empresa {\n  id: string;\n  cnpj: string;\n  razaoSocial: string;\n  uf: string;\n  ambiente: string;\n  ativo: boolean;\n  ultimoNSU: string;\n  updatedAt: string;\n}\n\nexport default function Empresas() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [reconcilandoId, setReconcilandoId] = useState<string | null>(null);\n  const [buscaAvancadaOpen, setBuscaAvancadaOpen] = useState(false);\n  const [empresaSelecionada, setEmpresaSelecionada] = useState<Empresa | null>(null);\n  const [nsuInicial, setNsuInicial] = useState(\"\");\n  const [nsuFinal, setNsuFinal] = useState(\"\");\n  const [maxConsultas, setMaxConsultas] = useState(\"20\");\n  const { toast } = useToast();\n\n  const { data: empresas, isLoading } = useQuery<Empresa[]>({\n    queryKey: [\"/api/empresas\"],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/empresas/${id}`, { method: \"DELETE\" }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/empresas\"] });\n      toast({\n        title: \"Empresa excluída\",\n        description: \"A empresa foi removida com sucesso.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao excluir\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const sincronizarMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/empresas/${id}/sincronizar`, { method: \"POST\" }),\n    onSuccess: () => {\n      toast({\n        title: \"Sincronização iniciada\",\n        description: \"A sincronização foi iniciada em segundo plano.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao sincronizar\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const desbloquearMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/debug/desbloquear/${id}`, { method: \"POST\" }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/empresas\"] });\n      toast({\n        title: \"Empresa desbloqueada\",\n        description: \"O bloqueio foi removido. Você pode sincronizar novamente.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao desbloquear\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const reconciliarNSUMutation = useMutation({\n    mutationFn: (id: string) => {\n      setReconcilandoId(id);\n      return apiRequest<{\n        success: boolean;\n        nsuAnterior: string;\n        nsuAtual: string;\n        chamadas: number;\n        intervalo: { min: string; max: string };\n      }>(`/api/empresas/${id}/reconciliar-nsu`, { method: \"POST\" });\n    },\n    onSuccess: (data) => {\n      setReconcilandoId(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/empresas\"] });\n      toast({\n        title: \"NSU reconciliado com sucesso\",\n        description: `NSU atualizado de ${data.nsuAnterior} para ${data.nsuAtual} (${data.chamadas} consultas)`,\n      });\n    },\n    onError: (error: Error) => {\n      setReconcilandoId(null);\n      toast({\n        title: \"Erro ao reconciliar NSU\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const buscarPorPeriodoMutation = useMutation({\n    mutationFn: ({ id, nsuInicial, nsuFinal, maxConsultas }: {\n      id: string;\n      nsuInicial: string;\n      nsuFinal: string;\n      maxConsultas: number;\n    }) => {\n      return apiRequest<{\n        success: boolean;\n        xmlsEncontrados: number;\n        consultasRealizadas: number;\n        nsuConsultados: string[];\n      }>(`/api/empresas/${id}/buscar-periodo`, {\n        method: \"POST\",\n        body: JSON.stringify({ nsuInicial, nsuFinal, maxConsultas }),\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n    },\n    onSuccess: (data) => {\n      setBuscaAvancadaOpen(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/xmls\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/logs\"] });\n      toast({\n        title: \"Busca avançada concluída\",\n        description: `${data.xmlsEncontrados} XML(s) encontrado(s) em ${data.consultasRealizadas} consulta(s)`,\n      });\n      \n      // Limpa formulário\n      setNsuInicial(\"\");\n      setNsuFinal(\"\");\n      setMaxConsultas(\"20\");\n      setEmpresaSelecionada(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro na busca avançada\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n\n  const filteredEmpresas = empresas?.filter((empresa) =>\n    empresa.razaoSocial.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    empresa.cnpj.includes(searchTerm)\n  );\n\n  const formatCNPJ = (cnpj: string) => {\n    return cnpj.replace(/^(\\d{2})(\\d{3})(\\d{3})(\\d{4})(\\d{2})$/, \"$1.$2.$3/$4-$5\");\n  };\n\n  const formatDateTime = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return new Intl.DateTimeFormat('pt-BR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    }).format(date);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-empresas\">Empresas Cadastradas</h1>\n          <p className=\"text-sm text-muted-foreground\">Gerencie as empresas para sincronização de XMLs</p>\n        </div>\n        <Button asChild data-testid=\"button-nova-empresa\">\n          <Link href=\"/empresas/nova\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Nova Empresa\n          </Link>\n        </Button>\n      </div>\n\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"relative flex-1 max-w-sm\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Buscar por nome ou CNPJ...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-empresa\"\n              />\n            </div>\n            <div className=\"text-sm text-muted-foreground\">\n              {filteredEmpresas?.length ?? 0} empresa(s)\n            </div>\n          </div>\n\n          {isLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3, 4].map((i) => (\n                <div key={i} className=\"flex items-center gap-4 p-4 border rounded-md\">\n                  <Skeleton className=\"w-12 h-12 rounded-md\" />\n                  <div className=\"flex-1 space-y-2\">\n                    <Skeleton className=\"h-5 w-48\" />\n                    <Skeleton className=\"h-4 w-32\" />\n                  </div>\n                  <Skeleton className=\"h-6 w-16\" />\n                  <Skeleton className=\"h-8 w-20\" />\n                </div>\n              ))}\n            </div>\n          ) : filteredEmpresas && filteredEmpresas.length > 0 ? (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-12\"></TableHead>\n                    <TableHead>Razão Social</TableHead>\n                    <TableHead>CNPJ</TableHead>\n                    <TableHead>UF</TableHead>\n                    <TableHead>Ambiente</TableHead>\n                    <TableHead>Último NSU</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Atualizado em</TableHead>\n                    <TableHead className=\"text-right\">Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredEmpresas.map((empresa) => (\n                    <TableRow key={empresa.id} data-testid={`row-empresa-${empresa.id}`} className=\"hover-elevate\">\n                      <TableCell>\n                        <div className=\"w-10 h-10 bg-primary/10 rounded-md flex items-center justify-center\">\n                          <Building2 className=\"w-5 h-5 text-primary\" />\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"font-medium\">\n                        {empresa.razaoSocial}\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-mono text-sm\">\n                          {formatCNPJ(empresa.cnpj)}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-medium\">{empresa.uf}</span>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm capitalize\">\n                          {empresa.ambiente === \"prod\" ? \"Produção\" : \"Homologação\"}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-mono text-xs text-muted-foreground\">\n                          {empresa.ultimoNSU}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <StatusBadge status={empresa.ativo ? \"ativo\" : \"inativo\"} />\n                      </TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground\">\n                        {formatDateTime(empresa.updatedAt)}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex items-center justify-end gap-2\">\n                          {empresa.ultimoNSU !== \"000000000000000\" && empresa.ultimoNSU !== \"0\" && (\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => {\n                                // Bloqueia múltiplas reconciliações simultâneas\n                                if (reconcilandoId !== null) return;\n                                reconciliarNSUMutation.mutate(empresa.id);\n                              }}\n                              disabled={reconcilandoId !== null}\n                              title=\"Alinhar NSU sem baixar XMLs (avança rapidamente)\"\n                              data-testid={`button-reconciliar-${empresa.id}`}\n                            >\n                              <RefreshCw className={`w-4 h-4 ${reconcilandoId === empresa.id ? 'animate-spin' : ''}`} />\n                            </Button>\n                          )}\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => {\n                              setEmpresaSelecionada(empresa);\n                              setBuscaAvancadaOpen(true);\n                            }}\n                            title=\"Busca avançada por período (máx 20 consultas/hora)\"\n                            data-testid={`button-busca-avancada-${empresa.id}`}\n                          >\n                            <Filter className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => desbloquearMutation.mutate(empresa.id)}\n                            disabled={desbloquearMutation.isPending}\n                            title=\"Desbloquear empresa (remove bloqueio SEFAZ)\"\n                            data-testid={`button-desbloquear-${empresa.id}`}\n                          >\n                            <Unlock className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => sincronizarMutation.mutate(empresa.id)}\n                            disabled={sincronizarMutation.isPending}\n                            title=\"Sincronizar agora (baixa XMLs)\"\n                            data-testid={`button-sync-${empresa.id}`}\n                          >\n                            <Play className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            asChild\n                            title=\"Editar empresa\"\n                            data-testid={`button-edit-${empresa.id}`}\n                          >\n                            <Link href={`/empresas/${empresa.id}/editar`}>\n                              <Pencil className=\"w-4 h-4\" />\n                            </Link>\n                          </Button>\n                          <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                data-testid={`button-delete-${empresa.id}`}\n                              >\n                                <Trash2 className=\"w-4 h-4\" />\n                              </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                              <AlertDialogHeader>\n                                <AlertDialogTitle>Confirmar exclusão</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                  Tem certeza que deseja excluir a empresa <strong>{empresa.razaoSocial}</strong>?\n                                  Esta ação não pode ser desfeita e todos os XMLs associados serão removidos.\n                                </AlertDialogDescription>\n                              </AlertDialogHeader>\n                              <AlertDialogFooter>\n                                <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                                <AlertDialogAction\n                                  onClick={() => deleteMutation.mutate(empresa.id)}\n                                  className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                                >\n                                  Excluir\n                                </AlertDialogAction>\n                              </AlertDialogFooter>\n                            </AlertDialogContent>\n                          </AlertDialog>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          ) : (\n            <div className=\"text-center py-12\">\n              <Building2 className=\"w-16 h-16 mx-auto mb-4 opacity-20\" />\n              <h3 className=\"text-lg font-medium mb-2\">Nenhuma empresa cadastrada</h3>\n              <p className=\"text-sm text-muted-foreground mb-6\">\n                {searchTerm\n                  ? \"Nenhuma empresa encontrada com os critérios de busca\"\n                  : \"Cadastre a primeira empresa para começar a sincronizar XMLs\"}\n              </p>\n              {!searchTerm && (\n                <Button asChild>\n                  <Link href=\"/empresas/nova\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Cadastrar Primeira Empresa\n                  </Link>\n                </Button>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={buscaAvancadaOpen} onOpenChange={setBuscaAvancadaOpen}>\n        <DialogContent data-testid=\"dialog-busca-avancada\">\n          <DialogHeader>\n            <DialogTitle>Busca Avançada por Período</DialogTitle>\n            <DialogDescription>\n              Busque XMLs específicos em um intervalo de NSU. Limite: <strong>20 consultas por hora</strong> (NT 2014.002)\n            </DialogDescription>\n          </DialogHeader>\n\n          {empresaSelecionada && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Empresa</Label>\n                <div className=\"text-sm text-muted-foreground\">\n                  {empresaSelecionada.razaoSocial} - {formatCNPJ(empresaSelecionada.cnpj)}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  Último NSU: <span className=\"font-mono\">{empresaSelecionada.ultimoNSU}</span>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"nsu-inicial\">NSU Inicial</Label>\n                  <Input\n                    id=\"nsu-inicial\"\n                    placeholder=\"Ex: 131950\"\n                    value={nsuInicial}\n                    onChange={(e) => setNsuInicial(e.target.value)}\n                    data-testid=\"input-nsu-inicial\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"nsu-final\">NSU Final</Label>\n                  <Input\n                    id=\"nsu-final\"\n                    placeholder=\"Ex: 131960\"\n                    value={nsuFinal}\n                    onChange={(e) => setNsuFinal(e.target.value)}\n                    data-testid=\"input-nsu-final\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"max-consultas\">Máximo de Consultas</Label>\n                <Input\n                  id=\"max-consultas\"\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"20\"\n                  placeholder=\"Máx: 20\"\n                  value={maxConsultas}\n                  onChange={(e) => setMaxConsultas(e.target.value)}\n                  data-testid=\"input-max-consultas\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Limite de 20 consultas por hora por empresa (SEFAZ)\n                </p>\n              </div>\n\n              <div className=\"rounded-md bg-amber-50 dark:bg-amber-950/20 p-3 border border-amber-200 dark:border-amber-900\">\n                <p className=\"text-xs text-amber-800 dark:text-amber-200\">\n                  <strong>Atenção:</strong> Cada NSU no intervalo conta como 1 consulta.\n                  O intervalo {nsuInicial && nsuFinal ? `(${nsuFinal} - ${nsuInicial} = ${parseInt(nsuFinal || \"0\") - parseInt(nsuInicial || \"0\") + 1})` : \"\"} não pode exceder {maxConsultas} NSUs.\n                </p>\n              </div>\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setBuscaAvancadaOpen(false);\n                setNsuInicial(\"\");\n                setNsuFinal(\"\");\n                setMaxConsultas(\"20\");\n                setEmpresaSelecionada(null);\n              }}\n              data-testid=\"button-cancel-busca\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={() => {\n                if (!empresaSelecionada) return;\n                \n                // Validação NSU inicial e final\n                const nsuInicialTrim = nsuInicial.trim();\n                const nsuFinalTrim = nsuFinal.trim();\n                \n                if (!nsuInicialTrim || !nsuFinalTrim) {\n                  toast({\n                    title: \"Campos obrigatórios\",\n                    description: \"Preencha NSU inicial e NSU final\",\n                    variant: \"destructive\",\n                  });\n                  return;\n                }\n\n                // Validação numérica\n                const nsuInicialNum = parseInt(nsuInicialTrim);\n                const nsuFinalNum = parseInt(nsuFinalTrim);\n                \n                if (isNaN(nsuInicialNum) || isNaN(nsuFinalNum)) {\n                  toast({\n                    title: \"NSU inválido\",\n                    description: \"NSU deve ser um número válido\",\n                    variant: \"destructive\",\n                  });\n                  return;\n                }\n\n                if (nsuInicialNum >= nsuFinalNum) {\n                  toast({\n                    title: \"Intervalo inválido\",\n                    description: \"NSU inicial deve ser menor que NSU final\",\n                    variant: \"destructive\",\n                  });\n                  return;\n                }\n\n                // Validação maxConsultas\n                const consultas = parseInt(maxConsultas);\n                if (isNaN(consultas) || consultas < 1 || consultas > 20) {\n                  toast({\n                    title: \"Limite inválido\",\n                    description: \"Máximo de consultas deve estar entre 1 e 20\",\n                    variant: \"destructive\",\n                  });\n                  return;\n                }\n\n                // Validação de intervalo vs maxConsultas\n                const totalNSUs = nsuFinalNum - nsuInicialNum + 1;\n                if (totalNSUs > consultas) {\n                  toast({\n                    title: \"Intervalo muito grande\",\n                    description: `Intervalo de ${totalNSUs} NSUs excede o limite de ${consultas} consultas`,\n                    variant: \"destructive\",\n                  });\n                  return;\n                }\n\n                buscarPorPeriodoMutation.mutate({\n                  id: empresaSelecionada.id,\n                  nsuInicial: nsuInicialTrim,\n                  nsuFinal: nsuFinalTrim,\n                  maxConsultas: consultas,\n                });\n              }}\n              disabled={buscarPorPeriodoMutation.isPending}\n              data-testid=\"button-executar-busca\"\n            >\n              {buscarPorPeriodoMutation.isPending ? \"Buscando...\" : \"Buscar XMLs\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":23314},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { sefazService } from \"./sefaz-service\";\nimport { xmlDownloadService } from \"./xml-download-service\";\nimport { authenticateUser } from \"./auth-middleware\";\nimport authRoutes from \"./auth-routes\";\nimport multer from \"multer\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\nimport cron from \"node-cron\";\nimport { z } from \"zod\";\nimport { insertEmpresaSchema, uploadCertificadoSchema } from \"@shared/schema\";\nimport { xmlStorageService } from \"./xml-storage\";\n\n// Configuração do multer para upload de certificados\nconst certificadosDir = path.join(process.cwd(), \"certificados\");\nfs.mkdir(certificadosDir, { recursive: true }).catch(console.error);\n\nconst upload = multer({\n  storage: multer.diskStorage({\n    destination: certificadosDir,\n    filename: (req, file, cb) => {\n      const uniqueSuffix = Date.now() + \"-\" + Math.round(Math.random() * 1e9);\n      cb(null, `cert-${uniqueSuffix}${path.extname(file.originalname)}`);\n    },\n  }),\n  fileFilter: (req, file, cb) => {\n    if (file.originalname.endsWith(\".pfx\") || file.originalname.endsWith(\".p12\")) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Apenas arquivos .pfx ou .p12 são permitidos\"));\n    }\n  },\n  limits: {\n    fileSize: 5 * 1024 * 1024, // 5MB\n  },\n});\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // ========== HEALTH CHECK ========== (público)\n  app.get(\"/api/health\", (req, res) => {\n    res.status(200).json({ status: \"ok\", timestamp: new Date().toISOString() });\n  });\n\n  // ========== DEBUG BLOQUEIO ========== (temporário - remover em produção)\n  app.get(\"/api/debug/bloqueio\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresas = await storage.getEmpresas(userId);\n      const { estaBloqueado, calcularMinutosRestantes, formatarDataBrasilCompleta } = await import(\"./utils/timezone\");\n      \n      const debug = empresas.map(emp => ({\n        id: emp.id,\n        razaoSocial: emp.razaoSocial,\n        bloqueadoAte: emp.bloqueadoAte,\n        bloqueadoAteISO: emp.bloqueadoAte ? emp.bloqueadoAte.toISOString() : null,\n        horaAtual: new Date().toISOString(),\n        bloqueado: estaBloqueado(emp.bloqueadoAte),\n        minutosRestantes: emp.bloqueadoAte ? calcularMinutosRestantes(emp.bloqueadoAte) : null,\n        horarioBR: emp.bloqueadoAte ? formatarDataBrasilCompleta(emp.bloqueadoAte) : null,\n      }));\n      \n      res.json(debug);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // Endpoint para testar geração de XML de manifestação (DEBUG)\n  app.post(\"/api/debug/test-manifestacao\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresas = await storage.getEmpresas(userId);\n      if (!empresas || empresas.length === 0) {\n        return res.status(404).json({ error: \"Nenhuma empresa cadastrada\" });\n      }\n      \n      const empresa = empresas[0];\n      \n      // Pega primeiro XML pendente de manifestação\n      const xmlsPendentes = await storage.getXmlsByStatus(empresa.id, \"aguardando_manifestacao\");\n      if (!xmlsPendentes || xmlsPendentes.length === 0) {\n        return res.status(404).json({ error: \"Nenhum XML pendente de manifestação\" });\n      }\n      \n      const chaveNFe = xmlsPendentes[0].chaveNfe;\n      \n      // Gera envelope SOAP de manifestação\n      const envelope = await (sefazService as any).buildSOAPEnvelopeManifestacao(\n        empresa,\n        chaveNFe,\n        \"210210\",\n        null,\n        1\n      );\n      \n      // Salva XML em arquivo temporário\n      const xmlFilePath = path.join(process.cwd(), \"debug-manifestacao.xml\");\n      await fs.writeFile(xmlFilePath, envelope, \"utf-8\");\n      \n      res.json({\n        success: true,\n        message: \"XML salvo em debug-manifestacao.xml\",\n        chaveNFe,\n        xmlPath: xmlFilePath,\n        xmlPreview: envelope.substring(0, 1000) + \"...\"\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Endpoint para desbloquear empresa manualmente (DEBUG - remover em produção)\n  app.post(\"/api/debug/desbloquear/:empresaId\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    const empresaId = req.params.empresaId;\n    \n    try {\n      const empresa = await storage.getEmpresa(empresaId, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      await storage.updateEmpresa(empresaId, { bloqueadoAte: null }, userId);\n      \n      await storage.createLog({\n        userId,\n        empresaId,\n        sincronizacaoId: null,\n        nivel: \"info\",\n        mensagem: `Bloqueio removido manualmente via endpoint debug`,\n        detalhes: JSON.stringify({ \n          empresa: empresa.razaoSocial,\n          bloqueioAnterior: empresa.bloqueadoAte?.toISOString()\n        }),\n      });\n\n      res.json({ \n        success: true, \n        mensagem: \"Bloqueio removido com sucesso\",\n        empresa: empresa.razaoSocial\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // Endpoint para resetar rate limit (DEV ONLY - facilitar testes)\n  app.post(\"/api/dev/reset-rate-limit/:empresaId\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    const empresaId = req.params.empresaId;\n    \n    try {\n      const empresa = await storage.getEmpresa(empresaId, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      // Resetar rate limits\n      await storage.resetRateLimit(empresaId);\n      \n      await storage.createLog({\n        userId,\n        empresaId,\n        sincronizacaoId: null,\n        nivel: \"info\",\n        mensagem: `Rate limit resetado manualmente (DEV)`,\n        detalhes: JSON.stringify({ \n          empresa: empresa.razaoSocial,\n          timestamp: new Date().toISOString()\n        }),\n      });\n\n      res.json({ \n        success: true, \n        mensagem: \"Rate limit resetado com sucesso. Próximo ciclo poderá executar manifestações/downloads.\",\n        empresa: empresa.razaoSocial\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== AUTENTICAÇÃO ==========\n  app.use(\"/api/auth\", authRoutes);\n\n  // ========== DASHBOARD ========== (protegida)\n  app.get(\"/api/dashboard/stats\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresas = await storage.getEmpresas(userId);\n      const empresasAtivas = await storage.getEmpresasAtivas(userId);\n      const xmlsHoje = await storage.getXmlsHoje(userId);\n      const sincronizacoesEmAndamento = await storage.getSincronizacoesEmAndamento(userId);\n      \n      const sincronizacoes = await storage.getSincronizacoes(userId);\n      const ultimaSincronizacao = sincronizacoes.length > 0\n        ? sincronizacoes[0].dataFim || sincronizacoes[0].dataInicio\n        : null;\n\n      res.json({\n        totalEmpresas: empresas.length,\n        empresasAtivas: empresasAtivas.length,\n        xmlsHoje,\n        ultimaSincronizacao,\n        sincronizacoesEmAndamento: sincronizacoesEmAndamento.length,\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.get(\"/api/dashboard/recent-xmls\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const xmls = await storage.getXmlsRecentes(5, userId);\n      const empresas = await storage.getEmpresas(userId);\n      const empresasMap = new Map(empresas.map((e) => [e.id, e]));\n\n      const result = xmls.map((xml) => {\n        const empresa = empresasMap.get(xml.empresaId);\n        return {\n          id: xml.id,\n          empresaCnpj: empresa?.cnpj || \"\",\n          empresaNome: empresa?.razaoSocial || \"\",\n          numeroNF: xml.numeroNF,\n          dataEmissao: xml.dataEmissao,\n          createdAt: xml.createdAt,\n        };\n      });\n\n      res.json(result);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.get(\"/api/dashboard/recent-logs\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const logs = await storage.getLogsRecentes(5, userId);\n      const empresas = await storage.getEmpresas(userId);\n      const empresasMap = new Map(empresas.map((e) => [e.id, e]));\n\n      const result = logs.map((log) => ({\n        ...log,\n        empresaNome: log.empresaId ? empresasMap.get(log.empresaId)?.razaoSocial : undefined,\n      }));\n\n      res.json(result);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== EMPRESAS ========== (protegidas)\n  app.get(\"/api/empresas\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresas = await storage.getEmpresas(userId);\n      res.json(empresas);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.get(\"/api/empresas/:id\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresa = await storage.getEmpresa(req.params.id, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n      res.json(empresa);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.post(\"/api/empresas\", authenticateUser, upload.single(\"certificado\"), async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"Certificado digital é obrigatório\" });\n      }\n\n      const data = uploadCertificadoSchema.parse({\n        cnpj: req.body.cnpj,\n        razaoSocial: req.body.razaoSocial,\n        uf: req.body.uf,\n        ambiente: req.body.ambiente,\n        certificadoSenha: req.body.certificadoSenha,\n        tipoArmazenamento: req.body.tipoArmazenamento,\n        manifestacaoAutomatica: req.body.manifestacaoAutomatica,\n      });\n\n      // ===== VALIDAR CERTIFICADO E SENHA =====\n      const { validateCertificate } = await import(\"./cert-loader\");\n      const validation = await validateCertificate(req.file.path, data.certificadoSenha);\n      \n      if (!validation.valid) {\n        // Remove arquivo enviado\n        await fs.unlink(req.file.path);\n        \n        // Retornar erro específico\n        if (validation.error?.includes('Senha do certificado incorreta')) {\n          return res.status(400).json({ \n            error: \"Senha do certificado incorreta. Verifique a senha e tente novamente.\" \n          });\n        } else if (validation.error?.includes('Arquivo de certificado não encontrado')) {\n          return res.status(400).json({ \n            error: \"Erro ao processar o arquivo do certificado. Tente fazer upload novamente.\" \n          });\n        } else if (validation.isExpired) {\n          const now = new Date();\n          const notBefore = validation.notBefore || new Date();\n          const notAfter = validation.notAfter || new Date();\n          \n          if (now < notBefore) {\n            // Certificado ainda não é válido\n            return res.status(400).json({ \n              error: `Certificado ainda não é válido. Será válido a partir de ${notBefore.toLocaleDateString('pt-BR')}.` \n            });\n          } else {\n            // Certificado expirado\n            return res.status(400).json({ \n              error: `Certificado expirado em ${notAfter.toLocaleDateString('pt-BR')}. Renove seu certificado digital.` \n            });\n          }\n        } else {\n          return res.status(400).json({ \n            error: validation.error || \"Certificado inválido. Verifique o arquivo e a senha.\" \n          });\n        }\n      }\n\n      // Avisar se certificado está próximo de expirar (menos de 30 dias)\n      if (validation.daysUntilExpiry && validation.daysUntilExpiry < 30 && validation.daysUntilExpiry > 0) {\n        console.warn(`⚠️ Certificado expira em ${validation.daysUntilExpiry} dias (${data.cnpj})`);\n      }\n\n      // Verifica se CNPJ já existe para este usuário\n      const existing = await storage.getEmpresaByCNPJ(data.cnpj, userId);\n      if (existing) {\n        // Remove arquivo enviado\n        await fs.unlink(req.file.path);\n        return res.status(400).json({ error: \"CNPJ já cadastrado\" });\n      }\n\n      const empresa = await storage.createEmpresa({\n        ...data,\n        userId,\n        certificadoPath: req.file.path,\n        ativo: true,\n      });\n\n      await storage.createLog({\n        userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"info\",\n        mensagem: `Empresa cadastrada: ${empresa.razaoSocial}`,\n        detalhes: JSON.stringify({ \n          cnpj: empresa.cnpj, \n          uf: empresa.uf,\n          certificadoValido: `${validation.notBefore?.toLocaleDateString('pt-BR')} até ${validation.notAfter?.toLocaleDateString('pt-BR')}`,\n          diasRestantes: validation.daysUntilExpiry\n        }),\n      });\n\n      res.status(201).json(empresa);\n    } catch (error) {\n      // Remove arquivo em caso de erro\n      if (req.file) {\n        await fs.unlink(req.file.path).catch(console.error);\n      }\n\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.patch(\"/api/empresas/:id\", authenticateUser, upload.single(\"certificado\"), async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const { updateEmpresaSchema } = await import(\"@shared/schema\");\n      \n      // Validar dados de atualização\n      const updates = updateEmpresaSchema.parse({\n        razaoSocial: req.body.razaoSocial,\n        uf: req.body.uf,\n        ambiente: req.body.ambiente,\n        certificadoSenha: req.body.certificadoSenha,\n        tipoArmazenamento: req.body.tipoArmazenamento,\n        manifestacaoAutomatica: req.body.manifestacaoAutomatica === \"true\",\n        ativo: req.body.ativo === \"true\",\n      });\n\n      // Buscar empresa existente\n      const empresaExistente = await storage.getEmpresa(req.params.id, userId);\n      if (!empresaExistente) {\n        if (req.file) {\n          await fs.unlink(req.file.path).catch(console.error);\n        }\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      const updateData: any = { ...updates };\n\n      // Se novo certificado foi enviado, validar e atualizar\n      if (req.file) {\n        const { validateCertificate } = await import(\"./cert-loader\");\n        const senha = updates.certificadoSenha || empresaExistente.certificadoSenha;\n        const validation = await validateCertificate(req.file.path, senha);\n        \n        if (!validation.valid) {\n          await fs.unlink(req.file.path);\n          \n          if (validation.error?.includes('Senha do certificado incorreta')) {\n            return res.status(400).json({ \n              error: \"Senha do certificado incorreta. Verifique a senha e tente novamente.\" \n            });\n          } else if (validation.isExpired) {\n            const notAfter = validation.notAfter || new Date();\n            return res.status(400).json({ \n              error: `Certificado expirado em ${notAfter.toLocaleDateString('pt-BR')}. Renove seu certificado digital.` \n            });\n          } else {\n            return res.status(400).json({ \n              error: validation.error || \"Certificado inválido. Verifique o arquivo e a senha.\" \n            });\n          }\n        }\n\n        // Remover certificado antigo\n        try {\n          await fs.unlink(empresaExistente.certificadoPath);\n        } catch (error) {\n          console.error(\"Erro ao remover certificado antigo:\", error);\n        }\n\n        updateData.certificadoPath = req.file.path;\n      }\n\n      const empresa = await storage.updateEmpresa(req.params.id, updateData, userId);\n      \n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      await storage.createLog({\n        userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"info\",\n        mensagem: `Empresa atualizada: ${empresa.razaoSocial}`,\n        detalhes: JSON.stringify({ \n          cnpj: empresa.cnpj,\n          alteracoes: Object.keys(updates)\n        }),\n      });\n\n      res.json(empresa);\n    } catch (error) {\n      if (req.file) {\n        await fs.unlink(req.file.path).catch(console.error);\n      }\n\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.delete(\"/api/empresas/:id\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresa = await storage.getEmpresa(req.params.id, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      // Remove certificado\n      try {\n        await fs.unlink(empresa.certificadoPath);\n      } catch (error) {\n        console.error(\"Erro ao remover certificado:\", error);\n      }\n\n      const deleted = await storage.deleteEmpresa(req.params.id, userId);\n      \n      if (deleted) {\n        await storage.createLog({\n          userId,\n          empresaId: null,\n          sincronizacaoId: null,\n          nivel: \"info\",\n          mensagem: `Empresa removida: ${empresa.razaoSocial}`,\n          detalhes: JSON.stringify({ cnpj: empresa.cnpj }),\n        });\n      }\n\n      res.json({ success: deleted });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.post(\"/api/empresas/:id/sincronizar\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresa = await storage.getEmpresa(req.params.id, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      // Executa sincronização de forma assíncrona\n      sefazService.sincronizarEmpresa(empresa).catch(console.error);\n\n      res.json({ message: \"Sincronização iniciada\" });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.post(\"/api/empresas/:id/reconciliar-nsu\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresa = await storage.getEmpresa(req.params.id, userId);\n      \n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      // Executa reconciliação\n      const resultado = await sefazService.reconciliarUltimoNSU(empresa);\n      \n      res.json({\n        success: true,\n        nsuAnterior: empresa.ultimoNSU,\n        nsuAtual: resultado.nsuFinal,\n        chamadas: resultado.chamadas,\n        intervalo: resultado.intervalo,\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.post(\"/api/empresas/:id/buscar-periodo\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const empresa = await storage.getEmpresa(req.params.id, userId);\n      \n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      // Validação com Zod (coerção automática de tipos)\n      const schema = z.object({\n        nsuInicial: z.string().trim().regex(/^[0-9]{1,15}$/, \"NSU inicial deve conter apenas números (máx 15 dígitos)\"),\n        nsuFinal: z.string().trim().regex(/^[0-9]{1,15}$/, \"NSU final deve conter apenas números (máx 15 dígitos)\"),\n        maxConsultas: z.coerce.number().int().min(1).max(20).default(20),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Dados inválidos\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { nsuInicial, nsuFinal, maxConsultas } = validationResult.data;\n\n      // Executa busca por período (limite de 20 é garantido pela validação Zod)\n      const resultado = await sefazService.buscarPorPeriodo(\n        empresa,\n        nsuInicial,\n        nsuFinal,\n        maxConsultas\n      );\n      \n      res.json({\n        success: true,\n        xmlsEncontrados: resultado.xmlsEncontrados,\n        consultasRealizadas: resultado.consultasRealizadas,\n        nsuConsultados: resultado.nsuConsultados,\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n\n  // ========== XMLs ========== (protegidos)\n  app.get(\"/api/xmls\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const xmls = await storage.getXmls(userId);\n      const empresas = await storage.getEmpresas(userId);\n      const manifestacoes = await storage.getManifestacoes(userId);\n      \n      const empresasMap = new Map(empresas.map((e) => [e.id, e]));\n      const manifestacoesMap = new Map(manifestacoes.map((m) => [m.chaveNFe, m]));\n\n      const result = xmls.map((xml) => {\n        const empresa = empresasMap.get(xml.empresaId);\n        const manifestacao = manifestacoesMap.get(xml.chaveNFe);\n        \n        return {\n          ...xml,\n          empresaCnpj: empresa?.cnpj || \"\",\n          empresaNome: empresa?.razaoSocial || \"\",\n          manifestacao: manifestacao ? {\n            id: manifestacao.id,\n            tipoEvento: manifestacao.tipoEvento,\n            status: manifestacao.status,\n            dataManifestacao: manifestacao.dataManifestacao,\n          } : null,\n        };\n      });\n\n      res.json(result);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.get(\"/api/xmls/:id/download\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const xml = await storage.getXml(req.params.id, userId);\n      if (!xml) {\n        return res.status(404).json({ error: \"XML não encontrado\" });\n      }\n\n      // Busca empresa para saber o tipo de armazenamento\n      const empresa = await storage.getEmpresa(xml.empresaId, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n\n      // Extrai caminho relativo do caminhoArquivo\n      // Suporta diferentes formatos para backward compatibility:\n      // - Novo (relativo): \"xmls/NFe/12345678000100/2025/11/12345.xml\"\n      // - Local antigo: \"./xmls/NFe/12345678000100/2025/11/12345.xml\"\n      // - Absoluto antigo: \"/home/runner/project/xmls/NFe/12345678000100/2025/11/12345.xml\"\n      // - Supabase: \"supabase://xmls/NFe/12345678000100/2025/11/12345.xml\"\n      let relativePath = xml.caminhoArquivo;\n      \n      // Se for caminho do Supabase (com protocolo)\n      if (relativePath.startsWith(\"supabase://xmls/\")) {\n        relativePath = relativePath.substring(\"supabase://xmls/\".length);\n      }\n      // Se for caminho local (relativo ou absoluto)\n      else {\n        // Remove prefixo \"./xmls/\" se existir\n        if (relativePath.startsWith(\"./xmls/\")) {\n          relativePath = relativePath.substring(\"./xmls/\".length);\n        }\n        // Remove \"xmls/\" se for o início (caso já seja relativo limpo)\n        else if (relativePath.startsWith(\"xmls/\")) {\n          relativePath = relativePath.substring(\"xmls/\".length);\n        }\n        // Se for caminho absoluto, extrai apenas a parte após \"/xmls/\"\n        else if (relativePath.includes(\"/xmls/\")) {\n          const idx = relativePath.lastIndexOf(\"/xmls/\");\n          relativePath = relativePath.substring(idx + \"/xmls/\".length);\n        }\n        // Se ainda for um caminho absoluto sem \"/xmls/\" (caso extremo), usa direto com res.download\n        else if (path.isAbsolute(relativePath)) {\n          // Backward compatibility: se for caminho absoluto antigo, usa res.download diretamente\n          return res.download(relativePath);\n        }\n      }\n\n      // Recupera XML usando storage híbrido\n      const xmlContent = await xmlStorageService.getXml(empresa.tipoArmazenamento, relativePath);\n\n      // Envia XML com headers apropriados\n      const filename = path.basename(relativePath);\n      res.setHeader(\"Content-Type\", \"application/xml\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(xmlContent);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== LOGS ========== (protegidos)\n  app.get(\"/api/logs\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const logs = await storage.getLogs(userId);\n      const empresas = await storage.getEmpresas(userId);\n      const empresasMap = new Map(empresas.map((e) => [e.id, e]));\n\n      const result = logs.map((log) => ({\n        ...log,\n        empresaNome: log.empresaId ? empresasMap.get(log.empresaId)?.razaoSocial : undefined,\n      }));\n\n      res.json(result);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // Endpoint temporário para limpar logs técnicos de lock\n  app.delete(\"/api/logs/cleanup-lock-logs\", authenticateUser, async (req, res) => {\n    try {\n      await storage.deleteLockLogs();\n      res.json({ message: \"Logs de lock removidos com sucesso\" });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // Endpoint de debug para verificar XMLs com erro\n  app.get(\"/api/debug/xmls-status\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const xmlsComErro = await storage.getXmlsComErroDefinitivo(userId);\n      const xmlsPendentes = await storage.getXmlsPendentesDownload(userId, 10);\n      const xmlsRetry = await storage.getXmlsComErroDownload(userId, 10);\n\n      res.json({\n        erros: xmlsComErro.map(x => ({\n          chave: x.chaveNFe,\n          tipo: x.tipoDocumento,\n          tentativas: x.tentativasDownload,\n          erro: x.erroDownload\n        })),\n        pendentes: xmlsPendentes.map(x => ({\n          chave: x.chaveNFe,\n          tentativas: x.tentativasDownload\n        })),\n        retry: xmlsRetry.map(x => ({\n          chave: x.chaveNFe,\n          tentativas: x.tentativasDownload,\n          erro: x.erroDownload\n        }))\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== SINCRONIZAÇÕES ========== (protegidas)\n  app.get(\"/api/sincronizacoes\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const sincronizacoes = await storage.getSincronizacoes(userId);\n      res.json(sincronizacoes);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.post(\"/api/sincronizacoes/executar\", authenticateUser, async (req, res) => {\n    try {\n      // Executa sincronização de todas as empresas de forma assíncrona\n      sefazService.sincronizarTodasEmpresas().catch(console.error);\n      \n      res.json({ message: \"Sincronização de todas as empresas iniciada\" });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== MANIFESTAÇÕES DO DESTINATÁRIO (NT 2020.001) ========== (protegidas)\n  app.get(\"/api/manifestacoes\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const { empresaId, status } = req.query;\n      \n      let manifestacoes;\n      if (empresaId) {\n        manifestacoes = await storage.getManifestacoesByEmpresa(empresaId as string, userId);\n      } else {\n        manifestacoes = await storage.getManifestacoes(userId);\n      }\n      \n      // Filtro adicional por status se fornecido\n      if (status && typeof status === \"string\") {\n        manifestacoes = manifestacoes.filter(m => m.status === status);\n      }\n      \n      res.json(manifestacoes);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  app.post(\"/api/manifestacoes/manifestar\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const { empresaId, chaveNFe, tipoEvento, justificativa } = req.body;\n      \n      // Validação básica\n      if (!empresaId || !chaveNFe || !tipoEvento) {\n        return res.status(400).json({ \n          error: \"empresaId, chaveNFe e tipoEvento são obrigatórios\" \n        });\n      }\n      \n      // Valida tipo de evento\n      const tiposValidos = [\"210200\", \"210210\", \"210220\", \"210240\"];\n      if (!tiposValidos.includes(tipoEvento)) {\n        return res.status(400).json({ \n          error: `tipoEvento inválido. Valores aceitos: ${tiposValidos.join(\", \")}` \n        });\n      }\n      \n      // Valida justificativa obrigatória para 210240\n      if (tipoEvento === \"210240\" && !justificativa) {\n        return res.status(400).json({ \n          error: \"Justificativa é obrigatória para Operação Não Realizada (210240)\" \n        });\n      }\n      \n      // Busca empresa\n      const empresa = await storage.getEmpresa(empresaId, userId);\n      if (!empresa) {\n        return res.status(404).json({ error: \"Empresa não encontrada\" });\n      }\n      \n      // Dispara manifestação via SefazService\n      const manifestacao = await sefazService.manifestarEvento(\n        empresa,\n        chaveNFe,\n        tipoEvento,\n        justificativa\n      );\n      \n      res.json({ \n        success: true, \n        manifestacao,\n        message: \"Manifestação enviada com sucesso\" \n      });\n    } catch (error) {\n      console.error(\"Erro ao manifestar:\", error);\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== CONFIGURAÇÕES ==========\n  \n  app.get(\"/api/configuracoes\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      let config = await storage.getConfiguracao(userId);\n      \n      // Se não existe, cria com valores padrão\n      if (!config) {\n        config = await storage.createConfiguracao({ userId });\n      }\n      \n      res.json(config);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n  \n  app.put(\"/api/configuracoes\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      console.log(\"[PUT /api/configuracoes] Request body:\", JSON.stringify(req.body));\n      const { updateConfiguracaoSchema } = await import(\"@shared/schema\");\n      const updates = updateConfiguracaoSchema.parse(req.body);\n      console.log(\"[PUT /api/configuracoes] Parsed updates:\", JSON.stringify(updates));\n      \n      // Verifica se existe configuração\n      let config = await storage.getConfiguracao(userId);\n      console.log(\"[PUT /api/configuracoes] Existing config:\", config ? \"found\" : \"not found\");\n      \n      if (!config) {\n        // Cria se não existir\n        console.log(\"[PUT /api/configuracoes] Creating new config\");\n        config = await storage.createConfiguracao({ userId, ...updates });\n      } else {\n        // Atualiza se existir\n        console.log(\"[PUT /api/configuracoes] Updating existing config\");\n        config = await storage.updateConfiguracao(userId, updates);\n      }\n      \n      console.log(\"[PUT /api/configuracoes] Success\");\n      res.json(config);\n    } catch (error) {\n      console.error(\"[PUT /api/configuracoes] Error:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      res.status(500).json({ error: String(error), stack: error instanceof Error ? error.stack : undefined });\n    }\n  });\n\n  // ========== DOWNLOADS AUTOMÁTICOS ========== (protegidos)\n  \n  // GET /api/xmls/downloads/pendentes - Lista XMLs pendentes de download\n  app.get(\"/api/xmls/downloads/pendentes\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const xmls = await storage.getXmlsPendentesDownload(userId, 100);\n      res.json(xmls);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // GET /api/xmls/downloads/erros - Lista XMLs com erro definitivo\n  app.get(\"/api/xmls/downloads/erros\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const xmls = await storage.getXmlsComErroDefinitivo(userId, 100);\n      res.json(xmls);\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // POST /api/xmls/downloads/processar - Processa downloads pendentes manualmente\n  app.post(\"/api/xmls/downloads/processar\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    try {\n      const { empresaId } = req.body;\n      \n      if (!empresaId) {\n        return res.status(400).json({ error: \"empresaId é obrigatório\" });\n      }\n\n      // Processa downloads da empresa específica\n      const resultado = await xmlDownloadService.processarDownloadsEmpresa(empresaId, userId);\n      \n      res.json({\n        message: \"Processamento concluído\",\n        ...resultado\n      });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // POST /api/xmls/downloads/retry/:id - Força retry de um XML específico\n  app.post(\"/api/xmls/downloads/retry/:id\", authenticateUser, async (req, res) => {\n    const userId = req.user!.id;\n    const { id } = req.params;\n    \n    try {\n      // Reseta status para pendente com tentativas zeradas\n      const xml = await storage.updateXml(id, {\n        statusDownload: \"pendente\",\n        tentativasDownload: 0,\n        erroDownload: undefined,\n      }, userId);\n\n      if (!xml) {\n        return res.status(404).json({ error: \"XML não encontrado\" });\n      }\n\n      res.json({ message: \"XML marcado para retry\", xml });\n    } catch (error) {\n      res.status(500).json({ error: String(error) });\n    }\n  });\n\n  // ========== AGENDAMENTO AUTOMÁTICO ==========\n  \n  // Sincronização SEFAZ - Executa a cada 1 hora\n  cron.schedule(\"0 * * * *\", async () => {\n    console.log(\"Executando sincronização agendada...\");\n    try {\n      await sefazService.sincronizarTodasEmpresas();\n    } catch (error) {\n      console.error(\"Erro na sincronização agendada:\", error);\n    }\n  });\n\n  // Download automático de XMLs - Executa a cada 5 minutos\n  cron.schedule(\"*/5 * * * *\", async () => {\n    console.log(\"[Cron] Executando processamento de downloads pendentes...\");\n    try {\n      await xmlDownloadService.processarDownloadsPendentes();\n    } catch (error) {\n      console.error(\"[Cron] Erro no processamento de downloads:\", error);\n    }\n  });\n\n  console.log(\"✓ Agendamento configurado:\");\n  console.log(\"  - Sincronização SEFAZ: a cada 1 hora\");\n  console.log(\"  - Download de XMLs: a cada 5 minutos\");\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":34927},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/pages/configuracoes.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Settings, Clock, Bell, Shield } from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useState, useEffect } from \"react\";\nimport type { Configuracao } from \"@shared/schema\";\n\nexport default function Configuracoes() {\n  const { toast } = useToast();\n  \n  const { data: config, isLoading } = useQuery<Configuracao>({\n    queryKey: [\"/api/configuracoes\"],\n  });\n\n  const [formData, setFormData] = useState({\n    intervaloSincronizacao: \"1h\" as const,\n    sincronizacaoAutomatica: true,\n    sincronizarAoIniciar: true,\n    retryAutomatico: true,\n    maxRetries: 3,\n    timeoutRequisicao: 60,\n    validarSSL: true,\n    logsDetalhados: false,\n    notificarNovosXmls: true,\n    notificarErros: true,\n    relatorioDiario: false,\n    emailNotificacoes: \"\",\n  });\n\n  useEffect(() => {\n    if (config) {\n      setFormData({\n        intervaloSincronizacao: config.intervaloSincronizacao as any,\n        sincronizacaoAutomatica: config.sincronizacaoAutomatica,\n        sincronizarAoIniciar: config.sincronizarAoIniciar,\n        retryAutomatico: config.retryAutomatico,\n        maxRetries: config.maxRetries,\n        timeoutRequisicao: config.timeoutRequisicao,\n        validarSSL: config.validarSSL,\n        logsDetalhados: config.logsDetalhados,\n        notificarNovosXmls: config.notificarNovosXmls,\n        notificarErros: config.notificarErros,\n        relatorioDiario: config.relatorioDiario,\n        emailNotificacoes: config.emailNotificacoes || \"\",\n      });\n    }\n  }, [config]);\n\n  const saveMutation = useMutation({\n    mutationFn: () =>\n      apiRequest(\"/api/configuracoes\", {\n        method: \"PUT\",\n        body: JSON.stringify(formData),\n        headers: { \"Content-Type\": \"application/json\" },\n      }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/configuracoes\"] });\n      toast({\n        title: \"Configurações salvas!\",\n        description: \"As configurações foram atualizadas com sucesso.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao salvar\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetMutation = useMutation({\n    mutationFn: () =>\n      apiRequest(\"/api/configuracoes\", {\n        method: \"PUT\",\n        body: JSON.stringify({\n          intervaloSincronizacao: \"1h\",\n          sincronizacaoAutomatica: true,\n          sincronizarAoIniciar: true,\n          retryAutomatico: true,\n          maxRetries: 3,\n          timeoutRequisicao: 60,\n          validarSSL: true,\n          logsDetalhados: false,\n          notificarNovosXmls: true,\n          notificarErros: true,\n          relatorioDiario: false,\n          emailNotificacoes: \"\",\n        }),\n        headers: { \"Content-Type\": \"application/json\" },\n      }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/configuracoes\"] });\n      toast({\n        title: \"Configurações restauradas!\",\n        description: \"As configurações foram restauradas para os valores padrão.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao restaurar\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <p className=\"text-muted-foreground\">Carregando configurações...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 max-w-4xl\">\n      <div>\n        <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-configuracoes\">Configurações</h1>\n        <p className=\"text-sm text-muted-foreground\">Gerencie as configurações do sistema</p>\n      </div>\n\n      <Tabs defaultValue=\"geral\" className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"geral\" data-testid=\"tab-geral\">\n            <Settings className=\"w-4 h-4 mr-2\" />\n            Geral\n          </TabsTrigger>\n          <TabsTrigger value=\"agendamento\" data-testid=\"tab-agendamento\">\n            <Clock className=\"w-4 h-4 mr-2\" />\n            Agendamento\n          </TabsTrigger>\n          <TabsTrigger value=\"notificacoes\" data-testid=\"tab-notificacoes\">\n            <Bell className=\"w-4 h-4 mr-2\" />\n            Notificações\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"geral\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Configurações Gerais</CardTitle>\n              <CardDescription>Preferências básicas do sistema</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Sincronização Automática</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Ativa ou desativa a sincronização automática para todas as empresas\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.sincronizacaoAutomatica}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, sincronizacaoAutomatica: checked })\n                  }\n                  data-testid=\"switch-auto-sync\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Logs Detalhados</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Registra informações detalhadas de debug nos logs\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.logsDetalhados}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, logsDetalhados: checked })\n                  }\n                  data-testid=\"switch-verbose-logs\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">\n                <Shield className=\"w-4 h-4 inline mr-2\" />\n                Segurança\n              </CardTitle>\n              <CardDescription>Configurações de segurança e certificados</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"timeout\">Timeout de Requisição (segundos)</Label>\n                <Input\n                  id=\"timeout\"\n                  type=\"number\"\n                  value={formData.timeoutRequisicao}\n                  onChange={(e) =>\n                    setFormData({ ...formData, timeoutRequisicao: parseInt(e.target.value) })\n                  }\n                  min=\"30\"\n                  max=\"300\"\n                  data-testid=\"input-timeout\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Tempo máximo de espera para requisições à SEFAZ\n                </p>\n              </div>\n\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Validar Certificados SSL</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Verifica a validade dos certificados SSL nas conexões\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.validarSSL}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, validarSSL: checked })\n                  }\n                  data-testid=\"switch-verify-ssl\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"agendamento\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Agendamento de Sincronização</CardTitle>\n              <CardDescription>Configure quando e como a sincronização deve ocorrer</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"interval\">Intervalo de Sincronização</Label>\n                <Select\n                  value={formData.intervaloSincronizacao}\n                  onValueChange={(value: any) =>\n                    setFormData({ ...formData, intervaloSincronizacao: value })\n                  }\n                >\n                  <SelectTrigger id=\"interval\" data-testid=\"select-interval\">\n                    <SelectValue placeholder=\"Selecione o intervalo\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"15m\">A cada 15 minutos</SelectItem>\n                    <SelectItem value=\"30m\">A cada 30 minutos</SelectItem>\n                    <SelectItem value=\"1h\">A cada 1 hora (padrão)</SelectItem>\n                    <SelectItem value=\"2h\">A cada 2 horas</SelectItem>\n                    <SelectItem value=\"6h\">A cada 6 horas</SelectItem>\n                    <SelectItem value=\"12h\">A cada 12 horas</SelectItem>\n                    <SelectItem value=\"24h\">A cada 24 horas</SelectItem>\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\">\n                  Frequência com que o sistema buscará novos XMLs\n                </p>\n              </div>\n\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Sincronizar ao Iniciar</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Executa sincronização imediatamente quando o sistema inicia\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.sincronizarAoIniciar}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, sincronizarAoIniciar: checked })\n                  }\n                  data-testid=\"switch-sync-on-start\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Retry Automático</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Tenta novamente automaticamente em caso de falha\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.retryAutomatico}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, retryAutomatico: checked })\n                  }\n                  data-testid=\"switch-auto-retry\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"max-retries\">Máximo de Tentativas</Label>\n                <Input\n                  id=\"max-retries\"\n                  type=\"number\"\n                  value={formData.maxRetries}\n                  onChange={(e) =>\n                    setFormData({ ...formData, maxRetries: parseInt(e.target.value) })\n                  }\n                  min=\"1\"\n                  max=\"10\"\n                  data-testid=\"input-max-retries\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Número de tentativas em caso de falha\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"notificacoes\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Notificações</CardTitle>\n              <CardDescription>Configure como você deseja ser notificado</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Notificar Novos XMLs</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Receba notificação quando novos XMLs forem baixados\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.notificarNovosXmls}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, notificarNovosXmls: checked })\n                  }\n                  data-testid=\"switch-notify-new-xmls\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Notificar Erros</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Receba notificação quando ocorrerem erros na sincronização\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.notificarErros}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, notificarErros: checked })\n                  }\n                  data-testid=\"switch-notify-errors\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between rounded-lg border p-4\">\n                <div className=\"space-y-0.5\">\n                  <Label>Relatório Diário</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Receba um resumo diário das sincronizações\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.relatorioDiario}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, relatorioDiario: checked })\n                  }\n                  data-testid=\"switch-daily-report\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">E-mail para Notificações</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={formData.emailNotificacoes}\n                  onChange={(e) =>\n                    setFormData({ ...formData, emailNotificacoes: e.target.value })\n                  }\n                  placeholder=\"seu@email.com\"\n                  data-testid=\"input-notification-email\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Endereço de e-mail para receber notificações (futuro)\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <div className=\"flex items-center gap-3\">\n        <Button\n          onClick={() => saveMutation.mutate()}\n          disabled={saveMutation.isPending}\n          data-testid=\"button-save-config\"\n        >\n          {saveMutation.isPending ? \"Salvando...\" : \"Salvar Configurações\"}\n        </Button>\n        <Button\n          variant=\"outline\"\n          onClick={() => resetMutation.mutate()}\n          disabled={resetMutation.isPending}\n          data-testid=\"button-reset-config\"\n        >\n          {resetMutation.isPending ? \"Restaurando...\" : \"Restaurar Padrões\"}\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":16208},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/pages/xmls.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { FileText, Download, Search, FolderOpen, ChevronRight, ChevronDown, CheckCircle2, XCircle, Clock, Ban } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\n\ninterface Xml {\n  id: string;\n  empresaId: string;\n  empresaCnpj: string;\n  empresaNome: string;\n  chaveNFe: string;\n  numeroNF: string;\n  modelo: string;\n  tipoDocumento: string;\n  dataEmissao: string;\n  caminhoArquivo: string;\n  tamanhoBytes: number;\n  createdAt: string;\n  statusDownload?: string;\n  tentativasDownload?: number;\n  erroDownload?: string;\n  statusNfe?: string;\n  manifestacao?: {\n    id: string;\n    tipoEvento: string;\n    status: string;\n    dataManifestacao: string | null;\n  } | null;\n}\n\ninterface Manifestacao {\n  id: string;\n  empresaId: string;\n  chaveNFe: string;\n  tipoEvento: string;\n  status: string;\n  dataManifestacao: string | null;\n}\n\ninterface XmlGroup {\n  cnpj: string;\n  empresaNome: string;\n  anos: {\n    ano: string;\n    meses: {\n      mes: string;\n      xmls: Xml[];\n    }[];\n  }[];\n}\n\nfunction getManifestacaoBadge(xml: Xml) {\n  // Apenas resNFe pode ter manifestação\n  if (xml.tipoDocumento !== \"resNFe\") {\n    return null;\n  }\n\n  const manifestacao = xml.manifestacao;\n\n  if (!manifestacao) {\n    return (\n      <Badge variant=\"outline\" className=\"gap-1 text-xs\">\n        <Clock className=\"w-3 h-3\" />\n        Não Manifestado\n      </Badge>\n    );\n  }\n\n  if (manifestacao.status === \"confirmado\") {\n    return (\n      <Badge variant=\"default\" className=\"gap-1 text-xs\">\n        <CheckCircle2 className=\"w-3 h-3\" />\n        Manifestado\n      </Badge>\n    );\n  }\n\n  if (manifestacao.status === \"erro\") {\n    return (\n      <Badge variant=\"destructive\" className=\"gap-1 text-xs\">\n        <XCircle className=\"w-3 h-3\" />\n        Erro Manifestação\n      </Badge>\n    );\n  }\n\n  if (manifestacao.status === \"pendente\") {\n    return (\n      <Badge variant=\"secondary\" className=\"gap-1 text-xs\">\n        <Clock className=\"w-3 h-3\" />\n        Manifestação Pendente\n      </Badge>\n    );\n  }\n\n  return (\n    <Badge variant=\"secondary\" className=\"gap-1 text-xs\">\n      {manifestacao.status}\n    </Badge>\n  );\n}\n\nfunction getStatusNfeBadge(xml: Xml) {\n  if (xml.statusNfe === \"cancelada\") {\n    return (\n      <Badge variant=\"destructive\" className=\"gap-1 text-xs\">\n        <Ban className=\"w-3 h-3\" />\n        Cancelada\n      </Badge>\n    );\n  }\n  \n  if (xml.statusNfe === \"denegada\") {\n    return (\n      <Badge variant=\"destructive\" className=\"gap-1 text-xs\">\n        <XCircle className=\"w-3 h-3\" />\n        Denegada\n      </Badge>\n    );\n  }\n  \n  return null;\n}\n\nfunction getTipoDocumentoBadge(xml: Xml) {\n  // Não exibe tipo de documento para XMLs cancelados (badge cancelada já informa)\n  if (xml.statusNfe === \"cancelada\" || xml.statusNfe === \"denegada\") {\n    return null;\n  }\n\n  if (xml.tipoDocumento === \"resNFe\") {\n    return (\n      <Badge variant=\"secondary\" className=\"gap-1 text-xs\">\n        <FileText className=\"w-3 h-3\" />\n        Resumo\n      </Badge>\n    );\n  }\n  \n  if (xml.tipoDocumento === \"nfeProc\") {\n    return (\n      <Badge variant=\"default\" className=\"gap-1 text-xs\">\n        <CheckCircle2 className=\"w-3 h-3\" />\n        XML Completo\n      </Badge>\n    );\n  }\n  \n  return null;\n}\n\nfunction getDownloadBadge(xml: Xml) {\n  // Não exibe badge de download para XMLs cancelados ou denegados\n  if (xml.statusNfe === \"cancelada\" || xml.statusNfe === \"denegada\") {\n    return null;\n  }\n\n  // Apenas resNFe pode ter download pendente (nfeProc já está completo)\n  if (xml.tipoDocumento !== \"resNFe\") {\n    return null;\n  }\n\n  if (xml.statusDownload === \"pendente\") {\n    return (\n      <Badge variant=\"outline\" className=\"gap-1 text-xs\">\n        <Clock className=\"w-3 h-3\" />\n        Aguardando Download\n      </Badge>\n    );\n  }\n  \n  if (xml.statusDownload === \"processando\") {\n    return (\n      <Badge variant=\"secondary\" className=\"gap-1 text-xs\">\n        <Download className=\"w-3 h-3\" />\n        Baixando...\n      </Badge>\n    );\n  }\n  \n  if (xml.statusDownload === \"erro\") {\n    return (\n      <Badge variant=\"destructive\" className=\"gap-1 text-xs\" title={xml.erroDownload}>\n        <XCircle className=\"w-3 h-3\" />\n        Erro Download ({xml.tentativasDownload || 0}/5)\n      </Badge>\n    );\n  }\n\n  if (xml.statusDownload === \"completo\") {\n    return (\n      <Badge variant=\"default\" className=\"gap-1 text-xs\">\n        <CheckCircle2 className=\"w-3 h-3\" />\n        Download OK\n      </Badge>\n    );\n  }\n  \n  return null;\n}\n\nexport default function Xmls() {\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [openCNPJs, setOpenCNPJs] = useState<Set<string>>(new Set());\n  const [openYears, setOpenYears] = useState<Set<string>>(new Set());\n  const [openMonths, setOpenMonths] = useState<Set<string>>(new Set());\n\n  const { data: xmls, isLoading } = useQuery<Xml[]>({\n    queryKey: [\"/api/xmls\"],\n  });\n\n  // Filtra XMLs para mostrar todos (nfeProc e resNFe)\n  const filteredXmls = xmls?.filter((xml) =>\n    xml.numeroNF.includes(searchTerm) ||\n    xml.chaveNFe.includes(searchTerm) ||\n    xml.empresaNome.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    xml.empresaCnpj.includes(searchTerm)\n  );\n\n  // Conta XMLs por tipo e status\n  const stats = {\n    total: xmls?.length || 0,\n    completos: xmls?.filter(x => x.tipoDocumento === \"nfeProc\").length || 0,\n    resumos: xmls?.filter(x => x.tipoDocumento === \"resNFe\").length || 0,\n    // CRÍTICO: Apenas resNFe podem estar pendentes de download (nfeProc já está completo)\n    pendentesDownload: xmls?.filter(x => x.tipoDocumento === \"resNFe\" && x.statusDownload === \"pendente\").length || 0,\n    errosDownload: xmls?.filter(x => x.tipoDocumento === \"resNFe\" && x.statusDownload === \"erro\" && (x.tentativasDownload || 0) >= 5).length || 0,\n  };\n\n  // Agrupar XMLs por CNPJ > Ano > Mês\n  const groupedXmls: XmlGroup[] = [];\n  if (filteredXmls) {\n    const cnpjMap = new Map<string, XmlGroup>();\n\n    filteredXmls.forEach((xml) => {\n      const date = new Date(xml.dataEmissao);\n      const ano = date.getFullYear().toString();\n      const mes = (date.getMonth() + 1).toString().padStart(2, '0');\n\n      if (!cnpjMap.has(xml.empresaCnpj)) {\n        cnpjMap.set(xml.empresaCnpj, {\n          cnpj: xml.empresaCnpj,\n          empresaNome: xml.empresaNome,\n          anos: [],\n        });\n      }\n\n      const group = cnpjMap.get(xml.empresaCnpj)!;\n      let yearGroup = group.anos.find((a) => a.ano === ano);\n\n      if (!yearGroup) {\n        yearGroup = { ano, meses: [] };\n        group.anos.push(yearGroup);\n      }\n\n      let monthGroup = yearGroup.meses.find((m) => m.mes === mes);\n\n      if (!monthGroup) {\n        monthGroup = { mes, xmls: [] };\n        yearGroup.meses.push(monthGroup);\n      }\n\n      monthGroup.xmls.push(xml);\n    });\n\n    groupedXmls.push(...Array.from(cnpjMap.values()));\n  }\n\n  const toggleCNPJ = (cnpj: string) => {\n    setOpenCNPJs((prev) => {\n      const next = new Set(prev);\n      if (next.has(cnpj)) {\n        next.delete(cnpj);\n      } else {\n        next.add(cnpj);\n      }\n      return next;\n    });\n  };\n\n  const toggleYear = (key: string) => {\n    setOpenYears((prev) => {\n      const next = new Set(prev);\n      if (next.has(key)) {\n        next.delete(key);\n      } else {\n        next.add(key);\n      }\n      return next;\n    });\n  };\n\n  const toggleMonth = (key: string) => {\n    setOpenMonths((prev) => {\n      const next = new Set(prev);\n      if (next.has(key)) {\n        next.delete(key);\n      } else {\n        next.add(key);\n      }\n      return next;\n    });\n  };\n\n  const formatCNPJ = (cnpj: string) => {\n    return cnpj.replace(/^(\\d{2})(\\d{3})(\\d{3})(\\d{4})(\\d{2})$/, \"$1.$2.$3/$4-$5\");\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const monthNames = [\n    \"Janeiro\", \"Fevereiro\", \"Março\", \"Abril\", \"Maio\", \"Junho\",\n    \"Julho\", \"Agosto\", \"Setembro\", \"Outubro\", \"Novembro\", \"Dezembro\"\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-xmls\">XMLs Baixados</h1>\n          <p className=\"text-sm text-muted-foreground\">Navegue pelos XMLs organizados por empresa, ano e mês</p>\n        </div>\n      </div>\n\n      {/* Estatísticas de Download */}\n      {!isLoading && (stats.resumos > 0 || stats.pendentesDownload > 0 || stats.errosDownload > 0) && (\n        <div className=\"grid gap-4 md:grid-cols-4\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-600\" />\n                <div className=\"flex-1\">\n                  <p className=\"text-xs text-muted-foreground\">XMLs Completos</p>\n                  <p className=\"text-2xl font-semibold\">{stats.completos}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-2\">\n                <FileText className=\"w-4 h-4 text-blue-600\" />\n                <div className=\"flex-1\">\n                  <p className=\"text-xs text-muted-foreground\">Resumos (resNFe)</p>\n                  <p className=\"text-2xl font-semibold\">{stats.resumos}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-2\">\n                <Clock className=\"w-4 h-4 text-yellow-600\" />\n                <div className=\"flex-1\">\n                  <p className=\"text-xs text-muted-foreground\">Pendentes Download</p>\n                  <p className=\"text-2xl font-semibold\">{stats.pendentesDownload}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-2\">\n                <XCircle className=\"w-4 h-4 text-red-600\" />\n                <div className=\"flex-1\">\n                  <p className=\"text-xs text-muted-foreground\">Erros Download</p>\n                  <p className=\"text-2xl font-semibold\">{stats.errosDownload}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"relative flex-1 max-w-md\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Buscar por NF-e, chave, empresa ou CNPJ...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-xmls\"\n              />\n            </div>\n            <div className=\"text-sm text-muted-foreground\">\n              {filteredXmls?.length ?? 0} XML(s)\n            </div>\n          </div>\n\n          {isLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"border rounded-md p-4\">\n                  <Skeleton className=\"h-6 w-64 mb-3\" />\n                  <div className=\"ml-6 space-y-2\">\n                    <Skeleton className=\"h-5 w-32\" />\n                    <Skeleton className=\"h-4 w-48\" />\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : groupedXmls.length > 0 ? (\n            <div className=\"space-y-2\">\n              {groupedXmls.map((cnpjGroup) => (\n                <Collapsible\n                  key={cnpjGroup.cnpj}\n                  open={openCNPJs.has(cnpjGroup.cnpj)}\n                  onOpenChange={() => toggleCNPJ(cnpjGroup.cnpj)}\n                >\n                  <Card className=\"overflow-hidden\">\n                    <CollapsibleTrigger className=\"w-full\" data-testid={`folder-cnpj-${cnpjGroup.cnpj}`}>\n                      <div className=\"flex items-center gap-3 p-4 hover-elevate\">\n                        <div className=\"w-8 h-8 bg-primary/10 rounded-md flex items-center justify-center flex-shrink-0\">\n                          <FolderOpen className=\"w-4 h-4 text-primary\" />\n                        </div>\n                        <div className=\"flex-1 text-left\">\n                          <p className=\"text-sm font-medium\">{cnpjGroup.empresaNome}</p>\n                          <p className=\"text-xs text-muted-foreground font-mono\">\n                            CNPJ {formatCNPJ(cnpjGroup.cnpj)}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"text-xs text-muted-foreground\">\n                            {cnpjGroup.anos.reduce((sum, ano) => \n                              sum + ano.meses.reduce((s, mes) => s + mes.xmls.length, 0), 0\n                            )} XML(s)\n                          </span>\n                          {openCNPJs.has(cnpjGroup.cnpj) ? (\n                            <ChevronDown className=\"w-4 h-4 text-muted-foreground\" />\n                          ) : (\n                            <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                          )}\n                        </div>\n                      </div>\n                    </CollapsibleTrigger>\n\n                    <CollapsibleContent>\n                      <div className=\"px-4 pb-4 pl-12 space-y-2\">\n                        {cnpjGroup.anos.map((yearGroup) => (\n                          <Collapsible\n                            key={`${cnpjGroup.cnpj}-${yearGroup.ano}`}\n                            open={openYears.has(`${cnpjGroup.cnpj}-${yearGroup.ano}`)}\n                            onOpenChange={() => toggleYear(`${cnpjGroup.cnpj}-${yearGroup.ano}`)}\n                          >\n                            <CollapsibleTrigger className=\"w-full\" data-testid={`folder-year-${yearGroup.ano}`}>\n                              <div className=\"flex items-center gap-2 p-2 hover-elevate rounded-md\">\n                                <FolderOpen className=\"w-4 h-4 text-muted-foreground\" />\n                                <span className=\"text-sm font-medium\">{yearGroup.ano}</span>\n                                <span className=\"text-xs text-muted-foreground ml-auto\">\n                                  {yearGroup.meses.reduce((sum, mes) => sum + mes.xmls.length, 0)} XML(s)\n                                </span>\n                                {openYears.has(`${cnpjGroup.cnpj}-${yearGroup.ano}`) ? (\n                                  <ChevronDown className=\"w-3 h-3 text-muted-foreground\" />\n                                ) : (\n                                  <ChevronRight className=\"w-3 h-3 text-muted-foreground\" />\n                                )}\n                              </div>\n                            </CollapsibleTrigger>\n\n                            <CollapsibleContent>\n                              <div className=\"ml-6 mt-2 space-y-2\">\n                                {yearGroup.meses.map((monthGroup) => (\n                                  <Collapsible\n                                    key={`${cnpjGroup.cnpj}-${yearGroup.ano}-${monthGroup.mes}`}\n                                    open={openMonths.has(`${cnpjGroup.cnpj}-${yearGroup.ano}-${monthGroup.mes}`)}\n                                    onOpenChange={() => toggleMonth(`${cnpjGroup.cnpj}-${yearGroup.ano}-${monthGroup.mes}`)}\n                                  >\n                                    <CollapsibleTrigger className=\"w-full\" data-testid={`folder-month-${monthGroup.mes}`}>\n                                      <div className=\"flex items-center gap-2 p-2 hover-elevate rounded-md\">\n                                        <FolderOpen className=\"w-4 h-4 text-muted-foreground\" />\n                                        <span className=\"text-sm\">{monthNames[parseInt(monthGroup.mes) - 1]}</span>\n                                        <span className=\"text-xs text-muted-foreground ml-auto\">\n                                          {monthGroup.xmls.length} XML(s)\n                                        </span>\n                                        {openMonths.has(`${cnpjGroup.cnpj}-${yearGroup.ano}-${monthGroup.mes}`) ? (\n                                          <ChevronDown className=\"w-3 h-3 text-muted-foreground\" />\n                                        ) : (\n                                          <ChevronRight className=\"w-3 h-3 text-muted-foreground\" />\n                                        )}\n                                      </div>\n                                    </CollapsibleTrigger>\n\n                                    <CollapsibleContent>\n                                      <div className=\"ml-6 mt-2 space-y-1\">\n                                        {monthGroup.xmls.map((xml) => (\n                                          <div\n                                            key={xml.id}\n                                            className=\"flex items-center gap-3 p-3 border rounded-md hover-elevate\"\n                                            data-testid={`xml-${xml.id}`}\n                                          >\n                                            <FileText className=\"w-4 h-4 text-primary flex-shrink-0\" />\n                                            <div className=\"flex-1 min-w-0\">\n                                              <p className=\"text-sm font-medium truncate\">\n                                                NF-e {xml.numeroNF}\n                                              </p>\n                                              <p className=\"text-xs text-muted-foreground font-mono truncate\">\n                                                {xml.chaveNFe}\n                                              </p>\n                                            </div>\n                                            <div className=\"flex items-center gap-1 flex-wrap\">\n                                              {getStatusNfeBadge(xml)}\n                                              {getTipoDocumentoBadge(xml)}\n                                              {getManifestacaoBadge(xml)}\n                                              {getDownloadBadge(xml)}\n                                            </div>\n                                            <div className=\"text-xs text-muted-foreground flex-shrink-0\">\n                                              {formatFileSize(xml.tamanhoBytes)}\n                                            </div>\n                                            <Button\n                                              variant=\"ghost\"\n                                              size=\"icon\"\n                                              className=\"flex-shrink-0\"\n                                              onClick={async () => {\n                                                try {\n                                                  const sessionStr = localStorage.getItem(\"session\");\n                                                  if (!sessionStr) {\n                                                    toast({\n                                                      title: \"Erro\",\n                                                      description: \"Sessão expirada. Faça login novamente.\",\n                                                      variant: \"destructive\",\n                                                    });\n                                                    return;\n                                                  }\n\n                                                  const session = JSON.parse(sessionStr);\n                                                  const response = await fetch(`/api/xmls/${xml.id}/download`, {\n                                                    headers: {\n                                                      Authorization: `Bearer ${session.accessToken}`,\n                                                    },\n                                                  });\n\n                                                  if (!response.ok) {\n                                                    throw new Error(\"Erro ao baixar XML\");\n                                                  }\n\n                                                  const blob = await response.blob();\n                                                  const url = window.URL.createObjectURL(blob);\n                                                  const a = document.createElement(\"a\");\n                                                  a.href = url;\n                                                  a.download = `${xml.numeroNF}.xml`;\n                                                  document.body.appendChild(a);\n                                                  a.click();\n                                                  window.URL.revokeObjectURL(url);\n                                                  document.body.removeChild(a);\n                                                } catch (error) {\n                                                  toast({\n                                                    title: \"Erro ao baixar\",\n                                                    description: String(error),\n                                                    variant: \"destructive\",\n                                                  });\n                                                }\n                                              }}\n                                              data-testid={`button-download-${xml.id}`}\n                                            >\n                                              <Download className=\"w-4 h-4\" />\n                                            </Button>\n                                          </div>\n                                        ))}\n                                      </div>\n                                    </CollapsibleContent>\n                                  </Collapsible>\n                                ))}\n                              </div>\n                            </CollapsibleContent>\n                          </Collapsible>\n                        ))}\n                      </div>\n                    </CollapsibleContent>\n                  </Card>\n                </Collapsible>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-12\">\n              <FileText className=\"w-16 h-16 mx-auto mb-4 opacity-20\" />\n              <h3 className=\"text-lg font-medium mb-2\">Nenhum XML encontrado</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                {searchTerm\n                  ? \"Nenhum XML encontrado com os critérios de busca\"\n                  : \"XMLs baixados aparecerão aqui após a sincronização\"}\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":23747},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"'Inter'\", \"-apple-system\", \"BlinkMacSystemFont\", \"'Segoe UI'\", \"sans-serif\"],\n        serif: [\"Georgia\", \"serif\"],\n        mono: [\"'Roboto Mono'\", \"'Courier New'\", \"monospace\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4134},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/pages/logs.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { StatusBadge } from \"@/components/status-badge\";\nimport { Download, Calendar, Filter, Trash2 } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\n\ninterface Log {\n  id: string;\n  empresaId: string | null;\n  sincronizacaoId: string | null;\n  nivel: \"info\" | \"warning\" | \"error\";\n  mensagem: string;\n  detalhes: string | null;\n  timestamp: string;\n  empresaNome?: string;\n}\n\nexport default function Logs() {\n  const [nivelFilter, setNivelFilter] = useState<string>(\"todos\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: logs, isLoading } = useQuery<Log[]>({\n    queryKey: [\"/api/logs\"],\n  });\n\n  const cleanupLockLogsMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"/api/logs/cleanup-lock-logs\", {\n        method: \"DELETE\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/logs\"] });\n      toast({\n        title: \"Logs limpos\",\n        description: \"Logs técnicos de lock removidos com sucesso\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao limpar logs\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredLogs = logs?.filter((log) => {\n    const matchNivel = nivelFilter === \"todos\" || log.nivel === nivelFilter;\n    const matchSearch = log.mensagem.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      log.empresaNome?.toLowerCase().includes(searchTerm.toLowerCase());\n    return matchNivel && matchSearch;\n  });\n\n  const formatDateTime = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return new Intl.DateTimeFormat('pt-BR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n    }).format(date);\n  };\n\n  const getLevelIcon = (nivel: string) => {\n    switch (nivel) {\n      case \"error\": return \"erro\";\n      case \"warning\": return \"pausado\";\n      default: return \"ativo\";\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-logs\">Logs de Sincronização</h1>\n          <p className=\"text-sm text-muted-foreground\">Histórico detalhado de todas as operações do sistema</p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button \n            variant=\"outline\" \n            onClick={() => cleanupLockLogsMutation.mutate()}\n            disabled={cleanupLockLogsMutation.isPending}\n            data-testid=\"button-cleanup-lock-logs\"\n          >\n            <Trash2 className=\"w-4 h-4 mr-2\" />\n            Limpar Logs Técnicos\n          </Button>\n          <Button variant=\"outline\" data-testid=\"button-exportar-logs\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Exportar Logs\n          </Button>\n        </div>\n      </div>\n\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex flex-wrap items-center gap-3 mb-6\">\n            <div className=\"flex-1 min-w-[200px]\">\n              <Input\n                placeholder=\"Buscar em logs...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search-logs\"\n              />\n            </div>\n\n            <Select value={nivelFilter} onValueChange={setNivelFilter}>\n              <SelectTrigger className=\"w-[180px]\" data-testid=\"select-nivel-filter\">\n                <Filter className=\"w-4 h-4 mr-2\" />\n                <SelectValue placeholder=\"Filtrar por nível\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"todos\">Todos os níveis</SelectItem>\n                <SelectItem value=\"info\">Info</SelectItem>\n                <SelectItem value=\"warning\">Warning</SelectItem>\n                <SelectItem value=\"error\">Error</SelectItem>\n              </SelectContent>\n            </Select>\n\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <Calendar className=\"w-4 h-4\" />\n              <span>{filteredLogs?.length ?? 0} registro(s)</span>\n            </div>\n          </div>\n\n          <div className=\"rounded-lg border\">\n            <div className=\"max-h-[600px] overflow-y-auto\">\n              {isLoading ? (\n                <div className=\"p-4 space-y-2\">\n                  {[1, 2, 3, 4, 5, 6, 7, 8].map((i) => (\n                    <div key={i} className=\"flex items-start gap-3 p-3 border-b\">\n                      <Skeleton className=\"w-20 h-5 rounded-full\" />\n                      <div className=\"flex-1 space-y-2\">\n                        <Skeleton className=\"h-4 w-full\" />\n                        <Skeleton className=\"h-3 w-32\" />\n                      </div>\n                      <Skeleton className=\"w-24 h-4\" />\n                    </div>\n                  ))}\n                </div>\n              ) : filteredLogs && filteredLogs.length > 0 ? (\n                <div className=\"divide-y\">\n                  {filteredLogs.map((log) => (\n                    <div\n                      key={log.id}\n                      className=\"flex items-start gap-3 p-4 hover:bg-muted/30 transition-colors\"\n                      data-testid={`log-${log.id}`}\n                    >\n                      <div className=\"flex-shrink-0 pt-0.5\">\n                        <StatusBadge status={getLevelIcon(log.nivel)} />\n                      </div>\n\n                      <div className=\"flex-1 min-w-0 space-y-1\">\n                        <p className=\"text-sm font-medium\">{log.mensagem}</p>\n                        {log.empresaNome && (\n                          <p className=\"text-xs text-muted-foreground\">\n                            Empresa: {log.empresaNome}\n                          </p>\n                        )}\n                        {log.detalhes && (\n                          <details className=\"text-xs text-muted-foreground mt-2\">\n                            <summary className=\"cursor-pointer hover:text-foreground\">\n                              Ver detalhes\n                            </summary>\n                            <pre className=\"mt-2 p-2 bg-muted rounded text-xs font-mono overflow-x-auto\">\n                              {JSON.stringify(JSON.parse(log.detalhes), null, 2)}\n                            </pre>\n                          </details>\n                        )}\n                      </div>\n\n                      <div className=\"flex-shrink-0 text-right\">\n                        <p className=\"text-xs font-mono text-muted-foreground whitespace-nowrap\">\n                          {formatDateTime(log.timestamp)}\n                        </p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-12\">\n                  <Filter className=\"w-16 h-16 mx-auto mb-4 opacity-20\" />\n                  <h3 className=\"text-lg font-medium mb-2\">Nenhum log encontrado</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {searchTerm || nivelFilter !== \"todos\"\n                      ? \"Tente ajustar os filtros de busca\"\n                      : \"Logs aparecerão aqui após operações do sistema\"}\n                  </p>\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":8021},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Building2, FileText, Clock, Activity } from \"lucide-react\";\nimport { StatCard } from \"@/components/stat-card\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge } from \"@/components/status-badge\";\nimport { Link } from \"wouter\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\ninterface DashboardStats {\n  totalEmpresas: number;\n  empresasAtivas: number;\n  xmlsHoje: number;\n  ultimaSincronizacao: string | null;\n  sincronizacoesEmAndamento: number;\n}\n\ninterface RecentXml {\n  id: string;\n  empresaCnpj: string;\n  empresaNome: string;\n  numeroNF: string;\n  dataEmissao: string;\n  createdAt: string;\n}\n\ninterface RecentLog {\n  id: string;\n  nivel: \"info\" | \"warning\" | \"error\";\n  mensagem: string;\n  timestamp: string;\n  empresaNome?: string;\n}\n\nexport default function Dashboard() {\n  const { data: stats, isLoading: isLoadingStats } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: recentXmls, isLoading: isLoadingXmls } = useQuery<RecentXml[]>({\n    queryKey: [\"/api/dashboard/recent-xmls\"],\n  });\n\n  const { data: recentLogs, isLoading: isLoadingLogs } = useQuery<RecentLog[]>({\n    queryKey: [\"/api/dashboard/recent-logs\"],\n  });\n\n  const formatDateTime = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return new Intl.DateTimeFormat('pt-BR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    }).format(date);\n  };\n\n  const formatTimeAgo = (dateStr: string) => {\n    const now = new Date();\n    const date = new Date(dateStr);\n    const diffMs = now.getTime() - date.getTime();\n    const diffMins = Math.floor(diffMs / 60000);\n    \n    if (diffMins < 1) return 'Agora mesmo';\n    if (diffMins < 60) return `Há ${diffMins} min`;\n    const diffHours = Math.floor(diffMins / 60);\n    if (diffHours < 24) return `Há ${diffHours}h`;\n    const diffDays = Math.floor(diffHours / 24);\n    return `Há ${diffDays}d`;\n  };\n\n  const getLevelBadgeVariant = (nivel: string) => {\n    switch (nivel) {\n      case \"error\": return \"destructive\";\n      case \"warning\": return \"secondary\";\n      default: return \"default\";\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-dashboard\">Dashboard</h1>\n          <p className=\"text-sm text-muted-foreground\">Visão geral do sistema de sincronização</p>\n        </div>\n        <Button asChild data-testid=\"button-nova-empresa\">\n          <Link href=\"/empresas/nova\">\n            <Building2 className=\"w-4 h-4 mr-2\" />\n            Nova Empresa\n          </Link>\n        </Button>\n      </div>\n\n      <div className=\"grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-4\">\n        <StatCard\n          title=\"Total de Empresas\"\n          value={stats?.totalEmpresas ?? 0}\n          icon={Building2}\n          description={`${stats?.empresasAtivas ?? 0} ativas`}\n          isLoading={isLoadingStats}\n        />\n        <StatCard\n          title=\"XMLs Hoje\"\n          value={stats?.xmlsHoje ?? 0}\n          icon={FileText}\n          description=\"Baixados nas últimas 24h\"\n          isLoading={isLoadingStats}\n        />\n        <StatCard\n          title=\"Última Sincronização\"\n          value={stats?.ultimaSincronizacao ? formatTimeAgo(stats.ultimaSincronizacao) : 'Nunca'}\n          icon={Clock}\n          isLoading={isLoadingStats}\n        />\n        <StatCard\n          title=\"Status Atual\"\n          value={stats?.sincronizacoesEmAndamento ?? 0}\n          icon={Activity}\n          description={stats?.sincronizacoesEmAndamento ? 'Em andamento' : 'Aguardando'}\n          isLoading={isLoadingStats}\n        />\n      </div>\n\n      <div className=\"grid gap-6 grid-cols-1 lg:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg font-medium\">XMLs Recentes</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {isLoadingXmls ? (\n                <>\n                  {[1, 2, 3, 4, 5].map((i) => (\n                    <div key={i} className=\"flex items-center gap-3 p-3 rounded-md border\">\n                      <Skeleton className=\"w-10 h-10 rounded-md\" />\n                      <div className=\"flex-1 space-y-2\">\n                        <Skeleton className=\"h-4 w-32\" />\n                        <Skeleton className=\"h-3 w-48\" />\n                      </div>\n                      <Skeleton className=\"h-4 w-16\" />\n                    </div>\n                  ))}\n                </>\n              ) : recentXmls && recentXmls.length > 0 ? (\n                recentXmls.map((xml) => (\n                  <div\n                    key={xml.id}\n                    className=\"flex items-center gap-3 p-3 rounded-md border hover-elevate\"\n                    data-testid={`card-xml-${xml.id}`}\n                  >\n                    <div className=\"w-10 h-10 rounded-md bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                      <FileText className=\"w-5 h-5 text-primary\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium truncate\">NF-e {xml.numeroNF}</p>\n                      <p className=\"text-xs text-muted-foreground truncate\">\n                        {xml.empresaNome} • CNPJ {xml.empresaCnpj}\n                      </p>\n                    </div>\n                    <div className=\"text-xs text-muted-foreground flex-shrink-0\">\n                      {formatTimeAgo(xml.createdAt)}\n                    </div>\n                  </div>\n                ))\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <FileText className=\"w-12 h-12 mx-auto mb-3 opacity-20\" />\n                  <p className=\"text-sm\">Nenhum XML baixado ainda</p>\n                  <p className=\"text-xs mt-1\">XMLs aparecerão aqui após a primeira sincronização</p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg font-medium\">Logs Recentes</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {isLoadingLogs ? (\n                <>\n                  {[1, 2, 3, 4, 5].map((i) => (\n                    <div key={i} className=\"flex items-start gap-3 p-3 rounded-md border\">\n                      <Skeleton className=\"w-16 h-5 rounded-full\" />\n                      <div className=\"flex-1 space-y-2\">\n                        <Skeleton className=\"h-4 w-full\" />\n                        <Skeleton className=\"h-3 w-24\" />\n                      </div>\n                    </div>\n                  ))}\n                </>\n              ) : recentLogs && recentLogs.length > 0 ? (\n                recentLogs.map((log) => (\n                  <div\n                    key={log.id}\n                    className=\"flex items-start gap-3 p-3 rounded-md border\"\n                    data-testid={`log-${log.id}`}\n                  >\n                    <StatusBadge \n                      status={log.nivel === \"error\" ? \"erro\" : log.nivel === \"warning\" ? \"pausado\" : \"ativo\"} \n                      className=\"flex-shrink-0 mt-0.5\"\n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm\">{log.mensagem}</p>\n                      <div className=\"flex items-center gap-2 mt-1\">\n                        {log.empresaNome && (\n                          <span className=\"text-xs text-muted-foreground\">{log.empresaNome}</span>\n                        )}\n                        <span className=\"text-xs text-muted-foreground\">\n                          {formatTimeAgo(log.timestamp)}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                ))\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Activity className=\"w-12 h-12 mx-auto mb-3 opacity-20\" />\n                  <p className=\"text-sm\">Nenhum log registrado</p>\n                  <p className=\"text-xs mt-1\">Logs aparecerão aqui após operações do sistema</p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8648},"server/sefaz-service.ts":{"content":"import https from \"https\";\nimport crypto from \"crypto\";\nimport fs from \"fs/promises\";\nimport fsSync from \"fs\";\nimport path from \"path\";\nimport { XMLParser } from \"fast-xml-parser\";\nimport * as pako from \"pako\";\nimport { SignedXml } from \"xml-crypto\";\nimport { DOMParser, XMLSerializer } from \"xmldom\";\nimport { storage } from \"./storage\";\nimport type { Empresa } from \"@shared/schema\";\nimport { loadPKCS12Certificate } from \"./cert-loader\";\nimport { \n  formatarDataBrasilCompleta, \n  calcularMinutosRestantes, \n  estaBloqueado, \n  criarBloqueio \n} from \"./utils/timezone\";\nimport { xmlStorageService } from \"./xml-storage\";\n\nconst UF_CODE_MAP: Record<string, number> = {\n  AC: 12, AL: 27, AM: 13, AP: 16, BA: 29, CE: 23,\n  DF: 53, ES: 32, GO: 52, MA: 21, MG: 31, MS: 50,\n  MT: 51, PA: 15, PB: 25, PE: 26, PI: 22, PR: 41,\n  RJ: 33, RN: 24, RO: 11, RR: 14, RS: 43, SC: 42,\n  SE: 28, SP: 35, TO: 17,\n};\n\nconst ENDPOINTS = {\n  prod: \"https://www1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx\",\n  hom: \"https://hom1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx\",\n};\n\n// Endpoints para NFeRecepcaoEvento (Manifestação do Destinatário)\n// NT 2020.001: Usa Ambiente Nacional (cOrgao=91)\nconst ENDPOINTS_RECEPCAO_EVENTO = {\n  prod: \"https://www.nfe.fazenda.gov.br/NFeRecepcaoEvento4/NFeRecepcaoEvento4.asmx\",\n  hom: \"https://hom1.nfe.fazenda.gov.br/NFeRecepcaoEvento4/NFeRecepcaoEvento4.asmx\",\n};\n\n// Endpoints para NfeDownloadNF (Download de XML Completo)\n// Endpoint Nacional conforme documentação SEFAZ\nconst ENDPOINTS_DOWNLOAD_NF = {\n  prod: \"https://www.nfe.fazenda.gov.br/NfeDownloadNF/NfeDownloadNF.asmx\",\n  hom: \"https://hom.nfe.fazenda.gov.br/NfeDownloadNF/NfeDownloadNF.asmx\",\n};\n\n// Tipos de Evento de Manifestação do Destinatário (NT 2020.001)\nexport const TIPOS_MANIFESTACAO = {\n  CONFIRMACAO: \"210200\", // Confirmação da Operação\n  CIENCIA: \"210210\",     // Ciência da Operação\n  DESCONHECIMENTO: \"210220\", // Desconhecimento da Operação\n  NAO_REALIZADA: \"210240\",   // Operação não Realizada\n} as const;\n\ninterface SefazResponse {\n  cStat: string;\n  xMotivo: string;\n  ultNSU?: string;\n  maxNSU?: string;\n  docZips?: Array<{\n    NSU: string;\n    schema: string;\n    content: string;\n  }>;\n}\n\n/**\n * Assina digitalmente o XML do evento conforme padrão XML Signature\n * NT 2020.001 exige assinatura digital em todos os eventos de manifestação\n * \n * @param xmlEvento - XML do elemento <evento> (sem assinatura)\n * @param privateKey - Chave privada em formato PEM\n * @param certificate - Certificado em formato PEM\n * @returns XML do evento assinado (com tag <Signature>)\n */\nfunction signXmlEvento(xmlEvento: string, privateKey: string, certificate: string): string {\n  try {\n    console.log('[signXmlEvento] 🔍 PrivateKey recebida:', privateKey ? `SIM (${privateKey.substring(0, 50)}...)` : 'NÃO');\n    console.log('[signXmlEvento] 🔍 Certificate recebido:', certificate ? `SIM (${certificate.substring(0, 50)}...)` : 'NÃO');\n    \n    // CORREÇÃO cStat 225: Usar algoritmos CLÁSSICOS exigidos pelo XSD xmldsig-core-schema_v1.01.xsd\n    // SEFAZ NF-e FIXA os algoritmos (não aceita SHA-256, apenas SHA-1)\n    // Referência: xmldsig-core-schema_v1.01.xsd em https://dfe-portal.svrs.rs.gov.br/\n    console.log('[signXmlEvento] 🔧 Usando algoritmos SHA-1 + C14N clássico (exigência XSD SEFAZ)');\n    const sig = new SignedXml({\n      privateKey: privateKey,  // String PEM diretamente conforme docs\n      publicCert: certificate,  // Será incluído em <KeyInfo><X509Certificate>\n      // CORREÇÃO: RSA-SHA1 ao invés de RSA-SHA256 (mandato SEFAZ)\n      signatureAlgorithm: 'http://www.w3.org/2000/09/xmldsig#rsa-sha1',\n      // CORREÇÃO: C14N clássico ao invés de Exclusive C14N (mandato SEFAZ)\n      canonicalizationAlgorithm: 'http://www.w3.org/TR/2001/REC-xml-c14n-20010315'\n    });\n    \n    // Adicionar referência ao elemento infEvento (que possui atributo Id)\n    sig.addReference({\n      xpath: \"//*[local-name()='infEvento']\",\n      transforms: [\n        'http://www.w3.org/2000/09/xmldsig#enveloped-signature',\n        // CORREÇÃO: C14N clássico ao invés de Exclusive C14N (mandato SEFAZ)\n        'http://www.w3.org/TR/2001/REC-xml-c14n-20010315'\n      ],\n      // CORREÇÃO: SHA-1 ao invés de SHA-256 (mandato SEFAZ)\n      digestAlgorithm: 'http://www.w3.org/2000/09/xmldsig#sha1'\n    });\n    \n    // Computar assinatura e inserir no final de <evento>\n    // publicCert já configura automaticamente <KeyInfo><X509Certificate>\n    // MANTER: prefix: '' para evitar cStat 404 (SEFAZ rejeita prefixos ds:)\n    sig.computeSignature(xmlEvento, {\n      prefix: '',  // STRING VAZIA = sem prefixos (não usar 'ds')\n      location: { reference: \"//*[local-name()='evento']\", action: 'append' }\n    });\n    \n    // Retornar XML assinado\n    return sig.getSignedXml();\n  } catch (error: any) {\n    console.error('[Assinatura XML] Erro ao assinar evento:', error.message);\n    throw new Error(`Falha na assinatura digital do evento: ${error.message}`);\n  }\n}\n\nexport class SefazService {\n  private parser: XMLParser;\n  private xmlDestPath: string;\n\n  constructor() {\n    this.parser = new XMLParser({\n      ignoreAttributes: false,\n      attributeNamePrefix: \"\",\n      parseTagValue: false, // CRÍTICO: Mantém TODOS os valores como string (preserva chaves de 44 dígitos)\n    });\n    this.xmlDestPath = process.env.XML_DEST_PATH || \"./xmls\";\n  }\n\n  /**\n   * Monta SOAP envelope usando consNSU (consulta por NSU específico)\n   * Usado apenas para compatibilidade com código legado\n   * ATENÇÃO: Preferir buildSOAPEnvelopeDistNSU para seguir NT 2014.002\n   */\n  private buildSOAPEnvelope(cnpj: string, uf: string, ambiente: string, nsu: string): string {\n    const cufAutor = UF_CODE_MAP[uf.toUpperCase()] || 35;\n    const tpAmb = ambiente.toLowerCase().startsWith(\"prod\") ? \"1\" : \"2\";\n    const nsu15 = nsu.padStart(15, \"0\");\n\n    return `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap12:Envelope xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"\n                 xmlns:nfe=\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe\">\n  <soap12:Body>\n    <nfe:nfeDistDFeInteresse>\n      <nfe:nfeDadosMsg>\n        <distDFeInt xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.01\">\n          <tpAmb>${tpAmb}</tpAmb>\n          <cUFAutor>${cufAutor}</cUFAutor>\n          <CNPJ>${cnpj}</CNPJ>\n          <consNSU><NSU>${nsu15}</NSU></consNSU>\n        </distDFeInt>\n      </nfe:nfeDadosMsg>\n    </nfe:nfeDistDFeInteresse>\n  </soap12:Body>\n</soap12:Envelope>`;\n  }\n\n  /**\n   * Monta SOAP envelope usando distNSU (distribuição por ultNSU)\n   * Conforme NT 2014.002 - Regra oficial da SEFAZ\n   * \n   * IMPORTANTE: Este é o método correto para consultas NFeDistribuicaoDFe\n   * - Usa <distNSU><ultNSU> em vez de <consNSU><NSU>\n   * - Permite que SEFAZ retorne documentos após o ultNSU informado\n   * - Evita rejeição cStat=656 (uso indevido do serviço)\n   * \n   * @param cnpj - CNPJ da empresa\n   * @param uf - UF de autorização (ex: 'SP', 'MG')\n   * @param ambiente - Ambiente ('producao' ou 'homologacao')\n   * @param ultNSU - Último NSU já consultado (use \"0\" apenas na primeira consulta)\n   */\n  private buildSOAPEnvelopeDistNSU(cnpj: string, uf: string, ambiente: string, ultNSU: string): string {\n    const cufAutor = UF_CODE_MAP[uf.toUpperCase()] || 35;\n    const tpAmb = ambiente.toLowerCase().startsWith(\"prod\") ? \"1\" : \"2\";\n    const ultNSU15 = ultNSU.padStart(15, \"0\");\n\n    return `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap12:Envelope xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"\n                 xmlns:nfe=\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe\">\n  <soap12:Body>\n    <nfe:nfeDistDFeInteresse>\n      <nfe:nfeDadosMsg>\n        <distDFeInt xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.01\">\n          <tpAmb>${tpAmb}</tpAmb>\n          <cUFAutor>${cufAutor}</cUFAutor>\n          <CNPJ>${cnpj}</CNPJ>\n          <distNSU><ultNSU>${ultNSU15}</ultNSU></distNSU>\n        </distDFeInt>\n      </nfe:nfeDadosMsg>\n    </nfe:nfeDistDFeInteresse>\n  </soap12:Body>\n</soap12:Envelope>`;\n  }\n\n  /**\n   * Monta SOAP envelope para consulta por chave de acesso (consChNFe)\n   * Conforme NT 2014.002 §3.6\n   * \n   * IMPORTANTE: Usa <consChNFe> para buscar XML completo por chave\n   * - Permite baixar nfeProc quando só temos resNFe (resumo)\n   * - Essencial para manifestação do destinatário (só pode manifestar com XML completo)\n   * \n   * @param cnpj - CNPJ da empresa\n   * @param uf - UF de autorização (ex: 'SP', 'MG')\n   * @param ambiente - Ambiente ('producao' ou 'homologacao')\n   * @param chaveNFe - Chave de acesso de 44 dígitos da NF-e/NFC-e\n   */\n  /**\n   * Monta SOAP envelope para NfeDownloadNF (Download de XML Completo)\n   * Conforme exemplo funcional fornecido - usa endpoint NfeDownloadNF.asmx\n   * \n   * IMPORTANTE: Este é o método CORRETO para download de XML completo após manifestação\n   * - Endpoint: NfeDownloadNF.asmx (não NFeDistribuicaoDFe)\n   * - SOAP 1.2 com namespace soap (não soap12)\n   * - Header com nfeCabecMsg contendo cUF e versaoDados\n   * - Body com downloadNFe contendo tpAmb, xServ, CNPJ, chNFe\n   * \n   * @param cnpj - CNPJ da empresa destinatária\n   * @param uf - UF de autorização (ex: 'SP', 'MG')\n   * @param ambiente - Ambiente ('producao' ou 'homologacao')\n   * @param chaveNFe - Chave de acesso da NF-e (44 dígitos)\n   */\n  private buildSOAPEnvelopeDownloadNFe(cnpj: string, uf: string, ambiente: string, chaveNFe: string): string {\n    const cUF = UF_CODE_MAP[uf.toUpperCase()] || 35;\n    const tpAmb = ambiente.toLowerCase().startsWith(\"prod\") ? \"1\" : \"2\";\n\n    if (!chaveNFe || chaveNFe.length !== 44) {\n      throw new Error(`Chave de acesso inválida: ${chaveNFe} (deve ter 44 dígitos)`);\n    }\n\n    // SOAP envelope conforme exemplo funcional fornecido\n    return `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap:Envelope xmlns:soap=\"http://www.w3.org/2003/05/soap-envelope\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\">\n    <soap:Header>\n        <nfeCabecMsg xmlns=\"http://www.portalfiscal.inf.br/nfe/wsdl/NfeDownloadNF\">\n            <cUF>${cUF}</cUF>\n            <versaoDados>1.00</versaoDados>\n        </nfeCabecMsg>\n    </soap:Header>\n    <soap:Body>\n        <nfeDadosMsg xmlns=\"http://www.portalfiscal.inf.br/nfe/wsdl/NfeDownloadNF\">\n            <downloadNFe xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.00\">\n                <tpAmb>${tpAmb}</tpAmb>\n                <xServ>DOWNLOAD NFE</xServ>\n                <CNPJ>${cnpj}</CNPJ>\n                <chNFe>${chaveNFe}</chNFe>\n            </downloadNFe>\n        </nfeDadosMsg>\n    </soap:Body>\n</soap:Envelope>`;\n  }\n\n  /**\n   * MÉTODO OFICIAL - Download de XML completo via NFeDistribuicaoDFe\n   * Conforme NT 2014.002 e documentação oficial da Fazenda\n   * \n   * Usa consulta por chave (consChNFe) que retorna o XML completo\n   * em formato <docZip> (Base64 + GZip)\n   * \n   * @param cnpj - CNPJ do interessado (deve bater com certificado)\n   * @param uf - UF autora da consulta\n   * @param ambiente - Ambiente ('producao' ou 'homologacao')\n   * @param chaveNFe - Chave de acesso de 44 dígitos\n   */\n  private buildSOAPEnvelopeConsChNFe(cnpj: string, uf: string, ambiente: string, chaveNFe: string): string {\n    const cUFAutor = UF_CODE_MAP[uf.toUpperCase()] || 35;\n    const tpAmb = ambiente.toLowerCase().startsWith(\"prod\") ? \"1\" : \"2\";\n\n    if (!chaveNFe || chaveNFe.length !== 44) {\n      throw new Error(`Chave de acesso inválida: ${chaveNFe} (deve ter 44 dígitos)`);\n    }\n\n    // SOAP 1.2 conforme documentação oficial NT 2014.002\n    return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<soap12:Envelope\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n    xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\">\n  <soap12:Header>\n    <nfeCabecMsg xmlns=\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe\">\n      <cUF>91</cUF>\n      <versaoDados>1.01</versaoDados>\n    </nfeCabecMsg>\n  </soap12:Header>\n  <soap12:Body>\n    <nfeDistDFeInteresse xmlns=\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe\">\n      <nfeDadosMsg>\n        <distDFeInt xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.01\">\n          <tpAmb>${tpAmb}</tpAmb>\n          <cUFAutor>${cUFAutor}</cUFAutor>\n          <CNPJ>${cnpj}</CNPJ>\n          <consChNFe>\n            <chNFe>${chaveNFe}</chNFe>\n          </consChNFe>\n        </distDFeInt>\n      </nfeDadosMsg>\n    </nfeDistDFeInteresse>\n  </soap12:Body>\n</soap12:Envelope>`;\n  }\n\n  /**\n   * Monta SOAP envelope para Manifestação do Destinatário (NFeRecepcaoEvento v4.00)\n   * Conforme NT 2020.001\n   * \n   * Eventos disponíveis:\n   * - 210200: Confirmação da Operação\n   * - 210210: Ciência da Operação (manifestação automática padrão)\n   * - 210220: Desconhecimento da Operação\n   * - 210240: Operação não Realizada (requer justificativa)\n   * \n   * IMPORTANTE: Assina digitalmente o evento usando certificado A1/A3\n   * \n   * @param cnpj - CNPJ do destinatário manifestante\n   * @param chaveNFe - Chave de acesso de 44 dígitos da NF-e\n   * @param tpEvento - Tipo de evento (210200, 210210, 210220, 210240)\n   * @param nSeqEvento - Número sequencial do evento (sempre 1 para manifestação)\n   * @param ambiente - Ambiente ('producao' ou 'homologacao')\n   * @param justificativa - Justificativa (obrigatória para 210240, opcional para outros)\n   * @param privateKey - Chave privada do certificado (PEM)\n   * @param certificate - Certificado digital (PEM)\n   */\n  private buildSOAPEnvelopeManifestacao(\n    cnpj: string,\n    chaveNFe: string,\n    tpEvento: string,\n    nSeqEvento: number,\n    ambiente: string,\n    justificativa: string | undefined,\n    privateKey: string,\n    certificate: string\n  ): string {\n    const tpAmb = ambiente.toLowerCase().startsWith(\"prod\") ? \"1\" : \"2\";\n    \n    if (!chaveNFe || chaveNFe.length !== 44) {\n      throw new Error(`Chave de acesso inválida: ${chaveNFe} (deve ter 44 dígitos)`);\n    }\n\n    // NT 2020.001: 210240 (Operação não Realizada) requer justificativa (min 15 caracteres)\n    if (tpEvento === TIPOS_MANIFESTACAO.NAO_REALIZADA) {\n      if (!justificativa || justificativa.length < 15) {\n        throw new Error(\"Evento 210240 (Operação não Realizada) requer justificativa de no mínimo 15 caracteres\");\n      }\n    }\n\n    // Data/hora do evento em horário de Brasília com offset dinâmico\n    // Formato: YYYY-MM-DDTHH:MM:SS±HH:MM (ex: 2025-11-19T14:30:00-03:00)\n    // CORREÇÃO DEFINITIVA: Usa timeZoneName:'shortOffset' para obter offset real\n    const now = new Date();\n    \n    // Formata data/hora em timezone America/Sao_Paulo\n    const brasiliaFormatter = new Intl.DateTimeFormat('en-CA', {\n      timeZone: 'America/Sao_Paulo',\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      hour12: false,\n    });\n    \n    const parts = brasiliaFormatter.formatToParts(now);\n    const partsMap = parts.reduce((acc, part) => {\n      if (part.type !== 'literal') acc[part.type] = part.value;\n      return acc;\n    }, {} as Record<string, string>);\n    \n    // Obtém offset dinâmico usando timeZoneName:'shortOffset' (ex: \"GMT-3\")\n    const offsetFormatter = new Intl.DateTimeFormat('en-US', {\n      timeZone: 'America/Sao_Paulo',\n      timeZoneName: 'shortOffset',\n    });\n    \n    const offsetParts = offsetFormatter.formatToParts(now);\n    const offsetPart = offsetParts.find(p => p.type === 'timeZoneName');\n    let offsetStr = '-03:00'; // Fallback padrão para Brasília\n    \n    if (offsetPart && offsetPart.value.startsWith('GMT')) {\n      // Converte \"GMT-3\" ou \"GMT+0\" para formato \"±HH:MM\"\n      const offsetMatch = offsetPart.value.match(/GMT([+-])(\\d+)/);\n      if (offsetMatch) {\n        const sign = offsetMatch[1];\n        const hours = offsetMatch[2].padStart(2, '0');\n        offsetStr = `${sign}${hours}:00`;\n      }\n    }\n    \n    // Monta timestamp final: YYYY-MM-DDTHH:MM:SS±HH:MM\n    const dhEvento = `${partsMap.year}-${partsMap.month}-${partsMap.day}T${partsMap.hour}:${partsMap.minute}:${partsMap.second}${offsetStr}`;\n\n    // ID do evento: \"ID\" + tpEvento + chNFe + nSeqEvento (2 dígitos)\n    const idEvento = `ID${tpEvento}${chaveNFe}${nSeqEvento.toString().padStart(2, \"0\")}`;\n    \n    // DEBUG: Verificar comprimentos\n    console.log(`[DEBUG ID] tpEvento: ${tpEvento} (${tpEvento.length} chars)`);\n    console.log(`[DEBUG ID] chaveNFe: ${chaveNFe} (${chaveNFe.length} chars)`);\n    console.log(`[DEBUG ID] nSeqEvento: ${nSeqEvento.toString().padStart(2, \"0\")} (${nSeqEvento.toString().padStart(2, \"0\").length} chars)`);\n    console.log(`[DEBUG ID] idEvento: ${idEvento} (${idEvento.length} chars, esperado 54)`);\n\n    // Descrição do evento conforme tipo\n    const descEvento = this.getTipoEventoDescricao(tpEvento);\n\n    // XML do evento (detEvento) - CORREÇÃO: adicionar xJust dentro de detEvento inline\n    // Conforme NT 2020.001, detEvento precisa estar dentro de infEvento\n    const xJustXML = justificativa ? `<xJust>${justificativa}</xJust>` : '';\n\n    // PASSO 1: Montar XML do evento (sem assinatura)\n    // CRÍTICO XSD: nSeqEvento elemento usa valor SEM padding (1-99), mas Id usa COM padding (01-99)\n    // TSeqEvento schema: [1-9][0-9]? - não aceita \"01\", apenas \"1\"\n    // CRÍTICO: detEvento DEVE ter xmlns EXPLÍCITO (evita cStat 215)\n    const xmlEventoSemAssinatura = `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<evento xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.00\">\n  <infEvento Id=\"${idEvento}\">\n    <cOrgao>91</cOrgao>\n    <tpAmb>${tpAmb}</tpAmb>\n    <CNPJ>${cnpj}</CNPJ>\n    <chNFe>${chaveNFe}</chNFe>\n    <dhEvento>${dhEvento}</dhEvento>\n    <tpEvento>${tpEvento}</tpEvento>\n    <nSeqEvento>${nSeqEvento}</nSeqEvento>\n    <verEvento>1.00</verEvento>\n    <detEvento versao=\"1.00\" xmlns=\"http://www.portalfiscal.inf.br/nfe\">\n      <descEvento>${descEvento}</descEvento>${xJustXML}\n    </detEvento>\n  </infEvento>\n</evento>`;\n\n    // PASSO 2: Assinar XML do evento (conforme NT 2020.001 P91)\n    console.log('[buildSOAPEnvelopeManifestacao] 🔍 Verificando parâmetros de assinatura...');\n    console.log('[buildSOAPEnvelopeManifestacao] privateKey recebida:', privateKey ? `SIM (${privateKey.substring(0, 50)}...)` : 'NÃO');\n    console.log('[buildSOAPEnvelopeManifestacao] certificate recebido:', certificate ? `SIM (${certificate.substring(0, 50)}...)` : 'NÃO');\n    \n    // Assinar XML (agora sempre obrigatório)\n    console.log('[Manifestação] 🔐 Assinando XML do evento com certificado digital...');\n    const xmlEventoAssinado = signXmlEvento(xmlEventoSemAssinatura, privateKey, certificate);\n    console.log('[Manifestação] ✅ Assinatura digital aplicada com sucesso');\n\n    // PASSO 3: Extrair tag <evento> COMPLETA (incluindo xmlns) do XML assinado\n    // Remove apenas declaração <?xml...?> mas PRESERVA <evento xmlns=\"...\">\n    // CORREÇÃO cStat 215: NT 2020.001 §6.3.1 exige xmlns em <evento>\n    const eventoCompletoMatch = xmlEventoAssinado.match(/<evento[\\s\\S]*<\\/evento>/);\n    if (!eventoCompletoMatch) {\n      throw new Error('Erro ao processar XML assinado: tag <evento> não encontrada');\n    }\n    const eventoCompleto = eventoCompletoMatch[0];\n\n    // PASSO 4: Embutir evento assinado COMPLETO no SOAP envelope\n    // Preserva namespace xmlns=\"http://www.portalfiscal.inf.br/nfe\" do <evento>\n    return `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n                 xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n                 xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\">\n  <soap12:Body>\n    <nfeDadosMsg xmlns=\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeRecepcaoEvento4\">\n      <envEvento xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"1.00\">\n        <idLote>1</idLote>\n        ${eventoCompleto}\n      </envEvento>\n    </nfeDadosMsg>\n  </soap12:Body>\n</soap12:Envelope>`;\n  }\n\n  private async callDistDFe(\n    empresa: Empresa,\n    envelope: string\n  ): Promise<string> {\n    return new Promise(async (resolve, reject) => {\n      try {\n        const url = new URL(ENDPOINTS[empresa.ambiente as \"prod\" | \"hom\"]);\n\n        // Carrega e converte certificado PKCS12 para PEM usando node-forge\n        // Isto resolve o problema \"Unsupported PKCS12 PFX data\" com certificados A1 brasileiros\n        // que usam algoritmos legados (DES/3DES) não suportados por OpenSSL 3.x\n        let certData;\n        try {\n          certData = await loadPKCS12Certificate(\n            empresa.certificadoPath,\n            empresa.certificadoSenha\n          );\n        } catch (error: any) {\n          // Erros do cert-loader já são formatados adequadamente\n          throw error;\n        }\n\n        // Cria agente HTTPS com certificado em formato PEM\n        // PEM é suportado nativamente pelo OpenSSL 3.x, evitando problemas com algoritmos legados\n        // IMPORTANTE: NÃO passamos 'ca' para preservar a trust store padrão do Node.js\n        // HTTPS Agent com certificado cliente A1/A3\n        // IMPORTANTE: rejectUnauthorized=false para aceitar certificados auto-assinados SEFAZ\n        // O certificado do servidor SEFAZ é validado pela raiz ICP-Brasil\n        const agent = new https.Agent({\n          key: certData.key,\n          cert: certData.cert,\n          rejectUnauthorized: false, // Desabilita validação SSL para SEFAZ\n          secureOptions: crypto.constants.SSL_OP_LEGACY_SERVER_CONNECT,\n          minVersion: 'TLSv1.2' as any, // Mínimo TLS 1.2\n          maxVersion: 'TLSv1.3' as any, // Máximo TLS 1.3\n        });\n\n        const options: https.RequestOptions = {\n          hostname: url.hostname,\n          port: 443,\n          path: url.pathname,\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/soap+xml; charset=utf-8; action=\\\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe/nfeDistDFeInteresse\\\"\",\n            \"Content-Length\": Buffer.byteLength(envelope),\n            \"SOAPAction\": \"http://www.portalfiscal.inf.br/nfe/wsdl/NFeDistribuicaoDFe/nfeDistDFeInteresse\",\n          },\n          agent,\n        };\n\n        // ========================================\n        // SOAP REQUEST LOGGING\n        // ========================================\n        console.log('\\n╔═══════════════════════════════════════════════════════════════════════════════╗');\n        console.log('║ SOAP REQUEST - NFeDistribuicaoDFe (Download/Consulta)                        ║');\n        console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n        console.log(`║ Endpoint: ${url.href}`);\n        console.log(`║ Empresa CNPJ: ${empresa.cnpj}`);\n        console.log(`║ Ambiente: ${empresa.ambiente}`);\n        console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n        console.log('║ SOAP ENVELOPE (REQUEST):                                                      ║');\n        console.log('╚═══════════════════════════════════════════════════════════════════════════════╝');\n        console.log(envelope);\n        console.log('╔═══════════════════════════════════════════════════════════════════════════════╗\\n');\n\n        const req = https.request(options, (res) => {\n          let data = \"\";\n          res.on(\"data\", (chunk) => (data += chunk));\n          res.on(\"end\", () => {\n            // ========================================\n            // SOAP RESPONSE LOGGING\n            // ========================================\n            console.log('\\n╔═══════════════════════════════════════════════════════════════════════════════╗');\n            console.log('║ SOAP RESPONSE - NFeDistribuicaoDFe (Download/Consulta)                       ║');\n            console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n            console.log(`║ HTTP Status: ${res.statusCode}`);\n            console.log(`║ Empresa CNPJ: ${empresa.cnpj}`);\n            console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n            console.log('║ SOAP ENVELOPE (RESPONSE):                                                     ║');\n            console.log('╚═══════════════════════════════════════════════════════════════════════════════╝');\n            console.log(data);\n            console.log('╔═══════════════════════════════════════════════════════════════════════════════╗\\n');\n\n            if (res.statusCode && res.statusCode >= 400) {\n              reject(new Error(`HTTP ${res.statusCode}: ${data}`));\n            } else {\n              resolve(data);\n            }\n          });\n        });\n\n        req.on(\"error\", (error) => {\n          reject(new Error(`Erro na requisição HTTPS: ${error.message}`));\n        });\n\n        req.write(envelope);\n        req.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /**\n   * Envia requisição SOAP para NfeDownloadNF (Download de XML Completo)\n   * Endpoint específico para download de XMLs após manifestação\n   */\n  private async callDownloadNFe(\n    empresa: Empresa,\n    envelope: string\n  ): Promise<string> {\n    return new Promise(async (resolve, reject) => {\n      try {\n        const url = new URL(ENDPOINTS_DOWNLOAD_NF[empresa.ambiente as \"prod\" | \"hom\"]);\n\n        let certData;\n        try {\n          certData = await loadPKCS12Certificate(\n            empresa.certificadoPath,\n            empresa.certificadoSenha\n          );\n        } catch (error: any) {\n          throw error;\n        }\n\n        // HTTPS Agent com certificado cliente A1/A3\n        // IMPORTANTE: rejectUnauthorized=false para aceitar certificados auto-assinados SEFAZ\n        const agent = new https.Agent({\n          key: certData.key,\n          cert: certData.cert,\n          rejectUnauthorized: false,\n          secureOptions: crypto.constants.SSL_OP_LEGACY_SERVER_CONNECT,\n          minVersion: 'TLSv1.2' as any,\n          maxVersion: 'TLSv1.3' as any,\n        });\n\n        const options: https.RequestOptions = {\n          hostname: url.hostname,\n          port: 443,\n          path: url.pathname,\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/soap+xml; charset=utf-8\",\n            \"Content-Length\": Buffer.byteLength(envelope),\n          },\n          agent,\n        };\n\n        // ========================================\n        // SOAP REQUEST LOGGING\n        // ========================================\n        console.log('\\n╔═══════════════════════════════════════════════════════════════════════════════╗');\n        console.log('║ SOAP REQUEST - NfeDownloadNF (Download Direto)                               ║');\n        console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n        console.log(`║ Endpoint: ${url.href}`);\n        console.log(`║ Empresa CNPJ: ${empresa.cnpj}`);\n        console.log(`║ Ambiente: ${empresa.ambiente}`);\n        console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n        console.log('║ SOAP ENVELOPE (REQUEST):                                                      ║');\n        console.log('╚═══════════════════════════════════════════════════════════════════════════════╝');\n        console.log(envelope);\n        console.log('╔═══════════════════════════════════════════════════════════════════════════════╗\\n');\n\n        const req = https.request(options, (res) => {\n          let data = \"\";\n          res.on(\"data\", (chunk) => (data += chunk));\n          res.on(\"end\", () => {\n            // ========================================\n            // SOAP RESPONSE LOGGING\n            // ========================================\n            console.log('\\n╔═══════════════════════════════════════════════════════════════════════════════╗');\n            console.log('║ SOAP RESPONSE - NfeDownloadNF (Download Direto)                              ║');\n            console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n            console.log(`║ HTTP Status: ${res.statusCode}`);\n            console.log(`║ Empresa CNPJ: ${empresa.cnpj}`);\n            console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n            console.log('║ SOAP ENVELOPE (RESPONSE):                                                     ║');\n            console.log('╚═══════════════════════════════════════════════════════════════════════════════╝');\n            console.log(data);\n            console.log('╔═══════════════════════════════════════════════════════════════════════════════╗\\n');\n\n            if (res.statusCode && res.statusCode >= 400) {\n              reject(new Error(`HTTP ${res.statusCode}: ${data}`));\n            } else {\n              resolve(data);\n            }\n          });\n        });\n\n        req.on(\"error\", (error) => {\n          reject(new Error(`Erro na requisição HTTPS NfeDownloadNF: ${error.message}`));\n        });\n\n        req.write(envelope);\n        req.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /**\n   * Envia requisição SOAP para NFeRecepcaoEvento (Manifestação do Destinatário)\n   * Conforme NT 2020.001\n   */\n  private async callRecepcaoEvento(\n    empresa: Empresa,\n    envelope: string\n  ): Promise<string> {\n    return new Promise(async (resolve, reject) => {\n      try {\n        const url = new URL(ENDPOINTS_RECEPCAO_EVENTO[empresa.ambiente as \"prod\" | \"hom\"]);\n        console.log(`[callRecepcaoEvento] 🌐 Endpoint manifestação (${empresa.ambiente}):`, url.href);\n        console.log('[callRecepcaoEvento] 📋 ENDPOINTS_RECEPCAO_EVENTO:', JSON.stringify(ENDPOINTS_RECEPCAO_EVENTO, null, 2));\n\n        let certData;\n        try {\n          certData = await loadPKCS12Certificate(\n            empresa.certificadoPath,\n            empresa.certificadoSenha\n          );\n        } catch (error: any) {\n          throw error;\n        }\n\n        // HTTPS Agent com certificado cliente A1/A3\n        // IMPORTANTE: rejectUnauthorized=false para aceitar certificados auto-assinados SEFAZ\n        const agent = new https.Agent({\n          key: certData.key,\n          cert: certData.cert,\n          rejectUnauthorized: false, // Desabilita validação SSL para SEFAZ\n          secureOptions: crypto.constants.SSL_OP_LEGACY_SERVER_CONNECT,\n          minVersion: 'TLSv1.2' as any,\n          maxVersion: 'TLSv1.3' as any,\n        });\n\n        const options: https.RequestOptions = {\n          hostname: url.hostname,\n          port: 443,\n          path: url.pathname,\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/soap+xml; charset=utf-8; action=\\\"http://www.portalfiscal.inf.br/nfe/wsdl/NFeRecepcaoEvento4/nfeRecepcaoEvento\\\"\",\n            \"Content-Length\": Buffer.byteLength(envelope),\n            \"SOAPAction\": \"http://www.portalfiscal.inf.br/nfe/wsdl/NFeRecepcaoEvento4/nfeRecepcaoEvento\",\n          },\n          agent,\n        };\n\n        // ========================================\n        // SOAP REQUEST LOGGING\n        // ========================================\n        console.log('\\n╔═══════════════════════════════════════════════════════════════════════════════╗');\n        console.log('║ SOAP REQUEST - NFeRecepcaoEvento (MANIFESTAÇÃO)                              ║');\n        console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n        console.log(`║ Endpoint: ${url.href}`);\n        console.log(`║ Empresa CNPJ: ${empresa.cnpj}`);\n        console.log(`║ Ambiente: ${empresa.ambiente}`);\n        console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n        console.log('║ SOAP ENVELOPE (REQUEST):                                                      ║');\n        console.log('╚═══════════════════════════════════════════════════════════════════════════════╝');\n        console.log(envelope);\n        console.log('╔═══════════════════════════════════════════════════════════════════════════════╗\\n');\n\n        const req = https.request(options, (res) => {\n          let data = \"\";\n          res.on(\"data\", (chunk) => (data += chunk));\n          res.on(\"end\", () => {\n            // ========================================\n            // SOAP RESPONSE LOGGING\n            // ========================================\n            console.log('\\n╔═══════════════════════════════════════════════════════════════════════════════╗');\n            console.log('║ SOAP RESPONSE - NFeRecepcaoEvento (MANIFESTAÇÃO)                             ║');\n            console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n            console.log(`║ HTTP Status: ${res.statusCode}`);\n            console.log(`║ Empresa CNPJ: ${empresa.cnpj}`);\n            console.log('╠═══════════════════════════════════════════════════════════════════════════════╣');\n            console.log('║ SOAP ENVELOPE (RESPONSE):                                                     ║');\n            console.log('╚═══════════════════════════════════════════════════════════════════════════════╝');\n            console.log(data);\n            console.log('╔═══════════════════════════════════════════════════════════════════════════════╗\\n');\n\n            if (res.statusCode && res.statusCode >= 400) {\n              reject(new Error(`HTTP ${res.statusCode}: ${data}`));\n            } else {\n              resolve(data);\n            }\n          });\n        });\n\n        req.on(\"error\", (error) => {\n          reject(new Error(`Erro na requisição HTTPS: ${error.message}`));\n        });\n\n        req.write(envelope);\n        req.end();\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  private parseSOAPResponse(xmlResponse: string): SefazResponse {\n    const parsed = this.parser.parse(xmlResponse);\n\n    // Navega pela estrutura SOAP - suporta múltiplos namespaces\n    const envelope = \n      parsed[\"soap12:Envelope\"] || \n      parsed[\"soap:Envelope\"] ||\n      parsed[\"Envelope\"];\n    \n    if (!envelope) {\n      console.error('❌ Envelope SOAP não encontrado');\n      return { cStat: \"\", xMotivo: \"Envelope SOAP não encontrado\", docZips: [] };\n    }\n    \n    const body = \n      envelope[\"soap12:Body\"] || \n      envelope[\"soap:Body\"] ||\n      envelope[\"Body\"];\n    \n    if (!body) {\n      console.error('❌ Body SOAP não encontrado');\n      return { cStat: \"\", xMotivo: \"Body SOAP não encontrado\", docZips: [] };\n    }\n    \n    const response =\n      body[\"nfeDistDFeInteresseResponse\"] ||\n      body[\"nfe:nfeDistDFeInteresseResponse\"];\n    \n    if (!response) {\n      console.error('❌ nfeDistDFeInteresseResponse não encontrada');\n      return { cStat: \"\", xMotivo: \"Response não encontrada\", docZips: [] };\n    }\n    \n    const result = \n      response[\"nfeDistDFeInteresseResult\"] || \n      response[\"nfe:nfeDistDFeInteresseResult\"];\n    \n    if (!result) {\n      console.error('❌ nfeDistDFeInteresseResult não encontrado');\n      return { cStat: \"\", xMotivo: \"Result não encontrado\", docZips: [] };\n    }\n    \n    // Tenta encontrar retDistDFeInt em várias estruturas possíveis\n    const retDistDFeInt = \n      result[\"retDistDFeInt\"] || \n      result[\"nfe:retDistDFeInt\"] ||\n      body[\"retDistDFeInt\"] ||\n      body[\"nfe:retDistDFeInt\"] ||\n      parsed[\"retDistDFeInt\"];\n\n    if (!retDistDFeInt) {\n      console.error('❌ retDistDFeInt não encontrado');\n      return { cStat: \"\", xMotivo: \"retDistDFeInt não encontrado\", docZips: [] };\n    }\n\n    const cStat = String(retDistDFeInt.cStat || \"\");\n    const xMotivo = String(retDistDFeInt.xMotivo || \"\");\n    const ultNSU = String(retDistDFeInt.ultNSU || \"\");\n    const maxNSU = String(retDistDFeInt.maxNSU || \"\");\n\n    let docZips: Array<{ NSU: string; schema: string; content: string }> = [];\n    const lote = retDistDFeInt.loteDistDFeInt;\n\n    if (lote?.docZip) {\n      const docs = Array.isArray(lote.docZip) ? lote.docZip : [lote.docZip];\n      docZips = docs.map((doc: any) => ({\n        NSU: doc.NSU || doc[\"@_NSU\"] || \"\",\n        schema: doc.schema || doc[\"@_schema\"] || \"\",\n        content: doc[\"#text\"] || doc[\"_text\"] || \"\",\n      }));\n    }\n\n    return { cStat, xMotivo, ultNSU, maxNSU, docZips };\n  }\n\n  private decompressDocZip(base64Content: string): string {\n    try {\n      const buffer = Buffer.from(base64Content, \"base64\");\n      console.log(`[Descompressão] Base64 → Buffer: ${buffer.length} bytes`);\n      \n      // CRÍTICO: pako.ungzip retorna Uint8Array, precisamos converter para string\n      const decompressed = pako.ungzip(buffer);\n      const xmlString = Buffer.from(decompressed).toString(\"utf-8\");\n      \n      console.log(`[Descompressão] GZIP → XML: ${xmlString.length} caracteres`);\n      console.log(`[Descompressão] Primeiros 100 chars: ${xmlString.substring(0, 100)}`);\n      \n      return xmlString;\n    } catch (error) {\n      console.warn(`[Descompressão] ERRO pako.ungzip: ${error} - tentando decode base64 direto`);\n      // Se falhar descompactação, talvez já esteja descompactado\n      const decoded = Buffer.from(base64Content, \"base64\").toString(\"utf-8\");\n      console.log(`[Descompressão] Base64 direto: ${decoded.length} caracteres`);\n      console.log(`[Descompressão] Primeiros 100 chars: ${decoded.substring(0, 100)}`);\n      return decoded;\n    }\n  }\n\n  /**\n   * Processa e salva documento baseado no schema (nfeProc, resNFe)\n   * FILTRO: Ignora procEventoNFe e resEvento (eventos são gerenciados internamente)\n   * Conforme NT 2014.002 §3.3 e MOC 7.0 §2.2\n   * \n   * IMPORTANTE: SEFAZ retorna schemas SEM namespace (ex: \"resNFe\" não \"http://...resNFe\")\n   */\n  private async processDocument(\n    xmlContent: string,\n    schema: string,\n    empresa: Empresa,\n    sincronizacaoId: string,\n    nsu: string\n  ): Promise<void> {\n    const parsed = this.parser.parse(xmlContent);\n\n    // Schema normalization: SEFAZ retorna apenas nome sem namespace\n    const schemaLower = schema.toLowerCase();\n    \n    if (schemaLower.includes(\"nfeproc\")) {\n      await this.saveNFeProc(parsed, xmlContent, empresa, sincronizacaoId);\n    } else if (schemaLower.includes(\"resnfe\")) {\n      await this.saveResNFe(parsed, xmlContent, empresa, sincronizacaoId, nsu);\n    } else if (schemaLower.includes(\"proceventonfe\")) {\n      // FILTRO: Não salva procEventoNFe (eventos são gerenciados pela tabela manifestacoes)\n      console.log(`[SEFAZ] Ignorando procEventoNFe NSU ${nsu} (eventos gerenciados internamente)`);\n    } else if (schemaLower.includes(\"resevento\")) {\n      // FILTRO: Não salva resEvento (resumos de eventos não são necessários)\n      console.log(`[SEFAZ] Ignorando resEvento NSU ${nsu} (resumos de eventos não exibidos)`);\n    } else {\n      console.warn(`Schema desconhecido: ${schema} - NSU ${nsu}`);\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId,\n        nivel: \"warning\",\n        mensagem: `Schema XML não reconhecido`,\n        detalhes: JSON.stringify({ schema, nsu }),\n      });\n    }\n  }\n\n  /**\n   * Salva XML completo de NF-e/NFC-e (nfeProc)\n   * MOC 7.0 §2.2: Modelo 55 (NF-e) e Modelo 65 (NFC-e)\n   */\n  private async saveNFeProc(\n    parsed: any,\n    xmlContent: string,\n    empresa: Empresa,\n    sincronizacaoId: string\n  ): Promise<void> {\n    const nfeProc = parsed.nfeProc;\n    if (!nfeProc) throw new Error(\"XML não é um nfeProc\");\n\n    const protNFe = nfeProc.protNFe;\n    const NFe = nfeProc.NFe;\n    const infNFe = NFe?.infNFe;\n    const ide = infNFe?.ide;\n\n    const chNFe = protNFe?.infProt?.chNFe || \"\";\n    const numeroNF = ide?.nNF || \"\";\n    const dhEmi = ide?.dhEmi || ide?.dEmi || new Date().toISOString();\n    const modelo = ide?.mod || \"55\"; // MOC 7.0 §2.2: 55=NF-e, 65=NFC-e\n\n    if (!chNFe || !numeroNF) {\n      throw new Error(\"Não foi possível extrair chave ou número da NF-e/NFC-e\");\n    }\n\n    // Estrutura: xmls/NFe|NFCe/CNPJ/ANO/MES/numeroNF.xml\n    // CORREÇÃO: Garantir que dataEmissao seja Date válido\n    const dataEmissao = dhEmi instanceof Date ? dhEmi : new Date(dhEmi);\n    if (isNaN(dataEmissao.getTime())) {\n      throw new Error(`Data de emissão inválida: ${dhEmi}`);\n    }\n    const ano = dataEmissao.getFullYear();\n    const mes = (dataEmissao.getMonth() + 1).toString().padStart(2, \"0\");\n    const tipoDoc = modelo === \"65\" ? \"NFCe\" : \"NFe\";\n\n    const filename = `${parseInt(numeroNF)}.xml`;\n    const relativePath = path.join(tipoDoc, empresa.cnpj, `${ano}`, mes, filename);\n\n    console.log(`[Salvamento] Salvando XML: ${relativePath} (${empresa.tipoArmazenamento})`);\n    console.log(`[Salvamento] Tamanho do conteúdo: ${xmlContent.length} caracteres`);\n    \n    // Salva usando storage híbrido (local ou supabase)\n    const caminhoCompleto = await xmlStorageService.saveXml(\n      empresa.tipoArmazenamento,\n      relativePath,\n      xmlContent\n    );\n    \n    const tamanhoBytes = Buffer.byteLength(xmlContent, \"utf-8\");\n    console.log(`[Salvamento] Arquivo salvo: ${tamanhoBytes} bytes em ${caminhoCompleto}`);\n\n    await storage.createXml({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      chaveNFe: chNFe,\n      numeroNF: numeroNF.toString(),\n      modelo: modelo.toString(),\n      tipoDocumento: \"nfeProc\",\n      dataEmissao,\n      caminhoArquivo: caminhoCompleto,\n      tamanhoBytes,\n      statusDownload: \"completo\", // XML completo já obtido\n      tentativasDownload: 0,\n    });\n\n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      nivel: \"info\",\n      mensagem: `XML salvo: ${tipoDoc} ${numeroNF}`,\n      detalhes: JSON.stringify({ \n        chNFe, \n        caminhoArquivo: caminhoCompleto,\n        modelo,\n        tamanhoBytes,\n        tipoArmazenamento: empresa.tipoArmazenamento\n      }),\n    });\n  }\n\n  /**\n   * Salva resumo de NF-e/NFC-e (resNFe)\n   * NT 2014.002 §3.3: Quando destinatário não tem direito ao XML completo\n   * \n   * IMPORTANTE: Modelo é extraído da CHAVE NFe (posições 20-22), NÃO do tpNF!\n   * - tpNF = tipo operação (0=entrada, 1=saída)\n   * - Modelo na chave: posições 20-22 (55=NF-e, 65=NFC-e)\n   */\n  private async saveResNFe(\n    parsed: any,\n    xmlContent: string,\n    empresa: Empresa,\n    sincronizacaoId: string,\n    nsu: string\n  ): Promise<void> {\n    const resNFe = parsed.resNFe;\n    if (!resNFe) throw new Error(\"XML não é um resNFe\");\n\n    // FIX: Garantir que chNFe seja sempre string (pode vir como array, objeto ou NÚMERO do parser XML)\n    const chNFeRaw = resNFe.chNFe;\n    let chNFe = \"\";\n    \n    if (Array.isArray(chNFeRaw)) {\n      chNFe = String(chNFeRaw[0] || \"\");\n    } else if (typeof chNFeRaw === \"number\") {\n      // CRÍTICO: Parser XML converte chaves grandes em number (notação científica)\n      chNFe = chNFeRaw.toFixed(0);\n    } else {\n      chNFe = String(chNFeRaw || \"\");\n    }\n    \n    const dhEmi = resNFe.dhEmi || new Date().toISOString();\n    \n    if (!chNFe || chNFe.length < 44) {\n      console.error(\"[ERRO resNFe] chNFe inválido:\", { chNFe, length: chNFe.length, chNFeRaw, tipo: typeof chNFeRaw });\n      throw new Error(`Chave de acesso inválida no resNFe (recebido: \"${chNFe}\", length: ${chNFe.length})`);\n    }\n\n    // Extrai modelo da chave (posições 20-22): \"55\" ou \"65\"\n    // Formato chave: UF(2) + AAMM(6) + CNPJ(14) + MOD(2) + ...\n    const modelo = chNFe.substring(20, 22) || \"55\";\n\n    // Estrutura: xmls/NFe|NFCe/CNPJ/ANO/MES/Resumos/CHAVEnsu_NSU.xml\n    // CORREÇÃO: Garantir que dataEmissao seja Date válido\n    const dataEmissao = dhEmi instanceof Date ? dhEmi : new Date(dhEmi);\n    if (isNaN(dataEmissao.getTime())) {\n      throw new Error(`Data de emissão inválida no resNFe: ${dhEmi}`);\n    }\n    const ano = dataEmissao.getFullYear();\n    const mes = (dataEmissao.getMonth() + 1).toString().padStart(2, \"0\");\n    const tipoDoc = modelo === \"65\" ? \"NFCe\" : \"NFe\";\n\n    const filename = `${chNFe}_nsu${nsu}.xml`;\n    const relativePath = path.join(tipoDoc, empresa.cnpj, `${ano}`, mes, \"Resumos\", filename);\n\n    const caminhoCompleto = await xmlStorageService.saveXml(\n      empresa.tipoArmazenamento,\n      relativePath,\n      xmlContent\n    );\n    const tamanhoBytes = Buffer.byteLength(xmlContent, \"utf-8\");\n\n    // Salva resNFe e marca como pendente para download do XML completo\n    await storage.createXml({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      chaveNFe: chNFe,\n      numeroNF: chNFe.substring(25, 34), // Extrai número da chave\n      modelo: modelo.toString(),\n      tipoDocumento: \"resNFe\",\n      dataEmissao,\n      caminhoArquivo: caminhoCompleto,\n      tamanhoBytes,\n      statusDownload: \"pendente\", // Marca para download automático do XML completo\n      tentativasDownload: 0,\n    });\n\n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      nivel: \"info\",\n      mensagem: `Resumo salvo: ${tipoDoc} (resNFe)`,\n      detalhes: JSON.stringify({ chNFe, caminhoArquivo: caminhoCompleto, modelo, nsu }),\n    });\n\n    // FASE 4: Manifestação automática do destinatário (NT 2020.001)\n    // Se manifestacaoAutomatica está ativa, manifesta Ciência (210210) automaticamente\n    // IMPORTANTE: Só manifesta se empresa for o DESTINATÁRIO (não emitente)\n    if (empresa.manifestacaoAutomatica) {\n      try {\n        // Validação crítica: Empresa deve ser o destinatário (CNPJ/CPF deve coincidir)\n        const cnpjDest = String(resNFe.CNPJ || \"\");\n        const cpfDest = String(resNFe.CPF || \"\");\n        const empresaCNPJ = empresa.cnpj.replace(/\\D/g, \"\"); // Remove formatação\n        \n        const isDestinatario = cnpjDest === empresaCNPJ || cpfDest === empresaCNPJ;\n        \n        if (!isDestinatario) {\n          console.log(`[Manifestação Automática] SKIPPED - Empresa não é destinatária (chave ${chNFe})`);\n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId,\n            nivel: \"info\",\n            mensagem: `Manifestação automática não aplicável - empresa não é destinatária`,\n            detalhes: JSON.stringify({ \n              chNFe,\n              cnpjEmpresa: empresaCNPJ,\n              cnpjDest,\n              cpfDest,\n              observacao: \"resNFe não representa operação onde empresa é destinatária\"\n            }),\n          });\n          return; // Sai do método sem manifestar\n        }\n        \n        console.log(`[Manifestação Automática] Empresa é destinatária - iniciando Ciência para chave ${chNFe}`);\n        \n        // Verifica se já foi manifestada antes\n        const manifestacaoExistente = await storage.getManifestacaoByChave(chNFe, empresa.userId);\n        \n        if (manifestacaoExistente) {\n          console.log(`[Manifestação Automática] Chave ${chNFe} já possui manifestação (${manifestacaoExistente.tipoEvento})`);\n        } else {\n          // Manifesta Ciência da Operação (210210)\n          await this.manifestarEvento(\n            empresa,\n            chNFe,\n            TIPOS_MANIFESTACAO.CIENCIA,\n            undefined // Ciência não requer justificativa\n          );\n          \n          console.log(`[Manifestação Automática] ✅ Ciência manifestada com sucesso para ${chNFe}`);\n        }\n      } catch (error) {\n        // Erro na manifestação NÃO deve interromper sincronização\n        console.error(`[Manifestação Automática] ❌ Erro ao manifestar ${chNFe}:`, error);\n        \n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId,\n          nivel: \"warning\",\n          mensagem: `Erro na manifestação automática para chave ${chNFe}`,\n          detalhes: JSON.stringify({ \n            chNFe, \n            error: String(error),\n            observacao: \"Erro não interrompeu sincronização. Manifestação pode ser feita manualmente.\"\n          }),\n        });\n      }\n    }\n  }\n\n  /**\n   * Salva evento de NF-e/NFC-e (procEventoNFe)\n   * NT 2014.002 §3.3: Cancelamento, CCe, Manifestação, etc\n   */\n  private async saveProcEvento(\n    parsed: any,\n    xmlContent: string,\n    empresa: Empresa,\n    sincronizacaoId: string,\n    nsu: string\n  ): Promise<void> {\n    const procEvento = parsed.procEventoNFe;\n    if (!procEvento) throw new Error(\"XML não é um procEventoNFe\");\n\n    const evento = procEvento.evento;\n    const infEvento = evento?.infEvento;\n    \n    // FIX: Garantir que chNFe seja sempre string (pode vir como array, objeto ou NÚMERO do parser XML)\n    const chNFeRaw = infEvento?.chNFe;\n    let chNFe = \"\";\n    \n    if (Array.isArray(chNFeRaw)) {\n      chNFe = String(chNFeRaw[0] || \"\");\n    } else if (typeof chNFeRaw === \"number\") {\n      // CRÍTICO: Parser XML converte chaves grandes em number (notação científica)\n      chNFe = chNFeRaw.toFixed(0);\n    } else {\n      chNFe = String(chNFeRaw || \"\");\n    }\n    \n    const tpEvento = String(infEvento?.tpEvento || \"\");\n    const dhEvento = infEvento?.dhEvento || new Date().toISOString();\n    const nSeqEvento = String(infEvento?.nSeqEvento || \"1\");\n\n    if (!chNFe || chNFe.length < 44) {\n      console.error(\"[ERRO procEventoNFe] chNFe inválido:\", { chNFe, length: chNFe.length, chNFeRaw, tipo: typeof chNFeRaw });\n      throw new Error(`Chave de acesso inválida no procEventoNFe (recebido: \"${chNFe}\", length: ${chNFe.length})`);\n    }\n\n    // Estrutura: xmls/NFe|NFCe/CNPJ/ANO/MES/Eventos/CHAVE_tpEvento_seq.xml\n    // CORREÇÃO: Garantir que dataEmissao seja Date válido\n    const dataEmissao = dhEvento instanceof Date ? dhEvento : new Date(dhEvento);\n    if (isNaN(dataEmissao.getTime())) {\n      throw new Error(`Data de evento inválida no procEventoNFe: ${dhEvento}`);\n    }\n    const ano = dataEmissao.getFullYear();\n    const mes = (dataEmissao.getMonth() + 1).toString().padStart(2, \"0\");\n    \n    // Detecta modelo pela chave (posição 20-21)\n    const modelo = chNFe.substring(20, 22) || \"55\";\n    const tipoDoc = modelo === \"65\" ? \"NFCe\" : \"NFe\";\n\n    const filename = `${chNFe}_${tpEvento}_seq${nSeqEvento}_nsu${nsu}.xml`;\n    const relativePath = path.join(tipoDoc, empresa.cnpj, `${ano}`, mes, \"Eventos\", filename);\n\n    const caminhoCompleto = await xmlStorageService.saveXml(\n      empresa.tipoArmazenamento,\n      relativePath,\n      xmlContent\n    );\n    const tamanhoBytes = Buffer.byteLength(xmlContent, \"utf-8\");\n\n    await storage.createXml({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      chaveNFe: chNFe,\n      numeroNF: chNFe.substring(25, 34), // Extrai número da chave\n      modelo: modelo.toString(),\n      tipoDocumento: \"procEventoNFe\",\n      dataEmissao,\n      caminhoArquivo: caminhoCompleto,\n      tamanhoBytes,\n    });\n\n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      nivel: \"info\",\n      mensagem: `Evento salvo: ${tipoDoc} (${this.getTipoEventoDescricao(tpEvento)})`,\n      detalhes: JSON.stringify({ chNFe, tpEvento, caminhoArquivo: caminhoCompleto, nsu }),\n    });\n  }\n\n  /**\n   * Salva resumo de evento (resEvento)\n   * NT 2014.002 §3.3\n   */\n  private async saveResEvento(\n    parsed: any,\n    xmlContent: string,\n    empresa: Empresa,\n    sincronizacaoId: string,\n    nsu: string\n  ): Promise<void> {\n    const resEvento = parsed.resEvento;\n    if (!resEvento) throw new Error(\"XML não é um resEvento\");\n\n    // FIX: Garantir que chNFe seja sempre string (pode vir como array, objeto ou NÚMERO do parser XML)\n    const chNFeRaw = resEvento.chNFe;\n    let chNFe = \"\";\n    \n    if (Array.isArray(chNFeRaw)) {\n      chNFe = String(chNFeRaw[0] || \"\");\n    } else if (typeof chNFeRaw === \"number\") {\n      // CRÍTICO: Parser XML converte chaves grandes em number (notação científica)\n      // Exemplo: 42251149531261000107... vira 4.2251149531261e+43\n      // Solução: usar toFixed(0) para preservar TODOS os dígitos\n      chNFe = chNFeRaw.toFixed(0);\n    } else {\n      chNFe = String(chNFeRaw || \"\");\n    }\n    \n    const tpEvento = String(resEvento.tpEvento || \"\");\n    const dhEvento = resEvento.dhEvento || resEvento.dhRecbto || new Date().toISOString();\n\n    if (!chNFe || chNFe.length < 44) {\n      console.error(\"[ERRO resEvento] chNFe inválido:\", { chNFe, length: chNFe.length, chNFeRaw, tipo: typeof chNFeRaw });\n      throw new Error(`Chave de acesso inválida no resEvento (recebido: \"${chNFe}\", length: ${chNFe.length})`);\n    }\n\n    // Estrutura: xmls/NFe|NFCe/CNPJ/ANO/MES/Eventos/Resumos/CHAVE_tpEvento_nsu.xml\n    // CORREÇÃO: Garantir que dataEmissao seja Date válido\n    const dataEmissao = dhEvento instanceof Date ? dhEvento : new Date(dhEvento);\n    if (isNaN(dataEmissao.getTime())) {\n      throw new Error(`Data de evento inválida no resEvento: ${dhEvento}`);\n    }\n    const ano = dataEmissao.getFullYear();\n    const mes = (dataEmissao.getMonth() + 1).toString().padStart(2, \"0\");\n    \n    const modelo = chNFe.substring(20, 22) || \"55\";\n    const tipoDoc = modelo === \"65\" ? \"NFCe\" : \"NFe\";\n\n    const filename = `${chNFe}_${tpEvento}_nsu${nsu}.xml`;\n    const relativePath = path.join(tipoDoc, empresa.cnpj, `${ano}`, mes, \"Eventos\", \"Resumos\", filename);\n\n    const caminhoCompleto = await xmlStorageService.saveXml(\n      empresa.tipoArmazenamento,\n      relativePath,\n      xmlContent\n    );\n    const tamanhoBytes = Buffer.byteLength(xmlContent, \"utf-8\");\n\n    await storage.createXml({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      chaveNFe: chNFe,\n      numeroNF: chNFe.substring(25, 34),\n      modelo: modelo.toString(),\n      tipoDocumento: \"resEvento\",\n      dataEmissao,\n      caminhoArquivo: caminhoCompleto,\n      tamanhoBytes,\n    });\n\n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId,\n      nivel: \"info\",\n      mensagem: `Resumo de evento salvo: ${tipoDoc} (${this.getTipoEventoDescricao(tpEvento)})`,\n      detalhes: JSON.stringify({ chNFe, tpEvento, caminhoArquivo: caminhoCompleto, nsu }),\n    });\n  }\n\n  /**\n   * Retorna descrição oficial do tipo de evento\n   * CORREÇÃO CRÍTICA: Exemplos oficiais usam SEM ACENTOS mesmo que NT 2020.001 Tabela 3.1 mostre com acentos\n   * Causa raiz cStat 215: Schema XSD valida contra strings EXATAS sem acentuação\n   */\n  private getTipoEventoDescricao(tpEvento: string): string {\n    const tipos: Record<string, string> = {\n      \"110110\": \"Carta de Correcao\",\n      \"110111\": \"Cancelamento\",\n      \"210200\": \"Confirmacao da Operacao\",\n      \"210210\": \"Ciencia da Operacao\",\n      \"210220\": \"Desconhecimento da Operacao\",\n      \"210240\": \"Operacao nao Realizada\",\n    };\n    return tipos[tpEvento] || `Evento ${tpEvento}`;\n  }\n\n  /**\n   * Baixa XML completo usando NFeDistribuicaoDFe (consChNFe)\n   * Conforme NT 2014.002 e documentação oficial da Fazenda\n   * \n   * Uso: Baixar XML completo (nfeProc) quando só temos resumo (resNFe)\n   * Retorna o XML em formato <docZip> (Base64 + GZip) que é descompactado automaticamente\n   * \n   * @param chaveNFe - Chave de acesso de 44 dígitos\n   * @param empresa - Dados da empresa\n   * @returns Objeto com xmlContent e cStat, ou null se não encontrado\n   */\n  async consultarChave(chaveNFe: string, empresa: Empresa): Promise<{ xmlContent: string; cStat: string } | null> {\n    try {\n      console.log(`[consultarChave] Baixando XML completo ${chaveNFe} para empresa ${empresa.cnpj}`);\n\n      // Usa método oficial: NFeDistribuicaoDFe com consChNFe\n      const envelope = this.buildSOAPEnvelopeConsChNFe(\n        empresa.cnpj,\n        empresa.uf,\n        empresa.ambiente,\n        chaveNFe\n      );\n\n      // Usa endpoint NFeDistribuicaoDFe (mesmo da sincronização)\n      const responseXML = await this.callDistDFe(empresa, envelope);\n      \n      // Log da resposta completa para debug\n      console.log(`[consultarChave] Resposta SOAP recebida (primeiros 500 chars): ${responseXML.substring(0, 500)}`);\n      \n      const parsed = this.parser.parse(responseXML);\n\n      // Extrai retorno do NFeDistribuicaoDFe\n      // Estrutura: soap12:Envelope > soap12:Body > nfeDistDFeInteresseResponse > nfeDistDFeInteresseResult > retDistDFeInt\n      const envelope_soap = parsed[\"soap12:Envelope\"] || parsed[\"soap:Envelope\"] || parsed[\"Envelope\"];\n      if (!envelope_soap) {\n        console.error('[consultarChave] ❌ Envelope SOAP não encontrado. Keys:', Object.keys(parsed));\n        throw new Error(\"Resposta SEFAZ inválida: Envelope SOAP não encontrado\");\n      }\n      \n      const body = envelope_soap[\"soap12:Body\"] || envelope_soap[\"soap:Body\"] || envelope_soap[\"Body\"];\n      if (!body) {\n        console.error('[consultarChave] ❌ Body SOAP não encontrado. Keys envelope:', Object.keys(envelope_soap));\n        throw new Error(\"Resposta SEFAZ inválida: Body SOAP não encontrado\");\n      }\n      \n      // Busca nfeDistDFeInteresseResult\n      const nfeDistDFeInteresseResult = \n        body[\"nfeDistDFeInteresseResult\"] || \n        body[\"nfeDistDFeInteresseResponse\"]?.[\"nfeDistDFeInteresseResult\"];\n      \n      if (!nfeDistDFeInteresseResult) {\n        console.error('[consultarChave] ❌ nfeDistDFeInteresseResult não encontrado. Keys body:', Object.keys(body));\n        throw new Error(\"Resposta SEFAZ inválida: nfeDistDFeInteresseResult não encontrado\");\n      }\n      \n      const retDistDFeInt = nfeDistDFeInteresseResult[\"retDistDFeInt\"];\n      if (!retDistDFeInt) {\n        console.error('[consultarChave] ❌ retDistDFeInt não encontrado. Keys:', Object.keys(nfeDistDFeInteresseResult));\n        throw new Error(\"Resposta SEFAZ inválida: retDistDFeInt não encontrado\");\n      }\n      \n      const cStat = String(retDistDFeInt.cStat || \"\");\n      const xMotivo = String(retDistDFeInt.xMotivo || \"\");\n\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        nivel: \"info\",\n        mensagem: `consultarChave: ${cStat} - ${xMotivo}`,\n        detalhes: JSON.stringify({ chaveNFe, cStat }),\n      });\n\n      // cStat 138: Documento localizado (XML completo disponível)\n      if (cStat === \"138\" && retDistDFeInt.loteDistDFeInt) {\n        const lote = retDistDFeInt.loteDistDFeInt;\n        let docZip = lote.docZip;\n        \n        // Caso legítimo: SEFAZ pode retornar cStat 138 sem docZip (resNFe only)\n        // Retornar null permite fallback para NfeDownloadNF\n        if (!docZip) {\n          console.log('[consultarChave] cStat 138 sem docZip - possível resNFe only - retornando null para fallback');\n          return null;\n        }\n\n        // CORREÇÃO: docZip pode vir como array se houver múltiplos documentos\n        // Pegar apenas o primeiro documento nesse caso\n        if (Array.isArray(docZip)) {\n          if (docZip.length === 0) {\n            console.error('[consultarChave] ❌ docZip é array vazia');\n            throw new Error('SEFAZ retornou docZip array vazia - sem documentos disponíveis');\n          }\n          console.log(`[consultarChave] docZip é array com ${docZip.length} documentos - usando primeiro`);\n          docZip = docZip[0];\n        }\n\n        // CORREÇÃO: docZip pode ser Object {NSU, schema, #text} ou string Base64\n        // Extrair conteúdo Base64 do objeto se necessário\n        let base64Content: string;\n        if (typeof docZip === 'string') {\n          base64Content = docZip;\n        } else if (typeof docZip === 'object') {\n          // XML parser retorna: { \"@_NSU\": \"...\", \"@_schema\": \"...\", \"#text\": \"base64...\" }\n          base64Content = docZip['#text'] || docZip['_text'] || '';\n          if (base64Content) {\n            console.log('[consultarChave] docZip é objeto - extraído #text:', base64Content.substring(0, 50) + '...');\n          }\n        } else {\n          console.error('[consultarChave] ❌ docZip tipo inválido:', typeof docZip, '- Dados:', JSON.stringify(docZip));\n          throw new Error(`docZip tipo inválido: ${typeof docZip} - esperado string, object ou array`);\n        }\n\n        // Validar conteúdo Base64 antes de tentar decodificar\n        // CRÍTICO: Lançar exceção ao invés de retornar null para evitar mascarar falhas\n        if (!base64Content || base64Content.trim().length === 0) {\n          console.error('[consultarChave] ❌ Conteúdo Base64 vazio - docZip:', JSON.stringify(docZip));\n          throw new Error(`docZip mal formado: #text/_text não encontrado ou vazio (chave: ${chaveNFe})`);\n        }\n\n        try {\n          // docZip vem como Base64 + GZip\n          // 1. Decodifica Base64\n          const gzipBuffer = Buffer.from(base64Content, 'base64');\n          \n          // 2. Descompacta GZip\n          const xmlContent = pako.ungzip(gzipBuffer, { to: 'string' });\n          \n          const parsedXML = this.parser.parse(xmlContent);\n\n          // Verifica se é nfeProc (XML completo)\n          if (parsedXML.nfeProc) {\n            console.log(`[consultarChave] ✓ XML completo baixado para chave ${chaveNFe}`);\n            return { xmlContent, cStat };\n          } else {\n            console.warn(`[consultarChave] Chave ${chaveNFe} retornou documento que não é nfeProc:`, Object.keys(parsedXML));\n            return null;\n          }\n        } catch (error: any) {\n          console.error(`[consultarChave] ❌ Erro ao descompactar docZip: ${error.message}`);\n          throw new Error(`Falha ao descompactar XML: ${error.message}`);\n        }\n      }\n\n      // cStat 653: NF-e Cancelada (arquivo indisponível)\n      if (cStat === \"653\") {\n        console.log(`[consultarChave] Chave ${chaveNFe} não retornou nfeProc (cStat=653: ${xMotivo})`);\n        // Retorna cStat para marcar como cancelada no banco\n        return { xmlContent: \"\", cStat: \"653\" };\n      }\n\n      // cStat 137: Nenhum documento encontrado\n      // cStat 656: Consumo indevido (já consultado antes)\n      console.log(`[consultarChave] Chave ${chaveNFe} não retornou nfeProc (cStat=${cStat}: ${xMotivo})`);\n      return null;\n    } catch (error) {\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        nivel: \"error\",\n        mensagem: `Erro em consultarChave: ${String(error)}`,\n        detalhes: JSON.stringify({ chaveNFe, error: String(error) }),\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Manifestar evento do destinatário para NF-e (NFeRecepcaoEvento v4.00)\n   * Conforme NT 2020.001\n   * \n   * @param empresa - Dados da empresa manifestante\n   * @param chaveNFe - Chave de acesso de 44 dígitos\n   * @param tpEvento - Tipo de evento (210200, 210210, 210220, 210240)\n   * @param justificativa - Justificativa (obrigatória para 210240)\n   * @returns Dados da manifestação registrada\n   */\n  async manifestarEvento(\n    empresa: Empresa,\n    chaveNFe: string,\n    tpEvento: string,\n    justificativa?: string\n  ): Promise<any> {\n    try {\n      console.log(`[Manifestação] Iniciando ${this.getTipoEventoDescricao(tpEvento)} para chave ${chaveNFe}`);\n\n      // Validação: 210240 requer justificativa\n      if (tpEvento === TIPOS_MANIFESTACAO.NAO_REALIZADA && (!justificativa || justificativa.length < 15)) {\n        throw new Error(\"Evento 210240 (Operação não Realizada) requer justificativa de no mínimo 15 caracteres\");\n      }\n\n      // Carrega certificado para assinatura digital (NT 2020.001 exige assinatura)\n      let certData;\n      try {\n        certData = await loadPKCS12Certificate(\n          empresa.certificadoPath,\n          empresa.certificadoSenha\n        );\n        console.log('[Manifestação] ✅ Certificado carregado com sucesso');\n        console.log('[Manifestação] 🔑 PrivateKey presente:', certData.key ? 'SIM' : 'NÃO');\n        console.log('[Manifestação] 📜 Certificate presente:', certData.cert ? 'SIM' : 'NÃO');\n      } catch (error: any) {\n        throw new Error(`Falha ao carregar certificado para manifestação: ${error.message}`);\n      }\n\n      // Monta envelope SOAP com assinatura digital\n      const envelope = this.buildSOAPEnvelopeManifestacao(\n        empresa.cnpj,\n        chaveNFe,\n        tpEvento,\n        1, // nSeqEvento sempre 1 para primeira manifestação\n        empresa.ambiente,\n        justificativa,\n        certData.key,       // privateKey em PEM\n        certData.cert       // certificate em PEM\n      );\n\n      // DEBUG: Mostra envelope completo sendo enviado\n      console.log(`[Manifestação] 📤 ENVELOPE SOAP ENVIANDO:\\n${envelope}`);\n\n      // Envia para SEFAZ\n      const responseXML = await this.callRecepcaoEvento(empresa, envelope);\n      \n      // Log da resposta completa para debug\n      console.log(`[Manifestação] Resposta SOAP recebida (primeiros 500 chars): ${responseXML.substring(0, 500)}`);\n      \n      const parsed = this.parser.parse(responseXML);\n\n      // Extrai retEvento da resposta SOAP\n      // Estrutura: soap:Envelope > soap:Body > nfeRecepcaoEventoResult > retEnvEvento > retEvento\n      const envelope_soap = parsed[\"soap12:Envelope\"] || parsed[\"soap:Envelope\"] || parsed[\"Envelope\"];\n      if (!envelope_soap) {\n        console.error('[Manifestação] ❌ Envelope SOAP não encontrado. Keys:', Object.keys(parsed));\n        throw new Error(\"Resposta SEFAZ inválida: Envelope SOAP não encontrado\");\n      }\n      \n      const body = envelope_soap[\"soap12:Body\"] || envelope_soap[\"soap:Body\"] || envelope_soap[\"Body\"];\n      if (!body) {\n        console.error('[Manifestação] ❌ Body SOAP não encontrado. Keys envelope:', Object.keys(envelope_soap));\n        throw new Error(\"Resposta SEFAZ inválida: Body SOAP não encontrado\");\n      }\n      \n      // CORREÇÃO: Busca nfeResultMsg (tag varia entre SVRS e Ambiente Nacional)\n      const nfeResultMsg = \n        body[\"nfeResultMsg\"] || \n        body[\"nfeRecepcaoEventoResult\"] || \n        body[\"nfeRecepcaoEventoNFResult\"] ||  // Ambiente Nacional usa \"NF\" maiúsculo\n        body[\"nfe:nfeResultMsg\"];\n      \n      if (!nfeResultMsg) {\n        console.error('[Manifestação] ❌ nfeResultMsg não encontrado. Keys body:', Object.keys(body));\n        throw new Error(\"Resposta SEFAZ inválida: nfeResultMsg não encontrado\");\n      }\n      \n      const retEnvEvento = nfeResultMsg[\"retEnvEvento\"];\n      if (!retEnvEvento) {\n        console.error('[Manifestação] ❌ retEnvEvento não encontrado. Keys:', Object.keys(nfeResultMsg));\n        throw new Error(\"Resposta SEFAZ inválida: retEnvEvento não encontrado\");\n      }\n      \n      // NT 2020.001 § 4.3.2: Duas estruturas possíveis\n      // 1. Erro de LOTE (cStat ≠ 128): cStat/xMotivo direto no retEnvEvento\n      // 2. Lote OK (cStat = 128): cStat/xMotivo dentro de retEnvEvento.retEvento.infEvento\n      \n      let cStat: string;\n      let xMotivo: string;\n      let nProt = \"\";\n      let dhRegEvento = \"\";\n      \n      const cStatLote = String(retEnvEvento.cStat || \"\");\n      \n      if (cStatLote !== \"128\") {\n        // Erro de LOTE (ex: cStat 225 = Falha no esquema XML)\n        cStat = cStatLote;\n        xMotivo = String(retEnvEvento.xMotivo || \"Erro de lote sem descrição\");\n        console.log(`[Manifestação] ⚠️ Erro de LOTE - cStat: ${cStat}, xMotivo: ${xMotivo}`);\n        console.log('[Manifestação] retEnvEvento completo:', JSON.stringify(retEnvEvento, null, 2));\n      } else {\n        // Lote OK (cStat 128), buscar retEvento\n        const retEvento = retEnvEvento[\"retEvento\"];\n        if (!retEvento || !retEvento.infEvento) {\n          console.error('[Manifestação] ❌ retEvento/infEvento não encontrado apesar de cStat=128. Keys:', Object.keys(retEnvEvento));\n          console.error('[Manifestação] retEnvEvento completo:', JSON.stringify(retEnvEvento, null, 2));\n          throw new Error(\"Resposta SEFAZ inválida: retEvento não encontrado (lote cStat=128)\");\n        }\n        \n        const infEvento = retEvento.infEvento;\n        cStat = String(infEvento.cStat || \"\");\n        xMotivo = String(infEvento.xMotivo || \"\");\n        nProt = String(infEvento.nProt || \"\");\n        dhRegEvento = String(infEvento.dhRegEvento || \"\");\n        console.log(`[Manifestação] ✅ Lote OK (128) - Evento cStat: ${cStat}, xMotivo: ${xMotivo}`);\n      }\n\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        nivel: \"info\",\n        mensagem: `Manifestação ${this.getTipoEventoDescricao(tpEvento)}: ${cStat} - ${xMotivo}`,\n        detalhes: JSON.stringify({ chaveNFe, tpEvento, cStat, nProt, dhRegEvento }),\n      });\n\n      // CRÍTICO: Calcular datas obrigatórias para evitar erro de NOT NULL\n      // dataAutorizacaoNFe: tenta extrair do dhRegEvento, senão usa data atual\n      let dataAutorizacaoNFe = new Date();\n      if (dhRegEvento) {\n        const tentativaData = new Date(dhRegEvento);\n        // CRÍTICO: new Date() não lança exceção com input inválido, retorna Invalid Date\n        // Precisa validar explicitamente com isNaN(date.getTime())\n        if (!Number.isNaN(tentativaData.getTime())) {\n          dataAutorizacaoNFe = tentativaData;\n          console.log(`[Manifestação] Data autorização NFe extraída: ${dhRegEvento}`);\n        } else {\n          console.warn(`[Manifestação] dhRegEvento inválido \"${dhRegEvento}\", usando data atual`);\n        }\n      } else {\n        console.warn(`[Manifestação] dhRegEvento não fornecido pela SEFAZ, usando data atual`);\n      }\n\n      // Valida dataAutorizacaoNFe antes de calcular prazoLegal\n      if (Number.isNaN(dataAutorizacaoNFe.getTime())) {\n        console.error(`[Manifestação] dataAutorizacaoNFe inválida, forçando data atual`);\n        dataAutorizacaoNFe = new Date();\n      }\n\n      // prazoLegal: NT 2020.001 §4 - 180 dias corridos a partir da autorização\n      const prazoLegal = new Date(dataAutorizacaoNFe);\n      prazoLegal.setDate(prazoLegal.getDate() + 180);\n\n      console.log(`[Manifestação] Dados calculados - dataAutorizacao: ${dataAutorizacaoNFe.toISOString()}, prazoLegal: ${prazoLegal.toISOString()}`);\n\n      // Cria/atualiza registro de manifestação\n      let manifestacao;\n      try {\n        manifestacao = await storage.createManifestacao({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          chaveNFe,\n          tipoEvento: tpEvento,\n          status: cStat === \"135\" ? \"autorizado\" : \"rejeitado\", // cStat 135 = Evento registrado\n          dataAutorizacaoNFe,\n          dataManifestacao: new Date(),\n          prazoLegal,\n          nsuEvento: null,\n          protocoloEvento: nProt || null,\n          cStat,\n          xMotivo,\n          justificativa: justificativa || null,\n          tentativas: 1,\n          ultimoErro: cStat === \"135\" ? null : xMotivo,\n        });\n\n        console.log(`[Manifestação] ✅ Registro salvo no banco: ${manifestacao.id}`);\n      } catch (dbError: any) {\n        console.error(`[Manifestação] ❌ ERRO ao salvar no banco:`, dbError);\n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          nivel: \"error\",\n          mensagem: `Erro ao salvar manifestação no banco`,\n          detalhes: JSON.stringify({ \n            chaveNFe, \n            tpEvento, \n            cStat, \n            erro: dbError.message,\n            stack: dbError.stack \n          }),\n        });\n        throw new Error(`Erro ao salvar manifestação no banco: ${dbError.message}`);\n      }\n\n      console.log(`[Manifestação] ${cStat === \"135\" ? \"✅ Sucesso\" : \"❌ Rejeitado\"}: ${xMotivo}`);\n      return manifestacao;\n    } catch (error) {\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        nivel: \"error\",\n        mensagem: `Erro ao manifestar evento: ${String(error)}`,\n        detalhes: JSON.stringify({ chaveNFe, tpEvento, error: String(error) }),\n      });\n      throw error;\n    }\n  }\n\n  async sincronizarEmpresa(empresa: Empresa): Promise<number> {\n    // CRÍTICO: Recarregar empresa do banco para pegar valor atualizado de bloqueadoAte\n    // Isso evita usar dados em cache quando o bloqueio já expirou\n    const empresaAtualizada = await storage.getEmpresa(empresa.id, empresa.userId);\n    if (!empresaAtualizada) {\n      throw new Error(\"Empresa não encontrada\");\n    }\n    empresa = empresaAtualizada; // Usa dados frescos do banco\n    \n    // Verifica se empresa está bloqueada (cStat 656)\n    if (estaBloqueado(empresa.bloqueadoAte)) {\n      const tempoRestante = calcularMinutosRestantes(empresa.bloqueadoAte);\n      const horarioBrasil = formatarDataBrasilCompleta(empresa.bloqueadoAte);\n      const mensagemBloqueio = `Empresa bloqueada pela SEFAZ (erro 656) até ${horarioBrasil}. Tempo restante: ${tempoRestante} minutos. Aguarde o desbloqueio automático.`;\n      \n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"warning\",\n        mensagem: \"Tentativa de sincronização bloqueada\",\n        detalhes: JSON.stringify({ \n          bloqueadoAte: empresa.bloqueadoAte?.toISOString(),\n          bloqueadoAteHorarioBrasil: horarioBrasil,\n          tempoRestanteMinutos: tempoRestante,\n          observacao: \"Aguarde o desbloqueio automático. Verifique se há outro sistema consultando este CNPJ.\"\n        }),\n      });\n      \n      throw new Error(mensagemBloqueio);\n    }\n\n    const sincronizacao = await storage.createSincronizacao({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      dataInicio: new Date(),\n      dataFim: null,\n      status: \"em_andamento\",\n      nsuInicial: empresa.ultimoNSU,\n      nsuFinal: null,\n      xmlsBaixados: 0,\n      mensagemErro: null,\n    });\n\n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId: sincronizacao.id,\n      nivel: \"info\",\n      mensagem: `Iniciando sincronização para ${empresa.razaoSocial}`,\n      detalhes: JSON.stringify({ cnpj: empresa.cnpj, nsuInicial: empresa.ultimoNSU }),\n    });\n\n    let xmlsBaixados = 0;\n    let nsuAtual = empresa.ultimoNSU;\n    let maxNSU = \"0\";\n    let alinhamentoCompleto = false;\n    const MAX_ITERACOES = 200; // Safety guard para sincronização\n\n    try {\n      // Loop até atingir maxNSU conforme NT 2014.002\n      for (let iteracao = 0; iteracao < MAX_ITERACOES; iteracao++) {\n        // CRÍTICO: Verifica rate limit ANTES de consultar SEFAZ (máx 20 consultas/hora)\n        const podeConsultar = await storage.checkRateLimit(empresa.id, \"distribuicaoDFe\", empresa.userId);\n        \n        if (!podeConsultar) {\n          // CRÍTICO: Persiste bloqueio de 65min para evitar retry antes do reset\n          const bloqueadoAte = criarBloqueio(65);\n          await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n          \n          const proximaConsultaHorarioBrasil = formatarDataBrasilCompleta(bloqueadoAte);\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: sincronizacao.id,\n            nivel: \"warning\",\n            mensagem: `Rate limit atingido - Bloqueado até ${proximaConsultaHorarioBrasil}`,\n            detalhes: JSON.stringify({ \n              iteracao: iteracao + 1,\n              ultNSUEnviado: nsuAtual,\n              bloqueadoAte: bloqueadoAte.toISOString(),\n              proximaConsultaHorarioBrasil,\n              motivo: \"Limite de 20 consultas/hora atingido - empresa bloqueada por 65min\",\n              acaoAutomatica: \"Bloqueio automático por 65min. Sincronização retomará após \" + proximaConsultaHorarioBrasil\n            }),\n          });\n          \n          // Marca sincronização como completa (parcial) e para o loop\n          alinhamentoCompleto = false;\n          break;\n        }\n        \n        // Usa distNSU conforme NT 2014.002 (não consNSU)\n        const envelope = this.buildSOAPEnvelopeDistNSU(empresa.cnpj, empresa.uf, empresa.ambiente, nsuAtual);\n        \n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: sincronizacao.id,\n          nivel: \"info\",\n          mensagem: `Sincronização - Consultando SEFAZ`,\n          detalhes: JSON.stringify({ iteracao: iteracao + 1, ultNSUEnviado: nsuAtual }),\n        });\n        \n        let responseXml: string;\n        try {\n          responseXml = await this.callDistDFe(empresa, envelope);\n        } catch (error) {\n          // Loga o erro real e retorna para tratamento\n          const errorMsg = `Erro ao chamar SEFAZ: ${error}`;\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: sincronizacao.id,\n            nivel: \"error\",\n            mensagem: errorMsg,\n            detalhes: JSON.stringify({ \n              iteracao: iteracao + 1,\n              ultNSUEnviado: nsuAtual,\n              error: String(error), \n              stack: (error as Error).stack \n            }),\n          });\n\n          // Em ambiente de desenvolvimento (sem certificado válido), permite simulação\n          if (process.env.ALLOW_SEFAZ_SIMULATION === \"true\") {\n            console.warn(`${errorMsg} (usando simulação)`);\n            responseXml = `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap12:Envelope xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\">\n  <soap12:Body>\n    <retDistDFeInt xmlns=\"http://www.portalfiscal.inf.br/nfe\">\n      <cStat>137</cStat>\n      <xMotivo>Nenhum documento localizado (simulação)</xMotivo>\n      <ultNSU>${nsuAtual}</ultNSU>\n      <maxNSU>${nsuAtual}</maxNSU>\n    </retDistDFeInt>\n  </soap12:Body>\n</soap12:Envelope>`;\n          } else {\n            // Em produção, propaga o erro\n            throw error;\n          }\n        }\n\n        const response = this.parseSOAPResponse(responseXml);\n        \n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: sincronizacao.id,\n          nivel: \"info\",\n          mensagem: `Sincronização - Resposta SEFAZ`,\n          detalhes: JSON.stringify({ \n            iteracao: iteracao + 1,\n            cStat: response.cStat,\n            xMotivo: response.xMotivo,\n            ultNSURetornado: response.ultNSU,\n            maxNSURetornado: response.maxNSU\n          }),\n        });\n\n        if (response.cStat === \"137\") {\n          // 137: Nenhum documento localizado\n          // NT 2014.002 §3.11.4: AGUARDAR 1 HORA antes de nova consulta\n          nsuAtual = response.ultNSU || nsuAtual;\n          maxNSU = response.maxNSU || nsuAtual;\n          \n          // PERSISTIR bloqueio de 65min (margem de segurança conforme NT 2014.002)\n          const bloqueadoAte = criarBloqueio(65);\n          await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n          \n          const proximaConsultaHorarioBrasil = formatarDataBrasilCompleta(bloqueadoAte);\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: sincronizacao.id,\n            nivel: \"info\",\n            mensagem: `cStat=137: Sem novos documentos neste momento`,\n            detalhes: JSON.stringify({ \n              ultNSU: nsuAtual,\n              maxNSU,\n              bloqueadoAte: bloqueadoAte.toISOString(),\n              proximaConsultaHorarioBrasil,\n              motivo: \"SEFAZ retornou cStat=137 (nenhum documento localizado)\",\n              acaoAutomatica: \"Sistema aguardará 1h antes de tentar novamente conforme NT 2014.002 §3.11.4\",\n              observacao: \"Bloqueio preventivo até \" + proximaConsultaHorarioBrasil + \". Próxima sincronização automática via cron.\"\n            }),\n          });\n          \n          alinhamentoCompleto = true; // Marca como completo para sair do loop\n          break; // Para o loop IMEDIATAMENTE\n        } else if (response.cStat === \"138\") {\n          // 138: Tem documentos - processa TODOS os schemas conforme NT 2014.002 §3.3\n          for (const docZip of response.docZips || []) {\n            try {\n              const xmlContent = this.decompressDocZip(docZip.content);\n              await this.processDocument(xmlContent, docZip.schema, empresa, sincronizacao.id, docZip.NSU);\n              xmlsBaixados++;\n            } catch (error) {\n              console.error(\"Erro ao processar docZip:\", error);\n              await storage.createLog({\n                userId: empresa.userId,\n                empresaId: empresa.id,\n                sincronizacaoId: sincronizacao.id,\n                nivel: \"warning\",\n                mensagem: `Erro ao processar documento NSU ${docZip.NSU} (${docZip.schema})`,\n                detalhes: JSON.stringify({ \n                  error: String(error),\n                  schema: docZip.schema,\n                  nsu: docZip.NSU\n                }),\n              });\n            }\n          }\n\n          nsuAtual = response.ultNSU || nsuAtual;\n          maxNSU = response.maxNSU || nsuAtual;\n        } else {\n          // Erro 656: Bloqueio temporário ou NSU desatualizado\n          if (response.cStat === \"656\") {\n            // NT 2014.002 v1.14: SEFAZ retorna ultNSU correto na rejeição 656\n            // CRÍTICO: Atualizar NSU ANTES de lançar erro para evitar loop infinito!\n            const nsuRetornadoPelaSefaz = response.ultNSU && response.ultNSU.trim() !== \"\" && response.ultNSU !== \"0\" ? response.ultNSU : null;\n            \n            // Calcula diferença usando BigInt para preservar zeros à esquerda\n            const diferenca = nsuRetornadoPelaSefaz \n              ? Number(BigInt(nsuRetornadoPelaSefaz) - BigInt(nsuAtual))\n              : 0;\n            \n            // Calcula bloqueio: 65 minutos (margem de segurança conforme NT)\n            const bloqueadoAte = criarBloqueio(65);\n            \n            // ATUALIZA empresa com NSU correto + bloqueio (conforme NT 2014.002 v1.14)\n            // Só atualiza ultimoNSU se SEFAZ retornou valor válido\n            const updatePayload = nsuRetornadoPelaSefaz\n              ? { ultimoNSU: nsuRetornadoPelaSefaz, bloqueadoAte }\n              : { bloqueadoAte };\n              \n            await storage.updateEmpresa(empresa.id, updatePayload, empresa.userId);\n\n            // Log detalhado para diagnóstico (exibe em horário do Brasil)\n            const horarioBrasilBloqueio = formatarDataBrasilCompleta(bloqueadoAte);\n            \n            // Detecta concorrência com outros sistemas (ERP/contador)\n            const nivelLog = diferenca > 1 ? \"warning\" : \"error\";\n            const mensagemConcorrencia = diferenca > 1 \n              ? `ATENÇÃO: NSU avançou ${diferenca} posições! Possível outro sistema consultando este CNPJ.`\n              : \"NSU atualizado conforme retorno da SEFAZ.\";\n            \n            await storage.createLog({\n              userId: empresa.userId,\n              empresaId: empresa.id,\n              sincronizacaoId: sincronizacao.id,\n              nivel: nivelLog,\n              mensagem: `cStat=656: Consumo indevido detectado pela SEFAZ`,\n              detalhes: JSON.stringify({ \n                iteracao: iteracao + 1,\n                ultNSUEnviado: nsuAtual,\n                ultNSURetornadoPelaSefaz: nsuRetornadoPelaSefaz || \"não retornado\",\n                diferencaNSU: diferenca,\n                nsuAtualizado: nsuRetornadoPelaSefaz || nsuAtual,\n                cStat: \"656\",\n                xMotivo: response.xMotivo,\n                bloqueadoAte: bloqueadoAte.toISOString(),\n                bloqueadoAteHorarioBrasil: horarioBrasilBloqueio,\n                motivo: \"SEFAZ aplicou bloqueio temporário por violação das regras de consulta (NT 2014.002)\",\n                causaProvavel: diferenca > 1\n                  ? \"Outro sistema (ERP/contador) está consultando este CNPJ simultaneamente\"\n                  : iteracao === 0 \n                    ? \"NSU desatualizado ou primeira consulta após bloqueio anterior\"\n                    : \"Múltiplas consultas em sequência ou NSU fora de ordem\",\n                acaoTomada: nsuRetornadoPelaSefaz\n                  ? `NSU atualizado de ${nsuAtual} para ${nsuRetornadoPelaSefaz} conforme retorno da SEFAZ (NT 2014.002 v1.14)`\n                  : `SEFAZ não retornou ultNSU válido - NSU mantido em ${nsuAtual}`,\n                acaoNecessaria: \"AGUARDAR desbloqueio automático - NÃO tentar novamente antes de \" + horarioBrasilBloqueio,\n                orientacao: mensagemConcorrencia\n              }),\n            });\n\n            const mensagemClara = nsuRetornadoPelaSefaz\n              ? `Bloqueio SEFAZ (cStat 656): ${response.xMotivo}. NSU atualizado para ${nsuRetornadoPelaSefaz}. Empresa bloqueada até ${horarioBrasilBloqueio}. ${diferenca > 1 ? 'ATENÇÃO: Detectada concorrência com outro sistema!' : 'Aguarde o desbloqueio automático.'}`\n              : `Bloqueio SEFAZ (cStat 656): ${response.xMotivo}. SEFAZ não retornou ultNSU válido. Empresa bloqueada até ${horarioBrasilBloqueio}. Aguarde o desbloqueio automático.`;\n            \n            throw new Error(mensagemClara);\n          }\n          throw new Error(`Erro SEFAZ: ${response.cStat} - ${response.xMotivo}`);\n        }\n\n        // Verifica alinhamento completo (conforme NT 2014.002)\n        if (nsuAtual === maxNSU) {\n          alinhamentoCompleto = true;\n          \n          // NT 2014.002 §3.11.4: Quando ultNSU == maxNSU, BLOQUEAR por 1 hora\n          const bloqueadoAte = criarBloqueio(65);\n          await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n          \n          const proximaConsultaHorarioBrasil = formatarDataBrasilCompleta(bloqueadoAte);\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: sincronizacao.id,\n            nivel: \"info\",\n            mensagem: `Alinhamento completo: ultNSU == maxNSU`,\n            detalhes: JSON.stringify({ \n              ultNSU: nsuAtual,\n              maxNSU,\n              bloqueadoAte: bloqueadoAte.toISOString(),\n              proximaConsultaHorarioBrasil,\n              motivo: \"Sistema está totalmente sincronizado (ultNSU == maxNSU)\",\n              acaoAutomatica: \"Bloqueio de 1h conforme NT 2014.002 §3.11.4 para evitar cStat=656\",\n              observacao: \"Próxima sincronização automática via cron após \" + proximaConsultaHorarioBrasil\n            }),\n          });\n          \n          console.log(`[Sincronização] Alinhamento completo: ultNSU === maxNSU (${nsuAtual}). Bloqueado até ${proximaConsultaHorarioBrasil}`);\n          break;\n        }\n\n        // Delay para evitar rate limiting (apenas se vai continuar)\n        await new Promise(resolve => setTimeout(resolve, 300));\n      }\n\n      // Verifica se o alinhamento foi completado\n      if (!alinhamentoCompleto) {\n        const mensagemErro = `Limite de segurança atingido (${MAX_ITERACOES} iterações) sem alcançar maxNSU. ultNSU=${nsuAtual}, maxNSU=${maxNSU}`;\n        \n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: sincronizacao.id,\n          nivel: \"error\",\n          mensagem: mensagemErro,\n          detalhes: JSON.stringify({ \n            nsuInicial: empresa.ultimoNSU,\n            nsuAtual,\n            maxNSU,\n            xmlsBaixados,\n            observacao: \"Backlog muito grande - considere aumentar MAX_ITERACOES ou executar reconciliação\"\n          }),\n        });\n\n        throw new Error(mensagemErro);\n      }\n\n      // Atualiza empresa com novo NSU\n      // IMPORTANTE: NÃO limpa bloqueio se foi aplicado por ultNSU==maxNSU ou cStat=137\n      // O bloqueio só deve ser limpo automaticamente após expirar o prazo\n      await storage.updateEmpresa(empresa.id, { \n        ultimoNSU: nsuAtual\n        // bloqueadoAte mantém valor existente (pode ter sido setado em ultNSU==maxNSU ou cStat=137)\n      }, empresa.userId);\n\n      // Finaliza sincronização\n      await storage.updateSincronizacao(sincronizacao.id, {\n        dataFim: new Date(),\n        status: \"concluida\",\n        nsuFinal: nsuAtual,\n        xmlsBaixados,\n      }, empresa.userId);\n\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: sincronizacao.id,\n        nivel: \"info\",\n        mensagem: `Sincronização concluída: ${xmlsBaixados} XML(s) baixado(s)`,\n        detalhes: JSON.stringify({ xmlsBaixados, nsuFinal: nsuAtual }),\n      });\n\n      return xmlsBaixados;\n    } catch (error) {\n      await storage.updateSincronizacao(sincronizacao.id, {\n        dataFim: new Date(),\n        status: \"erro\",\n        mensagemErro: String(error),\n      }, empresa.userId);\n\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: sincronizacao.id,\n        nivel: \"error\",\n        mensagem: `Erro na sincronização: ${String(error)}`,\n        detalhes: JSON.stringify({ \n          error: String(error),\n          stack: (error as Error).stack,\n          nsuInicial: empresa.ultimoNSU,\n          nsuAtual,\n          xmlsBaixados\n        }),\n      });\n\n      console.error(`Erro crítico ao sincronizar ${empresa.razaoSocial}:`, error);\n      // Não propaga - erro já registrado, permite continuar outras empresas\n      return 0;\n    }\n  }\n\n  async sincronizarTodasEmpresas(): Promise<void> {\n    const empresasAtivas = await storage.getEmpresasAtivas();\n\n    await storage.createLog({\n      empresaId: null,\n      sincronizacaoId: null,\n      nivel: \"info\",\n      mensagem: `Iniciando sincronização automática de ${empresasAtivas.length} empresa(s)`,\n      detalhes: null,\n    });\n\n    for (const empresa of empresasAtivas) {\n      try {\n        await this.sincronizarEmpresa(empresa);\n      } catch (error) {\n        console.error(`Erro ao sincronizar ${empresa.razaoSocial}:`, error);\n        // Continua com as próximas empresas mesmo se uma falhar\n      }\n    }\n\n    await storage.createLog({\n      empresaId: null,\n      sincronizacaoId: null,\n      nivel: \"info\",\n      mensagem: `Sincronização automática finalizada`,\n      detalhes: null,\n    });\n  }\n\n  /**\n   * Reconcilia o último NSU consultado seguindo NT 2014.002 da SEFAZ\n   * \n   * Avança o ponteiro NSU sequencialmente até atingir maxNSU (alinhamento completo).\n   * IMPORTANTE: Segue regras da Nota Técnica 2014.002 para evitar cStat=656 (uso indevido).\n   * \n   * Algoritmo conforme documentação SEFAZ:\n   * 1. Começa do ultimoNSU atual da empresa (NUNCA usa NSU=0 exceto primeira consulta)\n   * 2. Faz loop sequencial usando distNSU com ultNSU (não consNSU)\n   * 3. Continua até ultNSU === maxNSU (sincronização completa)\n   * 4. NÃO baixa XMLs (apenas avança ponteiro)\n   * 5. Atualiza banco apenas com valores retornados pela SEFAZ\n   * \n   * @param empresa - Empresa a ser reconciliada\n   * @returns NSU final alinhado e quantidade de chamadas realizadas\n   */\n  async reconciliarUltimoNSU(empresa: Empresa): Promise<{\n    nsuFinal: string;\n    chamadas: number;\n    intervalo: { min: string; max: string };\n  }> {\n    // CRÍTICO: Recarregar empresa do banco para pegar valor atualizado de bloqueadoAte\n    const empresaAtualizada = await storage.getEmpresa(empresa.id, empresa.userId);\n    if (!empresaAtualizada) {\n      throw new Error(\"Empresa não encontrada\");\n    }\n    empresa = empresaAtualizada; // Usa dados frescos do banco\n    \n    // Verifica se empresa está bloqueada (cStat 656)\n    if (estaBloqueado(empresa.bloqueadoAte)) {\n      const tempoRestante = calcularMinutosRestantes(empresa.bloqueadoAte);\n      const horarioBrasil = formatarDataBrasilCompleta(empresa.bloqueadoAte);\n      const mensagemBloqueio = `Empresa bloqueada pela SEFAZ (erro 656) até ${horarioBrasil}. Tempo restante: ${tempoRestante} minutos. Aguarde o desbloqueio automático.`;\n      \n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"warning\",\n        mensagem: \"Tentativa de reconciliação bloqueada\",\n        detalhes: JSON.stringify({ \n          bloqueadoAte: empresa.bloqueadoAte?.toISOString(),\n          bloqueadoAteHorarioBrasil: horarioBrasil,\n          tempoRestanteMinutos: tempoRestante,\n          observacao: \"Aguarde o desbloqueio automático. Verifique se há outro sistema consultando este CNPJ.\"\n        }),\n      });\n      \n      throw new Error(mensagemBloqueio);\n    }\n\n    const nsuInicial = empresa.ultimoNSU;\n    \n    // VALIDAÇÃO CRÍTICA: Não permitir reconciliação de empresas novas (NSU=0)\n    // A SEFAZ rejeita com cStat=656 se tentar usar ultNSU=0 em empresa que já consultou antes\n    if (nsuInicial === \"000000000000000\" || nsuInicial === \"0\") {\n      const mensagemErro = \"Reconciliação não disponível para empresas sem NSU configurado. Use 'Sincronizar' primeiro para inicializar o NSU.\";\n      \n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"warning\",\n        mensagem: mensagemErro,\n        detalhes: JSON.stringify({ \n          cnpj: empresa.cnpj,\n          ultimoNSU: nsuInicial,\n          observacao: \"Para empresas novas, execute Sincronização normal primeiro\"\n        }),\n      });\n\n      throw new Error(mensagemErro);\n    }\n    \n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId: null,\n      nivel: \"info\",\n      mensagem: `Iniciando alinhamento de NSU para ${empresa.razaoSocial}`,\n      detalhes: JSON.stringify({ \n        cnpj: empresa.cnpj, \n        nsuAtual: nsuInicial,\n        observacao: \"Seguindo NT 2014.002 - loop sequencial até maxNSU\"\n      }),\n    });\n\n    let chamadas = 0;\n    const MAX_ITERACOES = 100; // Safety guard: limite de segurança\n\n    try {\n      let nsuAtual = nsuInicial;\n      let maxNSU = \"0\";\n      let alinhamentoCompleto = false;\n\n      // Loop sequencial seguindo regras da SEFAZ\n      // Continua até ultNSU === maxNSU (alinhamento completo)\n      for (let i = 0; i < MAX_ITERACOES; i++) {\n        // CRÍTICO: Verifica rate limit ANTES de consultar SEFAZ (máx 20 consultas/hora)\n        const podeConsultar = await storage.checkRateLimit(empresa.id, \"distribuicaoDFe\", empresa.userId);\n        \n        if (!podeConsultar) {\n          // CRÍTICO: Persiste bloqueio de 65min para evitar retry antes do reset\n          const bloqueadoAte = criarBloqueio(65);\n          await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n          \n          const proximaConsultaHorarioBrasil = formatarDataBrasilCompleta(bloqueadoAte);\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"warning\",\n            mensagem: `Rate limit atingido - Bloqueado até ${proximaConsultaHorarioBrasil}`,\n            detalhes: JSON.stringify({ \n              iteracao: i + 1,\n              nsuAtual,\n              bloqueadoAte: bloqueadoAte.toISOString(),\n              proximaConsultaHorarioBrasil,\n              motivo: \"Limite de 20 consultas/hora atingido - empresa bloqueada por 65min\",\n              acaoAutomatica: \"Bloqueio automático. Reconciliação retomará após \" + proximaConsultaHorarioBrasil\n            }),\n          });\n          \n          // Para o loop - sincronização parcial será retomada depois\n          break;\n        }\n        \n        // Monta envelope usando distNSU com ultNSU (conforme NT 2014.002)\n        const envelope = this.buildSOAPEnvelopeDistNSU(\n          empresa.cnpj,\n          empresa.uf,\n          empresa.ambiente,\n          nsuAtual\n        );\n        chamadas++;\n\n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: null,\n          nivel: \"info\",\n          mensagem: `Reconciliação - Consultando SEFAZ`,\n          detalhes: JSON.stringify({ iteracao: i + 1, ultNSUEnviado: nsuAtual }),\n        });\n\n        let xmlResponse: string;\n        try {\n          xmlResponse = await this.callDistDFe(empresa, envelope);\n        } catch (error) {\n          // Loga erro com contexto de NSU e iteração\n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"error\",\n            mensagem: `Reconciliação - Erro ao chamar SEFAZ: ${error}`,\n            detalhes: JSON.stringify({ \n              iteracao: i + 1,\n              ultNSUEnviado: nsuAtual,\n              error: String(error), \n              stack: (error as Error).stack \n            }),\n          });\n          throw error; // Re-lança para catch externo\n        }\n\n        const response = this.parseSOAPResponse(xmlResponse);\n\n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: null,\n          nivel: \"info\",\n          mensagem: `Reconciliação - Resposta SEFAZ`,\n          detalhes: JSON.stringify({ \n            iteracao: i + 1,\n            cStat: response.cStat,\n            xMotivo: response.xMotivo,\n            ultNSURetornado: response.ultNSU,\n            maxNSURetornado: response.maxNSU\n          }),\n        });\n\n        // Valida resposta SEFAZ\n        if (response.cStat === \"137\") {\n          // 137: Sem documentos - NT 2014.002 exige aguardar 1h\n          const ultNSU = response.ultNSU || \"0\";\n          maxNSU = response.maxNSU || ultNSU;\n          \n          // PERSISTIR bloqueio de 65min (margem de segurança conforme NT 2014.002)\n          const bloqueadoAte = criarBloqueio(65);\n          await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n          \n          const proximaConsultaHorarioBrasil = formatarDataBrasilCompleta(bloqueadoAte);\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"info\",\n            mensagem: `cStat=137: Sem novos documentos na reconciliação`,\n            detalhes: JSON.stringify({ \n              ultNSU,\n              maxNSU,\n              bloqueadoAte: bloqueadoAte.toISOString(),\n              proximaConsultaHorarioBrasil,\n              motivo: \"SEFAZ retornou cStat=137 (nenhum documento localizado) durante alinhamento de NSU\",\n              acaoAutomatica: \"Sistema aguardará 1h antes de tentar novamente conforme NT 2014.002 §3.11.4\",\n              observacao: \"Bloqueio preventivo até \" + proximaConsultaHorarioBrasil + \". Tente novamente após esse horário.\"\n            }),\n          });\n          \n          // Atualiza NSU atual e para o loop IMEDIATAMENTE\n          nsuAtual = ultNSU;\n          alinhamentoCompleto = true;\n          break;\n        } else if (response.cStat === \"138\") {\n          // 138: Documentos encontrados - avança NSU\n          const ultNSU = response.ultNSU || \"0\";\n          maxNSU = response.maxNSU || ultNSU;\n          nsuAtual = ultNSU;\n        } else {\n          // Erro 656 ou outro erro\n          if (response.cStat === \"656\") {\n            // NT 2014.002 v1.14: SEFAZ retorna ultNSU correto na rejeição 656\n            // CRÍTICO: Atualizar NSU ANTES de lançar erro para evitar loop infinito!\n            const ultNSU = response.ultNSU || \"0\";\n            const nsuRetornadoPelaSefaz = ultNSU && ultNSU.trim() !== \"\" && ultNSU !== \"0\" ? ultNSU : null;\n            \n            // Calcula diferença usando BigInt para preservar zeros à esquerda\n            const diferenca = nsuRetornadoPelaSefaz \n              ? Number(BigInt(nsuRetornadoPelaSefaz) - BigInt(nsuAtual))\n              : 0;\n            \n            // Calcula bloqueio: 65 minutos (margem de segurança conforme NT)\n            const bloqueadoAte = criarBloqueio(65);\n            \n            // ATUALIZA empresa com NSU correto + bloqueio (conforme NT 2014.002 v1.14)\n            // Só atualiza ultimoNSU se SEFAZ retornou valor válido\n            const updatePayload = nsuRetornadoPelaSefaz\n              ? { ultimoNSU: nsuRetornadoPelaSefaz, bloqueadoAte }\n              : { bloqueadoAte };\n              \n            await storage.updateEmpresa(empresa.id, updatePayload, empresa.userId);\n            \n            const horarioBrasilBloqueio = formatarDataBrasilCompleta(bloqueadoAte);\n            \n            // Detecta concorrência com outros sistemas (ERP/contador)\n            const nivelLog = diferenca > 1 ? \"warning\" : \"error\";\n            const mensagemConcorrencia = diferenca > 1 \n              ? `ATENÇÃO: NSU avançou ${diferenca} posições durante reconciliação! Possível outro sistema consultando este CNPJ.`\n              : \"NSU atualizado conforme retorno da SEFAZ.\";\n            \n            await storage.createLog({\n              userId: empresa.userId,\n              empresaId: empresa.id,\n              sincronizacaoId: null,\n              nivel: nivelLog,\n              mensagem: `cStat=656: Consumo indevido durante reconciliação`,\n              detalhes: JSON.stringify({ \n                iteracao: i + 1,\n                ultNSUEnviado: nsuAtual,\n                ultNSURetornadoPelaSefaz: nsuRetornadoPelaSefaz || \"não retornado\",\n                diferencaNSU: diferenca,\n                nsuAtualizado: nsuRetornadoPelaSefaz || nsuAtual,\n                cStat: \"656\",\n                xMotivo: response.xMotivo,\n                bloqueadoAte: bloqueadoAte.toISOString(),\n                bloqueadoAteHorarioBrasil: horarioBrasilBloqueio,\n                motivo: \"SEFAZ aplicou bloqueio temporário durante alinhamento de NSU (NT 2014.002)\",\n                causaProvavel: diferenca > 1\n                  ? \"Outro sistema (ERP/contador) está consultando este CNPJ simultaneamente\"\n                  : \"NSU fora de sequência ou primeira consulta após bloqueio anterior\",\n                acaoTomada: nsuRetornadoPelaSefaz\n                  ? `NSU atualizado de ${nsuAtual} para ${nsuRetornadoPelaSefaz} conforme retorno da SEFAZ (NT 2014.002 v1.14)`\n                  : `SEFAZ não retornou ultNSU válido - NSU mantido em ${nsuAtual}`,\n                acaoNecessaria: \"AGUARDAR desbloqueio automático - NÃO tentar novamente antes de \" + horarioBrasilBloqueio,\n                orientacao: mensagemConcorrencia\n              }),\n            });\n\n            const mensagemClara = nsuRetornadoPelaSefaz\n              ? `Bloqueio SEFAZ (cStat 656): ${response.xMotivo}. NSU atualizado para ${nsuRetornadoPelaSefaz}. Empresa bloqueada até ${horarioBrasilBloqueio}. ${diferenca > 1 ? 'ATENÇÃO: Detectada concorrência com outro sistema!' : 'Aguarde o desbloqueio automático.'}`\n              : `Bloqueio SEFAZ (cStat 656): ${response.xMotivo}. SEFAZ não retornou ultNSU válido. Empresa bloqueada até ${horarioBrasilBloqueio}. Aguarde o desbloqueio automático.`;\n            throw new Error(mensagemClara);\n          }\n          throw new Error(`SEFAZ retornou cStat ${response.cStat}: ${response.xMotivo}`);\n        }\n\n        // Log de progresso\n        console.log(`[Alinhamento NSU] Iteração ${i + 1}: ultNSU=${nsuAtual}, maxNSU=${maxNSU}`);\n\n        // Verifica se atingiu maxNSU (alinhamento completo)\n        if (nsuAtual === maxNSU) {\n          alinhamentoCompleto = true;\n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"info\",\n            mensagem: `Alinhamento completo: ultNSU === maxNSU`,\n            detalhes: JSON.stringify({ ultNSU: nsuAtual, maxNSU, iteracoes: i + 1, chamadas }),\n          });\n          break; // Sucesso: alinhamento completo\n        }\n\n        // Delay para evitar rate limiting\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n\n      // Verifica se o alinhamento foi completado\n      if (!alinhamentoCompleto) {\n        const mensagemErro = `Limite de segurança atingido (${MAX_ITERACOES} iterações) sem alcançar maxNSU. ultNSU=${nsuAtual}, maxNSU=${maxNSU}`;\n        \n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: null,\n          nivel: \"error\",\n          mensagem: mensagemErro,\n          detalhes: JSON.stringify({ \n            nsuInicial,\n            nsuAtual,\n            maxNSU,\n            chamadas,\n            observacao: \"Intervenção manual necessária - backlog muito grande\"\n          }),\n        });\n\n        throw new Error(mensagemErro);\n      }\n\n      // Atualiza empresa com NSU final alinhado\n      await storage.updateEmpresa(empresa.id, { ultimoNSU: nsuAtual }, empresa.userId);\n\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"info\",\n        mensagem: `Alinhamento concluído com sucesso (NT 2014.002)`,\n        detalhes: JSON.stringify({ \n          nsuInicial,\n          nsuFinal: nsuAtual,\n          maxNSU,\n          chamadas,\n          estrategia: \"loop_sequencial_distNSU\"\n        }),\n      });\n\n      return {\n        nsuFinal: nsuAtual,\n        chamadas,\n        intervalo: { min: nsuInicial, max: nsuAtual },\n      };\n\n    } catch (error) {\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"error\",\n        mensagem: `Erro no alinhamento de NSU: ${String(error)}`,\n        detalhes: JSON.stringify({ error: String(error), chamadas }),\n      });\n\n      throw error;\n    }\n  }\n\n  /**\n   * Busca avançada de XMLs por período usando consNSU\n   * NT 2014.002: LIMITADO a 20 consultas por hora por CNPJ\n   * \n   * @param empresa - Empresa para buscar\n   * @param nsuInicial - NSU inicial do intervalo\n   * @param nsuFinal - NSU final do intervalo\n   * @param maxConsultas - Limite de consultas (máx 20)\n   * @returns Estatísticas da busca\n   */\n  async buscarPorPeriodo(\n    empresa: Empresa,\n    nsuInicial: string,\n    nsuFinal: string,\n    maxConsultas: number = 20\n  ): Promise<{\n    xmlsEncontrados: number;\n    consultasRealizadas: number;\n    nsuConsultados: string[];\n  }> {\n    // Validação: máximo 20 consultas/hora conforme NT 2014.002\n    if (maxConsultas > 20) {\n      throw new Error(\"Limite máximo de 20 consultas por hora (NT 2014.002)\");\n    }\n\n    const nsuInicialNum = parseInt(nsuInicial);\n    const nsuFinalNum = parseInt(nsuFinal);\n\n    if (nsuInicialNum >= nsuFinalNum) {\n      throw new Error(\"NSU inicial deve ser menor que NSU final\");\n    }\n\n    const totalNSUs = nsuFinalNum - nsuInicialNum + 1;\n    if (totalNSUs > maxConsultas) {\n      throw new Error(`Intervalo muito grande: ${totalNSUs} NSUs. Máximo permitido: ${maxConsultas} consultas.`);\n    }\n\n    await storage.createLog({\n      userId: empresa.userId,\n      empresaId: empresa.id,\n      sincronizacaoId: null,\n      nivel: \"info\",\n      mensagem: `Iniciando busca avançada por período`,\n      detalhes: JSON.stringify({\n        nsuInicial,\n        nsuFinal,\n        totalNSUs,\n        maxConsultas,\n        observacao: \"Busca pontual usando consNSU (limite 20/hora)\"\n      }),\n    });\n\n    let xmlsEncontrados = 0;\n    let consultasRealizadas = 0;\n    const nsuConsultados: string[] = [];\n\n    try {\n      // Loop por cada NSU no intervalo\n      for (let nsu = nsuInicialNum; nsu <= nsuFinalNum && consultasRealizadas < maxConsultas; nsu++) {\n        const nsuStr = nsu.toString().padStart(15, \"0\");\n        \n        // CRÍTICO: Verifica rate limit ANTES de consultar SEFAZ (máx 20 consultas/hora)\n        const podeConsultar = await storage.checkRateLimit(empresa.id, \"distribuicaoDFe\", empresa.userId);\n        \n        if (!podeConsultar) {\n          // CRÍTICO: Persiste bloqueio de 65min para evitar retry antes do reset\n          const bloqueadoAte = criarBloqueio(65);\n          await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n          \n          const proximaConsultaHorarioBrasil = formatarDataBrasilCompleta(bloqueadoAte);\n          \n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"warning\",\n            mensagem: `Rate limit atingido - Bloqueado até ${proximaConsultaHorarioBrasil}`,\n            detalhes: JSON.stringify({ \n              nsuAtual: nsuStr,\n              consultasRealizadas,\n              bloqueadoAte: bloqueadoAte.toISOString(),\n              proximaConsultaHorarioBrasil,\n              motivo: \"Limite de 20 consultas/hora atingido - empresa bloqueada por 65min\",\n              acaoAutomatica: \"Bloqueio automático. Busca retomará após \" + proximaConsultaHorarioBrasil\n            }),\n          });\n          \n          // Para o loop\n          break;\n        }\n        \n        // Monta envelope consNSU para consulta pontual\n        const envelope = this.buildSOAPEnvelope(\n          empresa.cnpj,\n          empresa.uf,\n          empresa.ambiente,\n          nsuStr\n        );\n\n        await storage.createLog({\n          userId: empresa.userId,\n          empresaId: empresa.id,\n          sincronizacaoId: null,\n          nivel: \"info\",\n          mensagem: `Busca avançada - Consultando NSU ${nsuStr}`,\n          detalhes: JSON.stringify({\n            nsu: nsuStr,\n            consulta: consultasRealizadas + 1,\n            total: maxConsultas\n          }),\n        });\n\n        let responseXml: string;\n        try {\n          responseXml = await this.callDistDFe(empresa, envelope);\n          consultasRealizadas++;\n          nsuConsultados.push(nsuStr);\n        } catch (error) {\n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"error\",\n            mensagem: `Busca avançada - Erro ao consultar NSU ${nsuStr}`,\n            detalhes: JSON.stringify({\n              error: String(error),\n              nsu: nsuStr\n            }),\n          });\n          \n          // Incrementa contador mesmo em erro\n          consultasRealizadas++;\n          nsuConsultados.push(nsuStr);\n          continue;\n        }\n\n        const response = this.parseSOAPResponse(responseXml);\n\n        if (response.cStat === \"138\") {\n          // Documento encontrado - processa\n          for (const docZip of response.docZips || []) {\n            try {\n              const xmlContent = this.decompressDocZip(docZip.content);\n              await this.processDocument(xmlContent, docZip.schema, empresa, null as any, docZip.NSU);\n              xmlsEncontrados++;\n              \n              await storage.createLog({\n                userId: empresa.userId,\n                empresaId: empresa.id,\n                sincronizacaoId: null,\n                nivel: \"info\",\n                mensagem: `Busca avançada - XML encontrado no NSU ${nsuStr}`,\n                detalhes: JSON.stringify({\n                  nsu: nsuStr,\n                  schema: docZip.schema\n                }),\n              });\n            } catch (error) {\n              await storage.createLog({\n                userId: empresa.userId,\n                empresaId: empresa.id,\n                sincronizacaoId: null,\n                nivel: \"warning\",\n                mensagem: `Busca avançada - Erro ao processar documento NSU ${nsuStr}`,\n                detalhes: JSON.stringify({\n                  error: String(error),\n                  schema: docZip.schema,\n                  nsu: nsuStr\n                }),\n              });\n            }\n          }\n        } else if (response.cStat === \"656\") {\n          // Limite de consultas atingido - para imediatamente\n          await storage.createLog({\n            userId: empresa.userId,\n            empresaId: empresa.id,\n            sincronizacaoId: null,\n            nivel: \"warning\",\n            mensagem: `Busca avançada - Limite de consultas atingido (cStat 656)`,\n            detalhes: JSON.stringify({\n              nsu: nsuStr,\n              consultasRealizadas,\n              xMotivo: response.xMotivo,\n              observacao: \"Aguarde 1 hora para novas consultas\"\n            }),\n          });\n          break;\n        }\n\n        // Delay entre consultas (respeito à SEFAZ)\n        if (nsu < nsuFinalNum && consultasRealizadas < maxConsultas) {\n          await new Promise(resolve => setTimeout(resolve, 2000)); // 2 segundos\n        }\n      }\n\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"info\",\n        mensagem: `Busca avançada concluída`,\n        detalhes: JSON.stringify({\n          nsuInicial,\n          nsuFinal,\n          consultasRealizadas,\n          xmlsEncontrados,\n          nsuConsultados\n        }),\n      });\n\n      return {\n        xmlsEncontrados,\n        consultasRealizadas,\n        nsuConsultados\n      };\n\n    } catch (error) {\n      await storage.createLog({\n        userId: empresa.userId,\n        empresaId: empresa.id,\n        sincronizacaoId: null,\n        nivel: \"error\",\n        mensagem: `Erro na busca avançada: ${String(error)}`,\n        detalhes: JSON.stringify({\n          error: String(error),\n          consultasRealizadas,\n          xmlsEncontrados\n        }),\n      });\n\n      throw error;\n    }\n  }\n}\n\nexport const sefazService = new SefazService();\n","size_bytes":118698},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"design_guidelines.md":{"content":"# Design Guidelines: Aplicativo de Download XML SEFAZ\n\n## Design Approach: Material Design System\n**Rationale:** This is a utility-focused, data-intensive business application for tax compliance. Material Design provides excellent patterns for dashboards, data tables, forms, and status indicators - perfect for this productivity tool.\n\n**Key Principles:**\n- Professional and trustworthy appearance for business/tax software\n- Efficient information display with clear visual hierarchy\n- Minimal distractions - focus on data and functionality\n- Real-time status feedback through clear indicators\n\n---\n\n## Typography\n\n**Font Family:**\n- Primary: 'Inter' (Google Fonts) - excellent for UI and data display\n- Monospace: 'Roboto Mono' for CNPJ, NSU numbers, file paths\n\n**Hierarchy:**\n- Page Titles: text-2xl font-semibold\n- Section Headers: text-lg font-medium\n- Card Titles: text-base font-medium\n- Body Text: text-sm font-normal\n- Captions/Labels: text-xs font-medium uppercase tracking-wide\n- Data Values: text-sm font-mono (for numbers, CNPJs)\n\n---\n\n## Layout System\n\n**Spacing Primitives:** Use Tailwind units of **2, 3, 4, 6, 8** for consistency\n- Component padding: p-4, p-6\n- Card spacing: gap-4, space-y-6\n- Form fields: space-y-3\n- Section margins: mb-6, mb-8\n\n**Grid Structure:**\n- Sidebar Navigation: Fixed width 16rem (w-64)\n- Main Content: Flexible with max-w-7xl container\n- Dashboard Cards: grid-cols-1 md:grid-cols-2 lg:grid-cols-3\n- Data Tables: Full-width responsive with horizontal scroll on mobile\n\n---\n\n## Core Layout Structure\n\n**Main Application Layout:**\n```\n┌─────────────────────────────────────────┐\n│  Top Bar (Logo + User Info)            │\n├──────────┬──────────────────────────────┤\n│          │                              │\n│ Sidebar  │   Main Content Area          │\n│ Nav      │   (Dashboard/Companies/Logs) │\n│          │                              │\n│          │                              │\n└──────────┴──────────────────────────────┘\n```\n\n**Sidebar Navigation (Fixed, w-64):**\n- Dashboard\n- Empresas Cadastradas\n- Logs de Sincronização\n- Configurações\n\n**Top Bar (h-16):**\n- Logo/App name (left)\n- Current sync status indicator (center)\n- User profile/settings (right)\n\n---\n\n## Component Library\n\n### 1. Dashboard Cards\n- Rounded corners (rounded-lg)\n- Subtle shadow (shadow-sm border)\n- Padding: p-6\n- Content: Icon + metric number + label\n- Grid layout for stats: \"Total Empresas\", \"XMLs Hoje\", \"Última Sincronização\", \"Status\"\n\n### 2. Company List/Table\n- Table headers: Sticky with subtle background\n- Row hover states for interactivity\n- Columns: Logo/Avatar, CNPJ, Razão Social, UF, Status Badge, Último XML, Ações\n- Action buttons: Icon buttons for Edit/Delete\n- Status badges: Small rounded pills with dot indicators\n\n### 3. Forms (Cadastro de Empresa)\n- Vertical form layout (max-w-2xl)\n- Field groups with clear labels (text-xs uppercase tracking-wide)\n- Input fields: border rounded-md focus:ring-2\n- File upload for .pfx certificate: Drag-drop zone with file preview\n- Password field for certificate with show/hide toggle\n- Select dropdown for UF with search\n- Clear submit/cancel button pair\n\n### 4. Status Indicators\n- Sync badges: \"Ativo\", \"Sincronizando\", \"Erro\", \"Pausado\"\n- Use dot indicators (w-2 h-2 rounded-full) before text\n- Real-time pulse animation only for \"Sincronizando\" state\n\n### 5. Log Viewer\n- Monospace font display\n- Scrollable container with fixed height\n- Line numbers optional\n- Timestamp + Level + Message columns\n- Filter by level (Info/Warning/Error)\n\n### 6. XML File Browser\n- Tree/folder structure: CNPJ → Year → Month → Files\n- Expandable/collapsible folders\n- File icons and size display\n- Download button per file\n- Search/filter by date range or CNPJ\n\n### 7. Navigation\n- Vertical sidebar with icons + text labels\n- Active state: Subtle background fill\n- Hover state: Light background\n- Icon size: w-5 h-5\n\n### 8. Buttons\n**Primary:** Solid background for main actions (Cadastrar, Salvar)\n**Secondary:** Outlined for cancel/back actions\n**Icon Buttons:** For table actions (edit/delete) - w-8 h-8 rounded-md\n**Sizes:** px-4 py-2 for standard, px-6 py-3 for prominent\n\n### 9. Data Display\n- Definition lists for company details\n- Stat cards with large numbers (text-3xl font-bold)\n- Progress indicators for sync status\n- Empty states with helpful illustrations and CTAs\n\n---\n\n## Animations\n\n**Minimal Use Only:**\n- Loading spinners for async operations\n- Subtle fade-in for newly loaded content (duration-200)\n- Pulse animation for \"Sincronizando\" badge\n- No page transitions or decorative animations\n\n---\n\n## Page-Specific Layouts\n\n### Dashboard Page\n- 4-column stat cards at top (grid-cols-4)\n- Recent activity feed below (2-column: Recent XMLs | Sync Logs)\n- Quick actions card for adding new company\n\n### Empresas Page\n- Header with search bar + \"Nova Empresa\" button\n- Data table with all companies\n- Click row to expand details or edit inline\n\n### Logs Page\n- Filter toolbar at top (date range, level, company)\n- Full-width log viewer with virtual scrolling\n- Export logs button\n\n### Configurações Page\n- Tabbed interface: Geral, Agendamento, Notificações\n- Form-based configuration with clear sections\n- Sync interval configuration (hourly by default, adjustable)\n\n---\n\n## Professional Polish\n\n- Consistent spacing rhythm throughout (multiples of 4)\n- Clear visual separation between sections using borders/backgrounds\n- Breadcrumbs for navigation context\n- Toast notifications for success/error feedback\n- Confirmation modals for destructive actions (delete company)\n- Responsive design: Sidebar collapses to hamburger menu on mobile\n- Loading states for all async operations\n- Error states with retry options","size_bytes":6016},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest<T = any>(\n  url: string,\n  options?: RequestInit,\n): Promise<T> {\n  // Busca token do localStorage (apenas no browser)\n  const sessionStr = typeof window !== 'undefined' ? localStorage.getItem(\"session\") : null;\n  \n  // Detecta se o body é FormData para não sobrescrever Content-Type\n  const isFormData = options?.body instanceof FormData;\n  \n  let headers: Record<string, string> = {\n    ...(!isFormData && { \"Content-Type\": \"application/json\" }),\n    ...options?.headers as Record<string, string>,\n  };\n\n  if (sessionStr) {\n    try {\n      const session = JSON.parse(sessionStr);\n      if (session.accessToken) {\n        headers[\"Authorization\"] = `Bearer ${session.accessToken}`;\n      }\n    } catch (error) {\n      console.error(\"Erro ao parsear sessão:\", error);\n    }\n  }\n\n  const res = await fetch(url, {\n    ...options,\n    headers,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  \n  // Se não tiver body (204 No Content), retorna objeto vazio\n  if (res.status === 204 || res.headers.get(\"content-length\") === \"0\") {\n    return {} as T;\n  }\n  \n  return res.json();\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    // Busca token do localStorage (apenas no browser)\n    const sessionStr = typeof window !== 'undefined' ? localStorage.getItem(\"session\") : null;\n    let headers: Record<string, string> = {};\n\n    if (sessionStr) {\n      try {\n        const session = JSON.parse(sessionStr);\n        if (session.accessToken) {\n          headers[\"Authorization\"] = `Bearer ${session.accessToken}`;\n        }\n      } catch (error) {\n        console.error(\"Erro ao parsear sessão:\", error);\n      }\n    }\n\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n      headers,\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":2658},"server/storage.ts":{"content":"import {\n  type Empresa,\n  type InsertEmpresa,\n  type Sincronizacao,\n  type InsertSincronizacao,\n  type Xml,\n  type InsertXml,\n  type Log,\n  type InsertLog,\n  type Manifestacao,\n  type InsertManifestacao,\n  type Configuracao,\n  type InsertConfiguracao,\n  type UpdateConfiguracao,\n} from \"@shared/schema\";\n\nexport interface IStorage {\n  // Empresas\n  getEmpresas(userId?: string): Promise<Empresa[]>;\n  getEmpresa(id: string, userId?: string): Promise<Empresa | null>;\n  getEmpresaByCNPJ(cnpj: string, userId?: string): Promise<Empresa | null>;\n  createEmpresa(empresa: InsertEmpresa & { userId: string }): Promise<Empresa>;\n  updateEmpresa(id: string, updates: Partial<Empresa>, userId?: string): Promise<Empresa | null>;\n  deleteEmpresa(id: string, userId?: string): Promise<boolean>;\n  getEmpresasAtivas(userId?: string): Promise<Empresa[]>;\n\n  // Sincronizações\n  getSincronizacoes(userId?: string): Promise<Sincronizacao[]>;\n  getSincronizacao(id: string, userId?: string): Promise<Sincronizacao | null>;\n  createSincronizacao(sinc: InsertSincronizacao & { userId: string }): Promise<Sincronizacao>;\n  updateSincronizacao(id: string, updates: Partial<Sincronizacao>, userId?: string): Promise<Sincronizacao | null>;\n  getSincronizacoesEmAndamento(userId?: string): Promise<Sincronizacao[]>;\n\n  // XMLs\n  getXmls(userId?: string): Promise<Xml[]>;\n  getXml(id: string, userId?: string): Promise<Xml | null>;\n  getXmlByChave(chaveNFe: string, userId?: string): Promise<Xml | null>;\n  createXml(xml: InsertXml & { userId: string }): Promise<Xml>;\n  updateXml(id: string, updates: Partial<Xml>, userId?: string): Promise<Xml | null>;\n  getXmlsRecentes(limit?: number, userId?: string): Promise<Xml[]>;\n  getXmlsHoje(userId?: string): Promise<number>;\n  getXmlsPendentesDownload(userId?: string, limit?: number): Promise<Xml[]>;\n  getXmlsComErroDownload(userId?: string, limit?: number): Promise<Xml[]>;\n  getXmlsComErroDefinitivo(userId?: string, limit?: number): Promise<Xml[]>;\n\n  // Logs\n  getLogs(userId?: string): Promise<Log[]>;\n  createLog(log: InsertLog & { userId?: string }): Promise<Log>;\n  getLogsRecentes(limit?: number, userId?: string): Promise<Log[]>;\n  deleteLockLogs(): Promise<void>;\n\n  // Manifestações do Destinatário (NT 2020.001)\n  getManifestacoes(userId?: string): Promise<Manifestacao[]>;\n  getManifestacao(id: string, userId?: string): Promise<Manifestacao | null>;\n  getManifestacaoByChave(chaveNFe: string, userId?: string): Promise<Manifestacao | null>;\n  getManifestacoesByEmpresa(empresaId: string, userId?: string): Promise<Manifestacao[]>;\n  getManifestacoesPendentes(empresaId: string, userId?: string): Promise<Manifestacao[]>;\n  createManifestacao(manifestacao: InsertManifestacao & { userId: string }): Promise<Manifestacao>;\n  updateManifestacao(id: string, updates: Partial<Manifestacao>, userId?: string): Promise<Manifestacao | null>;\n  getManifestacoesRecentes(limit?: number, userId?: string): Promise<Manifestacao[]>;\n\n  // Configurações\n  getConfiguracao(userId: string): Promise<Configuracao | null>;\n  createConfiguracao(config: InsertConfiguracao & { userId: string }): Promise<Configuracao>;\n  updateConfiguracao(userId: string, updates: UpdateConfiguracao): Promise<Configuracao>;\n\n  // Distributed Locks (PostgreSQL advisory locks via tabela dedicada)\n  tryAcquireDownloadLock(): Promise<boolean>;\n  releaseDownloadLock(): Promise<boolean>;\n\n  // Rate Limiting SEFAZ (evita cStat 656 - máx 20 consultas/hora)\n  checkRateLimit(empresaId: string, tipoOperacao: string, userId: string): Promise<boolean>;\n  resetRateLimit(empresaId: string): Promise<void>;\n  \n  // Atualizar status NFe (cancelada, denegada, etc)\n  updateXmlStatus(id: string, statusNfe: string, userId?: string): Promise<Xml | null>;\n}\n\n// Exporta SupabaseStorage como implementação única\nimport { supabaseStorage } from \"./supabase-storage\";\nexport const storage: IStorage = supabaseStorage;\n","size_bytes":3919},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/pages/empresa-form.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { Upload, ArrowLeft, Eye, EyeOff } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { UFS } from \"@shared/schema\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nconst formSchema = z.object({\n  cnpj: z.string().regex(/^\\d{14}$/, \"CNPJ deve conter 14 dígitos (somente números)\"),\n  razaoSocial: z.string().min(1, \"Razão social é obrigatória\"),\n  uf: z.string().length(2, \"Selecione uma UF\"),\n  ambiente: z.enum([\"prod\", \"hom\"]),\n  certificadoSenha: z.string().min(1, \"Senha do certificado é obrigatória\"),\n  ativo: z.boolean().default(true),\n  tipoArmazenamento: z.enum([\"local\", \"supabase\"]).default(\"local\"),\n  manifestacaoAutomatica: z.boolean().default(false),\n});\n\ntype FormData = z.infer<typeof formSchema>;\n\nexport default function EmpresaForm() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [certificadoFile, setCertificadoFile] = useState<File | null>(null);\n  const [showPassword, setShowPassword] = useState(false);\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      cnpj: \"\",\n      razaoSocial: \"\",\n      uf: \"\",\n      ambiente: \"prod\",\n      certificadoSenha: \"\",\n      ativo: true,\n      tipoArmazenamento: \"local\",\n      manifestacaoAutomatica: false,\n    },\n  });\n\n  const onSubmit = async (data: FormData) => {\n    if (!certificadoFile) {\n      toast({\n        title: \"Erro\",\n        description: \"Selecione o arquivo do certificado digital (.pfx)\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      const formData = new FormData();\n      formData.append(\"cnpj\", data.cnpj);\n      formData.append(\"razaoSocial\", data.razaoSocial);\n      formData.append(\"uf\", data.uf);\n      formData.append(\"ambiente\", data.ambiente);\n      formData.append(\"certificadoSenha\", data.certificadoSenha);\n      formData.append(\"tipoArmazenamento\", data.tipoArmazenamento);\n      formData.append(\"manifestacaoAutomatica\", data.manifestacaoAutomatica.toString());\n      formData.append(\"certificado\", certificadoFile);\n\n      await apiRequest(\"/api/empresas\", {\n        method: \"POST\",\n        body: formData,\n      });\n\n      toast({\n        title: \"Empresa cadastrada!\",\n        description: \"A empresa foi cadastrada com sucesso e está pronta para sincronização.\",\n      });\n\n      setTimeout(() => {\n        setLocation(\"/empresas\");\n      }, 1000);\n    } catch (error) {\n      toast({\n        title: \"Erro ao cadastrar\",\n        description: error instanceof Error ? error.message : \"Erro ao cadastrar empresa\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const formatCNPJ = (value: string) => {\n    const numbers = value.replace(/\\D/g, \"\");\n    return numbers.slice(0, 14);\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (!file.name.endsWith(\".pfx\") && !file.name.endsWith(\".p12\")) {\n        toast({\n          title: \"Arquivo inválido\",\n          description: \"Selecione um arquivo de certificado digital (.pfx ou .p12)\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setCertificadoFile(file);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6 max-w-3xl\">\n      <div className=\"flex items-center gap-3\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setLocation(\"/empresas\")}\n          data-testid=\"button-voltar\"\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n        </Button>\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-nova-empresa\">Nova Empresa</h1>\n          <p className=\"text-sm text-muted-foreground\">Cadastre uma empresa para sincronização automática</p>\n        </div>\n      </div>\n\n      <Form {...form}>\n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Dados da Empresa</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"razaoSocial\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Razão Social\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"Nome da empresa\"\n                        {...field}\n                        data-testid=\"input-razao-social\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"cnpj\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                        CNPJ\n                      </FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"00000000000000\"\n                          {...field}\n                          onChange={(e) => field.onChange(formatCNPJ(e.target.value))}\n                          maxLength={14}\n                          className=\"font-mono\"\n                          data-testid=\"input-cnpj\"\n                        />\n                      </FormControl>\n                      <FormDescription>Somente números (14 dígitos)</FormDescription>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"uf\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                        UF\n                      </FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-uf\">\n                            <SelectValue placeholder=\"Selecione a UF\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {UFS.map((uf) => (\n                            <SelectItem key={uf} value={uf}>\n                              {uf}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"ambiente\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Ambiente SEFAZ\n                    </FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-ambiente\">\n                          <SelectValue placeholder=\"Selecione o ambiente\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"prod\">Produção</SelectItem>\n                        <SelectItem value=\"hom\">Homologação</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Use Produção para ambiente real ou Homologação para testes\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"ativo\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-sm font-medium\">\n                        Empresa Ativa\n                      </FormLabel>\n                      <FormDescription>\n                        Empresas ativas são sincronizadas automaticamente a cada hora\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-ativo\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"tipoArmazenamento\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Tipo de Armazenamento\n                    </FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-tipo-armazenamento\">\n                          <SelectValue placeholder=\"Selecione o tipo de armazenamento\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"local\">Local (filesystem)</SelectItem>\n                        <SelectItem value=\"supabase\">Supabase Storage</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Define onde os XMLs serão armazenados (local ou nuvem)\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"manifestacaoAutomatica\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-sm font-medium\">\n                        Manifestação Automática\n                      </FormLabel>\n                      <FormDescription>\n                        Manifesta automaticamente evento 210210 (Ciência da Operação) quando um novo XML é recebido\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-manifestacao-automatica\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Certificado Digital</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div>\n                <FormLabel className=\"text-xs font-medium uppercase tracking-wide mb-3 block\">\n                  Arquivo do Certificado (.pfx)\n                </FormLabel>\n                <div className=\"border-2 border-dashed rounded-lg p-6 text-center hover-elevate\">\n                  <input\n                    type=\"file\"\n                    accept=\".pfx,.p12\"\n                    onChange={handleFileChange}\n                    className=\"hidden\"\n                    id=\"certificado-upload\"\n                    data-testid=\"input-certificado\"\n                  />\n                  <label\n                    htmlFor=\"certificado-upload\"\n                    className=\"cursor-pointer flex flex-col items-center gap-2\"\n                  >\n                    <Upload className=\"w-10 h-10 text-muted-foreground\" />\n                    {certificadoFile ? (\n                      <>\n                        <p className=\"text-sm font-medium\">{certificadoFile.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {(certificadoFile.size / 1024).toFixed(2)} KB\n                        </p>\n                      </>\n                    ) : (\n                      <>\n                        <p className=\"text-sm font-medium\">Clique para selecionar o certificado</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Arquivo .pfx ou .p12 (máx. 5MB)\n                        </p>\n                      </>\n                    )}\n                  </label>\n                </div>\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"certificadoSenha\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Senha do Certificado\n                    </FormLabel>\n                    <div className=\"relative\">\n                      <FormControl>\n                        <Input\n                          type={showPassword ? \"text\" : \"password\"}\n                          placeholder=\"Digite a senha do certificado\"\n                          {...field}\n                          className=\"pr-10\"\n                          data-testid=\"input-senha\"\n                        />\n                      </FormControl>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"absolute right-0 top-0 h-full\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        data-testid=\"button-toggle-senha\"\n                      >\n                        {showPassword ? (\n                          <EyeOff className=\"w-4 h-4\" />\n                        ) : (\n                          <Eye className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                    </div>\n                    <FormDescription>\n                      A senha será armazenada de forma segura e criptografada\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <div className=\"flex items-center gap-3\">\n            <Button\n              type=\"submit\"\n              disabled={form.formState.isSubmitting}\n              data-testid=\"button-salvar\"\n            >\n              {form.formState.isSubmitting ? \"Cadastrando...\" : \"Cadastrar Empresa\"}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setLocation(\"/empresas\")}\n              data-testid=\"button-cancelar\"\n            >\n              Cancelar\n            </Button>\n          </div>\n        </form>\n      </Form>\n    </div>\n  );\n}\n","size_bytes":16294},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 0 0% 100%;\n  --foreground: 0 0% 9%;\n  --border: 0 0% 91%;\n  --card: 0 0% 98%;\n  --card-foreground: 0 0% 9%;\n  --card-border: 0 0% 94%;\n  --sidebar: 0 0% 96%;\n  --sidebar-foreground: 0 0% 9%;\n  --sidebar-border: 0 0% 92%;\n  --sidebar-primary: 217 91% 35%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 0 0% 89%;\n  --sidebar-accent-foreground: 0 0% 9%;\n  --sidebar-ring: 217 91% 60%;\n  --popover: 0 0% 93%;\n  --popover-foreground: 0 0% 9%;\n  --popover-border: 0 0% 88%;\n  --primary: 217 91% 35%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 0 0% 88%;\n  --secondary-foreground: 0 0% 9%;\n  --muted: 0 0% 90%;\n  --muted-foreground: 0 0% 35%;\n  --accent: 217 20% 92%;\n  --accent-foreground: 0 0% 9%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 0 0% 75%;\n  --ring: 217 91% 60%;\n  --chart-1: 217 91% 35%;\n  --chart-2: 142 76% 28%;\n  --chart-3: 38 92% 45%;\n  --chart-4: 280 87% 35%;\n  --chart-5: 12 76% 42%;\n  --font-sans: Open Sans, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 0 0% 9%;\n  --foreground: 0 0% 98%;\n  --border: 0 0% 18%;\n  --card: 0 0% 11%;\n  --card-foreground: 0 0% 98%;\n  --card-border: 0 0% 14%;\n  --sidebar: 0 0% 13%;\n  --sidebar-foreground: 0 0% 98%;\n  --sidebar-border: 0 0% 16%;\n  --sidebar-primary: 217 91% 50%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 0 0% 18%;\n  --sidebar-accent-foreground: 0 0% 98%;\n  --sidebar-ring: 217 91% 60%;\n  --popover: 0 0% 15%;\n  --popover-foreground: 0 0% 98%;\n  --popover-border: 0 0% 18%;\n  --primary: 217 91% 50%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 0 0% 20%;\n  --secondary-foreground: 0 0% 98%;\n  --muted: 0 0% 18%;\n  --muted-foreground: 0 0% 65%;\n  --accent: 217 20% 16%;\n  --accent-foreground: 0 0% 98%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 0 0% 30%;\n  --ring: 217 91% 60%;\n  --chart-1: 217 91% 65%;\n  --chart-2: 142 76% 55%;\n  --chart-3: 38 92% 60%;\n  --chart-4: 280 87% 60%;\n  --chart-5: 12 76% 58%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","size_bytes":10530},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/pages/register.tsx":{"content":"import { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { FileText, Loader2 } from \"lucide-react\";\n\nexport default function Register() {\n  const [, navigate] = useLocation();\n  const { register } = useAuth();\n  const { toast } = useToast();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [nomeCompleto, setNomeCompleto] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (password !== confirmPassword) {\n      toast({\n        title: \"Erro\",\n        description: \"As senhas não coincidem\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (password.length < 6) {\n      toast({\n        title: \"Erro\",\n        description: \"A senha deve ter pelo menos 6 caracteres\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      await register(email, password, nomeCompleto);\n      toast({\n        title: \"Conta criada com sucesso\",\n        description: \"Bem-vindo ao SEFAZ XML Sync!\",\n      });\n      navigate(\"/\");\n    } catch (error: any) {\n      // Verifica se é erro de confirmação de email\n      const errorMessage = error.message || \"Ocorreu um erro ao criar sua conta\";\n      const isEmailConfirmation = errorMessage.includes(\"confirmar o cadastro\") || \n                                   errorMessage.includes(\"verifique seu email\");\n      const isRateLimit = errorMessage.includes(\"Muitas tentativas\") || \n                          errorMessage.includes(\"rate limit\") ||\n                          errorMessage.includes(\"aguarde\");\n      \n      toast({\n        title: isRateLimit ? \"⏱️ Aguarde um Momento\" : \n               isEmailConfirmation ? \"⚠️ Confirmação de Email Necessária\" : \n               \"Erro ao criar conta\",\n        description: errorMessage,\n        variant: (isEmailConfirmation || isRateLimit) ? \"default\" : \"destructive\",\n        duration: (isEmailConfirmation || isRateLimit) ? 10000 : 5000,\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"p-3 bg-primary/10 rounded-full\">\n              <FileText className=\"h-8 w-8 text-primary\" data-testid=\"icon-logo\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl font-bold\" data-testid=\"text-title\">\n            Criar Conta\n          </CardTitle>\n          <CardDescription data-testid=\"text-subtitle\">\n            Preencha os dados para começar\n          </CardDescription>\n        </CardHeader>\n\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"nomeCompleto\" data-testid=\"label-nome\">Nome Completo</Label>\n              <Input\n                id=\"nomeCompleto\"\n                type=\"text\"\n                placeholder=\"João Silva\"\n                value={nomeCompleto}\n                onChange={(e) => setNomeCompleto(e.target.value)}\n                required\n                disabled={isLoading}\n                data-testid=\"input-nome\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\" data-testid=\"label-email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"seu@email.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                required\n                disabled={isLoading}\n                data-testid=\"input-email\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\" data-testid=\"label-password\">Senha</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                minLength={6}\n                disabled={isLoading}\n                data-testid=\"input-password\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"confirmPassword\" data-testid=\"label-confirm-password\">Confirmar Senha</Label>\n              <Input\n                id=\"confirmPassword\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={confirmPassword}\n                onChange={(e) => setConfirmPassword(e.target.value)}\n                required\n                minLength={6}\n                disabled={isLoading}\n                data-testid=\"input-confirm-password\"\n              />\n            </div>\n          </CardContent>\n\n          <CardFooter className=\"flex flex-col space-y-4\">\n            <Button \n              type=\"submit\" \n              className=\"w-full\" \n              disabled={isLoading}\n              data-testid=\"button-register\"\n            >\n              {isLoading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Criando conta...\n                </>\n              ) : (\n                \"Criar Conta\"\n              )}\n            </Button>\n\n            <div className=\"text-sm text-center text-muted-foreground\">\n              Já tem uma conta?{\" \"}\n              <Link href=\"/login\" className=\"text-primary hover:underline\" data-testid=\"link-login\">\n                Entre aqui\n              </Link>\n            </div>\n          </CardFooter>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":6302},"server/supabase.ts":{"content":"import { createClient, SupabaseClient } from \"@supabase/supabase-js\";\n\n// Validar variáveis de ambiente\nconst supabaseUrl = process.env.SUPABASE_URL;\nconst supabaseAnonKey = process.env.SUPABASE_ANON_KEY;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseAnonKey || !supabaseServiceKey) {\n  throw new Error(\n    \"Faltam variáveis de ambiente do Supabase: SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY\"\n  );\n}\n\n// Cliente público (com RLS - respects Row Level Security)\n// Usado para operações do lado do servidor que precisam respeitar RLS\nexport const supabaseAnon = createClient(supabaseUrl, supabaseAnonKey, {\n  auth: {\n    persistSession: false, // Não persiste sessão no servidor\n    autoRefreshToken: false, // Cliente gerencia refresh\n  },\n});\n\n// Cliente admin (bypassa RLS - para sincronizações automáticas)\n// Usado apenas para operações do sistema (cron jobs, etc)\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: {\n    persistSession: false,\n    autoRefreshToken: false,\n  },\n});\n\n// Cria cliente Supabase com token de usuário específico\n// Usado para operações que precisam de contexto de usuário autenticado\nexport function createUserSupabaseClient(accessToken: string): SupabaseClient {\n  return createClient(supabaseUrl!, supabaseAnonKey!, {\n    global: {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    },\n    auth: {\n      persistSession: false,\n      autoRefreshToken: false,\n    },\n  });\n}\n\nconsole.log(\"✓ Supabase configurado com sucesso\");\n","size_bytes":1606},"client/src/pages/auth-confirm.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardHeader, CardTitle, CardDescription, CardContent } from \"@/components/ui/card\";\nimport { Loader2, CheckCircle, XCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface User {\n  id: string;\n  email: string;\n  nomeCompleto: string;\n}\n\nexport default function AuthConfirm() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [status, setStatus] = useState<\"loading\" | \"success\" | \"error\">(\"loading\");\n  const [message, setMessage] = useState(\"Confirmando seu email...\");\n\n  useEffect(() => {\n    const handleEmailConfirmation = async () => {\n      try {\n        // Supabase redireciona com access_token e refresh_token nos hash fragments\n        const hashParams = new URLSearchParams(window.location.hash.substring(1));\n        const accessToken = hashParams.get(\"access_token\");\n        const refreshToken = hashParams.get(\"refresh_token\");\n        const expiresInStr = hashParams.get(\"expires_in\");\n        const type = hashParams.get(\"type\");\n\n        if (!accessToken || !refreshToken) {\n          setStatus(\"error\");\n          setMessage(\"Link de confirmação inválido ou expirado\");\n          return;\n        }\n\n        if (type === \"signup\") {\n          // Usa o expires_in real do Supabase ou fallback para 3600 (1 hora)\n          const expiresInRaw = expiresInStr ? parseInt(expiresInStr) : 3600;\n          const expiresIn = isNaN(expiresInRaw) ? 3600 : expiresInRaw;\n          const expiresAt = Math.floor(Date.now() / 1000) + expiresIn;\n          \n          const session = {\n            accessToken,\n            refreshToken,\n            expiresAt,\n          };\n\n          // Salva sessão ANTES de fazer requisição para que apiRequest possa injetá-la\n          localStorage.setItem(\"session\", JSON.stringify(session));\n\n          // Busca dados do usuário usando apiRequest (que injeta o Bearer token automaticamente)\n          const userData = await apiRequest<{ user: User }>(\"/api/auth/me\");\n\n          // Salva usuário no localStorage\n          localStorage.setItem(\"user\", JSON.stringify(userData.user));\n\n          // Limpa tokens sensíveis do hash da URL por segurança\n          window.history.replaceState(null, \"\", window.location.pathname);\n\n          setStatus(\"success\");\n          setMessage(\"Email confirmado com sucesso! Redirecionando...\");\n\n          toast({\n            title: \"Email confirmado!\",\n            description: \"Bem-vindo ao SEFAZ XML Sync!\",\n          });\n\n          // Redireciona para o dashboard após 2 segundos\n          setTimeout(() => {\n            window.location.href = \"/\";\n          }, 2000);\n        } else {\n          setStatus(\"error\");\n          setMessage(\"Tipo de confirmação não reconhecido\");\n        }\n      } catch (error) {\n        console.error(\"Erro ao processar confirmação:\", error);\n        setStatus(\"error\");\n        setMessage(\"Erro ao processar confirmação de email\");\n        \n        toast({\n          title: \"Erro\",\n          description: \"Não foi possível confirmar seu email. Tente fazer login.\",\n          variant: \"destructive\",\n        });\n\n        // Redireciona para login após erro\n        setTimeout(() => {\n          navigate(\"/login\");\n        }, 3000);\n      }\n    };\n\n    handleEmailConfirmation();\n  }, [navigate, toast]);\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <div className=\"flex justify-center mb-4\">\n            {status === \"loading\" && (\n              <Loader2 className=\"h-12 w-12 text-primary animate-spin\" data-testid=\"icon-loading\" />\n            )}\n            {status === \"success\" && (\n              <CheckCircle className=\"h-12 w-12 text-green-500\" data-testid=\"icon-success\" />\n            )}\n            {status === \"error\" && (\n              <XCircle className=\"h-12 w-12 text-destructive\" data-testid=\"icon-error\" />\n            )}\n          </div>\n          <CardTitle className=\"text-2xl font-bold\" data-testid=\"text-title\">\n            {status === \"loading\" && \"Confirmando Email\"}\n            {status === \"success\" && \"Email Confirmado!\"}\n            {status === \"error\" && \"Erro na Confirmação\"}\n          </CardTitle>\n          <CardDescription data-testid=\"text-message\">\n            {message}\n          </CardDescription>\n        </CardHeader>\n\n        <CardContent className=\"text-center text-sm text-muted-foreground\">\n          {status === \"loading\" && \"Por favor, aguarde...\"}\n          {status === \"success\" && \"Você será redirecionado em instantes.\"}\n          {status === \"error\" && \"Você será redirecionado para a página de login.\"}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":4913},"GIT-SETUP.md":{"content":"# 📦 Como Subir o Código para o GitHub\n\n## Guia Completo Passo a Passo\n\n---\n\n## 📋 Pré-requisitos\n\n- [ ] Git instalado (`git --version`)\n- [ ] Conta no GitHub (https://github.com)\n\n---\n\n## 🚀 Método 1: Criar Repositório Novo (Recomendado)\n\n### **Passo 1: Criar Repositório no GitHub**\n\n1. Acesse: https://github.com\n2. Clique no **+** (canto superior direito) → **New repository**\n3. Preencha:\n   - **Repository name:** `sefaz-xml-sync`\n   - **Description:** `Sistema de download automático de XMLs da SEFAZ com autenticação multi-usuário`\n   - **Visibility:** \n     - ✅ **Private** (recomendado - código da empresa)\n     - ⚠️ **Public** (código aberto - cuidado com secrets!)\n   - ❌ **NÃO** marque \"Add a README file\"\n   - ❌ **NÃO** marque \"Add .gitignore\"\n   - ❌ **NÃO** escolha licença ainda\n4. Clique: **Create repository**\n\n**Copie a URL do repositório:**\n- HTTPS: `https://github.com/SEU_USUARIO/sefaz-xml-sync.git`\n- SSH: `git@github.com:SEU_USUARIO/sefaz-xml-sync.git`\n\n---\n\n### **Passo 2: No Replit (Terminal)**\n\n#### **2.1. Inicializar Git (se ainda não estiver)**\n\n```bash\n# Verificar se já é repositório Git\ngit status\n\n# Se der erro \"not a git repository\", inicializar:\ngit init\n```\n\n#### **2.2. Configurar Git (primeira vez)**\n\n```bash\n# Configurar nome e email\ngit config --global user.name \"Seu Nome\"\ngit config --global user.email \"seu-email@example.com\"\n\n# Verificar configuração\ngit config --list\n```\n\n#### **2.3. Verificar arquivos que serão commitados**\n\n```bash\n# Ver arquivos não rastreados\ngit status\n\n# IMPORTANTE: Verificar se NÃO aparecem:\n# - .env ou .env.*\n# - certificados/\n# - xmls/\n# Se aparecerem, verificar .gitignore!\n```\n\n#### **2.4. Adicionar arquivos ao staging**\n\n```bash\n# Adicionar todos os arquivos\ngit add .\n\n# Verificar o que foi adicionado\ngit status\n```\n\n#### **2.5. Criar commit inicial**\n\n```bash\n# Commit com mensagem descritiva\ngit commit -m \"feat: sistema completo de download automático de XMLs SEFAZ\n\n- Autenticação multi-usuário com Supabase\n- Sincronização automática a cada 1 hora\n- Upload de certificados digitais\n- Navegador de XMLs por CNPJ/Ano/Mês\n- Deploy Docker standalone (Nginx + Certbot)\n- Deploy Portainer + Traefik\n- Row-Level Security (RLS) para isolamento de dados\n- Documentação completa de deployment\"\n```\n\n---\n\n### **Passo 3: Conectar ao GitHub e Fazer Push**\n\n#### **3.1. Adicionar remote**\n\n```bash\n# Substituir SEU_USUARIO pelo seu username do GitHub\ngit remote add origin https://github.com/SEU_USUARIO/sefaz-xml-sync.git\n\n# Verificar\ngit remote -v\n```\n\n#### **3.2. Renomear branch para 'main' (se necessário)**\n\n```bash\n# Verificar branch atual\ngit branch\n\n# Se for 'master', renomear para 'main'\ngit branch -M main\n```\n\n#### **3.3. Push inicial**\n\n```bash\n# Push para GitHub\ngit push -u origin main\n```\n\n**Se pedir autenticação:**\n- **Username:** seu username do GitHub\n- **Password:** \n  - ❌ **NÃO** use sua senha do GitHub (não funciona mais!)\n  - ✅ Use um **Personal Access Token (PAT)**\n\n---\n\n### **Passo 4: Criar Personal Access Token (se necessário)**\n\nSe o push pedir senha e falhar:\n\n1. GitHub → **Settings** (seu perfil)\n2. **Developer settings** (menu lateral, final)\n3. **Personal access tokens** → **Tokens (classic)**\n4. **Generate new token** → **Generate new token (classic)**\n5. Preencha:\n   - **Note:** `Replit - SEFAZ XML Sync`\n   - **Expiration:** `90 days` (ou mais)\n   - **Scopes:** Marque:\n     - ✅ `repo` (acesso completo a repositórios)\n6. **Generate token**\n7. **COPIE O TOKEN** (não será mostrado novamente!)\n\n**Fazer push novamente:**\n```bash\ngit push -u origin main\n\n# Username: seu-usuario\n# Password: cole-o-token-aqui\n```\n\n---\n\n### **Passo 5: Verificar no GitHub**\n\n1. Acesse: `https://github.com/SEU_USUARIO/sefaz-xml-sync`\n2. Verifique se todos os arquivos foram enviados\n3. Verifique se **NÃO** aparecem:\n   - ❌ Arquivos `.env*`\n   - ❌ Pasta `certificados/`\n   - ❌ Pasta `xmls/`\n   - ❌ Arquivos `.pfx`\n\n---\n\n## 🔄 Atualizações Futuras\n\n### **Fazer alterações e enviar para o GitHub:**\n\n```bash\n# 1. Verificar alterações\ngit status\n\n# 2. Adicionar arquivos modificados\ngit add .\n\n# 3. Commit com mensagem descritiva\ngit commit -m \"feat: adicionar funcionalidade X\"\n\n# 4. Enviar para GitHub\ngit push\n```\n\n### **Exemplos de mensagens de commit:**\n\n```bash\n# Nova funcionalidade\ngit commit -m \"feat: adicionar exportação de XMLs em PDF\"\n\n# Correção de bug\ngit commit -m \"fix: corrigir parsing de SOAP com múltiplos documentos\"\n\n# Atualização de documentação\ngit commit -m \"docs: atualizar guia de deployment Portainer\"\n\n# Refatoração\ngit commit -m \"refactor: melhorar performance da sincronização SEFAZ\"\n\n# Alteração de configuração\ngit commit -m \"chore: atualizar dependências do projeto\"\n```\n\n---\n\n## 🔐 Segurança: O Que NUNCA Commitar\n\n### **Arquivos sensíveis (já no .gitignore):**\n\n- ❌ `.env*` (contém secrets do Supabase)\n- ❌ `certificados/` (certificados digitais .pfx)\n- ❌ `xmls/` (dados das empresas)\n- ❌ `acme.json` (certificados Let's Encrypt)\n- ❌ Logs com informações sensíveis\n\n### **Se você commitou por engano:**\n\n```bash\n# ATENÇÃO: Só use isso ANTES de fazer push!\n# Remove arquivo do staging\ngit reset HEAD arquivo-sensivel.env\n\n# Remove do último commit (se já commitou)\ngit reset --soft HEAD~1\n\n# Remove arquivo do Git mas mantém no disco\ngit rm --cached arquivo-sensivel.env\n\n# Commit novamente (sem o arquivo sensível)\ngit commit -m \"chore: remover arquivo sensível\"\n```\n\n**⚠️ Se já fez push para GitHub:**\n1. **NUNCA** use o mesmo secret novamente\n2. Gere novos secrets (Supabase, SESSION_SECRET)\n3. Delete o repositório do GitHub e crie novo\n4. **OU** use ferramentas como BFG Repo-Cleaner (avançado)\n\n---\n\n## 📂 Estrutura de Branches (Opcional - Avançado)\n\n### **Para trabalhar com múltiplos ambientes:**\n\n```bash\n# Branch de desenvolvimento\ngit checkout -b dev\ngit push -u origin dev\n\n# Branch de staging\ngit checkout -b staging\ngit push -u origin staging\n\n# Branch principal (produção)\ngit checkout main\n```\n\n### **Workflow:**\n1. Desenvolver em `dev`\n2. Testar em `staging`\n3. Merge para `main` (produção)\n\n---\n\n## 🔄 Clonar Repositório em Outro Lugar\n\n### **No servidor de produção:**\n\n```bash\n# HTTPS (público ou com token)\ngit clone https://github.com/SEU_USUARIO/sefaz-xml-sync.git\n\n# SSH (configuração de chave SSH necessária)\ngit clone git@github.com:SEU_USUARIO/sefaz-xml-sync.git\n\n# Entrar no diretório\ncd sefaz-xml-sync\n\n# Criar .env com valores de produção\ncp .env.portainer .env\nnano .env\n```\n\n---\n\n## 📝 Comandos Git Úteis\n\n```bash\n# Ver histórico de commits\ngit log --oneline\n\n# Ver alterações não commitadas\ngit diff\n\n# Ver status\ngit status\n\n# Desfazer alterações locais (cuidado!)\ngit checkout -- arquivo.txt\n\n# Atualizar do GitHub\ngit pull\n\n# Ver branches\ngit branch -a\n\n# Trocar de branch\ngit checkout nome-da-branch\n\n# Criar e trocar para nova branch\ngit checkout -b nova-branch\n\n# Ver remotos configurados\ngit remote -v\n```\n\n---\n\n## 🎯 Checklist Final\n\nAntes de fazer push, verificar:\n\n- [ ] `.gitignore` configurado corretamente\n- [ ] `git status` não mostra arquivos sensíveis\n- [ ] Arquivo `.env.example` (template) commitado\n- [ ] Arquivos `.env*` reais NÃO commitados\n- [ ] Certificados `.pfx` NÃO commitados\n- [ ] XMLs NÃO commitados\n- [ ] README.md e documentação atualizados\n- [ ] Commit com mensagem descritiva\n\n---\n\n## 🎓 Recursos de Aprendizado\n\n- **Git Basics:** https://git-scm.com/book/en/v2\n- **GitHub Guides:** https://guides.github.com\n- **Visual Git Guide:** https://marklodato.github.io/visual-git-guide/index-en.html\n- **Oh My Git! (Jogo):** https://ohmygit.org\n\n---\n\n## 🆘 Problemas Comuns\n\n### **\"remote: Support for password authentication was removed\"**\n\n**Solução:** Use Personal Access Token em vez de senha\n\n### **\"Permission denied (publickey)\"**\n\n**Solução:** \n1. Use HTTPS em vez de SSH\n2. **OU** configure chave SSH: https://docs.github.com/en/authentication/connecting-to-github-with-ssh\n\n### **\"! [rejected] main -> main (fetch first)\"**\n\n**Solução:**\n```bash\ngit pull origin main --rebase\ngit push origin main\n```\n\n### **Arquivos sensíveis foram commitados**\n\n**Se NÃO fez push ainda:**\n```bash\ngit reset --soft HEAD~1\n# Corrigir .gitignore e commitar novamente\n```\n\n**Se JÁ fez push:**\n1. Gerar novos secrets\n2. Deletar repositório e criar novo\n3. Push novamente\n\n---\n\n## ✅ Conclusão\n\nAgora seu código está no GitHub! 🎉\n\n**Próximos passos:**\n1. Fazer deploy via Portainer (seguir `DEPLOYMENT-PORTAINER.md`)\n2. Configurar CI/CD (GitHub Actions - opcional)\n3. Adicionar badges ao README\n4. Configurar branch protection (main)\n\n---\n\n**Dúvidas?** Consulte a documentação oficial do Git ou GitHub.\n","size_bytes":8792},"DEPLOYMENT.md":{"content":"# 🚀 Guia Completo de Deploy - SEFAZ XML Sync\n## Deploy com Docker em VPS Hetzner\n\n---\n\n## 📋 Pré-requisitos\n\n### 1. VPS Hetzner\n- Servidor Ubuntu 22.04 ou 24.04 LTS\n- Mínimo: 2GB RAM, 1 vCPU (CX11 - ~€4.51/mês)\n- Recomendado: 4GB RAM, 2 vCPU (CX21 - ~€5.83/mês)\n- IP público fixo\n\n### 2. Domínio\n- Domínio próprio configurado apontando para o IP do servidor\n- Registros DNS tipo A:\n  ```\n  @ (ou seu-dominio.com) → IP_DO_SERVIDOR\n  www → IP_DO_SERVIDOR\n  ```\n\n### 3. Conta Supabase\n- Projeto criado em https://supabase.com\n- Database schema executado (ver `supabase-schema.sql`)\n- RLS (Row-Level Security) configurado\n- Anon Key e Service Role Key disponíveis\n\n---\n\n## 🔧 Passo 1: Configurar VPS Hetzner\n\n### 1.1. Criar servidor no Hetzner Cloud\n\n```bash\n# Acesse: https://console.hetzner.cloud/\n# 1. Criar projeto\n# 2. Add Server\n# 3. Location: Escolha mais próxima (ex: Ashburn, Frankfurt)\n# 4. Image: Ubuntu 24.04\n# 5. Type: CX21 (4GB RAM recomendado)\n# 6. Networking: IPv4 + IPv6\n# 7. SSH Keys: Adicione sua chave pública\n# 8. Create & Buy now\n```\n\n### 1.2. Conectar ao servidor\n\n```bash\n# Substitua pelo IP real do seu servidor\nssh root@SEU_IP_AQUI\n```\n\n### 1.3. Atualizar sistema\n\n```bash\napt update && apt upgrade -y\n```\n\n### 1.4. Instalar Docker e Docker Compose\n\n```bash\n# Instalar dependências\napt install -y ca-certificates curl gnupg lsb-release\n\n# Adicionar chave GPG do Docker\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n\n# Adicionar repositório Docker\necho \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null\n\n# Instalar Docker\napt update\napt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\n\n# Verificar instalação\ndocker --version\ndocker compose version\n\n# Habilitar Docker no boot\nsystemctl enable docker\nsystemctl start docker\n```\n\n### 1.5. Configurar Firewall (UFW)\n\n```bash\n# Habilitar UFW\nufw enable\n\n# Permitir SSH\nufw allow 22/tcp\n\n# Permitir HTTP/HTTPS\nufw allow 80/tcp\nufw allow 443/tcp\n\n# Recarregar\nufw reload\nufw status\n```\n\n---\n\n## 📦 Passo 2: Preparar Aplicação\n\n### 2.1. Clonar/Transferir projeto para servidor\n\n**Opção A: Via Git (recomendado)**\n```bash\n# Instalar Git\napt install -y git\n\n# Criar diretório\nmkdir -p /opt/apps\ncd /opt/apps\n\n# Clonar seu repositório\ngit clone https://github.com/SEU_USUARIO/sefaz-xml-sync.git\ncd sefaz-xml-sync\n```\n\n**Opção B: Upload manual via SCP**\n```bash\n# No seu computador local:\nscp -r /caminho/do/projeto root@SEU_IP:/opt/apps/sefaz-xml-sync\n```\n\n### 2.2. Criar diretórios necessários\n\n```bash\ncd /opt/apps/sefaz-xml-sync\n\n# Criar estrutura de diretórios\nmkdir -p certificados xmls nginx/conf.d certbot/conf certbot/www\n```\n\n### 2.3. Configurar variáveis de ambiente\n\n```bash\n# Copiar exemplo\ncp .env.example .env\n\n# Editar com seus valores reais\nnano .env\n```\n\n**Preencha com:**\n```env\nSUPABASE_URL=https://seu-projeto.supabase.co\nSUPABASE_ANON_KEY=sua-anon-key-real\nSUPABASE_SERVICE_ROLE_KEY=sua-service-role-key-real\nSESSION_SECRET=$(openssl rand -base64 32)\nNODE_ENV=production\nPORT=5000\nXML_DEST_PATH=/app/xmls\nALLOW_SEFAZ_SIMULATION=false\n```\n\n**Gerar SESSION_SECRET:**\n```bash\nopenssl rand -base64 32\n```\n\n### 2.4. Editar configuração do Nginx\n\n```bash\nnano nginx/conf.d/default.conf\n```\n\n**Substituir `seu-dominio.com` pelo seu domínio real** em todas as linhas:\n- `server_name seu-dominio.com www.seu-dominio.com;`\n- Caminhos dos certificados SSL\n\n---\n\n## 🔐 Passo 3: Configurar SSL/HTTPS\n\n### 3.1. Preparar script de inicialização\n\n```bash\n# Tornar script executável\nchmod +x deploy-scripts/init-letsencrypt.sh\n\n# Editar script\nnano deploy-scripts/init-letsencrypt.sh\n```\n\n**Modificar:**\n```bash\ndomains=(seu-dominio.com www.seu-dominio.com)  # Seu domínio real\nemail=\"seu-email@exemplo.com\"  # Seu email real\nstaging=0  # Deixe 0 para produção (use 1 para testes)\n```\n\n### 3.2. Executar script (primeira vez)\n\n```bash\n./deploy-scripts/init-letsencrypt.sh\n```\n\n**O script irá:**\n1. Baixar parâmetros TLS recomendados\n2. Criar certificado temporário\n3. Iniciar Nginx\n4. Solicitar certificado real do Let's Encrypt\n5. Configurar renovação automática\n\n---\n\n## 🚀 Passo 4: Deploy da Aplicação\n\n### 4.1. Build das imagens Docker\n\n```bash\ndocker compose build\n```\n\n### 4.2. Iniciar containers\n\n```bash\ndocker compose up -d\n```\n\n### 4.3. Verificar status\n\n```bash\n# Ver containers rodando\ndocker compose ps\n\n# Ver logs\ndocker compose logs -f app\n\n# Logs específicos\ndocker compose logs -f nginx\ndocker compose logs -f certbot\n```\n\n### 4.4. Verificar saúde da aplicação\n\n```bash\n# Testar endpoint de saúde\ncurl http://localhost:5000/api/health\n\n# Verificar via navegador\n# https://seu-dominio.com\n```\n\n---\n\n## 📁 Passo 5: Upload de Certificados Digitais\n\n### 5.1. Transferir certificados .pfx para servidor\n\n**Do seu computador local:**\n```bash\nscp /caminho/certificado.pfx root@SEU_IP:/opt/apps/sefaz-xml-sync/certificados/\n```\n\n**Ou via SFTP/WinSCP (Windows)**\n\n### 5.2. Verificar permissões\n\n```bash\n# No servidor\ncd /opt/apps/sefaz-xml-sync\nchmod 600 certificados/*.pfx\n```\n\n---\n\n## 🔄 Passo 6: Configurar Backup Automático\n\n### 6.1. Criar script de backup\n\n```bash\nnano /opt/scripts/backup-sefaz.sh\n```\n\n```bash\n#!/bin/bash\nBACKUP_DIR=\"/backup/sefaz-xml-sync\"\nDATE=$(date +%Y%m%d_%H%M%S)\n\nmkdir -p $BACKUP_DIR\n\n# Backup XMLs e certificados\ntar -czf $BACKUP_DIR/xmls-$DATE.tar.gz /opt/apps/sefaz-xml-sync/xmls\ntar -czf $BACKUP_DIR/certificados-$DATE.tar.gz /opt/apps/sefaz-xml-sync/certificados\n\n# Manter apenas últimos 7 dias\nfind $BACKUP_DIR -type f -mtime +7 -delete\n\necho \"Backup realizado: $DATE\"\n```\n\n### 6.2. Tornar executável e agendar\n\n```bash\nchmod +x /opt/scripts/backup-sefaz.sh\n\n# Adicionar ao crontab (diário às 3h da manhã)\ncrontab -e\n\n# Adicione:\n0 3 * * * /opt/scripts/backup-sefaz.sh >> /var/log/backup-sefaz.log 2>&1\n```\n\n---\n\n## 📊 Passo 7: Monitoramento\n\n### 7.1. Ver logs em tempo real\n\n```bash\n# Logs da aplicação\ndocker compose logs -f app\n\n# Logs do Nginx\ndocker compose logs -f nginx\n\n# Todos os logs\ndocker compose logs -f\n```\n\n### 7.2. Monitorar recursos\n\n```bash\n# Status dos containers\ndocker stats\n\n# Uso de disco\ndf -h\n\n# Memória\nfree -h\n```\n\n### 7.3. Instalar Portainer (opcional - GUI para Docker)\n\n```bash\ndocker volume create portainer_data\n\ndocker run -d \\\n  -p 9000:9000 -p 9443:9443 \\\n  --name=portainer \\\n  --restart=always \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  -v portainer_data:/data \\\n  portainer/portainer-ce:latest\n```\n\nAcesse: `https://SEU_IP:9443`\n\n---\n\n## 🔄 Comandos Úteis\n\n### Gerenciamento Docker\n\n```bash\n# Parar aplicação\ndocker compose down\n\n# Reiniciar aplicação\ndocker compose restart\n\n# Reconstruir após mudanças\ndocker compose up -d --build\n\n# Ver logs\ndocker compose logs -f app\n\n# Limpar containers antigos\ndocker system prune -a\n```\n\n### Atualização da aplicação\n\n```bash\ncd /opt/apps/sefaz-xml-sync\n\n# Baixar código atualizado\ngit pull\n\n# Reconstruir e reiniciar\ndocker compose down\ndocker compose build --no-cache\ndocker compose up -d\n\n# Verificar\ndocker compose ps\ndocker compose logs -f app\n```\n\n### Renovação manual de certificado SSL\n\n```bash\n# Renovar certificado\ndocker compose run --rm certbot renew\n\n# Recarregar Nginx\ndocker compose exec nginx nginx -s reload\n```\n\n### Backup manual\n\n```bash\n# XMLs\ntar -czf backup-xmls-$(date +%Y%m%d).tar.gz /opt/apps/sefaz-xml-sync/xmls\n\n# Certificados\ntar -czf backup-certificados-$(date +%Y%m%d).tar.gz /opt/apps/sefaz-xml-sync/certificados\n\n# Database (Supabase faz backup automático, mas você pode exportar)\n```\n\n---\n\n## 🐛 Troubleshooting\n\n### Aplicação não inicia\n\n```bash\n# Ver logs detalhados\ndocker compose logs app\n\n# Verificar variáveis de ambiente\ndocker compose exec app env | grep SUPABASE\n\n# Reiniciar container\ndocker compose restart app\n```\n\n### Erro de SSL/HTTPS\n\n```bash\n# Verificar certificados\ndocker compose exec nginx ls -la /etc/letsencrypt/live/\n\n# Verificar configuração Nginx\ndocker compose exec nginx nginx -t\n\n# Recarregar Nginx\ndocker compose exec nginx nginx -s reload\n```\n\n### Certificado PKCS12 inválido\n\n```bash\n# Verificar certificado\nopenssl pkcs12 -info -in certificados/seu-certificado.pfx\n\n# Verificar permissões\nls -la certificados/\n```\n\n### Erro de conexão Supabase\n\n```bash\n# Testar conexão\ndocker compose exec app node -e \"\nconst { createClient } = require('@supabase/supabase-js');\nconst client = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);\nconsole.log('Conectado!');\n\"\n```\n\n### Container consumindo muita memória\n\n```bash\n# Ver uso de memória\ndocker stats\n\n# Limitar memória no docker-compose.yml\n# Adicione em services.app:\ndeploy:\n  resources:\n    limits:\n      memory: 1G\n```\n\n---\n\n## 📈 Otimizações de Produção\n\n### 1. Limitar logs\n\n```bash\n# Editar docker-compose.yml, adicionar em cada serviço:\nlogging:\n  driver: \"json-file\"\n  options:\n    max-size: \"10m\"\n    max-file: \"3\"\n```\n\n### 2. Health checks customizados\n\nJá incluídos no `Dockerfile` e `docker-compose.yml`\n\n### 3. Auto-restart\n\nJá configurado com `restart: unless-stopped`\n\n### 4. Monitoramento avançado (opcional)\n\n```bash\n# Instalar Prometheus + Grafana\n# (Guia separado se necessário)\n```\n\n---\n\n## 🔒 Checklist de Segurança\n\n- [ ] Firewall (UFW) configurado\n- [ ] SSH com chave pública (não senha)\n- [ ] HTTPS com certificado válido\n- [ ] Variáveis sensíveis em .env (não commitadas)\n- [ ] RLS habilitado no Supabase\n- [ ] Backup automático configurado\n- [ ] Logs com rotação\n- [ ] Certificados .pfx com permissões 600\n- [ ] Fail2ban instalado (opcional):\n  ```bash\n  apt install -y fail2ban\n  systemctl enable fail2ban\n  ```\n\n---\n\n## 📞 Suporte\n\n### Logs importantes:\n- Aplicação: `/var/log/app.log` (dentro do container)\n- Nginx: `docker compose logs nginx`\n- Certbot: `docker compose logs certbot`\n\n### Recursos:\n- Docker: https://docs.docker.com\n- Nginx: https://nginx.org/en/docs/\n- Let's Encrypt: https://letsencrypt.org/docs/\n- Supabase: https://supabase.com/docs\n\n---\n\n## 🎉 Conclusão\n\nSua aplicação agora está rodando em produção com:\n- ✅ HTTPS automático com Let's Encrypt\n- ✅ Renovação automática de certificados\n- ✅ Sincronização automática a cada 1 hora\n- ✅ Backup configurado\n- ✅ Monitoramento básico\n- ✅ Isolamento multi-tenant (RLS)\n\n**Acesse:** `https://seu-dominio.com`\n\n**Login inicial:**\n1. Criar conta via interface\n2. Confirmar email (se ativado no Supabase)\n3. Fazer login\n4. Cadastrar empresas com certificados\n5. Aguardar sincronização automática ou iniciar manualmente\n","size_bytes":10807},"DEPLOYMENT-PORTAINER.md":{"content":"# 🚀 Deploy SEFAZ XML Sync - Portainer + Traefik\n\n## Guia Completo Passo a Passo\n\n---\n\n## 📋 Pré-requisitos (Já Instalados)\n\n✅ Docker instalado  \n✅ Portainer rodando  \n✅ Traefik configurado com Let's Encrypt  \n\n### Verificar rede do Traefik\n\n```bash\n# Listar redes Docker\ndocker network ls | grep traefik\n\n# Deve mostrar algo como:\n# xxxxx   traefik-proxy   bridge    local\n```\n\nSe a rede do Traefik tem outro nome (ex: `traefik_default`), você precisará ajustar no `docker-compose.portainer.yml` na seção `networks`.\n\n---\n\n## 🗂️ Passo 1: Preparar Diretórios no Servidor\n\n### 1.1. Conectar ao servidor\n\n```bash\nssh root@SEU_IP_SERVIDOR\n```\n\n### 1.2. Criar estrutura de diretórios\n\n```bash\n# Criar diretórios para a aplicação\nmkdir -p /opt/sefaz-xml-sync\ncd /opt/sefaz-xml-sync\n\n# Criar diretórios para dados persistentes\nmkdir -p certificados xmls\n\n# Definir permissões\nchmod 700 certificados\nchmod 755 xmls\n```\n\n---\n\n## 📦 Passo 2: Transferir Código para o Servidor\n\n### Opção A: Via Git (Recomendado)\n\n```bash\ncd /opt/sefaz-xml-sync\n\n# Instalar Git (se necessário)\napt install -y git\n\n# Clonar repositório\ngit clone https://github.com/SEU_USUARIO/sefaz-xml-sync.git tmp\nmv tmp/* tmp/.* . 2>/dev/null || true\nrm -rf tmp\n\n# OU apenas fazer pull se já existe\ngit pull origin main\n```\n\n### Opção B: Via SCP (Upload manual)\n\n**No seu computador local:**\n\n```bash\n# Compactar projeto (excluindo node_modules e build)\ntar -czf sefaz-xml-sync.tar.gz \\\n  --exclude=node_modules \\\n  --exclude=client/dist \\\n  --exclude=.git \\\n  .\n\n# Enviar para servidor\nscp sefaz-xml-sync.tar.gz root@SEU_IP:/opt/sefaz-xml-sync/\n\n# No servidor, extrair\ncd /opt/sefaz-xml-sync\ntar -xzf sefaz-xml-sync.tar.gz\nrm sefaz-xml-sync.tar.gz\n```\n\n### Opção C: Build local e push para registry (Avançado)\n\n```bash\n# No seu computador local\ndocker build -t seu-usuario/sefaz-xml-sync:latest .\ndocker push seu-usuario/sefaz-xml-sync:latest\n\n# No docker-compose.portainer.yml, trocar:\n# build: . \n# Por:\n# image: seu-usuario/sefaz-xml-sync:latest\n```\n\n---\n\n## 🔐 Passo 3: Preparar Variáveis de Ambiente\n\n### 3.1. Copiar arquivo de exemplo\n\n```bash\ncd /opt/sefaz-xml-sync\ncp .env.portainer .env\n```\n\n### 3.2. Editar e preencher valores reais\n\n```bash\nnano .env\n```\n\n**Preencha com seus valores:**\n\n```env\n# Seu domínio\nDOMAIN=sefaz.seudominio.com\n\n# Certificado resolver do Traefik (verificar no Traefik)\nCERT_RESOLVER=le\n\n# Credenciais Supabase\nSUPABASE_URL=https://seu-projeto.supabase.co\nSUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\nSUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\n\n# Gerar SESSION_SECRET\nSESSION_SECRET=$(openssl rand -base64 32)\n\n# Paths no host\nCERTIFICADOS_PATH=/opt/sefaz-xml-sync/certificados\nXMLS_PATH=/opt/sefaz-xml-sync/xmls\n\n# Produção\nALLOW_SEFAZ_SIMULATION=false\n```\n\n**Salvar:** `Ctrl+O` → `Enter` → `Ctrl+X`\n\n### 3.3. Gerar SESSION_SECRET\n\n```bash\n# Gerar secret aleatório\nopenssl rand -base64 32\n\n# Copiar o resultado e colar no .env\n```\n\n### 3.4. Verificar nome do cert resolver do Traefik\n\n```bash\n# Inspecionar container do Traefik\ndocker inspect traefik | grep -i certresolver\n\n# OU verificar docker-compose do Traefik\n# Procure por: --certificatesresolvers.NOME.acme...\n# O NOME é o que você deve usar (geralmente 'le' ou 'letsencrypt')\n```\n\n---\n\n## 🌐 Passo 4: Configurar DNS\n\n### 4.1. Adicionar registro DNS tipo A\n\nNo seu provedor de domínio (ex: Cloudflare, GoDaddy, etc):\n\n```\nTipo: A\nNome: sefaz (ou @, se usar domínio raiz)\nValor: IP_DO_SEU_SERVIDOR\nTTL: Auto ou 300\n```\n\n### 4.2. Verificar propagação DNS\n\n```bash\n# Verificar se DNS está resolvendo\ndig sefaz.seudominio.com\n\n# OU\nnslookup sefaz.seudominio.com\n\n# Deve retornar o IP do seu servidor\n```\n\n---\n\n## 🐳 Passo 5: Deploy via Portainer\n\n### 5.1. Acessar Portainer\n\nAbra: `https://seu-portainer.com` (ou `http://IP:9000`)\n\n### 5.2. Criar novo Stack\n\n1. Menu lateral: **Stacks**\n2. Botão: **+ Add stack**\n3. **Name:** `sefaz-xml-sync`\n\n### 5.3. Adicionar Docker Compose\n\n**Opção A: Web editor (Copiar/Colar)**\n\n1. Selecione: **Web editor**\n2. Cole o conteúdo de `docker-compose.portainer.yml`:\n\n```bash\n# No servidor, copiar conteúdo\ncat /opt/sefaz-xml-sync/docker-compose.portainer.yml\n```\n\n3. Copie TODO o conteúdo e cole no editor do Portainer\n\n**Opção B: Repository (Git - Recomendado para produção)**\n\n1. Selecione: **Repository**\n2. **Repository URL:** `https://github.com/SEU_USUARIO/sefaz-xml-sync`\n3. **Repository reference:** `main`\n4. **Compose path:** `docker-compose.portainer.yml`\n5. (Opcional) Se repositório privado:\n   - Habilite **Authentication**\n   - Adicione **Username** e **Personal Access Token**\n\n### 5.4. Adicionar Variáveis de Ambiente\n\n**Role até a seção: Environment variables**\n\n**Opção A: Upload do arquivo .env**\n\n1. Clique: **Load variables from .env file**\n2. Selecione o arquivo `.env` que você editou\n3. Upload\n\n**Opção B: Adicionar manualmente (uma por vez)**\n\n1. Clique: **+ Add environment variable**\n2. Preencha:\n   ```\n   Name: DOMAIN\n   Value: sefaz.seudominio.com\n   ```\n3. Repita para cada variável:\n   - `CERT_RESOLVER`\n   - `SUPABASE_URL`\n   - `SUPABASE_ANON_KEY`\n   - `SUPABASE_SERVICE_ROLE_KEY`\n   - `SESSION_SECRET`\n   - `CERTIFICADOS_PATH`\n   - `XMLS_PATH`\n   - `ALLOW_SEFAZ_SIMULATION`\n\n**Opção C: Bulk editor (Mais rápido)**\n\n1. Clique: **Advanced mode**\n2. Cole todas as variáveis no formato:\n   ```\n   DOMAIN=sefaz.seudominio.com\n   CERT_RESOLVER=le\n   SUPABASE_URL=https://...\n   SUPABASE_ANON_KEY=eyJhbGc...\n   SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...\n   SESSION_SECRET=sua-secret-aqui\n   CERTIFICADOS_PATH=/opt/sefaz-xml-sync/certificados\n   XMLS_PATH=/opt/sefaz-xml-sync/xmls\n   ALLOW_SEFAZ_SIMULATION=false\n   ```\n\n### 5.5. Deploy!\n\n1. Role até o final\n2. Clique: **Deploy the stack**\n3. Aguarde o build e deploy (pode levar 2-5 minutos)\n\n---\n\n## ✅ Passo 6: Verificar Deploy\n\n### 6.1. Verificar logs no Portainer\n\n1. **Stacks** → `sefaz-xml-sync`\n2. Clique no container: `sefaz-xml-sync`\n3. Aba: **Logs**\n4. Procure por:\n   ```\n   ✓ Supabase configurado com sucesso\n   ✓ Agendamento configurado: sincronização a cada 1 hora\n   serving on port 5000\n   ```\n\n### 6.2. Verificar via linha de comando\n\n```bash\n# Ver containers rodando\ndocker ps | grep sefaz\n\n# Ver logs\ndocker logs sefaz-xml-sync -f\n\n# Verificar health\ndocker inspect sefaz-xml-sync | grep -A 5 Health\n```\n\n### 6.3. Testar endpoint de saúde\n\n```bash\n# Testar internamente\ncurl http://localhost:5000/api/health\n\n# Deve retornar:\n# {\"status\":\"ok\",\"timestamp\":\"2025-11-13T...\"}\n```\n\n### 6.4. Acessar via navegador\n\nAbra: **`https://sefaz.seudominio.com`**\n\n- Deve carregar a página de login\n- Deve ter certificado SSL válido (cadeado verde)\n- Certificado emitido por Let's Encrypt\n\n---\n\n## 🎯 Passo 7: Configuração Inicial da Aplicação\n\n### 7.1. Criar primeiro usuário\n\n1. Acesse: `https://sefaz.seudominio.com`\n2. Clique: **Registrar**\n3. Preencha:\n   - Email válido\n   - Nome completo\n   - Senha segura\n4. (Se email confirmation estiver habilitado) Confirme email\n5. Faça login\n\n### 7.2. Upload de certificados digitais\n\n**Via interface web:**\n\n1. Menu: **Empresas**\n2. Botão: **Nova Empresa**\n3. Preencha dados da empresa\n4. Upload do arquivo `.pfx`\n5. Senha do certificado\n6. Salvar\n\n**Via SCP (se preferir upload em massa):**\n\n```bash\n# Do seu computador local\nscp certificado1.pfx root@SEU_IP:/opt/sefaz-xml-sync/certificados/\nscp certificado2.pfx root@SEU_IP:/opt/sefaz-xml-sync/certificados/\n\n# No servidor, ajustar permissões\nchmod 600 /opt/sefaz-xml-sync/certificados/*.pfx\n```\n\n### 7.3. Verificar sincronização automática\n\n- **Agendamento:** A cada 1 hora (automático)\n- **Manual:** Menu Empresas → Botão de sincronizar (ícone nuvem)\n- **Logs:** Menu Logs para acompanhar\n\n---\n\n## 🔄 Passo 8: Atualização da Aplicação\n\n### Opção A: Via Portainer (se usou Repository)\n\n1. **Stacks** → `sefaz-xml-sync`\n2. Botão: **Pull and redeploy**\n3. Aguardar rebuild\n\n### Opção B: Rebuild manual\n\n1. No servidor:\n   ```bash\n   cd /opt/sefaz-xml-sync\n   git pull\n   ```\n\n2. No Portainer:\n   - **Stacks** → `sefaz-xml-sync`\n   - Botão: **Editor**\n   - Botão: **Update the stack**\n   - Marque: **Re-pull image and redeploy**\n   - Confirmar\n\n### Opção C: Webhooks (CI/CD Automático)\n\n1. No Portainer Stack, criar webhook\n2. Copiar URL do webhook\n3. Configurar GitHub/GitLab para chamar webhook em push\n\n---\n\n## 💾 Passo 9: Backup\n\n### 9.1. Script de backup automático\n\n```bash\n# Criar diretório de scripts\nmkdir -p /opt/scripts\n\n# Criar script de backup\nnano /opt/scripts/backup-sefaz.sh\n```\n\n**Conteúdo do script:**\n\n```bash\n#!/bin/bash\nset -e\n\nBACKUP_DIR=\"/backup/sefaz-xml-sync\"\nDATE=$(date +%Y%m%d_%H%M%S)\n\nmkdir -p $BACKUP_DIR\n\necho \"=== Backup SEFAZ XML Sync - $DATE ===\"\n\n# Backup XMLs\necho \"Backup de XMLs...\"\ntar -czf $BACKUP_DIR/xmls-$DATE.tar.gz /opt/sefaz-xml-sync/xmls\n\n# Backup Certificados\necho \"Backup de Certificados...\"\ntar -czf $BACKUP_DIR/certificados-$DATE.tar.gz /opt/sefaz-xml-sync/certificados\n\n# Manter apenas últimos 30 dias\nfind $BACKUP_DIR -type f -mtime +30 -delete\n\necho \"✓ Backup concluído: $BACKUP_DIR/\"\nls -lh $BACKUP_DIR/ | tail -5\n```\n\n### 9.2. Tornar executável\n\n```bash\nchmod +x /opt/scripts/backup-sefaz.sh\n\n# Testar\n/opt/scripts/backup-sefaz.sh\n```\n\n### 9.3. Agendar backup diário (Cron)\n\n```bash\n# Editar crontab\ncrontab -e\n\n# Adicionar linha (backup diário às 3h da manhã)\n0 3 * * * /opt/scripts/backup-sefaz.sh >> /var/log/backup-sefaz.log 2>&1\n```\n\n### 9.4. Restaurar backup\n\n```bash\n# Restaurar XMLs\ncd /opt/sefaz-xml-sync\ntar -xzf /backup/sefaz-xml-sync/xmls-YYYYMMDD_HHMMSS.tar.gz --strip-components=3\n\n# Restaurar Certificados\ntar -xzf /backup/sefaz-xml-sync/certificados-YYYYMMDD_HHMMSS.tar.gz --strip-components=3\n```\n\n---\n\n## 🔧 Troubleshooting\n\n### Problema: Container não inicia\n\n**Verificar logs:**\n```bash\ndocker logs sefaz-xml-sync\n```\n\n**Causas comuns:**\n- Variáveis de ambiente faltando/incorretas\n- Erro de conexão com Supabase\n- Porta 5000 já em uso\n\n**Solução:**\n```bash\n# Verificar variáveis\ndocker exec sefaz-xml-sync env | grep SUPABASE\n\n# Reiniciar container\ndocker restart sefaz-xml-sync\n```\n\n### Problema: SSL não funciona\n\n**Verificar:**\n```bash\n# DNS está resolvendo?\ndig sefaz.seudominio.com\n\n# Traefik está reconhecendo o serviço?\ndocker logs traefik | grep sefaz\n\n# Labels corretos?\ndocker inspect sefaz-xml-sync | grep -A 20 Labels\n```\n\n**Soluções:**\n1. Verificar se `CERT_RESOLVER` está correto\n2. Verificar se rede `traefik-proxy` existe\n3. Aguardar 1-2 minutos para Let's Encrypt emitir certificado\n4. Verificar logs do Traefik para erros ACME\n\n### Problema: Não consegue acessar pelo domínio\n\n**Verificar:**\n```bash\n# DNS propagou?\nnslookup sefaz.seudominio.com\n\n# Traefik está roteando?\ndocker logs traefik | grep -i sefaz\n\n# Firewall bloqueando?\nufw status\n```\n\n**Solução:**\n```bash\n# Abrir portas (se necessário)\nufw allow 80/tcp\nufw allow 443/tcp\nufw reload\n```\n\n### Problema: Certificado PKCS12 inválido\n\n**No modo desenvolvimento:**\n- `ALLOW_SEFAZ_SIMULATION=true` permite simular SEFAZ\n\n**Em produção:**\n```bash\n# Verificar certificado\nopenssl pkcs12 -info -in /opt/sefaz-xml-sync/certificados/cert.pfx\n\n# Verificar permissões\nls -la /opt/sefaz-xml-sync/certificados/\n# Devem ser 600 (rw-------)\n\n# Corrigir permissões\nchmod 600 /opt/sefaz-xml-sync/certificados/*.pfx\n```\n\n### Problema: Container consome muita memória\n\n**Limitar recursos no docker-compose:**\n\n```yaml\nservices:\n  app:\n    # ... outras configs\n    deploy:\n      resources:\n        limits:\n          memory: 1G\n          cpus: '1.0'\n        reservations:\n          memory: 512M\n```\n\n---\n\n## 📊 Monitoramento\n\n### Via Portainer\n\n1. **Containers** → `sefaz-xml-sync`\n2. Aba: **Stats** (uso de CPU, RAM, Rede)\n\n### Via linha de comando\n\n```bash\n# Uso de recursos\ndocker stats sefaz-xml-sync\n\n# Logs em tempo real\ndocker logs -f sefaz-xml-sync\n\n# Health status\ndocker inspect sefaz-xml-sync | grep -A 10 Health\n```\n\n### Logs persistentes\n\n```bash\n# Ver todos os logs\ndocker logs sefaz-xml-sync\n\n# Últimas 100 linhas\ndocker logs --tail 100 sefaz-xml-sync\n\n# Desde 1 hora atrás\ndocker logs --since 1h sefaz-xml-sync\n\n# Salvar logs em arquivo\ndocker logs sefaz-xml-sync > /tmp/sefaz-debug.log\n```\n\n---\n\n## 🔒 Checklist de Segurança\n\n- [ ] Firewall (UFW) configurado\n- [ ] SSL/HTTPS funcionando (Let's Encrypt via Traefik)\n- [ ] Variáveis sensíveis NÃO commitadas no Git\n- [ ] `.env` com permissões 600\n- [ ] Certificados .pfx com permissões 600\n- [ ] Backup automático configurado\n- [ ] RLS habilitado no Supabase\n- [ ] `ALLOW_SEFAZ_SIMULATION=false` em produção\n- [ ] Portainer com senha forte\n- [ ] SSH com chave pública (não senha)\n\n---\n\n## 📝 Comandos Úteis\n\n```bash\n# Reiniciar aplicação\ndocker restart sefaz-xml-sync\n\n# Parar aplicação\ndocker stop sefaz-xml-sync\n\n# Iniciar aplicação\ndocker start sefaz-xml-sync\n\n# Remover e recriar (cuidado!)\ndocker rm -f sefaz-xml-sync\n# Depois redeploy via Portainer\n\n# Ver rede do Traefik\ndocker network inspect traefik-proxy\n\n# Executar comando dentro do container\ndocker exec -it sefaz-xml-sync sh\n\n# Verificar certificados Let's Encrypt\ndocker exec traefik cat /acme.json | jq\n```\n\n---\n\n## 🎉 Conclusão\n\nSua aplicação SEFAZ XML Sync agora está rodando em produção com:\n\n- ✅ HTTPS automático via Traefik + Let's Encrypt\n- ✅ Deploy gerenciado pelo Portainer\n- ✅ Sincronização automática a cada 1 hora\n- ✅ Backup automático diário\n- ✅ Isolamento multi-tenant (RLS)\n- ✅ Health checks configurados\n- ✅ Auto-restart em falhas\n\n**Acesso:** `https://sefaz.seudominio.com`\n\n---\n\n## 📞 Suporte\n\n**Logs importantes:**\n- Aplicação: `docker logs sefaz-xml-sync`\n- Traefik: `docker logs traefik`\n- Portainer: Interface web em `https://portainer.seudominio.com`\n\n**Recursos:**\n- Portainer Docs: https://docs.portainer.io\n- Traefik Docs: https://doc.traefik.io\n- Supabase Docs: https://supabase.com/docs\n\n---\n\n**Bom trabalho! 🚀**\n","size_bytes":14051},"TROUBLESHOOTING-CERTIFICADOS.md":{"content":"# 🔧 Troubleshooting - Certificados Digitais\n\n## Problema: \"Unsupported PKCS12 PFX data\"\n\n### Causa\nCertificados digitais A1 brasileiros (.pfx) usam algoritmos criptográficos legados (DES, 3DES) que **não são suportados por padrão** no OpenSSL 3.x (usado pelo Node.js 18+).\n\n### Sintomas\n```\nError: Unsupported PKCS12 PFX data\n    at configSecureContext (node:internal/tls/secure-context:290:15)\n```\n\n### ✅ Solução Implementada\n\n**Arquitetura da Solução:**\n\nO sistema usa a biblioteca **`node-forge`** para converter certificados PKCS12 legados para formato PEM antes de criar o HTTPS Agent:\n\n```typescript\n// 1. Converter PKCS12 → PEM usando node-forge (server/cert-loader.ts)\nconst certData = await loadPKCS12Certificate(\n  empresa.certificadoPath,\n  empresa.certificadoSenha\n);\n\n// 2. Criar agent HTTPS com certificados em formato PEM\nconst agent = new https.Agent({\n  key: certData.key,      // Chave privada em PEM\n  cert: certData.cert,    // Certificado em PEM\n  ca: certData.ca,        // Chain de CAs em PEM\n  rejectUnauthorized: true,\n  secureOptions: crypto.constants.SSL_OP_LEGACY_SERVER_CONNECT,\n  minVersion: 'TLSv1.2',\n  maxVersion: 'TLSv1.3',\n});\n```\n\n**Por que funciona?**\n- **node-forge** consegue ler PKCS12 com algoritmos legados (DES/3DES)\n- Converte para formato PEM que é **nativamente suportado** pelo OpenSSL 3.x\n- Evita completamente o erro \"Unsupported PKCS12 PFX data\"\n\n### Verificações Automáticas\n\nO sistema agora valida:\n1. ✅ Arquivo .pfx existe e é legível\n2. ✅ Tamanho mínimo do certificado (> 100 bytes)\n3. ✅ Senha do certificado (MAC verification)\n4. ✅ Formato PKCS12 válido\n5. ✅ Presença de chave privada e certificado\n6. ✅ Cache de certificados convertidos (performance)\n\n---\n\n## Outros Problemas Comuns\n\n### 1. \"MAC verify error\"\n\n**Causa:** Senha do certificado incorreta\n\n**Solução:**\n1. Verifique a senha ao cadastrar a empresa\n2. Confirme com quem emitiu o certificado\n3. Teste a senha usando OpenSSL:\n   ```bash\n   openssl pkcs12 -info -in certificado.pfx -noout\n   # Digite a senha quando solicitado\n   ```\n\n### 2. Certificado Expirado\n\n**Causa:** Certificados A1 têm validade de 1 ano\n\n**Sintomas:**\n- Erro ao conectar com SEFAZ\n- Mensagem de \"certificado inválido\"\n\n**Solução:**\n1. Verificar validade:\n   ```bash\n   openssl pkcs12 -in certificado.pfx -nokeys -clcerts | openssl x509 -noout -dates\n   ```\n2. Renovar certificado na Autoridade Certificadora\n3. Fazer upload do novo certificado no sistema\n\n### 3. Arquivo Corrompido\n\n**Causa:** Download incompleto ou transferência com erro\n\n**Sintomas:**\n- \"Certificado inválido ou corrompido (tamanho muito pequeno)\"\n- Erro ao ler arquivo\n\n**Solução:**\n1. Fazer novo download do certificado\n2. Verificar integridade com checksum (se disponível)\n3. Upload novamente no sistema\n\n### 4. Permissões Incorretas (Produção)\n\n**Causa:** Arquivo .pfx com permissões muito abertas\n\n**Solução:**\n```bash\n# Definir permissões corretas\nchmod 600 /opt/sefaz-xml-sync/certificados/*.pfx\n\n# Verificar\nls -la /opt/sefaz-xml-sync/certificados/\n# Deve mostrar: -rw------- (600)\n```\n\n---\n\n## Validação Manual de Certificados\n\n### Verificar Informações do Certificado\n\n```bash\n# Ver todas as informações\nopenssl pkcs12 -info -in certificado.pfx\n\n# Ver apenas o certificado\nopenssl pkcs12 -in certificado.pfx -nokeys -clcerts | openssl x509 -text -noout\n\n# Ver datas de validade\nopenssl pkcs12 -in certificado.pfx -nokeys -clcerts | openssl x509 -noout -dates\n\n# Ver subject (CNPJ)\nopenssl pkcs12 -in certificado.pfx -nokeys -clcerts | openssl x509 -noout -subject\n```\n\n### Testar Senha\n\n```bash\n# Extrair chave privada (se senha correta)\nopenssl pkcs12 -in certificado.pfx -nocerts -nodes -out test-key.pem\n\n# Se funcionar, senha está correta\n# Remover arquivo de teste\nrm test-key.pem\n```\n\n### Converter para PEM (Debugging)\n\n```bash\n# Extrair certificado em formato PEM\nopenssl pkcs12 -in certificado.pfx -clcerts -nokeys -out cert.pem\n\n# Extrair chave privada\nopenssl pkcs12 -in certificado.pfx -nocerts -nodes -out key.pem\n\n# Verificar certificado PEM\nopenssl x509 -in cert.pem -text -noout\n```\n\n---\n\n## Compatibilidade\n\n### Node.js Versões\n\n| Versão | Suporte Certificados A1 | Requer Configuração |\n|--------|-------------------------|---------------------|\n| Node 16 | ✅ Suporte nativo | ❌ Não |\n| Node 18 | ⚠️ OpenSSL 3.0 | ✅ Sim (configurado) |\n| Node 20 | ⚠️ OpenSSL 3.0 | ✅ Sim (configurado) |\n| Node 21+ | ⚠️ OpenSSL 3.x | ✅ Sim (configurado) |\n\n**✅ Este sistema já está configurado para todas as versões**\n\n### Arquivos da Solução\n\n**`server/cert-loader.ts`** (utilitário de conversão):\n- Carrega arquivo .pfx do disco\n- Usa `node-forge` para parsing PKCS12\n- Converte para formato PEM (key, cert, ca)\n- Implementa cache em memória\n- Retorna erros claros e acionáveis\n\n**`server/sefaz-service.ts`** (integração):\n- Chama `loadPKCS12Certificate()` antes de criar HTTPS Agent\n- Usa certificados PEM em vez de buffer PFX\n- Mantém todas as verificações de segurança\n\n### Dependências\n\n```json\n{\n  \"dependencies\": {\n    \"node-forge\": \"^1.3.1\"\n  },\n  \"devDependencies\": {\n    \"@types/node-forge\": \"^1.3.11\"\n  }\n}\n```\n\n⚠️ **Importante**: A biblioteca `node-forge` já está instalada no projeto.\n\n---\n\n## Diagnóstico Passo a Passo\n\n### 1. Verificar Arquivo\n\n```bash\n# Tamanho\nls -lh certificados/cert.pfx\n\n# Tipo\nfile certificados/cert.pfx\n# Deve mostrar: \"data\" ou \"PKCS #12\"\n```\n\n### 2. Verificar Senha\n\n```bash\n# Testar senha\nopenssl pkcs12 -info -in certificados/cert.pfx -noout\n# Se pedir senha e não der erro, senha está correta\n```\n\n### 3. Verificar Validade\n\n```bash\n# Extrair e ver datas\nopenssl pkcs12 -in certificados/cert.pfx -nokeys -clcerts | \\\n  openssl x509 -noout -dates\n\n# Resultado:\n# notBefore=Dec  1 00:00:00 2023 GMT\n# notAfter=Nov 30 23:59:59 2024 GMT\n```\n\n### 4. Verificar CNPJ\n\n```bash\n# Ver subject do certificado\nopenssl pkcs12 -in certificados/cert.pfx -nokeys -clcerts | \\\n  openssl x509 -noout -subject\n\n# Deve conter o CNPJ da empresa\n```\n\n### 5. Teste no Sistema\n\n1. Interface web → **Empresas**\n2. Editar empresa\n3. Upload novo certificado\n4. Salvar\n5. Tentar sincronização manual\n6. Verificar logs: **Menu → Logs**\n\n---\n\n## Logs Úteis para Debug\n\n### Ver logs da aplicação\n\n```bash\n# Docker\ndocker logs sefaz-xml-sync -f\n\n# Replit\n# Automático no terminal\n```\n\n### Procurar erros de certificado\n\n```bash\n# Docker\ndocker logs sefaz-xml-sync 2>&1 | grep -i \"certificado\\|pfx\\|pkcs\"\n\n# Logs do sistema (interface web)\n# Menu → Logs → Filtrar: \"error\"\n```\n\n---\n\n## Suporte Técnico\n\n### Informações para Reportar Problema\n\nAo reportar problema com certificado, incluir:\n\n1. **Mensagem de erro completa** (copiar do log)\n2. **Resultado de:**\n   ```bash\n   file certificado.pfx\n   ls -lh certificado.pfx\n   openssl pkcs12 -info -in certificado.pfx -noout\n   ```\n3. **Ambiente:**\n   - Node.js version: `node --version`\n   - OpenSSL version: `openssl version`\n   - Sistema operacional\n4. **Já tentou:**\n   - [ ] Verificar senha\n   - [ ] Baixar certificado novamente\n   - [ ] Testar com openssl\n   - [ ] Verificar validade\n\n---\n\n## Prevenção\n\n### Checklist ao Obter Certificado A1\n\n- [ ] Baixar arquivo .pfx de fonte confiável\n- [ ] Anotar senha em local seguro\n- [ ] Verificar validade (notAfter)\n- [ ] Testar com OpenSSL antes de usar\n- [ ] Manter backup em local seguro\n- [ ] Configurar lembrete 30 dias antes de expirar\n\n### Renovação Automática (Futuro)\n\nPlanejado para futuras versões:\n- Alerta 30 dias antes de expirar\n- Email de notificação\n- Bloqueio automático de certificados expirados\n\n---\n\n## Referências\n\n- OpenSSL PKCS12: https://www.openssl.org/docs/man3.0/man1/openssl-pkcs12.html\n- Node.js TLS: https://nodejs.org/api/tls.html\n- Certificados ICP-Brasil: https://www.gov.br/iti/pt-br\n\n---\n\n**Última atualização:** 13 de novembro de 2025\n","size_bytes":7901},"server/auth-middleware.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\nimport { supabaseAdmin } from \"./supabase\";\n\n// Estende a interface Request do Express para incluir user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: {\n        id: string;\n        email: string;\n        [key: string]: any;\n      };\n      accessToken?: string;\n    }\n  }\n}\n\n// Middleware para validar JWT e autenticar usuário\nexport async function authenticateUser(\n  req: Request,\n  res: Response,\n  next: NextFunction\n) {\n  try {\n    // Extrai token do header Authorization\n    const authHeader = req.headers.authorization;\n    const token = authHeader?.split(\" \")[1]; // \"Bearer <token>\"\n\n    if (!token) {\n      return res.status(401).json({ error: \"Token de autenticação não fornecido\" });\n    }\n\n    // Valida token com Supabase (usando service role para validação server-side)\n    const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);\n\n    if (error || !user) {\n      return res.status(403).json({ error: \"Token inválido ou expirado\" });\n    }\n\n    // Anexa usuário e token à requisição\n    req.user = {\n      id: user.id,\n      email: user.email || \"\",\n      ...user.user_metadata,\n    };\n    req.accessToken = token;\n\n    next();\n  } catch (error) {\n    console.error(\"Erro no middleware de autenticação:\", error);\n    return res.status(500).json({ error: \"Erro ao validar autenticação\" });\n  }\n}\n\n// Middleware opcional - permite requisições sem autenticação mas anexa usuário se presente\nexport async function optionalAuth(\n  req: Request,\n  res: Response,\n  next: NextFunction\n) {\n  try {\n    const authHeader = req.headers.authorization;\n    const token = authHeader?.split(\" \")[1];\n\n    if (token) {\n      const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);\n\n      if (!error && user) {\n        req.user = {\n          id: user.id,\n          email: user.email || \"\",\n          ...user.user_metadata,\n        };\n        req.accessToken = token;\n      }\n    }\n\n    next();\n  } catch (error) {\n    // Em caso de erro, apenas continua sem usuário\n    next();\n  }\n}\n","size_bytes":2128},"deploy-scripts/deploy.sh":{"content":"#!/bin/bash\n\n# Script de deploy rápido\n# Uso: ./deploy.sh [build|restart|logs|stop]\n\nset -e\n\necho \"🚀 SEFAZ XML Sync - Deploy Script\"\necho \"==================================\"\n\ncase \"$1\" in\n  build)\n    echo \"📦 Construindo imagens Docker...\"\n    docker compose build --no-cache\n    echo \"✅ Build concluído!\"\n    ;;\n    \n  start)\n    echo \"🟢 Iniciando containers...\"\n    docker compose up -d\n    echo \"✅ Aplicação iniciada!\"\n    docker compose ps\n    ;;\n    \n  restart)\n    echo \"🔄 Reiniciando aplicação...\"\n    docker compose down\n    docker compose up -d\n    echo \"✅ Aplicação reiniciada!\"\n    docker compose ps\n    ;;\n    \n  logs)\n    echo \"📋 Mostrando logs (Ctrl+C para sair)...\"\n    docker compose logs -f app\n    ;;\n    \n  stop)\n    echo \"🛑 Parando aplicação...\"\n    docker compose down\n    echo \"✅ Aplicação parada!\"\n    ;;\n    \n  update)\n    echo \"🔄 Atualizando aplicação...\"\n    git pull\n    docker compose down\n    docker compose build --no-cache\n    docker compose up -d\n    echo \"✅ Atualização concluída!\"\n    docker compose ps\n    ;;\n    \n  status)\n    echo \"📊 Status dos containers:\"\n    docker compose ps\n    echo \"\"\n    echo \"💾 Uso de recursos:\"\n    docker stats --no-stream\n    ;;\n    \n  backup)\n    echo \"💾 Criando backup...\"\n    BACKUP_DIR=\"./backups\"\n    mkdir -p $BACKUP_DIR\n    DATE=$(date +%Y%m%d_%H%M%S)\n    \n    tar -czf $BACKUP_DIR/xmls-$DATE.tar.gz ./xmls\n    tar -czf $BACKUP_DIR/certificados-$DATE.tar.gz ./certificados\n    \n    echo \"✅ Backup criado em $BACKUP_DIR/\"\n    ls -lh $BACKUP_DIR/ | tail -2\n    ;;\n    \n  *)\n    echo \"Uso: $0 {build|start|restart|logs|stop|update|status|backup}\"\n    echo \"\"\n    echo \"Comandos:\"\n    echo \"  build    - Reconstrói as imagens Docker\"\n    echo \"  start    - Inicia os containers\"\n    echo \"  restart  - Reinicia os containers\"\n    echo \"  logs     - Mostra logs em tempo real\"\n    echo \"  stop     - Para os containers\"\n    echo \"  update   - Baixa código + rebuild + restart\"\n    echo \"  status   - Mostra status e uso de recursos\"\n    echo \"  backup   - Cria backup de XMLs e certificados\"\n    exit 1\n    ;;\nesac\n","size_bytes":2145},"COMANDOS-GIT.md":{"content":"# ⚡ Comandos Git - Guia Rápido\n\n## 🎯 Subir Código para GitHub (Primeira Vez)\n\n### 1️⃣ Criar Repositório no GitHub\n1. Acesse: https://github.com\n2. Clique no **+** → **New repository**\n3. Nome: `sefaz-xml-sync`\n4. **Private** (recomendado)\n5. **Create repository**\n6. Copie a URL: `https://github.com/SEU_USUARIO/sefaz-xml-sync.git`\n\n### 2️⃣ No Terminal do Replit\n\n```bash\n# Configurar Git (primeira vez)\ngit config --global user.name \"Seu Nome\"\ngit config --global user.email \"seu-email@example.com\"\n\n# Inicializar repositório (se necessário)\ngit init\n\n# Adicionar todos os arquivos\ngit add .\n\n# Ver o que será commitado (verificar se não tem .env!)\ngit status\n\n# Criar commit inicial\ngit commit -m \"feat: sistema completo SEFAZ XML Sync com suporte a certificados legados\n\n- Autenticação multi-usuário via Supabase Auth\n- Sincronização automática de XMLs a cada 1 hora\n- Suporte para certificados digitais A1 legados (DES/3DES)\n- Deploy Docker (standalone + Portainer + Traefik)\n- Row-Level Security (RLS) para isolamento de dados\n- Documentação completa de deployment e troubleshooting\"\n\n# Conectar ao GitHub (SUBSTITUA SEU_USUARIO!)\ngit remote add origin https://github.com/SEU_USUARIO/sefaz-xml-sync.git\n\n# Renomear branch para main\ngit branch -M main\n\n# Enviar para GitHub\ngit push -u origin main\n```\n\n**Se pedir senha:**\n- Username: seu-usuario-github\n- Password: USE UM **TOKEN** (não a senha!) → [Como criar token](#criar-token)\n\n---\n\n## 🔑 Criar Token do GitHub\n\n**Se o push pedir senha e falhar:**\n\n1. GitHub → **Settings** (seu perfil, canto superior direito)\n2. **Developer settings** (menu lateral, final)\n3. **Personal access tokens** → **Tokens (classic)**\n4. **Generate new token (classic)**\n5. Configurar:\n   - Note: `Replit SEFAZ`\n   - Expiration: `90 days`\n   - Marcar: **repo** (todos os subitens)\n6. **Generate token**\n7. **COPIAR O TOKEN** (não será mostrado de novo!)\n\n**Fazer push novamente:**\n```bash\ngit push -u origin main\n# Username: seu-usuario\n# Password: COLAR-O-TOKEN-AQUI\n```\n\n---\n\n## 🔄 Atualizar Código no GitHub (Depois da Primeira Vez)\n\n```bash\n# Verificar alterações\ngit status\n\n# Adicionar arquivos modificados\ngit add .\n\n# Criar commit\ngit commit -m \"descrição da mudança\"\n\n# Enviar para GitHub\ngit push\n```\n\n---\n\n## 📝 Mensagens de Commit\n\n**Exemplos:**\n```bash\ngit commit -m \"feat: adicionar exportação de XMLs\"\ngit commit -m \"fix: corrigir bug na sincronização\"\ngit commit -m \"docs: atualizar README\"\ngit commit -m \"refactor: melhorar performance\"\n```\n\n---\n\n## 🔍 Verificar Status\n\n```bash\n# Ver alterações\ngit status\n\n# Ver histórico\ngit log --oneline\n\n# Ver diferenças\ngit diff\n```\n\n---\n\n## ⚠️ Arquivos a NUNCA Commitar\n\nO `.gitignore` já está configurado para bloquear:\n- ❌ `.env*` (secrets)\n- ❌ `certificados/` (.pfx)\n- ❌ `xmls/` (dados)\n- ❌ `node_modules/`\n\n**Verificar antes de commitar:**\n```bash\ngit status\n\n# NÃO deve aparecer:\n# - .env\n# - certificados/\n# - xmls/\n# - node_modules/\n```\n\n---\n\n## 🆘 Ajuda Rápida\n\n### Desfazer último commit (antes de push)\n```bash\ngit reset --soft HEAD~1\n```\n\n### Remover arquivo do staging\n```bash\ngit reset HEAD arquivo.txt\n```\n\n### Desfazer alterações em arquivo\n```bash\ngit checkout -- arquivo.txt\n```\n\n### Atualizar do GitHub\n```bash\ngit pull\n```\n\n---\n\n## ✅ Checklist Antes de Push\n\n- [ ] `git status` não mostra `.env`\n- [ ] `git status` não mostra `certificados/`\n- [ ] `git status` não mostra `xmls/`\n- [ ] Commit com mensagem clara\n- [ ] Código funcional\n\n---\n\n## 🚀 Próximo Passo\n\n**Após fazer push, fazer deploy:**\n```bash\n# Ver guia completo\ncat DEPLOYMENT-PORTAINER.md\n```\n\n---\n\n**Dúvidas?** Ver guia completo: `GIT-SETUP.md`\n","size_bytes":3717},"deploy-scripts/init-letsencrypt.sh":{"content":"#!/bin/bash\n\n# Script para inicializar certificado SSL com Let's Encrypt\n# Baseado em: https://github.com/wmnnd/nginx-certbot\n\nif ! [ -x \"$(command -v docker-compose)\" ]; then\n  echo 'Error: docker-compose is not installed.' >&2\n  exit 1\nfi\n\n# CONFIGURAÇÕES - EDITE AQUI\ndomains=(seu-dominio.com www.seu-dominio.com)\nrsa_key_size=4096\ndata_path=\"./certbot\"\nemail=\"seu-email@exemplo.com\" # Email para notificações\nstaging=0 # Set to 1 if you're testing to avoid rate limits!\n\necho \"### Preparando diretórios...\"\nmkdir -p \"$data_path/conf\"\nmkdir -p \"$data_path/www\"\n\nif [ -d \"$data_path/conf/live/${domains[0]}\" ]; then\n  read -p \"Certificado existente encontrado. Deseja substituir? (y/N) \" decision\n  if [ \"$decision\" != \"Y\" ] && [ \"$decision\" != \"y\" ]; then\n    exit\n  fi\nfi\n\n# Download recommended TLS parameters\necho \"### Baixando parâmetros TLS recomendados...\"\ncurl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf > \"$data_path/conf/options-ssl-nginx.conf\"\ncurl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem > \"$data_path/conf/ssl-dhparams.pem\"\n\necho \"### Criando certificado dummy para Nginx iniciar...\"\npath=\"/etc/letsencrypt/live/${domains[0]}\"\nmkdir -p \"$data_path/conf/live/${domains[0]}\"\ndocker-compose run --rm --entrypoint \"\\\n  openssl req -x509 -nodes -newkey rsa:$rsa_key_size -days 1\\\n    -keyout '$path/privkey.pem' \\\n    -out '$path/fullchain.pem' \\\n    -subj '/CN=localhost'\" certbot\necho\n\necho \"### Iniciando Nginx...\"\ndocker-compose up --force-recreate -d nginx\necho\n\necho \"### Removendo certificado dummy...\"\ndocker-compose run --rm --entrypoint \"\\\n  rm -Rf /etc/letsencrypt/live/${domains[0]} && \\\n  rm -Rf /etc/letsencrypt/archive/${domains[0]} && \\\n  rm -Rf /etc/letsencrypt/renewal/${domains[0]}.conf\" certbot\necho\n\necho \"### Solicitando certificado Let's Encrypt...\"\ndomain_args=\"\"\nfor domain in \"${domains[@]}\"; do\n  domain_args=\"$domain_args -d $domain\"\ndone\n\n# Select appropriate email arg\ncase \"$email\" in\n  \"\") email_arg=\"--register-unsafely-without-email\" ;;\n  *) email_arg=\"--email $email\" ;;\nesac\n\n# Enable staging mode if needed\nif [ $staging != \"0\" ]; then staging_arg=\"--staging\"; fi\n\ndocker-compose run --rm --entrypoint \"\\\n  certbot certonly --webroot -w /var/www/certbot \\\n    $staging_arg \\\n    $email_arg \\\n    $domain_args \\\n    --rsa-key-size $rsa_key_size \\\n    --agree-tos \\\n    --force-renewal\" certbot\necho\n\necho \"### Recarregando Nginx...\"\ndocker-compose exec nginx nginx -s reload\necho\n\necho \"### Certificado SSL configurado com sucesso!\"\necho \"### Edite nginx/conf.d/default.conf e substitua 'seu-dominio.com' pelo seu domínio real\"\n","size_bytes":2724},"server/cert-loader.ts":{"content":"import forge from 'node-forge';\nimport fs from 'fs';\nimport path from 'path';\n\nexport interface CertificateData {\n  key: string;      // Private key em formato PEM\n  cert: string;     // Certificado em formato PEM\n  ca: string[];     // Certificados CA (chain) em formato PEM\n}\n\nexport interface CertificateValidation {\n  valid: boolean;\n  error?: string;\n  notBefore?: Date;\n  notAfter?: Date;\n  subject?: string;\n  issuer?: string;\n  isExpired?: boolean;\n  daysUntilExpiry?: number;\n}\n\ninterface CertificateCache {\n  [filePath: string]: CertificateData;\n}\n\nconst certCache: CertificateCache = {};\n\n/**\n * Carrega e converte certificado PKCS12 (.pfx) para formato PEM\n * \n * Esta função resolve o problema \"Unsupported PKCS12 PFX data\" que ocorre\n * quando certificados A1 brasileiros (que usam algoritmos legados DES/3DES)\n * são carregados diretamente no https.Agent do Node.js com OpenSSL 3.x.\n * \n * Solução: Usa node-forge para fazer parsing do PKCS12 e converter para PEM,\n * que é suportado nativamente pelo OpenSSL 3.x.\n * \n * @param pfxPath - Caminho completo para o arquivo .pfx\n * @param password - Senha do certificado\n * @returns Dados do certificado em formato PEM (key, cert, ca)\n * @throws Error se o certificado for inválido ou senha incorreta\n */\nexport async function loadPKCS12Certificate(\n  pfxPath: string,\n  password: string\n): Promise<CertificateData> {\n  // Verificar cache\n  const cacheKey = `${pfxPath}:${password}`;\n  if (certCache[cacheKey]) {\n    return certCache[cacheKey];\n  }\n\n  try {\n    // Ler arquivo .pfx\n    if (!fs.existsSync(pfxPath)) {\n      throw new Error(`Arquivo de certificado não encontrado: ${pfxPath}`);\n    }\n\n    const pfxBuffer = fs.readFileSync(pfxPath);\n\n    // Validar tamanho mínimo\n    if (pfxBuffer.length < 100) {\n      throw new Error(\n        `Certificado inválido ou corrompido (tamanho muito pequeno: ${pfxBuffer.length} bytes)`\n      );\n    }\n\n    // Converter buffer para formato base64 que o forge espera\n    const pfxBase64 = pfxBuffer.toString('base64');\n    const pfxAsn1 = forge.util.decode64(pfxBase64);\n\n    let p12Asn1: forge.asn1.Asn1;\n    try {\n      p12Asn1 = forge.asn1.fromDer(pfxAsn1);\n    } catch (error: any) {\n      throw new Error(\n        `Formato de certificado inválido. Verifique se o arquivo .pfx não está corrompido. ` +\n        `Erro: ${error.message}`\n      );\n    }\n\n    // Fazer parsing do PKCS12 com a senha\n    let p12: forge.pkcs12.Pkcs12Pfx;\n    try {\n      p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, password);\n    } catch (error: any) {\n      // Erro comum: senha incorreta\n      if (error.message?.includes('Invalid password') || \n          error.message?.includes('MAC verify')) {\n        throw new Error(\n          `Senha do certificado incorreta. Verifique a senha do arquivo .pfx`\n        );\n      }\n      throw new Error(\n        `Erro ao decodificar certificado PKCS12. ` +\n        `Verifique: (1) Senha correta, (2) Arquivo não corrompido. ` +\n        `Erro: ${error.message}`\n      );\n    }\n\n    // Extrair chave privada e certificados\n    const bags = p12.getBags({ bagType: forge.pki.oids.certBag });\n    const keyBags = p12.getBags({ bagType: forge.pki.oids.pkcs8ShroudedKeyBag });\n\n    // Verificar se encontrou chave privada\n    const keyBagArray = keyBags[forge.pki.oids.pkcs8ShroudedKeyBag];\n    if (!keyBagArray || keyBagArray.length === 0) {\n      throw new Error(\n        `Chave privada não encontrada no certificado. ` +\n        `Verifique se o arquivo .pfx contém a chave privada.`\n      );\n    }\n\n    // Verificar se encontrou certificados\n    const certBagArray = bags[forge.pki.oids.certBag];\n    if (!certBagArray || certBagArray.length === 0) {\n      throw new Error(\n        `Certificado não encontrado no arquivo .pfx. ` +\n        `Verifique se o arquivo está completo.`\n      );\n    }\n\n    // Extrair chave privada\n    const keyBag = keyBagArray[0];\n    if (!keyBag || !keyBag.key) {\n      throw new Error('Erro ao extrair chave privada do certificado');\n    }\n    const privateKey = keyBag.key;\n    const privateKeyPem = forge.pki.privateKeyToPem(privateKey);\n\n    // Extrair certificado principal e cadeia (CA certificates)\n    const certBags = certBagArray;\n    const certPems: string[] = [];\n    const caPems: string[] = [];\n\n    for (const bag of certBags) {\n      if (!bag.cert) continue;\n      \n      const certPem = forge.pki.certificateToPem(bag.cert);\n      \n      // O primeiro certificado normalmente é o certificado principal\n      // Os demais são certificados intermediários/raiz (CA)\n      if (certPems.length === 0) {\n        certPems.push(certPem);\n      } else {\n        caPems.push(certPem);\n      }\n    }\n\n    if (certPems.length === 0) {\n      throw new Error('Nenhum certificado válido encontrado no arquivo .pfx');\n    }\n\n    const certData: CertificateData = {\n      key: privateKeyPem,\n      cert: certPems[0],\n      ca: caPems,\n    };\n\n    // Armazenar em cache\n    certCache[cacheKey] = certData;\n\n    return certData;\n  } catch (error: any) {\n    // Se já é um erro customizado, apenas propagar\n    if (error.message.includes('Senha do certificado incorreta') ||\n        error.message.includes('Arquivo de certificado não encontrado') ||\n        error.message.includes('Certificado inválido ou corrompido')) {\n      throw error;\n    }\n\n    // Erro genérico\n    throw new Error(\n      `Erro ao carregar certificado: ${error.message}. ` +\n      `Verifique: (1) Arquivo .pfx válido, (2) Senha correta, (3) Certificado não expirado.`\n    );\n  }\n}\n\n/**\n * Limpa o cache de certificados\n * Útil para forçar reload após atualização de certificados\n */\nexport function clearCertificateCache(): void {\n  Object.keys(certCache).forEach(key => delete certCache[key]);\n}\n\n/**\n * Verifica se um certificado está em cache\n */\nexport function isCertificateCached(pfxPath: string, password: string): boolean {\n  const cacheKey = `${pfxPath}:${password}`;\n  return cacheKey in certCache;\n}\n\n/**\n * Valida certificado PKCS12 e extrai informações\n * \n * @param pfxPath - Caminho do arquivo .pfx\n * @param password - Senha do certificado\n * @returns Informações do certificado (validade, titular, etc)\n */\nexport async function validateCertificate(\n  pfxPath: string,\n  password: string\n): Promise<CertificateValidation> {\n  try {\n    // Tenta carregar o certificado (valida senha e formato)\n    const certData = await loadPKCS12Certificate(pfxPath, password);\n    \n    // Parse do certificado PEM para extrair informações\n    const certAsn1 = forge.pki.certificateFromPem(certData.cert);\n    \n    const notBefore = certAsn1.validity.notBefore;\n    const notAfter = certAsn1.validity.notAfter;\n    const now = new Date();\n    const isExpired = now > notAfter || now < notBefore;\n    \n    // Calcula dias até expiração\n    const daysUntilExpiry = Math.floor((notAfter.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    // Extrai subject (titular)\n    const subject = certAsn1.subject.attributes\n      .map(attr => `${attr.shortName}=${attr.value}`)\n      .join(', ');\n    \n    // Extrai issuer (emissor)\n    const issuer = certAsn1.issuer.attributes\n      .map(attr => `${attr.shortName}=${attr.value}`)\n      .join(', ');\n    \n    return {\n      valid: !isExpired,\n      notBefore,\n      notAfter,\n      subject,\n      issuer,\n      isExpired,\n      daysUntilExpiry,\n    };\n  } catch (error: any) {\n    return {\n      valid: false,\n      error: error.message,\n    };\n  }\n}\n","size_bytes":7466},"README.md":{"content":"# Sistema de Download Automático de NF-e e NFC-e (NFeDistribuicaoDFe)\n\nSistema robusto e compliant com **MOC 7.0** e **NT 2014.002** para download automático de XMLs fiscais (NF-e modelo 55 e NFC-e modelo 65) via Web Service **NFeDistribuicaoDFe** da SEFAZ.\n\n---\n\n## 📋 **Funcionalidades**\n\n### ✅ **Conformidade Total**\n- **MOC 7.0** (Manual de Orientação do Contribuinte NF-e/NFC-e)\n- **NT 2014.002** (Web Service de Distribuição de DF-e de Interesse dos Atores da NF-e)\n- Suporte completo para **NF-e (modelo 55)** e **NFC-e (modelo 65)**\n- Processa TODOS os schemas: `nfeProc`, `resNFe`, `procEventoNFe`, `resEvento`\n\n### 🔄 **Modos de Execução**\n1. **Agendado (Automático)**: Cron job executa sincronização a cada hora\n2. **Manual**: Interface web ou endpoint HTTP para execução sob demanda\n\n### 🔐 **Segurança**\n- Certificado Digital A1 (PKCS12) armazenado de forma segura\n- Autenticação JWT com Supabase Auth\n- Multi-tenant com isolamento via Row-Level Security (RLS)\n- Variáveis de ambiente para dados sensíveis\n\n### 📊 **Controle Rigoroso de NSU**\n- Persiste último NSU processado\n- Implementa bloqueio automático conforme NT 2014.002:\n  - **cStat=137**: Bloqueio de 65min (sem documentos)\n  - **cStat=656**: Bloqueio de 65min (consumo indevido)\n- Detecção automática de concorrência com outros sistemas (ERP)\n- Reconciliação de NSU para backlogs grandes\n\n### 📁 **Armazenamento Organizado**\n```\nxmls/\n├── NFe/                          # Nota Fiscal Eletrônica (modelo 55)\n│   └── CNPJ/\n│       └── ANO/\n│           └── MES/\n│               ├── numeroNF.xml                    # nfeProc (XML completo)\n│               ├── Resumos/\n│               │   └── CHAVE_nsuXXX.xml           # resNFe (resumo)\n│               └── Eventos/\n│                   ├── CHAVE_tpEvento_seq_nsu.xml # procEventoNFe\n│                   └── Resumos/\n│                       └── CHAVE_tpEvento_nsu.xml # resEvento\n└── NFCe/                         # NFC-e (modelo 65) - mesma estrutura\n```\n\n### 📝 **Logs Completos**\n- **Console**: Logs coloridos em tempo real\n- **Arquivo**: `logs/app-YYYY-MM-DD.log` (rotação automática)\n- **Banco de dados**: Logs detalhados com rastreabilidade\n\n---\n\n## 🚀 **Instalação e Configuração**\n\n### **1. Pré-requisitos**\n- Node.js 20+\n- Conta Supabase (PostgreSQL + Auth + Storage)\n- Certificado Digital A1 (.pfx ou .p12)\n- CNPJ autorizado na SEFAZ\n\n### **2. Variáveis de Ambiente**\n\nCrie um arquivo `.env` na raiz do projeto:\n\n```env\n# Ambiente\nNODE_ENV=production\nPORT=5000\n\n# Supabase (OBRIGATÓRIO)\nSUPABASE_URL=https://seu-projeto.supabase.co\nSUPABASE_ANON_KEY=sua-chave-anon\nSUPABASE_SERVICE_ROLE_KEY=sua-chave-service-role\n\n# Sessão (OBRIGATÓRIO)\nSESSION_SECRET=sua-chave-secreta-aleatoria-aqui\n\n# Armazenamento (OPCIONAL - padrões funcionam bem)\nXML_DEST_PATH=./xmls           # Diretório para salvar XMLs\nLOG_PATH=./logs                # Diretório para logs em arquivo\nMAX_LOG_FILES=30               # Quantidade de arquivos de log (30 dias)\n\n# Sincronização (OPCIONAL - padrões conforme NT 2014.002)\nSYNC_CRON=0 * * * *            # Cron: a cada hora (minuto 0)\nMAX_ITERATIONS=200             # Limite de segurança para loops\nDELAY_MS=300                   # Delay entre requests (ms)\nBLOQUEIO_MINUTOS=65            # Bloqueio após erro 656/137 (margem de segurança)\n\n# Simulação SEFAZ em Desenvolvimento (OPCIONAL)\nALLOW_SEFAZ_SIMULATION=true    # Permite testar sem SEFAZ real\n```\n\n### **3. Migração do Banco de Dados**\n\nExecute o script SQL no **Supabase Dashboard** → **SQL Editor**:\n\n```bash\ncat migrations/add_modelo_tipodocumento.sql\n```\n\nOu copie e cole o conteúdo de `migrations/add_modelo_tipodocumento.sql`.\n\n### **4. Executar o Sistema**\n\n```bash\n# Instalar dependências\nnpm install\n\n# Modo desenvolvimento (com hot-reload)\nnpm run dev\n\n# Modo produção\nnpm start\n```\n\nO sistema estará disponível em `http://localhost:5000`\n\n---\n\n## 📖 **Como Usar**\n\n### **Modo 1: Interface Web (Recomendado)**\n\n1. **Acesse**: `http://localhost:5000`\n2. **Registre-se** ou faça **Login**\n3. **Cadastre Empresa**:\n   - CNPJ\n   - Razão Social\n   - UF\n   - Ambiente (Produção ou Homologação)\n   - Upload do certificado A1 (.pfx)\n   - Senha do certificado\n4. **Sincronizar**:\n   - **Play (▶️)**: Baixa XMLs novos\n   - **RefreshCw (🔄)**: Alinha NSU (sem baixar XMLs)\n5. **Visualizar**:\n   - Dashboard com estatísticas\n   - Lista de XMLs baixados\n   - Logs detalhados\n\n### **Modo 2: HTTP Endpoint (Automação)**\n\nExecute sincronização manual via API:\n\n```bash\n# 1. Obter token de autenticação\ncurl -X POST http://localhost:5000/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"seu@email.com\",\"password\":\"sua-senha\"}'\n\n# Resposta: { \"access_token\": \"JWT_TOKEN_AQUI\" }\n\n# 2. Disparar sincronização manual\ncurl -X POST http://localhost:5000/api/sincronizacoes/executar \\\n  -H \"Authorization: Bearer JWT_TOKEN_AQUI\"\n\n# Resposta: { \"message\": \"Sincronização de todas as empresas iniciada\" }\n```\n\n### **Modo 3: Agendamento Automático (Padrão)**\n\nO sistema executa automaticamente **a cada hora** (configurável via `SYNC_CRON`).\n\n**Para alterar o intervalo:**\n\n```env\n# A cada 30 minutos\nSYNC_CRON=*/30 * * * *\n\n# Às 3h, 9h, 15h e 21h\nSYNC_CRON=0 3,9,15,21 * * *\n\n# A cada 2 horas\nSYNC_CRON=0 */2 * * *\n```\n\n---\n\n## 🔧 **Configurações Avançadas**\n\n### **Ambientes SEFAZ**\n\nO sistema suporta:\n- **Produção**: `https://www1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx`\n- **Homologação**: `https://hom1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx`\n\nConfigure por empresa na interface web.\n\n### **Schemas Processados**\n\nConforme **NT 2014.002 §3.3**:\n\n| Schema | Descrição | Quando |\n|--------|-----------|--------|\n| `nfeProc` | XML completo de NF-e/NFC-e | Destinatário tem direito ao XML completo |\n| `resNFe` | Resumo de NF-e/NFC-e | Destinatário só tem direito ao resumo |\n| `procEventoNFe` | Eventos (Cancelamento, CCe, Manifestação) | Sempre que houver evento |\n| `resEvento` | Resumo de evento | Resumo de evento disponível |\n\n### **Tipos de Eventos**\n\n| Código | Descrição |\n|--------|-----------|\n| 110110 | Carta de Correção (CCe) |\n| 110111 | Cancelamento |\n| 210200 | Confirmação da Operação |\n| 210210 | Ciência da Operação |\n| 210220 | Desconhecimento da Operação |\n| 210240 | Operação não Realizada |\n\n---\n\n## 📂 **Estrutura do Projeto**\n\n```\n.\n├── server/\n│   ├── config/\n│   │   └── index.ts              # Configuração centralizada\n│   ├── sefaz-service.ts          # Cliente SEFAZ NFeDistribuicaoDFe\n│   ├── cert-loader.ts            # Gerenciador de certificados A1\n│   ├── routes.ts                 # Endpoints da API\n│   ├── storage.ts                # Interface de Storage\n│   ├── supabase-storage.ts       # Implementação Supabase\n│   ├── logger.ts                 # Sistema de logs (console + arquivo)\n│   └── auth-middleware.ts        # Autenticação JWT\n├── client/\n│   └── src/\n│       ├── pages/                # Páginas React\n│       └── components/           # Componentes reutilizáveis\n├── shared/\n│   └── schema.ts                 # Schemas TypeScript + Zod\n├── migrations/\n│   └── add_modelo_tipodocumento.sql  # Migração banco de dados\n├── xmls/                         # XMLs baixados (criado automaticamente)\n├── logs/                         # Logs em arquivo (criado automaticamente)\n└── certificados/                 # Certificados A1 (criado automaticamente)\n```\n\n---\n\n## 🐛 **Troubleshooting**\n\n### **Erro 656 (Consumo Indevido)**\n\n**Causa**: NSU desatualizado ou consultas muito frequentes  \n**Solução**:\n1. Aguarde 1 hora (bloqueio automático)\n2. Use \"Alinhar NSU\" (🔄) após desbloqueio\n3. Verifique se há outro sistema (ERP/contador) consultando simultaneamente\n\n### **Erro 137 (Sem Documentos)**\n\n**Normal!** Significa que não há novos documentos naquele momento.  \nO sistema bloqueia automaticamente por 1h conforme NT 2014.002.\n\n### **Certificado Inválido**\n\nVerifique:\n- Certificado é A1 (.pfx ou .p12)?\n- Senha está correta?\n- Certificado não está expirado?\n- CNPJ do certificado corresponde ao CNPJ cadastrado?\n\n### **Logs em Branco**\n\nArquivos de log estão em `logs/app-YYYY-MM-DD.log`. Se não existir:\n1. Verifique permissões do diretório `logs/`\n2. Verifique `LOG_PATH` no `.env`\n\n---\n\n## 🛠️ **Stack Tecnológica**\n\n### Frontend\n- React 18 + TypeScript\n- Tailwind CSS + Shadcn UI\n- React Query (TanStack Query)\n- Wouter (roteamento)\n- Vite\n\n### Backend\n- Node.js + Express + TypeScript\n- Supabase (PostgreSQL + Auth)\n- node-cron (agendamento)\n- fast-xml-parser (processamento XML)\n- multer (upload de arquivos)\n- node-forge (certificados PKCS12)\n\n### Deploy\n- Docker + Docker Compose\n- Nginx + Certbot (standalone)\n- Traefik + Portainer (alternativo)\n\n---\n\n## 📚 **Referências Oficiais**\n\n- [MOC 7.0 - Manual de Orientação do Contribuinte](https://www.nfe.fazenda.gov.br/portal/listaConteudo.aspx?tipoConteudo=/fBxKhVZPDA=)\n- [NT 2014.002 - Web Service NFeDistribuicaoDFe](https://www.nfe.fazenda.gov.br/portal/exibirArquivo.aspx?conteudo=wLVBlKchUb4%3D)\n- [Portal Nacional NF-e](https://www.nfe.fazenda.gov.br/)\n- [Schemas XSD Oficiais](https://www.nfe.fazenda.gov.br/portal/listaConteudo.aspx?tipoConteudo=BMPFMBoln3w=)\n\n---\n\n## 📄 **Licença**\n\nEste projeto é privado e proprietário.\n\n---\n\n## 💡 **Suporte**\n\nPara dúvidas ou problemas:\n1. Verifique os **logs** em `logs/app-YYYY-MM-DD.log`\n2. Consulte a aba **Logs** na interface web\n3. Verifique a documentação oficial da SEFAZ\n4. Ver documentação adicional: `TROUBLESHOOTING-CERTIFICADOS.md`, `DEPLOYMENT.md`\n\n---\n\n**Desenvolvido com conformidade total à legislação fiscal brasileira 🇧🇷**\n","size_bytes":10012},"server/auth-routes.ts":{"content":"import { Router, Request, Response } from \"express\";\nimport { supabaseAnon, supabaseAdmin } from \"./supabase\";\nimport { registerSchema, loginSchema } from \"@shared/schema\";\nimport { authenticateUser } from \"./auth-middleware\";\nimport { z } from \"zod\";\n\nconst router = Router();\n\n// Endpoint de teste para verificar conexão Supabase\nrouter.get(\"/test-connection\", async (req: Request, res: Response) => {\n  try {\n    // Testa com anon key\n    const { data: anonData, error: anonError } = await supabaseAnon.auth.getSession();\n    \n    // Testa com admin key\n    const { data: adminData, error: adminError } = await supabaseAdmin.auth.admin.listUsers({ page: 1, perPage: 1 });\n    \n    res.json({\n      anonKey: {\n        works: !anonError,\n        error: anonError?.message\n      },\n      adminKey: {\n        works: !adminError,\n        error: adminError?.message,\n        userCount: adminData?.users?.length || 0\n      }\n    });\n  } catch (error) {\n    res.status(500).json({ error: String(error) });\n  }\n});\n\n// POST /api/auth/register - Registrar novo usuário\nrouter.post(\"/register\", async (req: Request, res: Response) => {\n  try {\n    const { email, password, nomeCompleto } = registerSchema.parse(req.body);\n\n    // Criar usuário no Supabase Auth\n    const { data, error } = await supabaseAnon.auth.signUp({\n      email,\n      password,\n      options: {\n        data: {\n          nomeCompleto,\n        },\n      },\n    });\n\n    if (error) {\n      console.error(\"Erro no registro - Supabase:\", error);\n      \n      // Trata rate limiting de envio de emails\n      if (error.status === 429 || error.message.includes(\"rate limit\")) {\n        return res.status(429).json({ \n          error: \"Muitas tentativas de registro. Por favor, aguarde alguns minutos antes de tentar novamente.\",\n          retryAfter: 60 // sugestão de espera em segundos\n        });\n      }\n      \n      // Supabase pode rejeitar emails de domínios de teste (example.com, etc)\n      // ou exigir confirmação de email dependendo das configurações do projeto\n      return res.status(400).json({ error: error.message });\n    }\n\n    // Debug: log completo da resposta do Supabase\n    console.log(\"=== REGISTRO SUPABASE DEBUG ===\");\n    console.log(\"Email tentado:\", email);\n    console.log(\"Tem user?\", !!data.user);\n    console.log(\"Tem session?\", !!data.session);\n    console.log(\"User ID:\", data.user?.id);\n    console.log(\"User email:\", data.user?.email);\n    console.log(\"User confirmado?\", data.user?.email_confirmed_at);\n    console.log(\"===============================\");\n\n    if (!data.user) {\n      console.error(\"❌ ERRO: Supabase não retornou user após signUp\");\n      return res.status(400).json({ error: \"Erro ao criar usuário no Supabase. Verifique as configurações de autenticação.\" });\n    }\n\n    if (!data.session) {\n      console.warn(\"⚠️ AVISO: Usuário criado mas sem sessão ativa\");\n      console.warn(\"Isso indica que confirmação de email está habilitada no Supabase\");\n      return res.status(400).json({ \n        error: \"Conta criada! Por favor, verifique seu email para confirmar o cadastro antes de fazer login.\",\n        requiresEmailConfirmation: true \n      });\n    }\n\n    // Valida token com service role para garantir que funcionará no middleware\n    const { data: validatedUser, error: validateError } = await supabaseAdmin.auth.getUser(data.session.access_token);\n    \n    if (validateError || !validatedUser.user) {\n      console.error(\"Erro ao validar token após registro:\", validateError);\n      return res.status(500).json({ error: \"Erro ao validar token de autenticação\" });\n    }\n\n    res.status(201).json({\n      user: {\n        id: data.user.id,\n        email: data.user.email,\n        nomeCompleto,\n      },\n      accessToken: data.session.access_token,\n      refreshToken: data.session.refresh_token,\n      expiresAt: data.session.expires_at,\n    });\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      return res.status(400).json({ error: error.errors });\n    }\n    console.error(\"Erro no registro:\", error);\n    res.status(500).json({ error: String(error) });\n  }\n});\n\n// POST /api/auth/login - Login de usuário\nrouter.post(\"/login\", async (req: Request, res: Response) => {\n  try {\n    const { email, password } = loginSchema.parse(req.body);\n\n    const { data, error } = await supabaseAnon.auth.signInWithPassword({\n      email,\n      password,\n    });\n\n    if (error) {\n      console.error(\"Erro no login - Supabase:\", error);\n      return res.status(401).json({ error: \"Email ou senha incorretos\" });\n    }\n\n    if (!data.user || !data.session) {\n      return res.status(401).json({ error: \"Erro ao fazer login\" });\n    }\n\n    // Valida token com service role para garantir que funcionará no middleware\n    const { data: validatedUser, error: validateError } = await supabaseAdmin.auth.getUser(data.session.access_token);\n    \n    if (validateError || !validatedUser.user) {\n      console.error(\"Erro ao validar token após login:\", validateError);\n      return res.status(500).json({ error: \"Erro ao validar token de autenticação\" });\n    }\n\n    res.json({\n      user: {\n        id: data.user.id,\n        email: data.user.email,\n        nomeCompleto: data.user.user_metadata?.nomeCompleto,\n      },\n      accessToken: data.session.access_token,\n      refreshToken: data.session.refresh_token,\n      expiresAt: data.session.expires_at,\n    });\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      return res.status(400).json({ error: error.errors });\n    }\n    console.error(\"Erro no login:\", error);\n    res.status(500).json({ error: String(error) });\n  }\n});\n\n// POST /api/auth/logout - Logout de usuário\nrouter.post(\"/logout\", authenticateUser, async (req: Request, res: Response) => {\n  try {\n    // Em vez de signOut() inefetivo em servidor stateless,\n    // apenas instrui cliente a descartar tokens localmente\n    // Em produção, considerar revogar refresh tokens: supabaseAdmin.auth.admin.deleteUser(req.user!.id)\n    \n    res.json({ message: \"Logout realizado com sucesso\" });\n  } catch (error) {\n    console.error(\"Erro no logout:\", error);\n    res.status(500).json({ error: String(error) });\n  }\n});\n\n// GET /api/auth/me - Obter usuário atual\nrouter.get(\"/me\", authenticateUser, async (req: Request, res: Response) => {\n  try {\n    if (!req.user) {\n      return res.status(401).json({ error: \"Não autenticado\" });\n    }\n\n    res.json({\n      user: {\n        id: req.user.id,\n        email: req.user.email,\n        nomeCompleto: req.user.nomeCompleto,\n      },\n    });\n  } catch (error) {\n    console.error(\"Erro ao buscar usuário:\", error);\n    res.status(500).json({ error: String(error) });\n  }\n});\n\n// POST /api/auth/refresh - Renovar token\nrouter.post(\"/refresh\", async (req: Request, res: Response) => {\n  try {\n    const { refresh_token } = req.body;\n\n    if (!refresh_token) {\n      return res.status(400).json({ error: \"Refresh token não fornecido\" });\n    }\n\n    const { data, error } = await supabaseAnon.auth.refreshSession({\n      refresh_token,\n    });\n\n    if (error || !data.session) {\n      return res.status(401).json({ error: \"Refresh token inválido\" });\n    }\n\n    // Valida token com service role para garantir que funcionará no middleware\n    const { data: validatedUser, error: validateError } = await supabaseAdmin.auth.getUser(data.session.access_token);\n    \n    if (validateError || !validatedUser.user) {\n      console.error(\"Erro ao validar token após refresh:\", validateError);\n      return res.status(401).json({ error: \"Erro ao validar token renovado\" });\n    }\n\n    res.json({\n      user: {\n        id: validatedUser.user.id,\n        email: validatedUser.user.email,\n        nomeCompleto: validatedUser.user.user_metadata?.nomeCompleto,\n      },\n      accessToken: data.session.access_token,\n      refreshToken: data.session.refresh_token,\n      expiresAt: data.session.expires_at,\n    });\n  } catch (error) {\n    console.error(\"Erro ao renovar token:\", error);\n    res.status(500).json({ error: String(error) });\n  }\n});\n\nexport default router;\n","size_bytes":8077},"client/src/contexts/AuthContext.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface User {\n  id: string;\n  email: string;\n  nomeCompleto: string;\n}\n\ninterface Session {\n  accessToken: string;\n  refreshToken: string;\n  expiresAt: number;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  session: Session | null;\n  isLoading: boolean;\n  login: (email: string, password: string) => Promise<void>;\n  register: (email: string, password: string, nomeCompleto: string) => Promise<void>;\n  logout: () => Promise<void>;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [session, setSession] = useState<Session | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Carrega sessão do localStorage na inicialização\n  useEffect(() => {\n    const loadSession = async () => {\n      if (typeof window === 'undefined') {\n        setIsLoading(false);\n        return;\n      }\n      \n      const storedSession = localStorage.getItem(\"session\");\n      const storedUser = localStorage.getItem(\"user\");\n      \n      if (storedSession) {\n        try {\n          const parsedSession: Session = JSON.parse(storedSession);\n          \n          // Verifica se token expirou\n          if (parsedSession.expiresAt * 1000 < Date.now()) {\n            // Token expirado, tenta renovar\n            await refreshSession(parsedSession.refreshToken);\n          } else {\n            setSession(parsedSession);\n            \n            // Carrega usuário salvo ou busca novamente\n            if (storedUser) {\n              setUser(JSON.parse(storedUser));\n            } else {\n              // Garante que session está no localStorage antes de fetchUser\n              // para que queryClient possa injetar o token\n              localStorage.setItem(\"session\", JSON.stringify(parsedSession));\n              await fetchUser();\n            }\n          }\n        } catch (error) {\n          console.error(\"Erro ao carregar sessão:\", error);\n          if (typeof window !== 'undefined') {\n            localStorage.removeItem(\"session\");\n            localStorage.removeItem(\"user\");\n          }\n        }\n      }\n      setIsLoading(false);\n    };\n\n    loadSession();\n  }, []);\n\n  const refreshSession = async (refreshToken: string) => {\n    try {\n      const response = await apiRequest<{ user: User; accessToken: string; refreshToken: string; expiresAt: number }>(\"/api/auth/refresh\", {\n        method: \"POST\",\n        body: JSON.stringify({ refresh_token: refreshToken }),\n      });\n      \n      const newSession: Session = {\n        accessToken: response.accessToken,\n        refreshToken: response.refreshToken,\n        expiresAt: response.expiresAt,\n      };\n      \n      setSession(newSession);\n      setUser(response.user);\n      if (typeof window !== 'undefined') {\n        localStorage.setItem(\"session\", JSON.stringify(newSession));\n        localStorage.setItem(\"user\", JSON.stringify(response.user));\n      }\n    } catch (error) {\n      console.error(\"Erro ao renovar sessão:\", error);\n      if (typeof window !== 'undefined') {\n        localStorage.removeItem(\"session\");\n        localStorage.removeItem(\"user\");\n      }\n      setSession(null);\n      setUser(null);\n    }\n  };\n\n  const fetchUser = async () => {\n    try {\n      const response = await apiRequest<{ user: User }>(\"/api/auth/me\");\n      setUser(response.user);\n      if (typeof window !== 'undefined') {\n        localStorage.setItem(\"user\", JSON.stringify(response.user));\n      }\n    } catch (error) {\n      console.error(\"Erro ao buscar usuário:\", error);\n      setUser(null);\n      if (typeof window !== 'undefined') {\n        localStorage.removeItem(\"user\");\n      }\n    }\n  };\n\n  const login = async (email: string, password: string) => {\n    const response = await apiRequest<{ user: User; accessToken: string; refreshToken: string; expiresAt: number }>(\"/api/auth/login\", {\n      method: \"POST\",\n      body: JSON.stringify({ email, password }),\n    });\n\n    const newSession: Session = {\n      accessToken: response.accessToken,\n      refreshToken: response.refreshToken,\n      expiresAt: response.expiresAt,\n    };\n\n    setUser(response.user);\n    setSession(newSession);\n    if (typeof window !== 'undefined') {\n      localStorage.setItem(\"session\", JSON.stringify(newSession));\n      localStorage.setItem(\"user\", JSON.stringify(response.user));\n    }\n  };\n\n  const register = async (email: string, password: string, nomeCompleto: string) => {\n    const response = await apiRequest<{ user: User; accessToken: string; refreshToken: string; expiresAt: number }>(\"/api/auth/register\", {\n      method: \"POST\",\n      body: JSON.stringify({ email, password, nomeCompleto }),\n    });\n\n    const newSession: Session = {\n      accessToken: response.accessToken,\n      refreshToken: response.refreshToken,\n      expiresAt: response.expiresAt,\n    };\n\n    setUser(response.user);\n    setSession(newSession);\n    if (typeof window !== 'undefined') {\n      localStorage.setItem(\"session\", JSON.stringify(newSession));\n      localStorage.setItem(\"user\", JSON.stringify(response.user));\n    }\n  };\n\n  const logout = async () => {\n    try {\n      await apiRequest(\"/api/auth/logout\", { method: \"POST\" });\n    } catch (error) {\n      console.error(\"Erro ao fazer logout:\", error);\n    } finally {\n      setUser(null);\n      setSession(null);\n      if (typeof window !== 'undefined') {\n        localStorage.removeItem(\"session\");\n        localStorage.removeItem(\"user\");\n      }\n    }\n  };\n\n  return (\n    <AuthContext.Provider value={{ user, session, isLoading, login, register, logout }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n\n// Hook para obter token para fazer requests autenticados\nexport function useAuthToken() {\n  const { session } = useAuth();\n  return session?.accessToken || null;\n}\n","size_bytes":6180},"client/src/pages/login.tsx":{"content":"import { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { FileText, Loader2 } from \"lucide-react\";\n\nexport default function Login() {\n  const [, navigate] = useLocation();\n  const { login } = useAuth();\n  const { toast } = useToast();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      await login(email, password);\n      toast({\n        title: \"Login realizado com sucesso\",\n        description: \"Bem-vindo de volta!\",\n      });\n      navigate(\"/\");\n    } catch (error: any) {\n      toast({\n        title: \"Erro ao fazer login\",\n        description: error.message || \"Email ou senha incorretos\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"p-3 bg-primary/10 rounded-full\">\n              <FileText className=\"h-8 w-8 text-primary\" data-testid=\"icon-logo\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl font-bold\" data-testid=\"text-title\">\n            SEFAZ XML Sync\n          </CardTitle>\n          <CardDescription data-testid=\"text-subtitle\">\n            Entre com sua conta para continuar\n          </CardDescription>\n        </CardHeader>\n\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\" data-testid=\"label-email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"seu@email.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                required\n                disabled={isLoading}\n                data-testid=\"input-email\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\" data-testid=\"label-password\">Senha</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                disabled={isLoading}\n                data-testid=\"input-password\"\n              />\n            </div>\n          </CardContent>\n\n          <CardFooter className=\"flex flex-col space-y-4\">\n            <Button \n              type=\"submit\" \n              className=\"w-full\" \n              disabled={isLoading}\n              data-testid=\"button-login\"\n            >\n              {isLoading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Entrando...\n                </>\n              ) : (\n                \"Entrar\"\n              )}\n            </Button>\n\n            <div className=\"text-sm text-center text-muted-foreground\">\n              Não tem uma conta?{\" \"}\n              <Link href=\"/register\" className=\"text-primary hover:underline\" data-testid=\"link-register\">\n                Cadastre-se\n              </Link>\n            </div>\n          </CardFooter>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":3916},"server/supabase-storage.ts":{"content":"import { supabaseAdmin } from \"./supabase\";\nimport type { IStorage } from \"./storage\";\nimport type {\n  Empresa,\n  InsertEmpresa,\n  Sincronizacao,\n  InsertSincronizacao,\n  Xml,\n  InsertXml,\n  Log,\n  InsertLog,\n  Manifestacao,\n  InsertManifestacao,\n  Configuracao,\n  InsertConfiguracao,\n  UpdateConfiguracao,\n} from \"@shared/schema\";\n\n// ========== FUNÇÕES DE PARSE (snake_case → camelCase) ==========\n\nfunction parseEmpresa(raw: any): Empresa {\n  return {\n    id: raw.id,\n    userId: raw.user_id,\n    cnpj: raw.cnpj,\n    razaoSocial: raw.razao_social,\n    uf: raw.uf,\n    ambiente: raw.ambiente,\n    certificadoPath: raw.certificado_path,\n    certificadoSenha: raw.certificado_senha,\n    ativo: raw.ativo,\n    ultimoNSU: raw.ultimo_nsu,\n    bloqueadoAte: raw.bloqueado_ate ? new Date(raw.bloqueado_ate) : null,\n    tipoArmazenamento: raw.tipo_armazenamento || \"local\",\n    manifestacaoAutomatica: raw.manifestacao_automatica !== undefined ? raw.manifestacao_automatica : true,\n    createdAt: raw.created_at,\n    updatedAt: raw.updated_at,\n  };\n}\n\nfunction parseSincronizacao(raw: any): Sincronizacao {\n  return {\n    id: raw.id,\n    userId: raw.user_id,\n    empresaId: raw.empresa_id,\n    dataInicio: raw.data_inicio,\n    dataFim: raw.data_fim,\n    status: raw.status,\n    nsuInicial: raw.nsu_inicial,\n    nsuFinal: raw.nsu_final,\n    xmlsBaixados: raw.xmls_baixados,\n    mensagemErro: raw.mensagem_erro,\n    createdAt: raw.created_at,\n  };\n}\n\nfunction parseXml(raw: any): Xml {\n  return {\n    id: raw.id,\n    userId: raw.user_id,\n    empresaId: raw.empresa_id,\n    sincronizacaoId: raw.sincronizacao_id,\n    chaveNFe: raw.chave_nfe,\n    numeroNF: raw.numero_nf,\n    modelo: raw.modelo,\n    tipoDocumento: raw.tipo_documento,\n    dataEmissao: raw.data_emissao,\n    caminhoArquivo: raw.caminho_arquivo,\n    tamanhoBytes: raw.tamanho_bytes,\n    statusDownload: raw.status_download || 'pendente',\n    tentativasDownload: raw.tentativas_download || 0,\n    ultimaTentativaDownload: raw.ultima_tentativa_download || undefined,\n    erroDownload: raw.erro_download || undefined,\n    statusNfe: raw.status_nfe || 'autorizada',\n    createdAt: raw.created_at,\n  };\n}\n\nfunction parseLog(raw: any): Log {\n  return {\n    id: raw.id,\n    userId: raw.user_id,\n    empresaId: raw.empresa_id,\n    sincronizacaoId: raw.sincronizacao_id,\n    nivel: raw.nivel,\n    mensagem: raw.mensagem,\n    detalhes: raw.detalhes,\n    timestamp: raw.timestamp,\n  };\n}\n\nfunction parseManifestacao(raw: any): Manifestacao {\n  return {\n    id: raw.id,\n    userId: raw.user_id,\n    empresaId: raw.empresa_id,\n    chaveNFe: raw.chave_nfe,\n    tipoEvento: raw.tipo_evento,\n    status: raw.status,\n    dataAutorizacaoNFe: new Date(raw.data_autorizacao_nfe),\n    dataManifestacao: raw.data_manifestacao ? new Date(raw.data_manifestacao) : null,\n    prazoLegal: new Date(raw.prazo_legal),\n    nsuEvento: raw.nsu_evento,\n    protocoloEvento: raw.protocolo_evento,\n    cStat: raw.c_stat,\n    xMotivo: raw.x_motivo,\n    justificativa: raw.justificativa,\n    tentativas: raw.tentativas,\n    ultimoErro: raw.ultimo_erro,\n    createdAt: new Date(raw.created_at),\n    updatedAt: new Date(raw.updated_at),\n  };\n}\n\nfunction parseConfiguracao(raw: any): Configuracao {\n  return {\n    id: raw.id,\n    userId: raw.user_id,\n    intervaloSincronizacao: raw.intervalo_sincronizacao,\n    sincronizacaoAutomatica: raw.sincronizacao_automatica,\n    sincronizarAoIniciar: raw.sincronizar_ao_iniciar,\n    retryAutomatico: raw.retry_automatico,\n    maxRetries: raw.max_retries,\n    timeoutRequisicao: raw.timeout_requisicao,\n    validarSSL: raw.validar_ssl,\n    logsDetalhados: raw.logs_detalhados,\n    notificarNovosXmls: raw.notificar_novos_xmls,\n    notificarErros: raw.notificar_erros,\n    relatorioDiario: raw.relatorio_diario,\n    emailNotificacoes: raw.email_notificacoes,\n    createdAt: new Date(raw.created_at),\n    updatedAt: new Date(raw.updated_at),\n  };\n}\n\nexport class SupabaseStorage implements IStorage {\n  // ========== EMPRESAS ==========\n\n  async getEmpresas(userId?: string): Promise<Empresa[]> {\n    let query = supabaseAdmin.from(\"empresas\").select(\"*\").order(\"created_at\", { ascending: false });\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar empresas: ${error.message}`);\n    return (data || []).map(parseEmpresa);\n  }\n\n  async getEmpresa(id: string, userId?: string): Promise<Empresa | null> {\n    let query = supabaseAdmin.from(\"empresas\").select(\"*\").eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null; // Not found\n      throw new Error(`Erro ao buscar empresa: ${error.message}`);\n    }\n\n    return parseEmpresa(data);\n  }\n\n  async getEmpresaByCNPJ(cnpj: string, userId?: string): Promise<Empresa | null> {\n    let query = supabaseAdmin.from(\"empresas\").select(\"*\").eq(\"cnpj\", cnpj);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.maybeSingle();\n\n    if (error) throw new Error(`Erro ao buscar empresa por CNPJ: ${error.message}`);\n    return data ? parseEmpresa(data) : null;\n  }\n\n  async getEmpresasAtivas(userId?: string): Promise<Empresa[]> {\n    let query = supabaseAdmin.from(\"empresas\").select(\"*\").eq(\"ativo\", true);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar empresas ativas: ${error.message}`);\n    return (data || []).map(parseEmpresa);\n  }\n\n  async createEmpresa(empresa: InsertEmpresa & { userId: string }): Promise<Empresa> {\n    const { data, error } = await supabaseAdmin\n      .from(\"empresas\")\n      .insert({\n        user_id: empresa.userId,\n        cnpj: empresa.cnpj,\n        razao_social: empresa.razaoSocial,\n        uf: empresa.uf,\n        ambiente: empresa.ambiente,\n        certificado_path: empresa.certificadoPath,\n        certificado_senha: empresa.certificadoSenha,\n        ativo: empresa.ativo ?? true,\n        tipo_armazenamento: empresa.tipoArmazenamento ?? \"local\",\n        manifestacao_automatica: empresa.manifestacaoAutomatica ?? true,\n      })\n      .select()\n      .single();\n\n    if (error) throw new Error(`Erro ao criar empresa: ${error.message}`);\n    return parseEmpresa(data);\n  }\n\n  async updateEmpresa(id: string, updates: Partial<Empresa>, userId?: string): Promise<Empresa | null> {\n    const updateData: any = {};\n    \n    if (updates.razaoSocial !== undefined) updateData.razao_social = updates.razaoSocial;\n    if (updates.uf !== undefined) updateData.uf = updates.uf;\n    if (updates.ambiente !== undefined) updateData.ambiente = updates.ambiente;\n    if (updates.certificadoPath !== undefined) updateData.certificado_path = updates.certificadoPath;\n    if (updates.certificadoSenha !== undefined) updateData.certificado_senha = updates.certificadoSenha;\n    if (updates.ativo !== undefined) updateData.ativo = updates.ativo;\n    if (updates.ultimoNSU !== undefined) updateData.ultimo_nsu = updates.ultimoNSU;\n    if (updates.bloqueadoAte !== undefined) updateData.bloqueado_ate = updates.bloqueadoAte;\n    if (updates.tipoArmazenamento !== undefined) updateData.tipo_armazenamento = updates.tipoArmazenamento;\n    if (updates.manifestacaoAutomatica !== undefined) updateData.manifestacao_automatica = updates.manifestacaoAutomatica;\n    \n    updateData.updated_at = new Date().toISOString();\n\n    let query = supabaseAdmin.from(\"empresas\").update(updateData).eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    // Não usa .select() para evitar erro de cache do PostgREST\n    // Busca os dados atualizados em seguida\n    const { error } = await query;\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao atualizar empresa: ${error.message}`);\n    }\n\n    // Busca empresa atualizada\n    return this.getEmpresa(id, userId);\n  }\n\n  async deleteEmpresa(id: string, userId?: string): Promise<boolean> {\n    let query = supabaseAdmin.from(\"empresas\").delete().eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { error } = await query;\n\n    if (error) throw new Error(`Erro ao deletar empresa: ${error.message}`);\n    return true;\n  }\n\n  // ========== SINCRONIZAÇÕES ==========\n\n  async getSincronizacoes(userId?: string): Promise<Sincronizacao[]> {\n    let query = supabaseAdmin.from(\"sincronizacoes\").select(\"*\").order(\"created_at\", { ascending: false });\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar sincronizações: ${error.message}`);\n    return (data || []).map(parseSincronizacao);\n  }\n\n  async getSincronizacao(id: string, userId?: string): Promise<Sincronizacao | null> {\n    let query = supabaseAdmin.from(\"sincronizacoes\").select(\"*\").eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao buscar sincronização: ${error.message}`);\n    }\n\n    return parseSincronizacao(data);\n  }\n\n  async getSincronizacoesEmAndamento(userId?: string): Promise<Sincronizacao[]> {\n    let query = supabaseAdmin.from(\"sincronizacoes\").select(\"*\").eq(\"status\", \"em_andamento\");\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar sincronizações em andamento: ${error.message}`);\n    return (data || []).map(parseSincronizacao);\n  }\n\n  async createSincronizacao(sincronizacao: InsertSincronizacao & { userId: string }): Promise<Sincronizacao> {\n    const { data, error } = await supabaseAdmin\n      .from(\"sincronizacoes\")\n      .insert({\n        user_id: sincronizacao.userId,\n        empresa_id: sincronizacao.empresaId,\n        data_inicio: sincronizacao.dataInicio,\n        data_fim: sincronizacao.dataFim || null,\n        status: sincronizacao.status,\n        nsu_inicial: sincronizacao.nsuInicial,\n        nsu_final: sincronizacao.nsuFinal || null,\n        xmls_baixados: sincronizacao.xmlsBaixados || 0,\n        mensagem_erro: sincronizacao.mensagemErro || null,\n      })\n      .select()\n      .single();\n\n    if (error) throw new Error(`Erro ao criar sincronização: ${error.message}`);\n    return parseSincronizacao(data);\n  }\n\n  async updateSincronizacao(id: string, updates: Partial<Sincronizacao>, userId?: string): Promise<Sincronizacao | null> {\n    const updateData: any = {};\n    \n    if (updates.dataFim !== undefined) updateData.data_fim = updates.dataFim;\n    if (updates.status !== undefined) updateData.status = updates.status;\n    if (updates.nsuFinal !== undefined) updateData.nsu_final = updates.nsuFinal;\n    if (updates.xmlsBaixados !== undefined) updateData.xmls_baixados = updates.xmlsBaixados;\n    if (updates.mensagemErro !== undefined) updateData.mensagem_erro = updates.mensagemErro;\n\n    let query = supabaseAdmin\n      .from(\"sincronizacoes\")\n      .update(updateData)\n      .eq(\"id\", id);\n\n    // CRÍTICO: Adiciona filtro de userId para segurança multi-tenant\n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.select().single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao atualizar sincronização: ${error.message}`);\n    }\n\n    return parseSincronizacao(data);\n  }\n\n  // ========== XMLs ==========\n\n  async getXmls(userId?: string): Promise<Xml[]> {\n    let query = supabaseAdmin\n      .from(\"xmls\")\n      .select(\"*\")\n      .in(\"tipo_documento\", [\"resNFe\", \"nfeProc\"]) // FILTRO: Apenas resNFe e nfeProc\n      .order(\"created_at\", { ascending: false });\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar XMLs: ${error.message}`);\n    return (data || []).map(parseXml);\n  }\n\n  async getXml(id: string, userId?: string): Promise<Xml | null> {\n    let query = supabaseAdmin.from(\"xmls\").select(\"*\").eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao buscar XML: ${error.message}`);\n    }\n\n    return parseXml(data);\n  }\n\n  async getXmlsHoje(userId?: string): Promise<number> {\n    const hoje = new Date();\n    hoje.setHours(0, 0, 0, 0);\n\n    let query = supabaseAdmin\n      .from(\"xmls\")\n      .select(\"id\", { count: \"exact\", head: true })\n      .in(\"tipo_documento\", [\"resNFe\", \"nfeProc\"]) // FILTRO: Apenas resNFe e nfeProc\n      .gte(\"created_at\", hoje.toISOString());\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { count, error } = await query;\n\n    if (error) throw new Error(`Erro ao contar XMLs de hoje: ${error.message}`);\n    return count || 0;\n  }\n\n  async getXmlsRecentes(limit: number = 10, userId?: string): Promise<Xml[]> {\n    let query = supabaseAdmin\n      .from(\"xmls\")\n      .select(\"*\")\n      .in(\"tipo_documento\", [\"resNFe\", \"nfeProc\"]) // FILTRO: Apenas resNFe e nfeProc\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar XMLs recentes: ${error.message}`);\n    return (data || []).map(parseXml);\n  }\n\n  async getXmlByChave(chaveNFe: string, userId?: string): Promise<Xml | null> {\n    let query = supabaseAdmin.from(\"xmls\").select(\"*\").eq(\"chave_nfe\", chaveNFe);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao buscar XML por chave: ${error.message}`);\n    }\n\n    return parseXml(data);\n  }\n\n  async createXml(xml: InsertXml & { userId: string }): Promise<Xml> {\n    const insertData: any = {\n      user_id: xml.userId,\n      empresa_id: xml.empresaId,\n      sincronizacao_id: xml.sincronizacaoId || null,\n      chave_nfe: xml.chaveNFe,\n      numero_nf: xml.numeroNF,\n      modelo: xml.modelo,\n      tipo_documento: xml.tipoDocumento,\n      data_emissao: xml.dataEmissao,\n      caminho_arquivo: xml.caminhoArquivo,\n      tamanho_bytes: xml.tamanhoBytes,\n      status_download: (xml as any).statusDownload || 'pendente',\n      tentativas_download: (xml as any).tentativasDownload || 0,\n      status_nfe: (xml as any).statusNfe || 'autorizada', // CRÍTICO: Sempre define status_nfe\n    };\n\n    const { data, error } = await supabaseAdmin\n      .from(\"xmls\")\n      .insert(insertData)\n      .select()\n      .single();\n\n    // Se erro de duplicata (constraint unique violation), busca XML existente\n    if (error) {\n      if (error.code === \"23505\") { // PostgreSQL unique violation\n        console.log(`XML duplicado detectado (ignorado): ${xml.chaveNFe}`);\n        const existing = await this.getXmlByChave(xml.chaveNFe, xml.userId);\n        if (existing) return existing;\n      }\n      throw new Error(`Erro ao criar XML: ${error.message}`);\n    }\n    \n    return parseXml(data);\n  }\n\n  async updateXml(id: string, updates: Partial<Xml>, userId?: string): Promise<Xml | null> {\n    const updateData: any = {};\n    \n    if (updates.statusDownload !== undefined) updateData.status_download = updates.statusDownload;\n    if (updates.tentativasDownload !== undefined) updateData.tentativas_download = updates.tentativasDownload;\n    if (updates.ultimaTentativaDownload !== undefined) updateData.ultima_tentativa_download = updates.ultimaTentativaDownload;\n    if (updates.erroDownload !== undefined) updateData.erro_download = updates.erroDownload;\n    if (updates.caminhoArquivo !== undefined) updateData.caminho_arquivo = updates.caminhoArquivo;\n    if (updates.tamanhoBytes !== undefined) updateData.tamanho_bytes = updates.tamanhoBytes;\n    if (updates.tipoDocumento !== undefined) updateData.tipo_documento = updates.tipoDocumento;\n    if (updates.statusNfe !== undefined) updateData.status_nfe = updates.statusNfe;\n\n    let query = supabaseAdmin.from(\"xmls\").update(updateData).eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { error } = await query;\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao atualizar XML: ${error.message}`);\n    }\n\n    return this.getXml(id, userId);\n  }\n\n  async getXmlsPendentesDownload(userId?: string, limit: number = 50): Promise<Xml[]> {\n    let query = supabaseAdmin\n      .from(\"xmls\")\n      .select(\"*\")\n      .eq(\"status_download\", \"pendente\")\n      .eq(\"tipo_documento\", \"resNFe\") // CRÍTICO: Apenas resNFe (resumos) devem ser baixados\n      .neq(\"status_nfe\", \"cancelada\") // FILTRO: Ignora XMLs cancelados (não processar)\n      .order(\"created_at\", { ascending: true })\n      .limit(limit);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar XMLs pendentes: ${error.message}`);\n    return (data || []).map(parseXml);\n  }\n\n  async getXmlsComErroDownload(userId?: string, limit: number = 50, maxTentativas: number = 999): Promise<Xml[]> {\n    // Busca XMLs com erro (pendente com tentativas OU erro definitivo) para retry infinito\n    // RETRY INFINITO: Removido filtro .gt(\"tentativas_download\", 0) para incluir XMLs resetados\n    let query = supabaseAdmin\n      .from(\"xmls\")\n      .select(\"*\")\n      .eq(\"tipo_documento\", \"resNFe\") // CRÍTICO: Apenas resNFe (resumos)\n      .eq(\"status_download\", \"erro\") // Busca apenas status \"erro\" (pendentes vão por getXmlsPendentesDownload)\n      .neq(\"status_nfe\", \"cancelada\") // FILTRO: Ignora XMLs cancelados (não processar)\n      .order(\"ultima_tentativa_download\", { ascending: true })\n      .limit(limit);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar XMLs com erro: ${error.message}`);\n    return (data || []).map(parseXml);\n  }\n\n  async getXmlsComErroDefinitivo(userId?: string, limit: number = 100): Promise<Xml[]> {\n    let query = supabaseAdmin\n      .from(\"xmls\")\n      .select(\"*\")\n      .eq(\"status_download\", \"erro\") // XMLs que falharam permanentemente\n      .eq(\"tipo_documento\", \"resNFe\") // Apenas resNFe\n      .order(\"updated_at\", { ascending: false })\n      .limit(limit);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar XMLs com erro definitivo: ${error.message}`);\n    return (data || []).map(parseXml);\n  }\n\n  // ========== LOGS ==========\n\n  async getLogs(userId?: string): Promise<Log[]> {\n    let query = supabaseAdmin.from(\"logs\").select(\"*\").order(\"timestamp\", { ascending: false }).limit(100);\n    \n    if (userId) {\n      query = query.or(`user_id.eq.${userId},user_id.is.null`);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar logs: ${error.message}`);\n    return (data || []).map(parseLog);\n  }\n\n  async getLogsRecentes(limit: number = 10, userId?: string): Promise<Log[]> {\n    let query = supabaseAdmin.from(\"logs\").select(\"*\").order(\"timestamp\", { ascending: false }).limit(limit);\n    \n    if (userId) {\n      query = query.or(`user_id.eq.${userId},user_id.is.null`);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar logs recentes: ${error.message}`);\n    return (data || []).map(parseLog);\n  }\n\n  async createLog(log: InsertLog & { userId?: string }): Promise<Log> {\n    const { data, error} = await supabaseAdmin\n      .from(\"logs\")\n      .insert({\n        user_id: log.userId || null,\n        empresa_id: log.empresaId || null,\n        sincronizacao_id: log.sincronizacaoId || null,\n        nivel: log.nivel,\n        mensagem: log.mensagem,\n        detalhes: log.detalhes || null,\n      })\n      .select()\n      .single();\n\n    if (error) throw new Error(`Erro ao criar log: ${error.message}`);\n    return parseLog(data);\n  }\n\n  async deleteLockLogs(): Promise<void> {\n    const { error } = await supabaseAdmin\n      .from(\"logs\")\n      .delete()\n      .in(\"mensagem\", [\"Download Service - Lock Acquired\", \"Download Service - Lock Released\"]);\n\n    if (error) throw new Error(`Erro ao deletar logs de lock: ${error.message}`);\n  }\n\n  // ========== MANIFESTAÇÕES DO DESTINATÁRIO (NT 2020.001) ==========\n\n  async getManifestacoes(userId?: string): Promise<Manifestacao[]> {\n    let query = supabaseAdmin.from(\"manifestacoes\").select(\"*\").order(\"created_at\", { ascending: false });\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar manifestações: ${error.message}`);\n    return (data || []).map(parseManifestacao);\n  }\n\n  async getManifestacao(id: string, userId?: string): Promise<Manifestacao | null> {\n    let query = supabaseAdmin.from(\"manifestacoes\").select(\"*\").eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao buscar manifestação: ${error.message}`);\n    }\n\n    return parseManifestacao(data);\n  }\n\n  async getManifestacaoByChave(chaveNFe: string, userId?: string): Promise<Manifestacao | null> {\n    let query = supabaseAdmin.from(\"manifestacoes\").select(\"*\").eq(\"chave_nfe\", chaveNFe);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.maybeSingle();\n\n    if (error) throw new Error(`Erro ao buscar manifestação por chave: ${error.message}`);\n    return data ? parseManifestacao(data) : null;\n  }\n\n  async getManifestacoesByEmpresa(empresaId: string, userId?: string): Promise<Manifestacao[]> {\n    let query = supabaseAdmin.from(\"manifestacoes\").select(\"*\").eq(\"empresa_id\", empresaId).order(\"created_at\", { ascending: false });\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar manifestações por empresa: ${error.message}`);\n    return (data || []).map(parseManifestacao);\n  }\n\n  async getManifestacoesPendentes(empresaId: string, userId?: string): Promise<Manifestacao[]> {\n    let query = supabaseAdmin\n      .from(\"manifestacoes\")\n      .select(\"*\")\n      .eq(\"empresa_id\", empresaId)\n      .eq(\"status\", \"pendente\")\n      .order(\"prazo_legal\", { ascending: true });\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar manifestações pendentes: ${error.message}`);\n    return (data || []).map(parseManifestacao);\n  }\n\n  async createManifestacao(manifestacao: InsertManifestacao & { userId: string }): Promise<Manifestacao> {\n    const { data, error } = await supabaseAdmin\n      .from(\"manifestacoes\")\n      .insert({\n        user_id: manifestacao.userId,\n        empresa_id: manifestacao.empresaId,\n        chave_nfe: manifestacao.chaveNFe,\n        tipo_evento: manifestacao.tipoEvento,\n        status: manifestacao.status || \"pendente\",\n        data_autorizacao_nfe: manifestacao.dataAutorizacaoNFe,\n        data_manifestacao: manifestacao.dataManifestacao || null,\n        prazo_legal: manifestacao.prazoLegal,\n        nsu_evento: manifestacao.nsuEvento || null,\n        protocolo_evento: manifestacao.protocoloEvento || null,\n        c_stat: manifestacao.cStat || null,\n        x_motivo: manifestacao.xMotivo || null,\n        justificativa: manifestacao.justificativa || null,\n        tentativas: manifestacao.tentativas || 0,\n        ultimo_erro: manifestacao.ultimoErro || null,\n      })\n      .select()\n      .single();\n\n    if (error) throw new Error(`Erro ao criar manifestação: ${error.message}`);\n    return parseManifestacao(data);\n  }\n\n  async updateManifestacao(id: string, updates: Partial<Manifestacao>, userId?: string): Promise<Manifestacao | null> {\n    const updateData: any = {};\n    \n    if (updates.status !== undefined) updateData.status = updates.status;\n    if (updates.dataManifestacao !== undefined) updateData.data_manifestacao = updates.dataManifestacao;\n    if (updates.nsuEvento !== undefined) updateData.nsu_evento = updates.nsuEvento;\n    if (updates.protocoloEvento !== undefined) updateData.protocolo_evento = updates.protocoloEvento;\n    if (updates.cStat !== undefined) updateData.c_stat = updates.cStat;\n    if (updates.xMotivo !== undefined) updateData.x_motivo = updates.xMotivo;\n    if (updates.tentativas !== undefined) updateData.tentativas = updates.tentativas;\n    if (updates.ultimoErro !== undefined) updateData.ultimo_erro = updates.ultimoErro;\n\n    updateData.updated_at = new Date().toISOString();\n\n    let query = supabaseAdmin.from(\"manifestacoes\").update(updateData).eq(\"id\", id);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query.select().single();\n\n    if (error) {\n      if (error.code === \"PGRST116\") return null;\n      throw new Error(`Erro ao atualizar manifestação: ${error.message}`);\n    }\n\n    return parseManifestacao(data);\n  }\n\n  async getManifestacoesRecentes(limit: number = 10, userId?: string): Promise<Manifestacao[]> {\n    let query = supabaseAdmin.from(\"manifestacoes\").select(\"*\").order(\"created_at\", { ascending: false }).limit(limit);\n    \n    if (userId) {\n      query = query.eq(\"user_id\", userId);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw new Error(`Erro ao buscar manifestações recentes: ${error.message}`);\n    return (data || []).map(parseManifestacao);\n  }\n\n  // ========== CONFIGURAÇÕES ==========\n\n  async getConfiguracao(userId: string): Promise<Configuracao | null> {\n    const { data, error } = await supabaseAdmin\n      .from(\"configuracoes\")\n      .select(\"*\")\n      .eq(\"user_id\", userId)\n      .maybeSingle();\n\n    if (error) throw new Error(`Erro ao buscar configuração: ${error.message}`);\n    return data ? parseConfiguracao(data) : null;\n  }\n\n  async createConfiguracao(config: InsertConfiguracao & { userId: string }): Promise<Configuracao> {\n    const { data, error } = await supabaseAdmin\n      .from(\"configuracoes\")\n      .insert({\n        user_id: config.userId,\n        intervalo_sincronizacao: config.intervaloSincronizacao || \"1h\",\n        sincronizacao_automatica: config.sincronizacaoAutomatica !== undefined ? config.sincronizacaoAutomatica : true,\n        sincronizar_ao_iniciar: config.sincronizarAoIniciar !== undefined ? config.sincronizarAoIniciar : true,\n        retry_automatico: config.retryAutomatico !== undefined ? config.retryAutomatico : true,\n        max_retries: config.maxRetries || 3,\n        timeout_requisicao: config.timeoutRequisicao || 60,\n        validar_ssl: config.validarSSL !== undefined ? config.validarSSL : true,\n        logs_detalhados: config.logsDetalhados !== undefined ? config.logsDetalhados : false,\n        notificar_novos_xmls: config.notificarNovosXmls !== undefined ? config.notificarNovosXmls : true,\n        notificar_erros: config.notificarErros !== undefined ? config.notificarErros : true,\n        relatorio_diario: config.relatorioDiario !== undefined ? config.relatorioDiario : false,\n        email_notificacoes: config.emailNotificacoes || null,\n      })\n      .select()\n      .single();\n\n    if (error) throw new Error(`Erro ao criar configuração: ${error.message}`);\n    return parseConfiguracao(data);\n  }\n\n  async updateConfiguracao(userId: string, updates: UpdateConfiguracao): Promise<Configuracao> {\n    const updateData: any = {};\n    \n    if (updates.intervaloSincronizacao !== undefined) updateData.intervalo_sincronizacao = updates.intervaloSincronizacao;\n    if (updates.sincronizacaoAutomatica !== undefined) updateData.sincronizacao_automatica = updates.sincronizacaoAutomatica;\n    if (updates.sincronizarAoIniciar !== undefined) updateData.sincronizar_ao_iniciar = updates.sincronizarAoIniciar;\n    if (updates.retryAutomatico !== undefined) updateData.retry_automatico = updates.retryAutomatico;\n    if (updates.maxRetries !== undefined) updateData.max_retries = updates.maxRetries;\n    if (updates.timeoutRequisicao !== undefined) updateData.timeout_requisicao = updates.timeoutRequisicao;\n    if (updates.validarSSL !== undefined) updateData.validar_ssl = updates.validarSSL;\n    if (updates.logsDetalhados !== undefined) updateData.logs_detalhados = updates.logsDetalhados;\n    if (updates.notificarNovosXmls !== undefined) updateData.notificar_novos_xmls = updates.notificarNovosXmls;\n    if (updates.notificarErros !== undefined) updateData.notificar_erros = updates.notificarErros;\n    if (updates.relatorioDiario !== undefined) updateData.relatorio_diario = updates.relatorioDiario;\n    if (updates.emailNotificacoes !== undefined) updateData.email_notificacoes = updates.emailNotificacoes || null;\n\n    updateData.updated_at = new Date().toISOString();\n\n    const { data, error } = await supabaseAdmin\n      .from(\"configuracoes\")\n      .update(updateData)\n      .eq(\"user_id\", userId)\n      .select()\n      .single();\n\n    if (error) throw new Error(`Erro ao atualizar configuração: ${error.message}`);\n    return parseConfiguracao(data);\n  }\n\n  // ========== DISTRIBUTED LOCKS ==========\n  \n  // Owner UUID único e estável para esta instância do processo\n  private lockOwnerUuid: string | null = null;\n\n  /**\n   * Obtém ou gera owner UUID estável para locks distribuídos\n   */\n  private getLockOwnerUuid(): string {\n    if (!this.lockOwnerUuid) {\n      // Usa UUID da variável de ambiente ou gera novo (estável durante vida do processo)\n      this.lockOwnerUuid = process.env.LOCK_OWNER_UUID || crypto.randomUUID();\n      console.log(`[SupabaseStorage] Lock owner UUID: ${this.lockOwnerUuid}`);\n    }\n    return this.lockOwnerUuid;\n  }\n\n  /**\n   * Tenta adquirir lock de download distribuído usando função PostgreSQL\n   * Retorna true se conseguiu adquirir, false se já ocupado por outro owner\n   */\n  async tryAcquireDownloadLock(): Promise<boolean> {\n    try {\n      const lockName = \"xml-download-service\";\n      const ownerUuid = this.getLockOwnerUuid();\n      \n      // Chama função PostgreSQL via RPC\n      const { data, error } = await supabaseAdmin.rpc('acquire_download_lock', {\n        p_name: lockName,\n        p_owner: ownerUuid,\n        p_ttl_seconds: 180 // 3 minutos\n      });\n\n      if (error) {\n        console.error(\"[SupabaseStorage] Erro ao adquirir lock:\", error.message);\n        return false;\n      }\n\n      const acquired = !!data;\n      console.log(`[SupabaseStorage] Lock \"${lockName}\" acquire: ${acquired ? 'SUCCESS' : 'FAIL (já ocupado)'}`);\n      return acquired;\n    } catch (error: any) {\n      console.error(\"[SupabaseStorage] Exceção ao adquirir lock:\", error.message);\n      return false;\n    }\n  }\n\n  /**\n   * Libera lock de download distribuído\n   * Retorna true se liberou, false se não era o owner\n   */\n  async releaseDownloadLock(): Promise<boolean> {\n    try {\n      const lockName = \"xml-download-service\";\n      const ownerUuid = this.getLockOwnerUuid();\n      \n      const { data, error } = await supabaseAdmin.rpc('release_download_lock', {\n        p_name: lockName,\n        p_owner: ownerUuid\n      });\n\n      if (error) {\n        console.error(\"[SupabaseStorage] Erro ao liberar lock:\", error.message);\n        return false;\n      }\n\n      const released = !!data;\n      console.log(`[SupabaseStorage] Lock \"${lockName}\" release: ${released ? 'SUCCESS' : 'FAIL (não era o owner)'}`);\n      return released;\n    } catch (error: any) {\n      console.error(\"[SupabaseStorage] Exceção ao liberar lock:\", error.message);\n      return false;\n    }\n  }\n\n  // ========== RATE LIMITING SEFAZ ==========\n\n  /**\n   * Verifica e incrementa rate limit para consultas SEFAZ\n   * Retorna TRUE se pode consultar (dentro do limite de 20/hora)\n   * Retorna FALSE se excedeu o limite\n   * \n   * @param empresaId - ID da empresa\n   * @param tipoOperacao - Tipo de operação SEFAZ ('consultaChave', 'distribuicaoDFe', 'recepcaoEvento')\n   * @param userId - ID do usuário\n   */\n  async checkRateLimit(empresaId: string, tipoOperacao: string, userId: string): Promise<boolean> {\n    try {\n      // Chama função PostgreSQL que incrementa e verifica limite\n      const { data, error } = await supabaseAdmin.rpc('increment_and_check_rate_limit', {\n        p_user_id: userId,\n        p_empresa_id: empresaId,\n        p_tipo_operacao: tipoOperacao,\n        p_limite: 20 // Máximo 20 consultas por hora\n      });\n\n      if (error) {\n        // Se RPC não existe, migration não foi aplicada\n        if (error.message.includes(\"function\") && error.message.includes(\"does not exist\")) {\n          console.error(\"❌ [SupabaseStorage] ERRO CRÍTICO: Migration 'supabase-migration-rate-limit-status.sql' NÃO foi aplicada!\");\n          console.error(\"   → Aplique a migration no Supabase Dashboard antes de usar rate limiting\");\n          console.error(\"   → Rate limiting desabilitado temporariamente (fail-open)\");\n        } else {\n          console.error(\"[SupabaseStorage] Erro ao verificar rate limit:\", error.message);\n        }\n        // Em caso de erro, permite consulta (fail-open) - evita bloquear sistema\n        return true;\n      }\n\n      const podeConsultar = !!data;\n      \n      if (!podeConsultar) {\n        console.warn(`[SupabaseStorage] Rate limit excedido para empresa ${empresaId} - operação ${tipoOperacao}`);\n      }\n\n      return podeConsultar;\n    } catch (error: any) {\n      console.error(\"[SupabaseStorage] Exceção ao verificar rate limit:\", error.message);\n      // Em caso de exceção, permite consulta (fail-open)\n      return true;\n    }\n  }\n\n  /**\n   * Reseta rate limit para uma empresa (DEV ONLY)\n   * Remove todos os registros de controle de rate limit permitindo novas consultas imediatas\n   * \n   * @param empresaId - ID da empresa\n   */\n  async resetRateLimit(empresaId: string): Promise<void> {\n    try {\n      const { error } = await supabaseAdmin\n        .from(\"sefaz_rate_limit\")\n        .delete()\n        .eq(\"empresa_id\", empresaId);\n\n      if (error) {\n        console.error(\"[SupabaseStorage] Erro ao resetar rate limit:\", error.message);\n        throw error;\n      }\n\n      console.log(`[SupabaseStorage] ✅ Rate limit resetado para empresa ${empresaId}`);\n    } catch (error: any) {\n      console.error(\"[SupabaseStorage] Exceção ao resetar rate limit:\", error.message);\n      throw error;\n    }\n  }\n\n  /**\n   * Atualiza status da NFe (cancelada, denegada, etc)\n   * \n   * @param id - ID do XML\n   * @param statusNfe - Novo status ('autorizada', 'cancelada', 'denegada', etc)\n   * @param userId - ID do usuário (opcional, para RLS)\n   */\n  async updateXmlStatus(id: string, statusNfe: string, userId?: string): Promise<Xml | null> {\n    try {\n      const { data, error } = await supabaseAdmin\n        .from(\"xmls\")\n        .update({ \n          status_nfe: statusNfe\n        })\n        .eq(\"id\", id)\n        .select()\n        .single();\n\n      if (error) {\n        console.error(\"[SupabaseStorage] Erro ao atualizar status NFe:\", error.message);\n        return null;\n      }\n\n      return parseXml(data);\n    } catch (error: any) {\n      console.error(\"[SupabaseStorage] Exceção ao atualizar status NFe:\", error.message);\n      return null;\n    }\n  }\n}\n\nexport const supabaseStorage = new SupabaseStorage();\n","size_bytes":36047},"QUICK-START-PORTAINER.md":{"content":"# ⚡ Quick Start - Portainer + Traefik\n\n## 🎯 Checklist Rápido\n\n### ✅ Pré-requisitos\n- [ ] Docker instalado e rodando\n- [ ] Portainer acessível (https://portainer.seudominio.com)\n- [ ] Traefik configurado com Let's Encrypt\n- [ ] Rede `traefik-proxy` existe (verificar: `docker network ls`)\n- [ ] Domínio apontando para o servidor (DNS tipo A)\n- [ ] Projeto Supabase configurado\n\n---\n\n## 🚀 Deploy em 5 Minutos\n\n### 1️⃣ Preparar servidor\n\n```bash\n# Criar diretórios\nmkdir -p /opt/sefaz-xml-sync/{certificados,xmls}\ncd /opt/sefaz-xml-sync\n\n# Clonar código\ngit clone https://github.com/SEU_USUARIO/sefaz-xml-sync.git .\n```\n\n### 2️⃣ Configurar variáveis\n\n```bash\n# Copiar template\ncp .env.portainer .env\n\n# Editar (substitua pelos valores reais)\nnano .env\n```\n\n**Mínimo necessário:**\n```env\nDOMAIN=sefaz.seudominio.com\nCERT_RESOLVER=le\nSUPABASE_URL=https://xxx.supabase.co\nSUPABASE_ANON_KEY=eyJ...\nSUPABASE_SERVICE_ROLE_KEY=eyJ...\nSESSION_SECRET=$(openssl rand -base64 32)\nCERTIFICADOS_PATH=/opt/sefaz-xml-sync/certificados\nXMLS_PATH=/opt/sefaz-xml-sync/xmls\n```\n\n### 3️⃣ Deploy no Portainer\n\n1. **Stacks** → **+ Add stack**\n2. **Name:** `sefaz-xml-sync`\n3. **Build method:** Web editor\n4. Cole conteúdo de: `docker-compose.portainer.yml`\n5. **Environment variables:** Upload `.env`\n6. **Deploy the stack**\n\n### 4️⃣ Verificar\n\n```bash\n# Ver logs\ndocker logs sefaz-xml-sync -f\n\n# Acessar\n# https://sefaz.seudominio.com\n```\n\n---\n\n## 🔧 Verificações Importantes\n\n### Rede do Traefik\n```bash\ndocker network ls | grep traefik\n# Deve mostrar: traefik-proxy (ou o nome que você usa)\n```\n\nSe o nome for diferente, editar em `docker-compose.portainer.yml`:\n```yaml\nnetworks:\n  traefik-proxy:  # <-- Trocar pelo nome correto\n    external: true\n```\n\n### Certificate Resolver\n```bash\ndocker inspect traefik | grep certresolver\n# Anote o nome (ex: 'le', 'letsencrypt', etc)\n```\n\nUse esse nome em `.env`:\n```env\nCERT_RESOLVER=le  # <-- Nome que você encontrou\n```\n\n---\n\n## 📋 Variáveis de Ambiente (Referência)\n\n| Variável | Exemplo | Obrigatório |\n|----------|---------|-------------|\n| `DOMAIN` | `sefaz.example.com` | ✅ Sim |\n| `CERT_RESOLVER` | `le` | ✅ Sim |\n| `SUPABASE_URL` | `https://xxx.supabase.co` | ✅ Sim |\n| `SUPABASE_ANON_KEY` | `eyJhbG...` | ✅ Sim |\n| `SUPABASE_SERVICE_ROLE_KEY` | `eyJhbG...` | ✅ Sim |\n| `SESSION_SECRET` | (gerar novo) | ✅ Sim |\n| `CERTIFICADOS_PATH` | `/opt/sefaz-xml-sync/certificados` | ✅ Sim |\n| `XMLS_PATH` | `/opt/sefaz-xml-sync/xmls` | ✅ Sim |\n| `ALLOW_SEFAZ_SIMULATION` | `false` | ⚠️ Produção: false |\n\n---\n\n## 🎨 Labels do Traefik (Resumo)\n\n```yaml\nlabels:\n  - \"traefik.enable=true\"\n  - \"traefik.http.services.sefaz-xml-sync.loadbalancer.server.port=5000\"\n  - \"traefik.http.routers.sefaz-xml-sync.rule=Host(`sefaz.example.com`)\"\n  - \"traefik.http.routers.sefaz-xml-sync.entrypoints=websecure\"\n  - \"traefik.http.routers.sefaz-xml-sync.tls.certresolver=le\"\n```\n\n**O que fazem:**\n- ✅ Habilita Traefik\n- ✅ Define porta interna (5000)\n- ✅ Roteia domínio → container\n- ✅ Força HTTPS (websecure)\n- ✅ SSL automático (Let's Encrypt)\n\n---\n\n## 🐛 Troubleshooting Rápido\n\n### Container não inicia\n```bash\ndocker logs sefaz-xml-sync\n# Verificar erros de env vars ou conexão Supabase\n```\n\n### SSL não funciona\n```bash\n# 1. DNS OK?\ndig sefaz.seudominio.com\n\n# 2. Traefik vê o container?\ndocker logs traefik | grep sefaz\n\n# 3. Aguarde 1-2 min para emissão do certificado\n```\n\n### Não acessa pelo domínio\n```bash\n# Firewall\nufw allow 80/tcp\nufw allow 443/tcp\n\n# Verificar roteamento\ndocker inspect sefaz-xml-sync | grep -A 20 Labels\n```\n\n---\n\n## 🔄 Comandos Úteis\n\n```bash\n# Ver logs\ndocker logs -f sefaz-xml-sync\n\n# Reiniciar\ndocker restart sefaz-xml-sync\n\n# Status\ndocker ps | grep sefaz\n\n# Recursos\ndocker stats sefaz-xml-sync\n\n# Executar comando no container\ndocker exec -it sefaz-xml-sync sh\n```\n\n---\n\n## 📖 Documentação Completa\n\n- **Passo a passo detalhado:** `DEPLOYMENT-PORTAINER.md`\n- **Troubleshooting completo:** Ver seção no guia acima\n- **Backup automático:** Scripts incluídos no guia\n\n---\n\n## ✅ Deploy Concluído!\n\n**Acesse:** `https://sefaz.seudominio.com`\n\n**Primeira vez:**\n1. Criar conta (Registrar)\n2. Confirmar email (se ativado)\n3. Fazer login\n4. Cadastrar empresas\n5. Upload certificados .pfx\n6. Aguardar sincronização automática (1h) ou iniciar manual\n\n---\n\n**Dúvidas?** Consulte o guia completo: `DEPLOYMENT-PORTAINER.md`\n","size_bytes":4470},"SEFAZ-BLOQUEIO-TEMPORARIO.md":{"content":"# 🔒 Bloqueio Temporário SEFAZ (cStat 656) - Solução Definitiva\n\n## 📋 O que é o erro 656?\n\nO erro **656 - Consumo Indevido** da SEFAZ acontece quando o sistema viola as regras da **Nota Técnica 2014.002 §3.11.4**, especificamente:\n\n### 🚨 Causas (NT 2014.002):\n\n1. **NSU Fora de Sequência** ⚠️ **CAUSA MAIS COMUM**\n   - Enviou `ultNSU` diferente do retornado pela SEFAZ na consulta anterior\n   - Tentou \"resetar\" NSU para zero em CNPJ que já teve consultas anteriores\n   - **Mensagem:** \"Deve ser utilizado o ultNSU nas solicitacoes subsequentes\"\n   - **Solução aplicada**: Sistema usa APENAS valores retornados pela SEFAZ ✅\n\n2. **Consultas Repetidas sem Aguardar 1h**\n   - Recebeu `cStat=137` (sem documentos) e consultou novamente antes de 1 hora\n   - **Mensagem:** \"Deve ser aguardado 1 hora para efetuar nova solicitação\"\n   - **Solução aplicada**: Bloqueio automático de 1h após receber cStat=137 ✅\n\n### ✅ **CORREÇÃO CRÍTICA APLICADA (14/11/2025):**\n\nO sistema tinha um **bug grave** que violava a NT 2014.002:\n- **Antes**: Botão \"Resetar NSU\" colocava `ultNSU=0` em CNPJs com histórico\n- **Resultado**: Erro 656 imediato (NT 2014.002 permite NSU=0 apenas na primeira consulta real)\n- **Agora**: Botão removido, sistema usa APENAS valores retornados pela SEFAZ ✅\n\n## 🎯 Como Usar o Sistema CORRETAMENTE\n\n### ✅ **Empresas Novas (NSU=0):**\n1. Cadastre a empresa com certificado\n2. Clique **\"Sincronizar\"** (▶️ Play)\n3. Sistema busca todos os XMLs disponíveis\n4. NSU atualizado automaticamente\n\n### ✅ **Empresas com NSU Desatualizado:**\n1. Clique **\"Alinhar NSU\"** (🔄 RefreshCw)  \n   - Avança NSU sequencialmente sem baixar XMLs\n   - Rápido para backlogs grandes\n2. Depois clique **\"Sincronizar\"** (▶️ Play)\n   - Baixa XMLs faltantes\n\n### ✅ **Se Receber Erro 656:**\n1. ⏰ **Aguarde 1 hora** (bloqueio automático)\n2. Sistema mostra: \"Bloqueado até [horário do Brasil]\"\n3. Após desbloqueio automático, use **\"Alinhar NSU\"**\n4. Se persistir: **verifique se há outro sistema** consultando\n\n---\n\n## 📊 Entendendo os Botões\n\n| Botão | Ícone | Quando Usar | O que Faz |\n|-------|-------|-------------|-----------|\n| **Alinhar NSU** | 🔄 | NSU desatualizado | Avança NSU sem baixar XMLs (rápido) |\n| **Sincronizar** | ▶️ | Buscar XMLs novos | Baixa XMLs e atualiza NSU |\n| **Excluir** | 🗑️ | Remover empresa | Deleta empresa e XMLs |\n\n**Nota:** \"Alinhar NSU\" só aparece para empresas que já sincronizaram (NSU ≠ 0)\n\n## Logs de diagnóstico\n\nAgora o sistema mostra logs detalhados na interface de logs:\n\n**Sincronização:**\n```\nMensagem: Sincronização - Consultando SEFAZ\nDetalhes: {\"iteracao\":1,\"ultNSUEnviado\":\"000000000000000\"}\n\nMensagem: Sincronização - Resposta SEFAZ\nDetalhes: {\"iteracao\":1,\"cStat\":\"656\",\"xMotivo\":\"Rejeição: Consumo Indevido...\",\"ultNSURetornado\":\"\",\"maxNSURetornado\":\"\"}\n```\n\n**Reconciliação:**\n```\nMensagem: Reconciliação - Consultando SEFAZ\nDetalhes: {\"iteracao\":1,\"ultNSUEnviado\":\"77517\"}\n\nMensagem: Reconciliação - Resposta SEFAZ\nDetalhes: {\"iteracao\":1,\"cStat\":\"137\",\"xMotivo\":\"Nenhum documento localizado\",\"ultNSURetornado\":\"77517\",\"maxNSURetornado\":\"80761\"}\n```\n\n**Em caso de erro de rede/certificado:**\n```\nMensagem: Erro ao chamar SEFAZ: [erro]\nDetalhes: {\"iteracao\":1,\"ultNSUEnviado\":\"000000000000000\",\"error\":\"...\",\"stack\":\"...\"}\n```\n\n## Referências\n\n- [NT 2014.002 - Portal Nacional NF-e](https://www.nfe.fazenda.gov.br/portal/exibirArquivo.aspx?conteudo=wLVBlKchUb4%3D)\n- [Tecnospeed: Regras de sincronização](https://atendimento.tecnospeed.com.br/hc/pt-br/articles/10794811536791)\n- [NetCPA: Atualização das regras de uso indevido](https://netcpa.com.br/colunas/nf-e-04032022-atualizacao-das-regras-de-uso-indevido-do-web-service-nfedistribuicaodfe-nt-2014002/13214)\n\n## Status atual do sistema\n\n✅ **Correções implementadas:**\n- ✨ **Bloqueio automático de 61 minutos após erro 656** (evita loop infinito)\n- ✨ **Bloqueio automático de 60 minutos após cStat=137** (conforme NT 2014.002 §3.11.4)\n- ✨ **Verificação de bloqueio antes de sincronizar** (manual e automático)\n- ✨ **Desbloqueio automático** após sincronização bem-sucedida\n- ✨ **Loop para imediatamente** ao receber cStat=137 (não faz mais consultas)\n- ✨ **Funcionalidade \"Resetar NSU\" removida** (causava erro 656)\n- Validação que bloqueia reconciliação de empresas com NSU=0\n- Frontend oculta botão \"Alinhar NSU\" para empresas novas\n- Uso correto de `<distNSU><ultNSU>` conforme NT 2014.002\n- Conversão de ultNSU/maxNSU para string (fix TypeError)\n- Logs detalhados mostrando NSU enviado e resposta SEFAZ\n- Mensagem clara explicando bloqueio temporário\n\n✅ **Proteções ativas:**\n- ⏱️ **Bloqueio persistente**: Armazenado em `empresas.bloqueadoAte`\n- 🔒 **Bloqueio respeitado**: Cron e endpoints manuais verificam bloqueio\n- 🛑 **cStat=137 para o loop**: Sistema NÃO faz mais consultas após receber 137\n- Safety guards: 100 iterações (reconciliação), 200 iterações (sincronização)\n- Delay entre consultas: 300-500ms\n- Alinhamento completo garantido (ultNSU === maxNSU)\n- Apenas valores da SEFAZ são usados (nunca valores arbitrários)\n","size_bytes":5194},"INSTRUCOES-MIGRACAO-TIMEZONE.md":{"content":"# Instruções para Migração de Timezone\n\n## ⚠️ ATENÇÃO - LEIA ANTES DE EXECUTAR\n\nEsta migração converte todas as colunas `timestamp` para `timestamptz` (timestamp with timezone) preservando os valores existentes como UTC.\n\n## Pré-requisitos\n\n1. **BACKUP DO BANCO** - Faça backup completo antes de executar\n2. **Teste em staging** - Execute primeiro em ambiente de desenvolvimento/staging\n3. **Validação** - Verifique timestamps após migração\n\n## Por que esta migração é necessária?\n\nO problema atual:\n- Banco está usando `TIMESTAMP` (sem timezone)\n- Valores são armazenados literalmente, causando confusão de fusos horários\n- Usuário reportou timestamps com +3h de diferença\n\nA solução:\n- Usar `TIMESTAMPTZ` (timestamp with timezone)\n- Armazenar tudo em UTC internamente\n- Converter para America/Sao_Paulo apenas na exibição\n\n## Como executar a migração\n\n### Opção 1: Supabase SQL Editor (Recomendado)\n\n1. Acesse: https://supabase.com/dashboard\n2. Vá em: **SQL Editor**\n3. Copie e cole o conteúdo de `scripts/migrate-to-timestamptz.sql`\n4. Clique em **Run**\n5. Aguarde conclusão (pode levar alguns segundos)\n\n### Opção 2: psql (se tiver acesso direto)\n\n```bash\npsql -h [HOST] -U [USER] -d [DATABASE] -f scripts/migrate-to-timestamptz.sql\n```\n\n## Validação pós-migração\n\nExecute no SQL Editor para verificar:\n\n```sql\n-- Verificar tipos das colunas\nSELECT \n  id, \n  cnpj,\n  razao_social,\n  bloqueado_ate,\n  created_at,\n  pg_typeof(bloqueado_ate) as tipo_bloqueado,\n  pg_typeof(created_at) as tipo_created\nFROM empresas \nLIMIT 3;\n```\n\n**Resultado esperado:**\n- `tipo_bloqueado`: `timestamp with time zone`\n- `tipo_created`: `timestamp with time zone`\n\n```sql\n-- Verificar que valores não mudaram (comparar com backup)\nSELECT \n  id,\n  bloqueado_ate,\n  bloqueado_ate AT TIME ZONE 'America/Sao_Paulo' as horario_brasil\nFROM empresas\nWHERE bloqueado_ate IS NOT NULL\nLIMIT 3;\n```\n\n**O que observar:**\n- `bloqueado_ate` deve estar em UTC (mesmo valor de antes)\n- `horario_brasil` deve mostrar -3h (UTC-3)\n\n## O que mudou no código?\n\n### 1. Schema (`shared/schema.ts`)\nTodas as colunas timestamp agora usam:\n```typescript\ntimestamp(\"coluna\", { withTimezone: true, mode: 'date' })\n```\n\n### 2. Utilitários de timezone (`server/utils/timezone.ts`)\nFunções para formatar datas em horário do Brasil:\n- `formatarDataBrasil(date)` - Formato curto\n- `formatarDataBrasilCompleta(date)` - Formato longo\n- `formatarHoraBrasil(date)` - Apenas hora\n- `calcularMinutosRestantes(date)` - Para bloqueios\n- `estaBloqueado(date)` - Verifica se ainda bloqueado\n- `criarBloqueio(minutos)` - Cria timestamp de bloqueio\n\n### 3. Lógica de negócio\n- Backend: Trabalha sempre em UTC (Date objects)\n- Exibição: Usa utilitários para formatar em America/Sao_Paulo\n- Cálculos: Sempre em UTC (evita problemas com horário de verão)\n\n## Rollback (se necessário)\n\nSe algo der errado, restore o backup:\n\n```sql\n-- No Supabase, use a feature de \"Point in Time Recovery\" (PITR)\n-- Ou restaure do backup SQL manualmente\n```\n\n## Próximos passos após migração\n\n1. ✅ Verificar que tipos estão corretos (`timestamptz`)\n2. ✅ Validar que valores não mudaram\n3. ✅ Reiniciar aplicação\n4. ✅ Testar bloqueio automático\n5. ✅ Verificar exibição de datas na interface\n\n## Referências\n\n- [PostgreSQL Timezone Documentation](https://www.postgresql.org/docs/current/datatype-datetime.html)\n- [Best Practices for Timezone Storage](https://wiki.postgresql.org/wiki/Don%27t_Do_This#Don.27t_use_timestamp_.28without_time_zone.29)\n","size_bytes":3546},"server/utils/timezone.ts":{"content":"/**\n * Utilitários para trabalhar com timezone do Brasil\n * \n * IMPORTANTE: O banco armazena TUDO em UTC (timestamptz)\n * Este módulo fornece helpers para exibir em horário do Brasil (America/Sao_Paulo)\n */\n\n/**\n * Formata uma data UTC para exibição em horário do Brasil\n * @param date - Data em UTC (instância de Date)\n * @returns String formatada em horário do Brasil (ex: \"14/11/2025, 18:30:00\")\n */\nexport function formatarDataBrasil(date: Date | string | null | undefined): string {\n  if (!date) return 'N/A';\n  \n  const d = typeof date === 'string' ? new Date(date) : date;\n  \n  return d.toLocaleString('pt-BR', {\n    timeZone: 'America/Sao_Paulo',\n    dateStyle: 'short',\n    timeStyle: 'medium',\n  });\n}\n\n/**\n * Formata uma data UTC para exibição COMPLETA em horário do Brasil\n * @param date - Data em UTC (instância de Date)\n * @returns String formatada (ex: \"14 de novembro de 2025, 18:30:00\")\n */\nexport function formatarDataBrasilCompleta(date: Date | string | null | undefined): string {\n  if (!date) return 'N/A';\n  \n  const d = typeof date === 'string' ? new Date(date) : date;\n  \n  return d.toLocaleString('pt-BR', {\n    timeZone: 'America/Sao_Paulo',\n    dateStyle: 'long',\n    timeStyle: 'medium',\n  });\n}\n\n/**\n * Formata uma data UTC para exibição apenas da HORA em horário do Brasil\n * @param date - Data em UTC (instância de Date)\n * @returns String formatada (ex: \"18:30:00\")\n */\nexport function formatarHoraBrasil(date: Date | string | null | undefined): string {\n  if (!date) return 'N/A';\n  \n  const d = typeof date === 'string' ? new Date(date) : date;\n  \n  return d.toLocaleString('pt-BR', {\n    timeZone: 'America/Sao_Paulo',\n    timeStyle: 'medium',\n  });\n}\n\n/**\n * Calcula diferença em minutos entre agora (UTC) e uma data futura (UTC)\n * Útil para calcular \"tempo restante\" em bloqueios\n * \n * @param futureDate - Data futura em UTC\n * @returns Minutos restantes (arredondado para cima), ou 0 se já passou\n */\nexport function calcularMinutosRestantes(futureDate: Date | string | null | undefined): number {\n  if (!futureDate) return 0;\n  \n  const future = typeof futureDate === 'string' ? new Date(futureDate) : futureDate;\n  const now = new Date();\n  \n  const diffMs = future.getTime() - now.getTime();\n  if (diffMs <= 0) return 0;\n  \n  return Math.ceil(diffMs / 1000 / 60);\n}\n\n/**\n * Verifica se uma data bloqueio ainda está ativa\n * @param bloqueadoAte - Data limite do bloqueio (UTC)\n * @returns true se ainda bloqueado, false se já desbloqueado\n */\nexport function estaBloqueado(bloqueadoAte: Date | string | null | undefined): boolean {\n  if (!bloqueadoAte) return false;\n  \n  const limite = typeof bloqueadoAte === 'string' ? new Date(bloqueadoAte) : bloqueadoAte;\n  return new Date() < limite;\n}\n\n/**\n * Cria um timestamp UTC para bloqueio (agora + minutos)\n * @param minutos - Quantos minutos para frente (ex: 61 para bloqueio SEFAZ)\n * @returns Date em UTC\n */\nexport function criarBloqueio(minutos: number): Date {\n  return new Date(Date.now() + minutos * 60 * 1000);\n}\n","size_bytes":3033},"PROXIMOS-PASSOS-TIMEZONE.md":{"content":"# ✅ Correção de Timezone - Próximos Passos\n\n## Mudanças Implementadas\n\n### 1. ✅ Schema Atualizado (`shared/schema.ts`)\nTodas as colunas timestamp agora usam `{ withTimezone: true, mode: 'date' }`:\n- ✅ `profiles`: created_at, updated_at\n- ✅ `empresas`: bloqueado_ate, created_at, updated_at\n- ✅ `sincronizacoes`: data_inicio, data_fim, created_at\n- ✅ `xmls`: data_emissao, created_at\n- ✅ `logs`: timestamp\n\n### 2. ✅ Utilitários de Timezone (`server/utils/timezone.ts`)\nFunções criadas para trabalhar com horário do Brasil:\n- `formatarDataBrasil(date)` - Formato curto (14/11/2025, 18:30:00)\n- `formatarDataBrasilCompleta(date)` - Formato longo (14 de novembro de 2025, 18:30:00)\n- `formatarHoraBrasil(date)` - Apenas hora (18:30:00)\n- `calcularMinutosRestantes(date)` - Para calcular tempo de bloqueio\n- `estaBloqueado(date)` - Verifica se bloqueio ainda está ativo\n- `criarBloqueio(minutos)` - Cria timestamp UTC de bloqueio\n\n### 3. ✅ Código Atualizado (`server/sefaz-service.ts`)\n- Importa utilitários de timezone\n- Usa `criarBloqueio(61)` para gerar timestamps de bloqueio em UTC\n- Usa `formatarDataBrasilCompleta()` para exibir datas em logs e mensagens\n- Usa `estaBloqueado()` para verificar bloqueios\n- Usa `calcularMinutosRestantes()` para calcular tempo restante\n\n### 4. ✅ SQL de Migração Criado (`scripts/migrate-to-timestamptz.sql`)\n- Converte todas as colunas `TIMESTAMP` para `TIMESTAMPTZ`\n- Usa `AT TIME ZONE 'UTC'` para preservar valores existentes\n- Adiciona comentários documentando que valores são armazenados em UTC\n- **SEGURO**: Não corrompe dados existentes\n\n## 🚨 AÇÃO NECESSÁRIA: Executar Migração SQL\n\n**Você precisa executar a migração SQL no Supabase para que as mudanças funcionem!**\n\n### Passo a Passo:\n\n1. **Acesse o Supabase Dashboard**: https://supabase.com/dashboard\n2. **Vá em SQL Editor**\n3. **Abra o arquivo**: `scripts/migrate-to-timestamptz.sql`\n4. **Copie TODO o conteúdo** do arquivo\n5. **Cole no SQL Editor** do Supabase\n6. **Clique em \"Run\"**\n7. **Aguarde a execução** (pode levar alguns segundos)\n\n### ✅ Validação Pós-Migração\n\nApós executar a migração, execute no SQL Editor para verificar:\n\n```sql\n-- Verificar tipos das colunas\nSELECT \n  id, \n  cnpj,\n  bloqueado_ate,\n  created_at,\n  pg_typeof(bloqueado_ate) as tipo_bloqueado,\n  pg_typeof(created_at) as tipo_created\nFROM empresas \nLIMIT 3;\n```\n\n**Resultado esperado:**\n- `tipo_bloqueado`: `timestamp with time zone`\n- `tipo_created`: `timestamp with time zone`\n\n## Como o Sistema Funciona Agora\n\n### Backend (Lógica Interna)\n- ✅ Tudo é armazenado em **UTC** no banco\n- ✅ Cálculos (bloqueios, durações) em UTC\n- ✅ `Date` objects sempre em UTC\n\n### Exibição (Logs, Mensagens, UI)\n- ✅ Datas formatadas em **horário do Brasil** (America/Sao_Paulo)\n- ✅ Usa utilitários `formatarDataBrasil*()` automaticamente\n- ✅ Usuário sempre vê horário local do Brasil\n\n### Exemplo Prático\n\n**Cenário**: Bloqueio SEFAZ às 21:00 UTC\n\n**Backend** (armazena):\n```typescript\nconst bloqueadoAte = criarBloqueio(61); // 2025-11-14T22:01:00.000Z (UTC)\n```\n\n**Log/Mensagem** (exibe):\n```typescript\nformatarDataBrasilCompleta(bloqueadoAte); // \"14 de novembro de 2025, 19:01:00\" (UTC-3)\n```\n\n**Usuário vê**: \"19:01:00\" (horário do Brasil)  \n**Banco armazena**: \"22:01:00Z\" (UTC)\n\n## Benefícios\n\n✅ **Consistência**: Tudo em UTC internamente  \n✅ **Horário de Verão**: Não afeta cálculos (UTC não tem DST)  \n✅ **Multi-tenant**: Funciona para usuários em qualquer timezone  \n✅ **Exibição Local**: Usuário sempre vê horário do Brasil  \n✅ **Zero Bugs**: Conversões automáticas e centralizadas  \n\n## Próximos Passos\n\n1. ✅ Execute a migração SQL no Supabase\n2. ✅ Valide que tipos estão corretos (`timestamptz`)\n3. ✅ Reinicie a aplicação (já foi reiniciada automaticamente)\n4. ✅ Teste o sistema de bloqueio\n5. ✅ Verifique logs e mensagens exibem horário correto\n\n## Arquivos Importantes\n\n- 📄 `scripts/migrate-to-timestamptz.sql` - SQL de migração\n- 📄 `INSTRUCOES-MIGRACAO-TIMEZONE.md` - Instruções detalhadas\n- 📄 `server/utils/timezone.ts` - Utilitários de timezone\n- 📄 `shared/schema.ts` - Schema atualizado com timestamptz\n- 📄 `server/sefaz-service.ts` - Código atualizado usando utilitários\n\n## ⚠️ IMPORTANTE\n\n- ⚠️ A migração SQL é **SEGURA** e não corrompe dados\n- ⚠️ Valores existentes são preservados como UTC\n- ⚠️ Execute em um ambiente de teste primeiro (se possível)\n- ⚠️ Faça backup do banco antes (boa prática)\n\n---\n\n**Status Atual**: ✅ Código pronto | ⏳ Aguardando migração SQL no Supabase\n\nAssim que executar a migração SQL, o problema de timezone estará 100% resolvido!\n","size_bytes":4736},"server/config/index.ts":{"content":"/**\n * Configuração Centralizada do Sistema\n * Conforme especificação MOC 7.0 e NT 2014.002\n * \n * IMPORTANTE: Todas as variáveis sensíveis (senhas, certificados) devem estar em variáveis de ambiente\n */\n\nexport interface AppConfig {\n  // Ambiente de execução\n  nodeEnv: string;\n  port: number;\n  \n  // Modelos de documento suportados (MOC 7.0 §2.2)\n  modelos: {\n    nfe: string;    // Modelo 55\n    nfce: string;   // Modelo 65\n  };\n  \n  // Endpoints SEFAZ NFeDistribuicaoDFe (NT 2014.002)\n  sefaz: {\n    endpoints: {\n      producao: string;\n      homologacao: string;\n    };\n    versao: string; // Versão do schema distDFeInt\n  };\n  \n  // Schemas XML suportados (NT 2014.002 §3.3)\n  schemas: {\n    nfeProc: string;      // XML completo de NF-e/NFC-e\n    resNFe: string;       // Resumo de NF-e/NFC-e\n    procEventoNFe: string; // Eventos (cancelamento, CCe, manifestação)\n    resEvento: string;    // Resumo de eventos\n  };\n  \n  // Armazenamento\n  storage: {\n    xmlPath: string;      // Diretório raiz para XMLs\n    logPath: string;      // Diretório para logs em arquivo\n    maxLogFiles: number;  // Quantidade máxima de arquivos de log\n  };\n  \n  // Sincronização automática\n  sync: {\n    cronExpression: string; // Expressão cron (padrão: a cada hora)\n    maxIterations: number;  // Limite de segurança para loops\n    delayBetweenRequests: number; // Delay entre requests (ms)\n    bloqueioMinutos: number; // Minutos de bloqueio após erro 656/137\n  };\n  \n  // Supabase\n  supabase: {\n    url: string;\n    anonKey: string;\n    serviceRoleKey: string;\n  };\n}\n\n/**\n * Carrega configuração a partir de variáveis de ambiente\n */\nexport function loadConfig(): AppConfig {\n  // Validação de variáveis obrigatórias\n  const required = ['SUPABASE_URL', 'SUPABASE_ANON_KEY', 'SUPABASE_SERVICE_ROLE_KEY'];\n  const missing = required.filter(key => !process.env[key]);\n  \n  if (missing.length > 0) {\n    throw new Error(`Variáveis de ambiente obrigatórias faltando: ${missing.join(', ')}`);\n  }\n  \n  return {\n    // Ambiente\n    nodeEnv: process.env.NODE_ENV || 'development',\n    port: parseInt(process.env.PORT || '5000', 10),\n    \n    // Modelos suportados (MOC 7.0 §2.2)\n    modelos: {\n      nfe: '55',   // NF-e\n      nfce: '65',  // NFC-e\n    },\n    \n    // Endpoints SEFAZ (NT 2014.002)\n    sefaz: {\n      endpoints: {\n        producao: 'https://www1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx',\n        homologacao: 'https://hom1.nfe.fazenda.gov.br/NFeDistribuicaoDFe/NFeDistribuicaoDFe.asmx',\n      },\n      versao: '1.01', // Versão do schema distDFeInt\n    },\n    \n    // Schemas XML (NT 2014.002 §3.3)\n    schemas: {\n      nfeProc: 'http://www.portalfiscal.inf.br/nfe/nfeProc',\n      resNFe: 'http://www.portalfiscal.inf.br/nfe/resNFe',\n      procEventoNFe: 'http://www.portalfiscal.inf.br/nfe/procEventoNFe',\n      resEvento: 'http://www.portalfiscal.inf.br/nfe/resEvento',\n    },\n    \n    // Armazenamento\n    storage: {\n      xmlPath: process.env.XML_DEST_PATH || './xmls',\n      logPath: process.env.LOG_PATH || './logs',\n      maxLogFiles: parseInt(process.env.MAX_LOG_FILES || '30', 10), // 30 dias\n    },\n    \n    // Sincronização\n    sync: {\n      cronExpression: process.env.SYNC_CRON || '0 * * * *', // Padrão: a cada hora (minuto 0)\n      maxIterations: parseInt(process.env.MAX_ITERATIONS || '200', 10),\n      delayBetweenRequests: parseInt(process.env.DELAY_MS || '300', 10),\n      bloqueioMinutos: parseInt(process.env.BLOQUEIO_MINUTOS || '65', 10), // Margem de segurança conforme NT\n    },\n    \n    // Supabase\n    supabase: {\n      url: process.env.SUPABASE_URL!,\n      anonKey: process.env.SUPABASE_ANON_KEY!,\n      serviceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    },\n  };\n}\n\n// Singleton: carrega configuração uma única vez\nexport const config = loadConfig();\n\n/**\n * Tipos de Evento (MOC 7.0 e NT 2014.002)\n */\nexport const TIPOS_EVENTO = {\n  CARTA_CORRECAO: '110110',\n  CANCELAMENTO: '110111',\n  CONFIRMACAO_OPERACAO: '210200',\n  CIENCIA_OPERACAO: '210210',\n  DESCONHECIMENTO_OPERACAO: '210220',\n  OPERACAO_NAO_REALIZADA: '210240',\n} as const;\n\n/**\n * Descrições dos tipos de evento\n */\nexport const DESCRICOES_EVENTO: Record<string, string> = {\n  [TIPOS_EVENTO.CARTA_CORRECAO]: 'Carta de Correção',\n  [TIPOS_EVENTO.CANCELAMENTO]: 'Cancelamento',\n  [TIPOS_EVENTO.CONFIRMACAO_OPERACAO]: 'Confirmação da Operação',\n  [TIPOS_EVENTO.CIENCIA_OPERACAO]: 'Ciência da Operação',\n  [TIPOS_EVENTO.DESCONHECIMENTO_OPERACAO]: 'Desconhecimento da Operação',\n  [TIPOS_EVENTO.OPERACAO_NAO_REALIZADA]: 'Operação não Realizada',\n};\n\n/**\n * Códigos de Status SEFAZ (NT 2014.002)\n */\nexport const STATUS_SEFAZ = {\n  SUCESSO: '138',                    // Documentos encontrados\n  SEM_DOCUMENTOS: '137',             // Nenhum documento localizado\n  CONSUMO_INDEVIDO: '656',           // Rejeição: Consumo indevido\n} as const;\n","size_bytes":4920},"server/logger.ts":{"content":"/**\n * Sistema de Logs com suporte a arquivo e console\n * Conforme especificação do sistema (logs/app.log)\n */\n\nimport fs from \"fs/promises\";\nimport fsSync from \"fs\";\nimport path from \"path\";\nimport { config } from \"./config\";\n\nexport type LogLevel = \"info\" | \"warning\" | \"error\" | \"debug\";\n\nexport interface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  message: string;\n  details?: any;\n  userId?: string;\n  empresaId?: string;\n  sincronizacaoId?: string;\n}\n\nclass Logger {\n  private logPath: string;\n  private maxLogFiles: number;\n  private currentLogFile: string | null = null;\n\n  constructor() {\n    this.logPath = config.storage.logPath;\n    this.maxLogFiles = config.storage.maxLogFiles;\n    this.initializeLogDirectory();\n  }\n\n  /**\n   * Inicializa diretório de logs\n   */\n  private initializeLogDirectory(): void {\n    try {\n      if (!fsSync.existsSync(this.logPath)) {\n        fsSync.mkdirSync(this.logPath, { recursive: true });\n      }\n      this.currentLogFile = this.getCurrentLogFile();\n    } catch (error) {\n      console.error(\"Erro ao inicializar diretório de logs:\", error);\n    }\n  }\n\n  /**\n   * Retorna nome do arquivo de log do dia atual\n   */\n  private getCurrentLogFile(): string {\n    const now = new Date();\n    const year = now.getFullYear();\n    const month = String(now.getMonth() + 1).padStart(2, \"0\");\n    const day = String(now.getDate()).padStart(2, \"0\");\n    return path.join(this.logPath, `app-${year}-${month}-${day}.log`);\n  }\n\n  /**\n   * Formata entrada de log para arquivo\n   */\n  private formatLogEntry(entry: LogEntry): string {\n    const parts = [\n      `[${entry.timestamp}]`,\n      `[${entry.level.toUpperCase()}]`,\n      entry.message,\n    ];\n\n    if (entry.userId) {\n      parts.push(`userId=${entry.userId}`);\n    }\n\n    if (entry.empresaId) {\n      parts.push(`empresaId=${entry.empresaId}`);\n    }\n\n    if (entry.sincronizacaoId) {\n      parts.push(`sincronizacaoId=${entry.sincronizacaoId}`);\n    }\n\n    if (entry.details) {\n      parts.push(`details=${JSON.stringify(entry.details)}`);\n    }\n\n    return parts.join(\" \");\n  }\n\n  /**\n   * Escreve log no arquivo\n   */\n  private async writeToFile(entry: LogEntry): Promise<void> {\n    try {\n      const logFile = this.getCurrentLogFile();\n      \n      // Se mudou o dia, atualiza arquivo atual\n      if (logFile !== this.currentLogFile) {\n        this.currentLogFile = logFile;\n        await this.rotateLogFiles();\n      }\n\n      const line = this.formatLogEntry(entry) + \"\\n\";\n      await fs.appendFile(logFile, line, \"utf-8\");\n    } catch (error) {\n      console.error(\"Erro ao escrever log em arquivo:\", error);\n    }\n  }\n\n  /**\n   * Rotação de logs: mantém apenas os últimos N arquivos\n   */\n  private async rotateLogFiles(): Promise<void> {\n    try {\n      const files = await fs.readdir(this.logPath);\n      const logFiles = files\n        .filter((f) => f.startsWith(\"app-\") && f.endsWith(\".log\"))\n        .sort()\n        .reverse(); // Mais recentes primeiro\n\n      // Remove arquivos antigos\n      if (logFiles.length > this.maxLogFiles) {\n        const toDelete = logFiles.slice(this.maxLogFiles);\n        for (const file of toDelete) {\n          await fs.unlink(path.join(this.logPath, file));\n        }\n      }\n    } catch (error) {\n      console.error(\"Erro na rotação de logs:\", error);\n    }\n  }\n\n  /**\n   * Loga mensagem (console + arquivo)\n   */\n  async log(\n    level: LogLevel,\n    message: string,\n    details?: any,\n    metadata?: {\n      userId?: string;\n      empresaId?: string;\n      sincronizacaoId?: string;\n    }\n  ): Promise<void> {\n    const entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level,\n      message,\n      details,\n      ...metadata,\n    };\n\n    // Console (colorido)\n    const colors = {\n      info: \"\\x1b[36m\",    // Cyan\n      warning: \"\\x1b[33m\", // Yellow\n      error: \"\\x1b[31m\",   // Red\n      debug: \"\\x1b[90m\",   // Gray\n    };\n    const reset = \"\\x1b[0m\";\n    \n    const consoleMsg = `${colors[level]}[${level.toUpperCase()}]${reset} ${message}`;\n    \n    if (level === \"error\") {\n      console.error(consoleMsg, details ? details : \"\");\n    } else if (level === \"warning\") {\n      console.warn(consoleMsg, details ? details : \"\");\n    } else if (level === \"debug\" && config.nodeEnv === \"development\") {\n      console.debug(consoleMsg, details ? details : \"\");\n    } else {\n      console.log(consoleMsg, details ? details : \"\");\n    }\n\n    // Arquivo (sempre)\n    await this.writeToFile(entry);\n  }\n\n  /**\n   * Atalhos para níveis comuns\n   */\n  info(message: string, details?: any, metadata?: any): Promise<void> {\n    return this.log(\"info\", message, details, metadata);\n  }\n\n  warning(message: string, details?: any, metadata?: any): Promise<void> {\n    return this.log(\"warning\", message, details, metadata);\n  }\n\n  error(message: string, details?: any, metadata?: any): Promise<void> {\n    return this.log(\"error\", message, details, metadata);\n  }\n\n  debug(message: string, details?: any, metadata?: any): Promise<void> {\n    return this.log(\"debug\", message, details, metadata);\n  }\n\n  /**\n   * Retorna logs recentes do arquivo atual\n   */\n  async getRecentLogs(lines: number = 100): Promise<string[]> {\n    try {\n      const logFile = this.getCurrentLogFile();\n      \n      if (!fsSync.existsSync(logFile)) {\n        return [];\n      }\n\n      const content = await fs.readFile(logFile, \"utf-8\");\n      const allLines = content.split(\"\\n\").filter((line) => line.trim());\n      \n      return allLines.slice(-lines);\n    } catch (error) {\n      console.error(\"Erro ao ler logs recentes:\", error);\n      return [];\n    }\n  }\n}\n\n// Singleton\nexport const logger = new Logger();\n","size_bytes":5669},"CHANGELOG_MOC_NT.md":{"content":"# 📝 CHANGELOG: Conformidade com MOC 7.0 e NT 2014.002\n\n**Data:** 15 de novembro de 2025  \n**Objetivo:** Adequar sistema de download automático ao MOC 7.0 e NT 2014.002\n\n---\n\n## ✅ **MUDANÇAS IMPLEMENTADAS**\n\n### **1. Suporte para NFC-e (Modelo 65)** 🆕\n\n**Antes:**\n- Sistema processava apenas NF-e (modelo 55)\n- Pasta única: `xmls/CNPJ/ANO/MES/`\n\n**Depois:**\n- Suporte completo para NF-e (55) E NFC-e (65)\n- Detecção automática via campo `ide.mod`\n- Pastas separadas:\n  - `xmls/NFe/CNPJ/ANO/MES/`\n  - `xmls/NFCe/CNPJ/ANO/MES/`\n\n**Conformidade:** MOC 7.0 §2.2\n\n---\n\n### **2. Processamento de TODOS os Schemas XML** 🆕\n\n**Antes:**\n- Processava apenas `nfeProc` (XML completo)\n- Descartava resumos e eventos\n\n**Depois:**\n- ✅ **nfeProc**: XML completo de NF-e/NFC-e\n- ✅ **resNFe**: Resumo (quando não tem direito ao XML completo)\n- ✅ **procEventoNFe**: Eventos (cancelamento, CCe, manifestação)\n- ✅ **resEvento**: Resumo de eventos\n\n**Estrutura de Pastas:**\n```\nxmls/\n└── NFe/ (ou NFCe/)\n    └── CNPJ/\n        └── ANO/\n            └── MES/\n                ├── 12345.xml                        # nfeProc\n                ├── Resumos/\n                │   └── 35XXX_nsuYYY.xml            # resNFe\n                └── Eventos/\n                    ├── 35XXX_110111_seq1_nsuZZZ.xml # procEventoNFe\n                    └── Resumos/\n                        └── 35XXX_110111_nsuAAA.xml  # resEvento\n```\n\n**Conformidade:** NT 2014.002 §3.3\n\n---\n\n### **3. Schema do Banco de Dados Atualizado** 🔄\n\n**Campos Adicionados na Tabela `xmls`:**\n\n| Campo | Tipo | Descrição |\n|-------|------|-----------|\n| `modelo` | TEXT | \"55\" (NF-e) ou \"65\" (NFC-e) |\n| `tipo_documento` | TEXT | \"nfeProc\", \"resNFe\", \"procEventoNFe\", \"resEvento\" |\n\n**Migração:** `migrations/add_modelo_tipodocumento.sql`\n\n**Índices Criados:**\n- `idx_xmls_modelo`\n- `idx_xmls_tipo_documento`\n\n---\n\n### **4. Configuração Centralizada** 🆕\n\n**Novo Arquivo:** `server/config/index.ts`\n\n**Benefícios:**\n- Todas as configurações em um único lugar\n- Validação de variáveis de ambiente obrigatórias\n- Constantes documentadas com referências à NT 2014.002\n- Suporte para customização via `.env`\n\n**Configurações:**\n- Modelos suportados (55, 65)\n- Endpoints SEFAZ (prod/hom)\n- Schemas XML\n- Cron job (sincronização automática)\n- Limites de segurança (iterações, delay)\n- Bloqueio após erros 656/137\n\n---\n\n### **5. Sistema de Logs em Arquivo** 🆕\n\n**Novo Arquivo:** `server/logger.ts`\n\n**Recursos:**\n- **Console**: Logs coloridos em tempo real\n- **Arquivo**: `logs/app-YYYY-MM-DD.log`\n- **Rotação Automática**: Mantém últimos 30 dias\n- **Níveis**: info, warning, error, debug\n- **Metadata**: userId, empresaId, sincronizacaoId\n\n**Formato de Log:**\n```\n[2025-11-15T12:00:00.000Z] [INFO] Sincronização iniciada userId=abc empresaId=def details={...}\n```\n\n---\n\n### **6. README Completo** 📚\n\n**Novo README.md com:**\n- Instruções de instalação passo-a-passo\n- Configuração de variáveis de ambiente\n- Documentação dos 3 modos de execução:\n  1. Interface web\n  2. HTTP endpoint\n  3. Agendamento automático\n- Troubleshooting\n- Referências oficiais (MOC 7.0, NT 2014.002)\n- Estrutura de pastas dos XMLs\n- Tipos de eventos suportados\n\n---\n\n### **7. Correções e Melhorias** 🔧\n\n**Roteamento de Schemas:**\n- Corrigido: Agora compara schemas case-insensitive\n- SEFAZ retorna schemas sem namespace (ex: \"resNFe\", não \"http://...resNFe\")\n- Roteamento robusto com fallback para schemas desconhecidos\n\n**Detecção de Modelo:**\n- Extrai `ide.mod` do XML para determinar 55 ou 65\n- Fallback para modelo 55 se não encontrado\n- Logs claros identificando NF-e vs NFC-e\n\n**Eventos:**\n- Mapeamento completo de tipos de evento:\n  - 110110: Carta de Correção\n  - 110111: Cancelamento\n  - 210200: Confirmação da Operação\n  - 210210: Ciência da Operação\n  - 210220: Desconhecimento da Operação\n  - 210240: Operação não Realizada\n\n---\n\n## 🚀 **PRÓXIMOS PASSOS**\n\n### **Para o Usuário:**\n\n1. **Executar Migração SQL:**\n   ```sql\n   -- Copiar e executar no Supabase Dashboard → SQL Editor\n   cat migrations/add_modelo_tipodocumento.sql\n   ```\n\n2. **Reiniciar Aplicação:**\n   ```bash\n   npm run dev\n   # ou em produção\n   docker compose restart\n   ```\n\n3. **Testar Processamento:**\n   - Cadastrar empresa com CNPJ que tenha NFC-e\n   - Executar sincronização manual\n   - Verificar pastas `xmls/NFe/` e `xmls/NFCe/`\n   - Conferir logs em `logs/app-YYYY-MM-DD.log`\n\n4. **Validar Schemas:**\n   - Confirmar que resumos estão sendo salvos em `Resumos/`\n   - Confirmar que eventos estão sendo salvos em `Eventos/`\n   - Verificar campo `modelo` e `tipo_documento` no banco\n\n---\n\n## 📊 **CONFORMIDADE**\n\n| Norma | Item | Status |\n|-------|------|--------|\n| MOC 7.0 §2.2 | Modelo 55 (NF-e) | ✅ Implementado |\n| MOC 7.0 §2.2 | Modelo 65 (NFC-e) | ✅ Implementado |\n| NT 2014.002 §3.3 | Schema nfeProc | ✅ Implementado |\n| NT 2014.002 §3.3 | Schema resNFe | ✅ Implementado |\n| NT 2014.002 §3.3 | Schema procEventoNFe | ✅ Implementado |\n| NT 2014.002 §3.3 | Schema resEvento | ✅ Implementado |\n| NT 2014.002 §3.11.4 | Controle de NSU | ✅ Já implementado |\n| NT 2014.002 §3.11.4 | Bloqueio cStat=137 | ✅ Já implementado |\n| NT 2014.002 §3.11.4 | Bloqueio cStat=656 | ✅ Já implementado |\n\n---\n\n## 🔍 **ARQUIVOS MODIFICADOS**\n\n1. `shared/schema.ts` - Campos modelo e tipo_documento\n2. `server/sefaz-service.ts` - Processamento de todos os schemas\n3. `server/config/index.ts` - Configuração centralizada (NOVO)\n4. `server/logger.ts` - Logs em arquivo (NOVO)\n5. `migrations/add_modelo_tipodocumento.sql` - Migração SQL (NOVO)\n6. `README.md` - Documentação completa\n7. `package.json` - Dependência @types/pako\n\n---\n\n## ⚠️ **ATENÇÃO**\n\n### **Migração Obrigatória:**\nExecutar `migrations/add_modelo_tipodocumento.sql` no Supabase antes de usar o sistema.\n\n### **Backward Compatibility:**\nXMLs já baixados continuarão funcionando (campos novos têm valores padrão).\n\n### **Teste Recomendado:**\nTestar com CNPJ que tenha mix de NF-e (55) e NFC-e (65) para validar separação de pastas.\n\n---\n\n**Desenvolvido com conformidade total à legislação fiscal brasileira 🇧🇷**\n","size_bytes":6301},"client/src/pages/empresa-edit.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { Upload, ArrowLeft, Eye, EyeOff } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { UFS } from \"@shared/schema\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Empresa } from \"@shared/schema\";\n\nconst formSchema = z.object({\n  razaoSocial: z.string().min(1, \"Razão social é obrigatória\"),\n  uf: z.string().length(2, \"Selecione uma UF\"),\n  ambiente: z.enum([\"prod\", \"hom\"]),\n  certificadoSenha: z.string().optional(),\n  ativo: z.boolean().default(true),\n  tipoArmazenamento: z.enum([\"local\", \"supabase\"]).default(\"local\"),\n  manifestacaoAutomatica: z.boolean().default(false),\n});\n\ntype FormData = z.infer<typeof formSchema>;\n\ninterface EmpresaEditProps {\n  params: {\n    id: string;\n  };\n}\n\nexport default function EmpresaEdit({ params }: EmpresaEditProps) {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [certificadoFile, setCertificadoFile] = useState<File | null>(null);\n  const [showPassword, setShowPassword] = useState(false);\n\n  const { data: empresa, isLoading } = useQuery<Empresa>({\n    queryKey: [\"/api/empresas\", params.id],\n  });\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      razaoSocial: \"\",\n      uf: \"\",\n      ambiente: \"prod\",\n      certificadoSenha: \"\",\n      ativo: true,\n      tipoArmazenamento: \"local\",\n      manifestacaoAutomatica: false,\n    },\n    values: empresa ? {\n      razaoSocial: empresa.razaoSocial,\n      uf: empresa.uf,\n      ambiente: empresa.ambiente as \"prod\" | \"hom\",\n      certificadoSenha: \"\",\n      ativo: empresa.ativo,\n      tipoArmazenamento: empresa.tipoArmazenamento as \"local\" | \"supabase\",\n      manifestacaoAutomatica: empresa.manifestacaoAutomatica,\n    } : undefined,\n  });\n\n  const onSubmit = async (data: FormData) => {\n    try {\n      const formData = new FormData();\n      formData.append(\"razaoSocial\", data.razaoSocial);\n      formData.append(\"uf\", data.uf);\n      formData.append(\"ambiente\", data.ambiente);\n      if (data.certificadoSenha) {\n        formData.append(\"certificadoSenha\", data.certificadoSenha);\n      }\n      formData.append(\"tipoArmazenamento\", data.tipoArmazenamento);\n      formData.append(\"manifestacaoAutomatica\", data.manifestacaoAutomatica.toString());\n      formData.append(\"ativo\", data.ativo.toString());\n      \n      if (certificadoFile) {\n        formData.append(\"certificado\", certificadoFile);\n      }\n\n      await apiRequest(`/api/empresas/${params.id}`, {\n        method: \"PATCH\",\n        body: formData,\n      });\n\n      toast({\n        title: \"Empresa atualizada!\",\n        description: \"As informações da empresa foram atualizadas com sucesso.\",\n      });\n\n      setTimeout(() => {\n        setLocation(\"/empresas\");\n      }, 1000);\n    } catch (error) {\n      toast({\n        title: \"Erro ao atualizar\",\n        description: error instanceof Error ? error.message : \"Erro ao atualizar empresa\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (!file.name.endsWith(\".pfx\") && !file.name.endsWith(\".p12\")) {\n        toast({\n          title: \"Arquivo inválido\",\n          description: \"Selecione um arquivo de certificado digital (.pfx ou .p12)\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setCertificadoFile(file);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <p className=\"text-muted-foreground\">Carregando...</p>\n      </div>\n    );\n  }\n\n  if (!empresa) {\n    return (\n      <div className=\"flex flex-col items-center justify-center h-64 space-y-4\">\n        <p className=\"text-muted-foreground\">Empresa não encontrada</p>\n        <Button onClick={() => setLocation(\"/empresas\")}>\n          Voltar para empresas\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 max-w-3xl\">\n      <div className=\"flex items-center gap-3\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setLocation(\"/empresas\")}\n          data-testid=\"button-voltar\"\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n        </Button>\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"heading-editar-empresa\">Editar Empresa</h1>\n          <p className=\"text-sm text-muted-foreground\">Atualize as informações da empresa</p>\n        </div>\n      </div>\n\n      <Form {...form}>\n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Dados da Empresa</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"razaoSocial\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Razão Social\n                    </FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"Nome da empresa\"\n                        {...field}\n                        data-testid=\"input-razao-social\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <FormLabel className=\"text-xs font-medium uppercase tracking-wide mb-2 block\">\n                    CNPJ\n                  </FormLabel>\n                  <Input\n                    value={empresa.cnpj}\n                    disabled\n                    className=\"font-mono bg-muted\"\n                    data-testid=\"input-cnpj-readonly\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    CNPJ não pode ser alterado\n                  </p>\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"uf\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                        UF\n                      </FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-uf\">\n                            <SelectValue placeholder=\"Selecione a UF\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {UFS.map((uf) => (\n                            <SelectItem key={uf} value={uf}>\n                              {uf}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"ambiente\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Ambiente SEFAZ\n                    </FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-ambiente\">\n                          <SelectValue placeholder=\"Selecione o ambiente\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"prod\">Produção</SelectItem>\n                        <SelectItem value=\"hom\">Homologação</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Use Produção para ambiente real ou Homologação para testes\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"ativo\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-sm font-medium\">\n                        Empresa Ativa\n                      </FormLabel>\n                      <FormDescription>\n                        Empresas ativas são sincronizadas automaticamente a cada hora\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-ativo\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"tipoArmazenamento\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Tipo de Armazenamento\n                    </FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-tipo-armazenamento\">\n                          <SelectValue placeholder=\"Selecione o tipo de armazenamento\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"local\">Local (filesystem)</SelectItem>\n                        <SelectItem value=\"supabase\">Supabase Storage</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Define onde os XMLs serão armazenados (local ou nuvem)\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"manifestacaoAutomatica\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-sm font-medium\">\n                        Manifestação Automática\n                      </FormLabel>\n                      <FormDescription>\n                        Manifesta automaticamente evento 210210 (Ciência da Operação) quando um novo XML é recebido\n                      </FormDescription>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-manifestacao-automatica\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg font-medium\">Certificado Digital (Opcional)</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div>\n                <FormLabel className=\"text-xs font-medium uppercase tracking-wide mb-3 block\">\n                  Novo Certificado (.pfx)\n                </FormLabel>\n                <p className=\"text-sm text-muted-foreground mb-3\">\n                  Faça upload apenas se desejar trocar o certificado atual\n                </p>\n                <div className=\"border-2 border-dashed rounded-lg p-6 text-center hover-elevate\">\n                  <input\n                    type=\"file\"\n                    accept=\".pfx,.p12\"\n                    onChange={handleFileChange}\n                    className=\"hidden\"\n                    id=\"certificado-upload\"\n                    data-testid=\"input-certificado\"\n                  />\n                  <label\n                    htmlFor=\"certificado-upload\"\n                    className=\"cursor-pointer flex flex-col items-center gap-2\"\n                  >\n                    <Upload className=\"w-10 h-10 text-muted-foreground\" />\n                    {certificadoFile ? (\n                      <>\n                        <p className=\"text-sm font-medium\">{certificadoFile.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {(certificadoFile.size / 1024).toFixed(2)} KB\n                        </p>\n                      </>\n                    ) : (\n                      <>\n                        <p className=\"text-sm font-medium\">Clique para selecionar um novo certificado</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Arquivo .pfx ou .p12 (máx. 5MB)\n                        </p>\n                      </>\n                    )}\n                  </label>\n                </div>\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"certificadoSenha\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-xs font-medium uppercase tracking-wide\">\n                      Senha do Certificado\n                    </FormLabel>\n                    <div className=\"relative\">\n                      <FormControl>\n                        <Input\n                          type={showPassword ? \"text\" : \"password\"}\n                          placeholder=\"Digite apenas se trocar o certificado\"\n                          {...field}\n                          className=\"pr-10\"\n                          data-testid=\"input-senha\"\n                        />\n                      </FormControl>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"absolute right-0 top-0 h-full\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        data-testid=\"button-toggle-senha\"\n                      >\n                        {showPassword ? (\n                          <EyeOff className=\"w-4 h-4\" />\n                        ) : (\n                          <Eye className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                    </div>\n                    <FormDescription>\n                      Deixe em branco para manter a senha atual\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <div className=\"flex items-center gap-3\">\n            <Button\n              type=\"submit\"\n              disabled={form.formState.isSubmitting}\n              data-testid=\"button-salvar\"\n            >\n              {form.formState.isSubmitting ? \"Salvando...\" : \"Salvar Alterações\"}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setLocation(\"/empresas\")}\n              data-testid=\"button-cancelar\"\n            >\n              Cancelar\n            </Button>\n          </div>\n        </form>\n      </Form>\n    </div>\n  );\n}\n","size_bytes":16795},"server/xml-storage.ts":{"content":"import fs from \"fs/promises\";\nimport fsSync from \"fs\";\nimport path from \"path\";\nimport { supabaseAdmin } from \"./supabase\";\n\n/**\n * Serviço de Armazenamento Híbrido de XMLs\n * \n * Suporta dois tipos de storage:\n * - \"local\": Filesystem local (./xmls/) - Rápido mas não persistente no Replit\n * - \"supabase\": Supabase Storage - Persistente e escalável\n * \n * Conforme escolha do usuário: \"Implementar ambos e deixar configurável\"\n */\nexport class XmlStorageService {\n  private localBasePath: string;\n  private supabaseBucket: string;\n\n  constructor() {\n    this.localBasePath = process.env.XML_DEST_PATH || \"./xmls\";\n    this.supabaseBucket = \"xmls\"; // Nome do bucket no Supabase Storage\n  }\n\n  /**\n   * Salva um XML no storage escolhido (local ou Supabase)\n   * \n   * @param tipoArmazenamento - \"local\" ou \"supabase\"\n   * @param relativePath - Caminho relativo do arquivo (ex: \"CNPJ/2025/11/12345.xml\")\n   * @param conteudo - Conteúdo XML em string\n   * @returns Caminho completo do arquivo salvo\n   */\n  async saveXml(\n    tipoArmazenamento: string,\n    relativePath: string,\n    conteudo: string\n  ): Promise<string> {\n    if (tipoArmazenamento === \"supabase\") {\n      return await this.saveToSupabase(relativePath, conteudo);\n    } else {\n      return await this.saveToLocal(relativePath, conteudo);\n    }\n  }\n\n  /**\n   * Recupera um XML do storage escolhido\n   * \n   * @param tipoArmazenamento - \"local\" ou \"supabase\"\n   * @param relativePath - Caminho relativo do arquivo\n   * @returns Conteúdo XML em string\n   */\n  async getXml(tipoArmazenamento: string, relativePath: string): Promise<string> {\n    if (tipoArmazenamento === \"supabase\") {\n      return await this.getFromSupabase(relativePath);\n    } else {\n      return await this.getFromLocal(relativePath);\n    }\n  }\n\n  /**\n   * Verifica se um XML existe no storage\n   * \n   * @param tipoArmazenamento - \"local\" ou \"supabase\"\n   * @param relativePath - Caminho relativo do arquivo\n   * @returns true se existir, false caso contrário\n   */\n  async existsXml(tipoArmazenamento: string, relativePath: string): Promise<boolean> {\n    if (tipoArmazenamento === \"supabase\") {\n      return await this.existsInSupabase(relativePath);\n    } else {\n      return await this.existsInLocal(relativePath);\n    }\n  }\n\n  /**\n   * Deleta um XML do storage\n   * \n   * @param tipoArmazenamento - \"local\" ou \"supabase\"\n   * @param relativePath - Caminho relativo do arquivo\n   */\n  async deleteXml(tipoArmazenamento: string, relativePath: string): Promise<void> {\n    if (tipoArmazenamento === \"supabase\") {\n      await this.deleteFromSupabase(relativePath);\n    } else {\n      await this.deleteFromLocal(relativePath);\n    }\n  }\n\n  // ========== MÉTODOS PRIVADOS - FILESYSTEM LOCAL ==========\n\n  private async saveToLocal(relativePath: string, conteudo: string): Promise<string> {\n    const fullPath = path.join(this.localBasePath, relativePath);\n    const dir = path.dirname(fullPath);\n\n    // Cria diretórios se não existirem\n    await fs.mkdir(dir, { recursive: true });\n\n    // Salva arquivo\n    await fs.writeFile(fullPath, conteudo, \"utf-8\");\n\n    // Retorna caminho relativo normalizado para consistência (ex: \"xmls/NFe/12345678000100/2025/11/12345.xml\")\n    return path.join(this.localBasePath, relativePath);\n  }\n\n  private async getFromLocal(relativePath: string): Promise<string> {\n    const fullPath = path.join(this.localBasePath, relativePath);\n    return await fs.readFile(fullPath, \"utf-8\");\n  }\n\n  private async existsInLocal(relativePath: string): Promise<boolean> {\n    const fullPath = path.join(this.localBasePath, relativePath);\n    try {\n      await fs.access(fullPath);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  private async deleteFromLocal(relativePath: string): Promise<void> {\n    const fullPath = path.join(this.localBasePath, relativePath);\n    await fs.unlink(fullPath);\n  }\n\n  // ========== MÉTODOS PRIVADOS - SUPABASE STORAGE ==========\n\n  private async saveToSupabase(relativePath: string, conteudo: string): Promise<string> {\n    const { data, error } = await supabaseAdmin.storage\n      .from(this.supabaseBucket)\n      .upload(relativePath, conteudo, {\n        contentType: \"application/xml\",\n        upsert: true, // Sobrescreve se já existir\n      });\n\n    if (error) {\n      throw new Error(`Erro ao salvar XML no Supabase Storage: ${error.message}`);\n    }\n\n    // Retorna o caminho completo no Supabase\n    return `supabase://${this.supabaseBucket}/${data.path}`;\n  }\n\n  private async getFromSupabase(relativePath: string): Promise<string> {\n    const { data, error } = await supabaseAdmin.storage\n      .from(this.supabaseBucket)\n      .download(relativePath);\n\n    if (error) {\n      throw new Error(`Erro ao recuperar XML do Supabase Storage: ${error.message}`);\n    }\n\n    // Converte Blob para string\n    return await data.text();\n  }\n\n  private async existsInSupabase(relativePath: string): Promise<boolean> {\n    const { data, error } = await supabaseAdmin.storage\n      .from(this.supabaseBucket)\n      .list(path.dirname(relativePath), {\n        search: path.basename(relativePath),\n      });\n\n    if (error) {\n      // Se o bucket não existir, retorna false\n      if (error.message.includes(\"not found\")) return false;\n      throw new Error(`Erro ao verificar XML no Supabase Storage: ${error.message}`);\n    }\n\n    return data && data.length > 0;\n  }\n\n  private async deleteFromSupabase(relativePath: string): Promise<void> {\n    const { error } = await supabaseAdmin.storage\n      .from(this.supabaseBucket)\n      .remove([relativePath]);\n\n    if (error) {\n      throw new Error(`Erro ao deletar XML do Supabase Storage: ${error.message}`);\n    }\n  }\n\n  /**\n   * Cria o bucket de XMLs no Supabase Storage (se não existir)\n   * Deve ser chamado uma vez na inicialização do servidor\n   */\n  async ensureBucketExists(): Promise<void> {\n    const { data: buckets, error: listError } = await supabaseAdmin.storage.listBuckets();\n\n    if (listError) {\n      console.error(\"⚠️  Erro ao listar buckets do Supabase Storage:\", listError.message);\n      return;\n    }\n\n    const bucketExists = buckets?.some((bucket) => bucket.name === this.supabaseBucket);\n\n    if (!bucketExists) {\n      const { error: createError } = await supabaseAdmin.storage.createBucket(this.supabaseBucket, {\n        public: false, // Privado - requer autenticação\n        fileSizeLimit: 10 * 1024 * 1024, // 10MB por arquivo\n      });\n\n      if (createError) {\n        console.error(\"⚠️  Erro ao criar bucket de XMLs no Supabase Storage:\", createError.message);\n      } else {\n        console.log(\"✅ Bucket de XMLs criado no Supabase Storage\");\n      }\n    }\n  }\n}\n\n// Exporta instância única (singleton)\nexport const xmlStorageService = new XmlStorageService();\n","size_bytes":6783},"INSTRUCOES_MIGRATIONS.md":{"content":"# 🚀 Instruções de Aplicação das Migrations SQL\n\n## ⚠️ IMPORTANTE: Migrations Obrigatórias\n\nO sistema de **Download Automático de XMLs** está implementado e funcional, mas requer que você aplique **2 migrations SQL** diretamente no Supabase Dashboard **ANTES** de testar a funcionalidade.\n\n**Por que não usar execute_sql_tool?**\n- O `execute_sql_tool` conecta apenas ao banco local (development database), nunca ao Supabase (produção)\n- Este projeto usa **SEMPRE** Supabase PostgreSQL, conforme especificado em `replit.md`\n- Por isso, você precisa aplicar manualmente via Supabase Dashboard\n\n---\n\n## 📋 Passo a Passo\n\n### **MIGRATION 1: Campos de Controle de Download**\n\n1. Abra o [Supabase Dashboard](https://app.supabase.com)\n2. Selecione seu projeto\n3. Navegue até **SQL Editor** (menu lateral esquerdo)\n4. Clique em **New Query**\n5. Cole TODO o conteúdo do arquivo `supabase-migration-download-control.sql`\n6. Clique em **Run** (ou pressione Ctrl/Cmd + Enter)\n7. ✅ Confirme que não há erros (deve retornar \"Success\")\n\n**O que essa migration faz:**\n- Adiciona 4 novos campos na tabela `xmls`:\n  - `status_download` (VARCHAR): pendente, processando, completo, erro\n  - `tentativas_download` (INTEGER): contador de tentativas (0-5)\n  - `ultima_tentativa_download` (TIMESTAMP): timestamp da última tentativa\n  - `erro_download` (TEXT): mensagem de erro (se houver)\n- Preenche campos existentes com valores default:\n  - nfeProc → status_download = 'completo'\n  - resNFe → status_download = 'pendente'\n\n---\n\n### **MIGRATION 2: Distributed Locks (PostgreSQL)**\n\n1. No mesmo **SQL Editor** do Supabase Dashboard\n2. Clique em **New Query** (para limpar o editor)\n3. Cole TODO o conteúdo do arquivo `supabase-migration-distributed-locks.sql`\n4. Clique em **Run**\n5. ✅ Confirme que não há erros\n\n**O que essa migration faz:**\n- Cria tabela `distributed_locks` com:\n  - `name` (VARCHAR PRIMARY KEY): identificador do lock\n  - `owner` (UUID): processo que detém o lock\n  - `acquired_at` (TIMESTAMP): quando foi adquirido\n  - `expires_at` (TIMESTAMP): quando expira (TTL automático)\n- Cria função PostgreSQL `acquire_download_lock(p_name, p_owner, p_ttl_seconds)`:\n  - **Atomic INSERT ON CONFLICT**: garante exclusão mútua\n  - Retorna TRUE se adquiriu, FALSE se já ocupado\n  - TTL automático (default 180s = 3min)\n- Cria função PostgreSQL `release_download_lock(p_name, p_owner)`:\n  - Deleta lock apenas se owner correto\n  - Retorna TRUE se liberou, FALSE se não era o owner\n\n---\n\n## 🧪 Como Testar Após Aplicar Migrations\n\n### Teste 1: Verificar Campos Criados\n```sql\n-- No SQL Editor do Supabase Dashboard\nSELECT \n  chave_nfe,\n  tipo_documento,\n  status_download,\n  tentativas_download,\n  ultima_tentativa_download,\n  erro_download\nFROM xmls\nLIMIT 5;\n```\n\nResultado esperado: Deve retornar XMLs com `status_download` preenchido.\n\n### Teste 2: Verificar Funções PLPGSQL\n```sql\n-- Testa acquire_download_lock\nSELECT acquire_download_lock('test-lock', gen_random_uuid()::uuid, 60);\n-- Deve retornar: true (primeira vez)\n\n-- Tenta adquirir novamente com outro owner\nSELECT acquire_download_lock('test-lock', gen_random_uuid()::uuid, 60);\n-- Deve retornar: false (lock já ocupado)\n\n-- Limpa lock de teste\nDELETE FROM distributed_locks WHERE name = 'test-lock';\n```\n\n### Teste 3: Aguardar Cron Job (Automático)\n- O sistema tem um cron job configurado para rodar **a cada 5 minutos**\n- No próximo ciclo (máximo 5min), você verá nos logs:\n  ```\n  [SupabaseStorage] Lock owner UUID: <uuid-gerado>\n  [SupabaseStorage] Lock \"xml-download-service\" acquire: SUCCESS\n  [Download Service] Lock adquirido com sucesso\n  [Download Service] Processando downloads pendentes...\n  ```\n\n### Teste 4: Trigger Manual (Endpoint)\n```bash\n# Via curl ou Postman\nPOST http://localhost:5000/api/xmls/downloads/processar\nContent-Type: application/json\n\n{\n  \"empresaId\": \"<id-da-empresa>\"\n}\n```\n\nResposta esperada:\n```json\n{\n  \"success\": true,\n  \"message\": \"Processamento de downloads iniciado\",\n  \"processados\": 3\n}\n```\n\n---\n\n## 📊 Monitoramento\n\n### Dashboard (Interface Web)\nNavegue até a página **XMLs** e observe:\n- **Cards de Estatísticas**:\n  - Total Completos\n  - Resumos (resNFe)\n  - Pendentes Download\n  - Erros Download\n- **Badges Visuais** na listagem:\n  - 🟡 Pendente (resNFe aguardando download)\n  - 🔵 Processando (tentativa em andamento)\n  - ✅ Completo (nfeProc baixado com sucesso)\n  - ❌ Erro X/5 (falha, mostra tentativas)\n\n### Logs (Backend)\nMonitore o console do servidor para:\n```\n[Download Service] Lock adquirido com sucesso\n[Download Service] Processando 3 XMLs pendentes...\n[Download Service] Baixando XML completo: 35201234567890123456789012345678901234\n[Download Service] XML completo salvo com sucesso\n[Download Service] Lock liberado com sucesso\n```\n\n### Supabase Dashboard\n```sql\n-- Vê XMLs pendentes de download\nSELECT chave_nfe, status_download, tentativas_download \nFROM xmls \nWHERE tipo_documento = 'resNFe' AND status_download IN ('pendente', 'erro')\nORDER BY tentativas_download ASC;\n\n-- Vê locks ativos\nSELECT * FROM distributed_locks;\n```\n\n---\n\n## 🔧 Troubleshooting\n\n### Erro: \"function acquire_download_lock does not exist\"\n**Causa**: Migration 2 não foi aplicada.\n**Solução**: Aplique `supabase-migration-distributed-locks.sql` no Supabase Dashboard.\n\n### Erro: \"column status_download does not exist\"\n**Causa**: Migration 1 não foi aplicada.\n**Solução**: Aplique `supabase-migration-download-control.sql` no Supabase Dashboard.\n\n### Downloads não processam (logs mostram \"Lock já ocupado\")\n**Causa Normal**: Outro processo/instância do servidor está ativo com o lock.\n**Solução**: Aguarde até 3min (TTL do lock) ou force release:\n```sql\nDELETE FROM distributed_locks WHERE name = 'xml-download-service';\n```\n\n### XMLs completos (nfeProc) sendo reprocessados\n**Causa**: Filtros não estão funcionando corretamente.\n**Verificação**: Verifique nos logs se há XMLs com `tipo_documento = 'nfeProc'` sendo processados.\n**Solução**: Isso NÃO deve acontecer - há filtro duplo (SQL + inline).\n\n---\n\n## ✅ Checklist de Validação Final\n\nAntes de considerar o sistema pronto:\n\n- [ ] Migration 1 aplicada (campos status_download criados)\n- [ ] Migration 2 aplicada (funções acquire/release criadas)\n- [ ] Teste SQL: `SELECT * FROM distributed_locks;` funciona\n- [ ] Cron executou ao menos 1 vez (logs mostram \"Lock adquirido\")\n- [ ] Dashboard mostra estatísticas de downloads\n- [ ] XMLs com status \"pendente\" são processados automaticamente\n- [ ] XMLs com erro (5 tentativas) não são reprocessados\n- [ ] Lock é liberado após processamento (finally block)\n\n---\n\n## 📚 Arquivos de Referência\n\n- **Migration 1**: `supabase-migration-download-control.sql`\n- **Migration 2**: `supabase-migration-distributed-locks.sql`\n- **Service**: `server/xml-download-service.ts`\n- **Storage**: `server/supabase-storage.ts`\n- **Endpoints**: `server/routes.ts`\n- **Frontend**: `client/src/pages/xmls.tsx`\n- **Documentação**: `replit.md` (seção \"FASE 8\")\n\n---\n\n## 🎯 Próximos Passos Após Validação\n\n1. Testar com XMLs reais da SEFAZ (não simulação)\n2. Monitorar erros e ajustar retry logic se necessário\n3. Configurar alertas para XMLs com status \"erro\" definitivo (5 tentativas)\n4. Otimizar batch size se houver grande volume de XMLs pendentes\n5. Considerar índices adicionais para queries de status_download\n\n---\n\n**Dúvidas?** Consulte os logs do servidor e a documentação em `replit.md`.\n","size_bytes":7487},"server/xml-download-service.ts":{"content":"/**\n * Serviço de Download Automático de XMLs Completos\n * \n * Este serviço gerencia o download automático de XMLs completos (nfeProc)\n * a partir de resumos (resNFe) usando consulta por chave de acesso.\n * \n * Fluxo:\n * 1. Busca XMLs com status_download='pendente' ou 'erro' (com retry)\n * 2. Para cada XML, tenta consultar chave na SEFAZ\n * 3. Se obtiver XML completo, substitui o resumo e marca como 'completo'\n * 4. Se falhar, incrementa tentativas e marca como 'erro'\n */\n\nimport { storage } from \"./storage\";\nimport { sefazService } from \"./sefaz-service\";\nimport type { Xml, Empresa } from \"@shared/schema\";\nimport path from \"path\";\nimport { xmlStorageService } from \"./xml-storage\";\nimport { XMLParser } from \"fast-xml-parser\";\n\nexport class XmlDownloadService {\n  private readonly MAX_TENTATIVAS = 999; // Retry infinito - sempre tenta baixar e manifestar\n  private readonly BATCH_SIZE = 10; // Processa 10 XMLs por vez\n  private readonly LOCK_TIMEOUT = 3 * 60 * 1000; // 3 minutos (menos que intervalo do cron de 5min)\n  private lockAcquired: boolean = false; // Flag se lock foi adquirido\n  private parser: XMLParser; // Parser para identificar tipo de documento\n\n  constructor() {\n    // Parser XML configurado para manter strings (preservar chaves 44 dígitos)\n    this.parser = new XMLParser({\n      ignoreAttributes: false,\n      parseAttributeValue: false,\n      parseTagValue: false,\n      trimValues: true,\n      numberParseOptions: {\n        leadingZeros: false,\n        hex: false,\n        skipLike: /^[0-9]{44}$/, // Mantém chaves NFe como string\n      },\n    });\n  }\n\n  /**\n   * Adquire lock distribuído usando PostgreSQL + tabela dedicada\n   * ATÔMICO: INSERT ON CONFLICT garante exclusão mútua real\n   */\n  private async acquireLock(): Promise<boolean> {\n    try {\n      // Tenta adquirir lock distribuído\n      const acquired = await storage.tryAcquireDownloadLock();\n      \n      if (!acquired) {\n        console.log(\"[Download Service] Lock já ocupado por outro processo\");\n        return false;\n      }\n\n      console.log(\"[Download Service] Lock adquirido com sucesso\");\n      this.lockAcquired = true;\n\n      return true;\n    } catch (error) {\n      console.error(\"[Download Service] Erro ao adquirir lock:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Libera lock distribuído\n   */\n  private async releaseLock(): Promise<void> {\n    if (!this.lockAcquired) return;\n    \n    try {\n      await storage.releaseDownloadLock();\n      \n      console.log(\"[Download Service] Lock liberado com sucesso\");\n      \n      this.lockAcquired = false;\n    } catch (error) {\n      console.error(\"[Download Service] Erro ao liberar lock:\", error);\n    }\n  }\n\n  /**\n   * Processa downloads pendentes de todos os usuários\n   * Chamado periodicamente pelo cron job\n   */\n  async processarDownloadsPendentes(): Promise<void> {\n    console.log(\"[Download Service] Iniciando processamento de downloads pendentes...\");\n\n    // CRÍTICO: Tenta adquirir lock para evitar concorrência\n    const lockAcquired = await this.acquireLock();\n    if (!lockAcquired) {\n      console.log(\"[Download Service] Lock ativo - outro processo está executando. Pulando esta execução.\");\n      return;\n    }\n\n    try {\n      // Busca XMLs pendentes (sem filtro de usuário - processa todos)\n      const xmlsPendentes = await storage.getXmlsPendentesDownload(undefined, this.BATCH_SIZE);\n      \n      // Busca XMLs com erro que precisam retry\n      const xmlsComErro = await storage.getXmlsComErroDownload(undefined, this.BATCH_SIZE);\n\n      const todosXmls = [...xmlsPendentes, ...xmlsComErro];\n\n      if (todosXmls.length === 0) {\n        console.log(\"[Download Service] Nenhum XML pendente de download\");\n        return;\n      }\n\n      // CRÍTICO: Filtra novamente para garantir que apenas resNFe seja processado\n      // Isso previne race conditions onde XML pode ter sido convertido entre query e processamento\n      // IMPORTANTE: NÃO filtramos por tentativasDownload aqui pois a manifestação é independente\n      const xmlsValidos = todosXmls.filter(xml => {\n        if (xml.tipoDocumento !== \"resNFe\") {\n          console.warn(`[Download Service] Pulando XML ${xml.id} - já é ${xml.tipoDocumento}`);\n          return false;\n        }\n        if (xml.statusDownload === \"completo\") {\n          console.warn(`[Download Service] Pulando XML ${xml.id} - status já é completo`);\n          return false;\n        }\n        // Removido filtro por tentativasDownload - permitir retry de manifestação\n        return true;\n      });\n\n      if (xmlsValidos.length === 0) {\n        console.log(\"[Download Service] Nenhum XML válido para processar após filtros\");\n        return;\n      }\n\n      console.log(`[Download Service] Encontrados ${xmlsValidos.length} XMLs válidos para processar (de ${todosXmls.length} retornados)`);\n      console.log(`  - Pendentes: ${xmlsPendentes.length}`);\n      console.log(`  - Com erro (retry): ${xmlsComErro.length}`);\n\n      // Agrupa XMLs por empresa para otimizar certificados\n      const xmlsPorEmpresa = this.agruparPorEmpresa(xmlsValidos);\n\n      for (const [empresaId, xmls] of Array.from(xmlsPorEmpresa.entries())) {\n        await this.processarXmlsDaEmpresa(empresaId, xmls);\n      }\n\n      console.log(\"[Download Service] Processamento concluído\");\n    } catch (error: any) {\n      console.error(\"[Download Service] Erro no processamento:\", error.message);\n      await storage.createLog({\n        nivel: \"error\",\n        mensagem: \"Erro no processamento de downloads automáticos\",\n        detalhes: JSON.stringify({ erro: error.message }),\n      });\n    } finally {\n      // CRÍTICO: Sempre libera lock, mesmo em caso de erro\n      await this.releaseLock();\n    }\n  }\n\n  /**\n   * Processa downloads de XMLs de uma empresa específica\n   */\n  private async processarXmlsDaEmpresa(empresaId: string, xmls: Xml[]): Promise<void> {\n    console.log(`[Download Service] Processando ${xmls.length} XMLs da empresa ${empresaId}`);\n\n    // Busca dados da empresa\n    const empresa = await storage.getEmpresa(empresaId);\n    if (!empresa) {\n      console.error(`[Download Service] Empresa ${empresaId} não encontrada`);\n      return;\n    }\n\n    if (!empresa.ativo) {\n      console.log(`[Download Service] Empresa ${empresaId} está inativa, ignorando`);\n      return;\n    }\n\n    // Processa cada XML\n    for (const xml of xmls) {\n      await this.tentarDownloadXml(xml, empresa);\n      \n      // Pequeno delay entre downloads para não sobrecarregar SEFAZ\n      await this.sleep(2000); // 2 segundos entre downloads\n    }\n  }\n\n  /**\n   * Tenta fazer download do XML completo via consulta por chave\n   * NOVO FLUXO (2024-11):\n   * 1. Verifica se já foi manifestado\n   * 2. Se não foi manifestado, manifesta primeiro (respeitando rate limit e max tentativas)\n   * 3. Se manifestação falhou mas ainda tem tentativas, retenta manifestação\n   * 4. Só depois tenta o download do XML completo\n   * 5. Sempre respeita limite de 20 consultas/hora por empresa\n   */\n  private async tentarDownloadXml(xml: Xml, empresa: Empresa): Promise<void> {\n    // FILTRO: Ignora XMLs cancelados - não tenta download nem manifestação\n    if (xml.statusNfe === \"cancelada\" || xml.statusDownload === \"cancelada\") {\n      console.log(`[Download Service] XML cancelado - não processa: ${xml.chaveNFe}`);\n      return;\n    }\n\n    // RETRY INFINITO: Reseta XMLs com erro definitivo para pendente ao retentar\n    if (xml.statusDownload === \"erro\") {\n      console.log(`[Download Service] Resetando XML com erro para pendente (retry infinito): ${xml.chaveNFe}`);\n      await storage.updateXml(xml.id, {\n        statusDownload: \"pendente\",\n        tentativasDownload: 0, // CRÍTICO: Reseta contador de tentativas para permitir retry infinito\n        erroDownload: null, // Limpa mensagem de erro anterior\n      });\n      // Atualiza objeto local para refletir reset\n      xml.statusDownload = \"pendente\";\n      xml.tentativasDownload = 0;\n      xml.erroDownload = null;\n    }\n\n    // CRÍTICO: Calcula tentativa APÓS reset (garante que valor reflete estado atual)\n    const tentativaAtual = xml.tentativasDownload ?? 0;\n    const novaTentativa = tentativaAtual + 1;\n    console.log(`[Download Service] Processando: ${xml.chaveNFe} (tentativa download ${novaTentativa})`);\n\n\n    // ====================\n    // ETAPA 1: MANIFESTAÇÃO\n    // ====================\n    // Verifica se já foi manifestado antes de baixar\n    const manifestacaoExistente = await storage.getManifestacaoByChave(xml.chaveNFe, empresa.userId);\n    \n    if (!manifestacaoExistente || manifestacaoExistente.status === \"erro\") {\n      // Verifica tentativas de manifestação (separado de tentativas de download)\n      const tentativasManifestacao = manifestacaoExistente?.tentativas ?? 0;\n      \n      // REMOVIDO LIMITE - retry infinito de manifestação\n      // Sempre tenta manifestar, independente do número de tentativas anteriores\n      \n      console.log(`[Download Service] XML não manifestado ou com erro - tentando manifestar: ${xml.chaveNFe} (tentativa manifestação ${tentativasManifestacao + 1}/${this.MAX_TENTATIVAS})`);\n      \n      // Verifica rate limit ANTES de manifestar (máx 20 consultas/hora)\n      const podeManifest = await storage.checkRateLimit(empresa.id, \"manifestacao\", empresa.userId);\n      if (!podeManifest) {\n        console.warn(`[Download Service] Rate limit excedido para manifestação - pulando por enquanto`);\n        // NÃO incrementa tentativas - rate limit é temporário\n        return;\n      }\n\n      try {\n        // Tenta manifestar Ciência da Operação (210210)\n        await sefazService.manifestarEvento(\n          empresa,\n          xml.chaveNFe,\n          \"210210\", // Ciência da Operação\n          undefined // Não precisa justificativa\n        );\n        \n        console.log(`[Download Service] ✓ Manifestação (Ciência) enviada: ${xml.chaveNFe}`);\n        \n        await storage.createLog({\n          userId: xml.userId,\n          empresaId: xml.empresaId,\n          nivel: \"info\",\n          mensagem: `Manifestação automática enviada: NF-e ${xml.numeroNF}`,\n          detalhes: JSON.stringify({ \n            chaveNFe: xml.chaveNFe,\n            tipoEvento: \"210210 - Ciência da Operação\",\n            tentativa: tentativasManifestacao + 1\n          }),\n        });\n      } catch (manifestError: any) {\n        console.error(`[Download Service] ✗ Erro ao manifestar ${xml.chaveNFe}:`, manifestError.message);\n        \n        // Log do erro de manifestação\n        await storage.createLog({\n          userId: xml.userId,\n          empresaId: xml.empresaId,\n          nivel: \"warning\",\n          mensagem: `Erro na manifestação automática (retry na próxima execução): NF-e ${xml.numeroNF}`,\n          detalhes: JSON.stringify({ \n            chaveNFe: xml.chaveNFe,\n            erro: manifestError.message,\n            tentativa: tentativasManifestacao + 1\n          }),\n        });\n        \n        // RETORNA sem tentar download - manifestação é pré-requisito\n        return;\n      }\n    } else if (manifestacaoExistente.status === \"confirmado\" || manifestacaoExistente.status === \"enviado\") {\n      console.log(`[Download Service] XML já manifestado (${manifestacaoExistente.status}) - prosseguindo com download: ${xml.chaveNFe}`);\n    } else {\n      console.log(`[Download Service] Manifestação com status ${manifestacaoExistente.status} - prosseguindo com download: ${xml.chaveNFe}`);\n    }\n\n    // ====================\n    // ETAPA 2: DOWNLOAD XML COMPLETO\n    // ====================\n    // RETRY INFINITO: Removido limite de tentativas - sempre tenta download\n    // Rate limit é a única proteção (20 consultas/hora por empresa)\n    \n    // Verifica rate limit ANTES de consultar SEFAZ (máx 20 consultas/hora)\n    const podeConsultar = await storage.checkRateLimit(empresa.id, \"consultaChave\", empresa.userId);\n    if (!podeConsultar) {\n      console.warn(`[Download Service] Rate limit excedido para download - pulando XML (retry automático após janela)`);\n      \n      // NÃO grava erro nem incrementa tentativas - rate limit é temporário\n      // XML continuará com statusDownload=\"pendente\" e será retentado automaticamente\n      // quando janela de 1h resetar e rate limiter permitir novamente\n      return;\n    }\n\n    // Atualiza tentativa ANTES de consultar\n    await storage.updateXml(xml.id, {\n      tentativasDownload: novaTentativa,\n      ultimaTentativaDownload: new Date(),\n    });\n\n    try {\n      console.log(`[Download Service] Consultando XML completo: ${xml.chaveNFe}`);\n      \n      // Consulta XML completo via chave de acesso\n      const resultado = await sefazService.consultarChave(xml.chaveNFe, empresa);\n\n      if (!resultado) {\n        throw new Error(\"SEFAZ retornou sem XML completo\");\n      }\n\n      // cStat 653: NF-e cancelada - marca como cancelada sem salvar XML\n      if (resultado.cStat === \"653\") {\n        await storage.updateXml(xml.id, {\n          statusDownload: \"cancelada\",\n          statusNfe: \"cancelada\",\n          erroDownload: \"NF-e cancelada - arquivo indisponível para download (cStat 653)\",\n        });\n        \n        console.log(`[Download Service] ✓ NF-e ${xml.numeroNF} marcada como CANCELADA (cStat 653)`);\n        \n        await storage.createLog({\n          userId: xml.userId,\n          empresaId: xml.empresaId,\n          nivel: \"warning\",\n          mensagem: `NF-e ${xml.numeroNF} está cancelada`,\n          detalhes: JSON.stringify({ \n            chaveNFe: xml.chaveNFe,\n            cStat: \"653\",\n            motivo: \"NF-e Cancelada - arquivo indisponível para download\"\n          }),\n        });\n        return; // Não tenta salvar XML\n      }\n\n      if (!resultado.xmlContent) {\n        throw new Error(\"SEFAZ retornou sem XML completo\");\n      }\n\n      // Salva XML completo substituindo o resumo\n      await this.salvarXmlCompleto(xml, empresa, resultado.xmlContent, resultado.cStat);\n\n      console.log(`[Download Service] ✓ Download bem-sucedido: ${xml.chaveNFe}`);\n      \n      await storage.createLog({\n        userId: xml.userId,\n        empresaId: xml.empresaId,\n        nivel: \"info\",\n        mensagem: `Download automático concluído: NF-e ${xml.numeroNF}`,\n        detalhes: JSON.stringify({ \n          chaveNFe: xml.chaveNFe,\n          tentativas: novaTentativa,\n          cStat: resultado.cStat\n        }),\n      });\n    } catch (error: any) {\n      console.error(`[Download Service] ✗ Erro ao baixar ${xml.chaveNFe}:`, error.message);\n\n      // RETRY INFINITO: Sempre mantém como \"pendente\" para retry automático\n      // Não marca como \"erro\" permanente - sistema retenta indefinidamente\n      await storage.updateXml(xml.id, {\n        statusDownload: \"pendente\",\n        erroDownload: error.message.substring(0, 500), // Limita tamanho do erro\n      });\n\n      // Log de erro (informativo, não crítico)\n      await storage.createLog({\n        userId: xml.userId,\n        empresaId: xml.empresaId,\n        nivel: \"warning\",\n        mensagem: `Erro no download automático (retry na próxima execução): NF-e ${xml.numeroNF}`,\n        detalhes: JSON.stringify({ \n          chaveNFe: xml.chaveNFe,\n          ultimoErro: error.message.substring(0, 500),\n          tentativa: novaTentativa\n        }),\n      });\n    }\n  }\n\n  /**\n   * Salva XML completo no storage e atualiza registro do banco\n   * CRÍTICO: Persiste o arquivo XML no disco/Supabase Storage\n   * \n   * IDENTIFICAÇÃO AUTOMÁTICA DO TIPO DE DOCUMENTO:\n   * Analisa TAG raiz do XML retornado pela SEFAZ para determinar tipo correto:\n   * - <nfeProc> → \"nfeProc\" (XML completo autorizado)\n   * - <resNFe> → \"resNFe\" (resumo - não deveria acontecer, mas previne bugs)\n   * - <procEventoNFe> → \"procEventoNFe\" (evento processado)\n   * - <resEvento> → \"resEvento\" (resumo de evento)\n   */\n  private async salvarXmlCompleto(\n    xmlOriginal: Xml,\n    empresa: Empresa,\n    xmlContent: string,\n    cStat: string\n  ): Promise<void> {\n    // ETAPA 1: Identifica tipo de documento pela TAG raiz do XML\n    const parsed = this.parser.parse(xmlContent);\n    let tipoDocumentoIdentificado = \"nfeProc\"; // Default\n    \n    if (parsed.nfeProc) {\n      tipoDocumentoIdentificado = \"nfeProc\";\n      console.log(`[Download Service] XML identificado: nfeProc (XML completo)`);\n    } else if (parsed.resNFe) {\n      tipoDocumentoIdentificado = \"resNFe\";\n      console.log(`[Download Service] XML identificado: resNFe (resumo - inesperado)`);\n    } else if (parsed.procEventoNFe) {\n      tipoDocumentoIdentificado = \"procEventoNFe\";\n      console.log(`[Download Service] XML identificado: procEventoNFe (evento processado)`);\n    } else if (parsed.resEvento) {\n      tipoDocumentoIdentificado = \"resEvento\";\n      console.log(`[Download Service] XML identificado: resEvento (resumo de evento)`);\n    } else {\n      console.warn(`[Download Service] ⚠️ TAG raiz desconhecida - usando default \"nfeProc\"`, Object.keys(parsed));\n    }\n\n    // ETAPA 2: Extrai informações do XML completo\n    // CORREÇÃO: dataEmissao pode vir como string do DB - converter para Date\n    const dataEmissao = xmlOriginal.dataEmissao instanceof Date \n      ? xmlOriginal.dataEmissao \n      : new Date(xmlOriginal.dataEmissao);\n    const ano = dataEmissao.getFullYear();\n    const mes = (dataEmissao.getMonth() + 1).toString().padStart(2, \"0\");\n    const tipoDoc = xmlOriginal.modelo === \"65\" ? \"NFCe\" : \"NFe\";\n\n    // Caminho para XML completo (diferente do resumo - sem pasta \"Resumos\")\n    const filename = `${parseInt(xmlOriginal.numeroNF)}.xml`;\n    const relativePath = path.join(tipoDoc, empresa.cnpj, `${ano}`, mes, filename);\n\n    // CRÍTICO: Salva XML completo no storage (disco ou Supabase)\n    const caminhoCompleto = await xmlStorageService.saveXml(\n      empresa.tipoArmazenamento,\n      relativePath,\n      xmlContent\n    );\n\n    const tamanhoBytes = Buffer.byteLength(xmlContent, \"utf-8\");\n\n    // Deleta arquivo resNFe antigo para liberar espaço\n    try {\n      if (xmlOriginal.caminhoArquivo !== caminhoCompleto) {\n        await xmlStorageService.deleteXml(empresa.tipoArmazenamento, xmlOriginal.caminhoArquivo);\n        console.log(`[Download Service] Arquivo resNFe antigo deletado: ${xmlOriginal.caminhoArquivo}`);\n      }\n    } catch (err) {\n      // Não falha se não conseguir deletar (arquivo pode já ter sido deletado)\n      console.warn(`[Download Service] Não foi possível deletar resNFe antigo:`, err);\n    }\n\n    // ETAPA 3: Determina status da NFe baseado em cStat da SEFAZ\n    let statusNfe = \"autorizada\"; // Default\n    switch (cStat) {\n      case \"100\":\n      case \"138\": // Documento localizado\n        statusNfe = \"autorizada\";\n        break;\n      case \"101\":\n      case \"653\": // NF-e cancelada (arquivo indisponível)\n        statusNfe = \"cancelada\";\n        console.log(`[Download Service] NFe ${xmlOriginal.numeroNF} está CANCELADA (cStat ${cStat})`);\n        break;\n      case \"110\":\n      case \"301\":\n      case \"302\":\n        statusNfe = \"denegada\";\n        console.log(`[Download Service] NFe ${xmlOriginal.numeroNF} está DENEGADA (cStat ${cStat})`);\n        break;\n      case \"217\":\n        // NF-e não consta na base da SEFAZ (pode ter sido inutilizada ou erro)\n        statusNfe = \"autorizada\"; // Mantém default mas pode ser ajustado\n        console.warn(`[Download Service] NFe ${xmlOriginal.numeroNF} não consta (cStat 217)`);\n        break;\n    }\n\n    // ETAPA 4: Atualiza registro com tipo identificado, XML completo E status da NFe\n    await storage.updateXml(xmlOriginal.id, {\n      tipoDocumento: tipoDocumentoIdentificado, // ✅ IDENTIFICADO PELA TAG RAIZ\n      caminhoArquivo: caminhoCompleto, // Novo caminho\n      tamanhoBytes, // Novo tamanho\n      statusDownload: \"completo\",\n      statusNfe, // Status baseado em cStat\n      erroDownload: undefined, // Limpa erro anterior\n    });\n\n    console.log(`[Download Service] ✓ XML salvo com tipo \"${tipoDocumentoIdentificado}\" - chave ${xmlOriginal.chaveNFe}`);\n  }\n\n  /**\n   * Agrupa XMLs por empresa para otimizar processamento\n   */\n  private agruparPorEmpresa(xmls: Xml[]): Map<string, Xml[]> {\n    const grupos = new Map<string, Xml[]>();\n\n    for (const xml of xmls) {\n      const lista = grupos.get(xml.empresaId) || [];\n      lista.push(xml);\n      grupos.set(xml.empresaId, lista);\n    }\n\n    return grupos;\n  }\n\n  /**\n   * Utilitário para delay\n   */\n  private sleep(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Processa downloads pendentes de uma empresa específica (endpoint manual)\n   */\n  async processarDownloadsEmpresa(empresaId: string, userId?: string): Promise<{ processados: number; sucesso: number; erro: number }> {\n    console.log(`[Download Service] Processamento manual para empresa ${empresaId}`);\n\n    // Busca empresa\n    const empresa = await storage.getEmpresa(empresaId, userId);\n    if (!empresa) {\n      throw new Error(\"Empresa não encontrada\");\n    }\n\n    // Busca XMLs pendentes da empresa\n    const xmlsPendentes = await storage.getXmlsPendentesDownload(userId);\n    const xmlsEmpresa = xmlsPendentes.filter(x => x.empresaId === empresaId);\n\n    if (xmlsEmpresa.length === 0) {\n      return { processados: 0, sucesso: 0, erro: 0 };\n    }\n\n    let sucesso = 0;\n    let erro = 0;\n\n    for (const xml of xmlsEmpresa) {\n      try {\n        await this.tentarDownloadXml(xml, empresa);\n        sucesso++;\n      } catch (err) {\n        erro++;\n      }\n      \n      await this.sleep(2000);\n    }\n\n    return {\n      processados: xmlsEmpresa.length,\n      sucesso,\n      erro\n    };\n  }\n}\n\n// Singleton\nexport const xmlDownloadService = new XmlDownloadService();\n","size_bytes":21723},"server/reset-rate-limit-dev.ts":{"content":"import { supabaseStorage } from \"./supabase-storage\";\n\nconst EMPRESA_ID = \"09b75153-fdd1-422a-ad92-325f1563e5d5\";\n\nasync function main() {\n  console.log(`🔄 Resetando rate limit para empresa ${EMPRESA_ID}...`);\n  \n  try {\n    await supabaseStorage.resetRateLimit(EMPRESA_ID);\n    console.log(\"✅ Rate limit resetado com sucesso!\");\n    console.log(\"⏰ Próximo ciclo (5min) poderá tentar manifestação\");\n  } catch (error: any) {\n    console.error(\"❌ Erro:\", error.message);\n    process.exit(1);\n  }\n}\n\nmain();\n","size_bytes":519},"DEPLOYMENT-TRAEFIK.md":{"content":"# 🚀 Guia de Deploy em Produção - SEFAZ XML Sync\n## Docker Standalone + Traefik + Portainer\n\n> **Sistema de Download Automático de XMLs da SEFAZ (NF-e/NFC-e)**  \n> **URL Produção:** https://downloadsefaz.dibs.com.br  \n> **Infraestrutura:** Docker Standalone + Traefik + Portainer\n\n---\n\n## 📋 Índice\n\n1. [Pré-requisitos](#-pré-requisitos)\n2. [Preparação do Servidor](#-preparação-do-servidor)\n3. [Configuração do Traefik](#-configuração-do-traefik)\n4. [Deploy da Aplicação](#-deploy-da-aplicação)\n5. [Verificação e Testes](#-verificação-e-testes)\n6. [Manutenção](#-manutenção)\n7. [Troubleshooting](#-troubleshooting)\n\n---\n\n## 🎯 Pré-requisitos\n\n### ✅ Servidor Linux\n\n- **Sistema Operacional:** Ubuntu 22.04 LTS ou superior (recomendado)\n- **CPU:** 2 vCPUs mínimo (4 vCPUs recomendado)\n- **RAM:** 4 GB mínimo (8 GB recomendado)\n- **Disco:** 50 GB SSD mínimo\n- **Portas Abertas:** 80 (HTTP), 443 (HTTPS)\n\n### ✅ Software Instalado\n\n```bash\n# Docker Engine (última versão)\ndocker --version  # Deve retornar >= 24.0\n\n# Docker Compose (última versão)\ndocker compose version  # Deve retornar >= 2.20\n\n# Traefik (rodando em container)\ndocker ps | grep traefik  # Deve mostrar container ativo\n\n# Portainer (opcional, mas você já usa)\ndocker ps | grep portainer  # Deve mostrar container ativo\n```\n\n### ✅ DNS Configurado\n\n- **Domínio:** `downloadsefaz.dibs.com.br`\n- **Tipo:** A Record\n- **Valor:** IP público do seu servidor\n- **TTL:** 300 (5 minutos)\n\n**Verificar DNS:**\n```bash\nnslookup downloadsefaz.dibs.com.br\n# Deve retornar o IP do seu servidor\n```\n\n### ✅ Supabase Produção Configurado\n\n- Projeto Supabase criado\n- Banco de dados provisionado\n- Schemas e tabelas criadas (via SQL Editor)\n- Row-Level Security (RLS) configurado\n- Credenciais de acesso (URL, ANON_KEY, SERVICE_ROLE_KEY)\n\n---\n\n## 🔧 Preparação do Servidor\n\n### Passo 1: Conectar ao Servidor\n\n```bash\n# SSH para o servidor\nssh usuario@seu-servidor.com\n\n# Ou se usa chave privada\nssh -i ~/.ssh/sua-chave.pem usuario@seu-servidor.com\n```\n\n### Passo 2: Criar Estrutura de Diretórios\n\n```bash\n# Navegar para diretório de aplicações\ncd /home/usuario\n\n# Criar diretório do projeto\nmkdir -p sefaz-xml-sync\ncd sefaz-xml-sync\n\n# Criar subdiretórios para volumes Docker\nmkdir -p volumes/{xmls,certificados}\nchmod 755 volumes/{xmls,certificados}\n```\n\n### Passo 3: Transferir Arquivos do Projeto\n\n**Opção A: Via Git (Recomendado)**\n```bash\n# Clone o repositório (se estiver no Git)\ngit clone https://seu-repo/sefaz-xml-sync.git .\n```\n\n**Opção B: Via SCP (Transfer Manual)**\n```bash\n# No seu computador local (não no servidor)\n# Transferir arquivos para servidor\nscp -r ./sefaz-xml-sync/* usuario@seu-servidor:/home/usuario/sefaz-xml-sync/\n```\n\n**Opção C: Via Portainer (Upload Manual)**\n1. Acesse Portainer Web UI\n2. Vá em \"Stacks\" → \"Add Stack\"\n3. Faça upload do `docker-compose.production.yml`\n4. Configure environment variables inline\n\n---\n\n## 🌐 Configuração do Traefik\n\n### Verificar Traefik Existente\n\n```bash\n# Verificar se Traefik está rodando\ndocker ps | grep traefik\n\n# Verificar rede do Traefik\ndocker network ls | grep traefik-proxy\n```\n\n### Se Traefik Ainda NÃO Estiver Configurado\n\n**Criar rede Docker para Traefik:**\n```bash\ndocker network create traefik-proxy\n```\n\n**Criar `docker-compose.traefik.yml`:**\n\n```yaml\nversion: '3.8'\n\nnetworks:\n  traefik-proxy:\n    name: traefik-proxy\n\nservices:\n  traefik:\n    image: traefik:v3.0\n    container_name: traefik\n    restart: unless-stopped\n    \n    command:\n      # API & Dashboard\n      - --api.dashboard=true\n      - --api.insecure=false\n      \n      # Docker Provider\n      - --providers.docker=true\n      - --providers.docker.exposedbydefault=false\n      - --providers.docker.network=traefik-proxy\n      \n      # Entry Points\n      - --entrypoints.web.address=:80\n      - --entrypoints.websecure.address=:443\n      \n      # HTTP → HTTPS Redirect Automático\n      - --entrypoints.web.http.redirections.entryPoint.to=websecure\n      - --entrypoints.web.http.redirections.entryPoint.scheme=https\n      \n      # Let's Encrypt (PRODUÇÃO) - AJUSTE SEU EMAIL!\n      - [email protected]\n      - --certificatesresolvers.leresolver.acme.storage=/letsencrypt/acme.json\n      - --certificatesresolvers.leresolver.acme.httpchallenge.entrypoint=web\n    \n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    \n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - ./letsencrypt:/letsencrypt\n    \n    networks:\n      - traefik-proxy\n```\n\n**Deploy Traefik:**\n```bash\n# Criar diretório para certificados Let's Encrypt\nmkdir -p letsencrypt\ntouch letsencrypt/acme.json\nchmod 600 letsencrypt/acme.json\n\n# IMPORTANTE: acme.json DEVE ter permissão 600!\n\n# Subir Traefik\ndocker compose -f docker-compose.traefik.yml up -d\n\n# Verificar logs\ndocker logs traefik -f\n```\n\n---\n\n## 🚢 Deploy da Aplicação\n\n### Passo 1: Configurar Variáveis de Ambiente\n\n```bash\n# Navegar para diretório do projeto\ncd /home/usuario/sefaz-xml-sync\n\n# Copiar arquivo de exemplo\ncp .env.production.example .env.production\n\n# Editar variáveis (use nano, vim ou vi)\nnano .env.production\n```\n\n**Preencher `.env.production`:**\n```bash\n# ===== OBRIGATÓRIAS =====\nNODE_ENV=production\nPORT=5000\n\n# SUPABASE (pegue no Dashboard do Supabase: Settings → API)\nSUPABASE_URL=https://xxxxx.supabase.co\nSUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ey...\nSUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ey...\n\n# SESSION SECRET (GERE UM NOVO - veja comando abaixo)\nSESSION_SECRET=COLE_AQUI_O_RESULTADO_DO_OPENSSL\n\n# ===== OPCIONAIS =====\nTZ=America/Sao_Paulo\nLOG_LEVEL=info\n```\n\n**Gerar SESSION_SECRET seguro:**\n```bash\nopenssl rand -base64 32\n# Copie o resultado e cole em SESSION_SECRET no .env.production\n```\n\n**Proteger arquivo (IMPORTANTE!):**\n```bash\nchmod 600 .env.production\n\n# Verificar\nls -la .env.production\n# Deve mostrar: -rw------- (apenas owner pode ler/escrever)\n```\n\n### Passo 2: Build da Imagem Docker\n\n```bash\n# Build da imagem de produção\ndocker build -f Dockerfile.production -t sefaz-xml-sync:1.0.0 .\n\n# Isso pode levar 3-5 minutos na primeira vez\n# Verificar imagem criada\ndocker images | grep sefaz-xml-sync\n```\n\n### Passo 3: Deploy com Docker Compose\n\n```bash\n# Subir aplicação em background (-d = detached)\ndocker compose -f docker-compose.production.yml up -d\n\n# Verificar containers rodando\ndocker ps | grep sefaz\n\n# Ver logs em tempo real\ndocker logs sefaz-xml-sync -f\n\n# Pressione Ctrl+C para sair dos logs (container continua rodando)\n```\n\n### Passo 4: Verificar Status Inicial\n\n```bash\n# Ver saúde do container (aguarde ~30 segundos após start)\ndocker inspect sefaz-xml-sync | grep -A 5 Health\n\n# Testar API local (dentro do servidor)\ncurl http://localhost:5000/api/health\n# Deve retornar: {\"status\":\"ok\"}\n\n# Testar via domínio HTTP (Traefik vai redirecionar para HTTPS)\ncurl -L http://downloadsefaz.dibs.com.br/api/health\n# -L = follow redirects\n```\n\n---\n\n## ✅ Verificação e Testes\n\n### 1. Verificar Certificado SSL (Let's Encrypt)\n\n```bash\n# Aguardar ~60-90 segundos para Let's Encrypt provisionar certificado\necho \"Aguardando provisionamento do certificado SSL...\"\nsleep 90\n\n# Testar HTTPS\ncurl -I https://downloadsefaz.dibs.com.br/api/health\n\n# Deve retornar:\n# HTTP/2 200\n# server: nginx (Traefik retorna \"nginx\" internamente)\n```\n\n**Verificar Certificado no Navegador:**\n1. Abrir https://downloadsefaz.dibs.com.br\n2. Clicar no cadeado 🔒 na barra de endereço\n3. Verificar:\n   - ✅ **Emitido por:** Let's Encrypt Authority X3\n   - ✅ **Válido para:** downloadsefaz.dibs.com.br\n   - ✅ **Expira em:** ~90 dias (renovação automática)\n\n### 2. Testar Funcionalidades da Aplicação\n\n**Testes via cURL:**\n```bash\n# Health check da API\ncurl https://downloadsefaz.dibs.com.br/api/health\n\n# Login (exemplo - ajuste conforme sua API)\ncurl -X POST https://downloadsefaz.dibs.com.br/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"[email protected]\",\"password\":\"senha123\"}'\n```\n\n**Testar no Navegador:**\n1. Abrir https://downloadsefaz.dibs.com.br\n2. Criar uma conta / Fazer login\n3. Cadastrar empresa com certificado A1 (.pfx)\n4. Testar sincronização manual\n5. Verificar se XMLs são baixados em `volumes/xmls/`\n\n### 3. Verificar Logs da Aplicação\n\n```bash\n# Logs da aplicação (últimas 100 linhas)\ndocker logs sefaz-xml-sync --tail 100\n\n# Logs em tempo real (Ctrl+C para sair)\ndocker logs sefaz-xml-sync -f\n\n# Logs do Traefik (para debug de certificados)\ndocker logs traefik --tail 100 | grep -i \"certificate\\|acme\"\n\n# Ver logs no Supabase Dashboard\n# Acesse: https://supabase.com/dashboard → Seu Projeto → Logs\n```\n\n### 4. Monitoramento via Portainer\n\n**Via Portainer Web UI:**\n1. Acessar `https://seu-portainer.dominio.com` (ou IP:9000)\n2. Ir em \"Containers\"\n3. Clicar em `sefaz-xml-sync`\n4. Ver métricas: CPU, RAM, I/O, Network, Logs\n\n**Via Docker Stats (CLI):**\n```bash\ndocker stats sefaz-xml-sync\n\n# Exemplo de saída:\n# CONTAINER ID   NAME               CPU %     MEM USAGE / LIMIT     \n# abc123def456   sefaz-xml-sync     2.5%      512MiB / 2GiB\n```\n\n---\n\n## 🔄 Manutenção\n\n### Atualizar Aplicação (Deploy Nova Versão)\n\n```bash\n# 1. Navegar para diretório\ncd /home/usuario/sefaz-xml-sync\n\n# 2. Pull das mudanças (se usar Git)\ngit pull origin main\n\n# 3. Rebuild da imagem com nova tag\ndocker build -f Dockerfile.production -t sefaz-xml-sync:1.0.1 .\n\n# 4. Atualizar docker-compose.yml com nova versão\nnano docker-compose.production.yml\n# Trocar: image: sefaz-xml-sync:1.0.0\n# Para:   image: sefaz-xml-sync:1.0.1\n\n# 5. Recrear container (zero downtime com Traefik)\ndocker compose -f docker-compose.production.yml up -d --force-recreate\n\n# 6. Verificar logs\ndocker logs sefaz-xml-sync -f\n\n# 7. Limpar imagens antigas\ndocker image prune -a\n```\n\n### Backup de Dados\n\n**Backup de XMLs e Certificados:**\n```bash\n# Criar diretório de backups\nmkdir -p /backup/sefaz\n\n# Backup de XMLs (compactado)\ntar -czf /backup/sefaz/xmls-backup-$(date +%Y%m%d-%H%M%S).tar.gz \\\n  volumes/xmls/\n\n# Backup de certificados (compactado)\ntar -czf /backup/sefaz/certificados-backup-$(date +%Y%m%d-%H%M%S).tar.gz \\\n  volumes/certificados/\n\n# Copiar para local seguro (exemplo: outro servidor)\nscp /backup/sefaz/*.tar.gz usuario@backup-server:/backups/sefaz/\n\n# Limpar backups antigos (manter últimos 7 dias)\nfind /backup/sefaz -name \"*.tar.gz\" -mtime +7 -delete\n```\n\n**Backup do Banco de Dados (Supabase):**\n1. Acessar Supabase Dashboard: https://supabase.com/dashboard\n2. Ir em seu projeto → \"Database\" → \"Backups\"\n3. Clicar em \"Create backup\" (backup manual)\n4. Configurar backup automático diário (recomendado)\n\n**Criar Script de Backup Automático:**\n```bash\n# Criar script\nnano /usr/local/bin/backup-sefaz.sh\n```\n\n```bash\n#!/bin/bash\n# Script de Backup Automático - SEFAZ XML Sync\n\nBACKUP_DIR=\"/backup/sefaz\"\nPROJECT_DIR=\"/home/usuario/sefaz-xml-sync\"\nDATE=$(date +%Y%m%d-%H%M%S)\n\nmkdir -p $BACKUP_DIR\n\n# Backup XMLs\ntar -czf $BACKUP_DIR/xmls-$DATE.tar.gz $PROJECT_DIR/volumes/xmls/\n\n# Backup Certificados\ntar -czf $BACKUP_DIR/certificados-$DATE.tar.gz $PROJECT_DIR/volumes/certificados/\n\n# Manter apenas últimos 7 dias\nfind $BACKUP_DIR -type f -name \"*.tar.gz\" -mtime +7 -delete\n\necho \"Backup realizado: $DATE\" >> /var/log/backup-sefaz.log\n```\n\n```bash\n# Tornar executável\nchmod +x /usr/local/bin/backup-sefaz.sh\n\n# Agendar no crontab (diário às 3h da manhã)\ncrontab -e\n\n# Adicionar linha:\n0 3 * * * /usr/local/bin/backup-sefaz.sh\n```\n\n### Renovação de Certificado SSL\n\n**Traefik renova automaticamente!** ✅  \nLet's Encrypt renova ~30 dias antes de expirar.\n\n**Verificar renovação automática:**\n```bash\n# Ver logs de renovação do Traefik\ndocker logs traefik | grep -i \"renew\\|certificate\"\n\n# Verificar acme.json (contém certificados)\nls -lh letsencrypt/acme.json\n# Tamanho deve ser > 1KB (se 0 bytes, certificado não foi provisionado)\n```\n\n**Forçar renovação manual (se necessário):**\n```bash\n# Parar Traefik\ndocker stop traefik\n\n# Deletar certificado antigo\nrm letsencrypt/acme.json\ntouch letsencrypt/acme.json\nchmod 600 letsencrypt/acme.json\n\n# Reiniciar Traefik (vai reprovisionar certificado)\ndocker start traefik\n\n# Aguardar ~90 segundos e verificar\nsleep 90\ncurl -I https://downloadsefaz.dibs.com.br\n```\n\n### Monitorar Uso de Disco\n\n```bash\n# Verificar uso de disco geral\ndf -h\n\n# Tamanho dos XMLs\ndu -sh /home/usuario/sefaz-xml-sync/volumes/xmls/\n\n# Tamanho dos certificados\ndu -sh /home/usuario/sefaz-xml-sync/volumes/certificados/\n\n# Tamanho total do projeto\ndu -sh /home/usuario/sefaz-xml-sync/\n\n# Limpar imagens Docker antigas (libera espaço)\ndocker system prune -a\n# Confirme com 'y' quando perguntado\n```\n\n---\n\n## 🐛 Troubleshooting\n\n### Problema 1: Container não inicia\n\n```bash\n# Ver logs detalhados (últimas 200 linhas)\ndocker logs sefaz-xml-sync --tail 200\n\n# Verificar variáveis de ambiente\ndocker exec sefaz-xml-sync env | grep -E \"SUPABASE|SESSION|NODE_ENV\"\n\n# Verificar saúde do container\ndocker inspect sefaz-xml-sync | grep -A 10 Health\n\n# Testar build local (sem docker-compose)\ndocker run -it --rm \\\n  --env-file .env.production \\\n  -p 5000:5000 \\\n  sefaz-xml-sync:1.0.0\n```\n\n**Erros Comuns:**\n- ❌ `SUPABASE_URL is not defined` → Falta variável em `.env.production`\n- ❌ `Cannot connect to Supabase` → URL/chaves incorretas\n- ❌ `Port 5000 already in use` → Outro container usando mesma porta\n\n### Problema 2: Certificado SSL não provisiona\n\n```bash\n# Verificar DNS (DEVE apontar para servidor)\nnslookup downloadsefaz.dibs.com.br\n# Resultado DEVE ser o IP do seu servidor\n\n# Verificar portas abertas (80 e 443)\nsudo netstat -tulpn | grep -E ':80|:443'\n\n# Ver logs do Traefik (foco em ACME/Let's Encrypt)\ndocker logs traefik | grep -i \"acme\\|certificate\\|letsencrypt\"\n\n# Verificar acme.json\nls -lh letsencrypt/acme.json\ncat letsencrypt/acme.json | jq .  # Formata JSON (se jq instalado)\n\n# Testar acesso HTTP na porta 80 (necessário para challenge)\ncurl -I http://downloadsefaz.dibs.com.br/.well-known/acme-challenge/test\n```\n\n**Erros Comuns:**\n- ❌ DNS não aponta para servidor → Aguarde propagação DNS (até 48h)\n- ❌ Firewall bloqueia porta 80/443 → Abrir portas no firewall\n- ❌ `acme.json` com permissão errada → Deve ser 600 (`chmod 600`)\n\n**Forçar renovação:**\n```bash\n# Parar Traefik\ndocker stop traefik\n\n# Limpar certificados\nrm letsencrypt/acme.json\ntouch letsencrypt/acme.json\nchmod 600 letsencrypt/acme.json\n\n# Reiniciar Traefik\ndocker start traefik\n\n# Aguardar ~90s e testar\nsleep 90\ncurl -I https://downloadsefaz.dibs.com.br\n```\n\n### Problema 3: Erro de conexão com Supabase\n\n```bash\n# Testar conexão de dentro do container\ndocker exec sefaz-xml-sync wget -O- https://seu-projeto.supabase.co/rest/v1/\n\n# Verificar variáveis (DEVEM estar preenchidas)\ndocker exec sefaz-xml-sync printenv | grep SUPABASE\n\n# Verificar firewall/security groups\n# Servidor DEVE conseguir acessar *.supabase.co\nping seu-projeto.supabase.co\n```\n\n**Soluções:**\n- ✅ Verificar se URL/chaves estão corretas no Supabase Dashboard\n- ✅ Verificar se projeto Supabase não está pausado (plano grátis pausa após inatividade)\n- ✅ Verificar se firewall permite conexões HTTPS saindo (outbound)\n\n### Problema 4: XMLs não são baixados/salvos\n\n```bash\n# Ver logs de sincronização\ndocker logs sefaz-xml-sync | grep -i \"sync\\|download\\|xml\\|sefaz\"\n\n# Verificar volumes montados\ndocker inspect sefaz-xml-sync | grep -A 10 Mounts\n\n# Verificar permissões do volume\nls -la volumes/xmls/\n\n# Acessar container e verificar diretório\ndocker exec -it sefaz-xml-sync sh\nls -la /app/xmls/\nexit\n```\n\n**Soluções:**\n- ✅ Certificado A1 (.pfx) válido e não expirado\n- ✅ Senha do certificado correta\n- ✅ CNPJ cadastrado está correto\n- ✅ Permissões do volume: `chmod 755 volumes/xmls/`\n\n### Problema 5: Alto uso de CPU/RAM\n\n```bash\n# Ver estatísticas em tempo real\ndocker stats sefaz-xml-sync\n\n# Verificar processos dentro do container\ndocker exec sefaz-xml-sync ps aux\n\n# Ver logs para identificar causa\ndocker logs sefaz-xml-sync --tail 500 | grep -i \"error\\|timeout\\|loop\"\n```\n\n**Ajustar Limites (se necessário):**\n\nEditar `docker-compose.production.yml`:\n```yaml\nservices:\n  sefaz-xml-sync:\n    # ... outras configs ...\n    deploy:\n      resources:\n        limits:\n          cpus: '1.0'      # Limite de 1 CPU\n          memory: 1G       # Limite de 1GB RAM\n        reservations:\n          cpus: '0.5'      # Reserva mínima\n          memory: 512M     # Reserva mínima\n```\n\nAplicar mudanças:\n```bash\ndocker compose -f docker-compose.production.yml up -d --force-recreate\n```\n\n### Problema 6: Traefik não roteia para aplicação\n\n```bash\n# Verificar se container está na rede traefik-proxy\ndocker inspect sefaz-xml-sync | grep -A 5 Networks\n\n# Verificar labels do Traefik\ndocker inspect sefaz-xml-sync | grep -A 20 Labels\n\n# Ver routers ativos no Traefik\ndocker exec traefik wget -qO- http://localhost:8080/api/http/routers | jq .\n```\n\n**Soluções:**\n- ✅ Container DEVE estar em `networks: - traefik-proxy`\n- ✅ Labels DEVEM ter `traefik.enable=true`\n- ✅ Certificado resolver DEVE ser `leresolver` (mesmo nome usado no Traefik)\n\n---\n\n## 📊 Checklist Final de Deploy\n\nAntes de considerar deploy completo, verifique:\n\n### Infraestrutura\n- [ ] ✅ DNS `downloadsefaz.dibs.com.br` aponta para IP do servidor\n- [ ] ✅ Portas 80 e 443 abertas no firewall\n- [ ] ✅ Docker e Docker Compose instalados e atualizados\n- [ ] ✅ Traefik rodando: `docker ps | grep traefik`\n- [ ] ✅ Rede `traefik-proxy` criada: `docker network ls`\n\n### Certificados SSL\n- [ ] ✅ `letsencrypt/acme.json` com permissão 600\n- [ ] ✅ Certificado SSL provisionado (aguardar ~90s após primeiro deploy)\n- [ ] ✅ HTTPS funciona: `curl -I https://downloadsefaz.dibs.com.br`\n- [ ] ✅ Cadeado verde 🔒 no navegador\n\n### Aplicação\n- [ ] ✅ `.env.production` configurado com valores reais\n- [ ] ✅ `SESSION_SECRET` gerado com `openssl rand -base64 32`\n- [ ] ✅ Imagem Docker construída: `sefaz-xml-sync:1.0.0`\n- [ ] ✅ Container rodando: `docker ps | grep sefaz`\n- [ ] ✅ Health check OK: `curl https://downloadsefaz.dibs.com.br/api/health`\n- [ ] ✅ Logs sem erros críticos: `docker logs sefaz-xml-sync`\n\n### Funcionalidades\n- [ ] ✅ Login funciona no navegador\n- [ ] ✅ Cadastro de empresa funciona\n- [ ] ✅ Upload de certificado A1 (.pfx) funciona\n- [ ] ✅ Sincronização manual funciona\n- [ ] ✅ XMLs são baixados e salvos em `volumes/xmls/`\n- [ ] ✅ Logs aparecem no Supabase Dashboard\n\n### Backup e Monitoramento\n- [ ] ✅ Script de backup criado: `/usr/local/bin/backup-sefaz.sh`\n- [ ] ✅ Crontab configurado para backup diário\n- [ ] ✅ Backup manual testado e verificado\n- [ ] ✅ Monitoramento via Portainer configurado\n\n---\n\n## 🎉 Deploy Completo!\n\nSua aplicação está rodando em produção com:\n\n✅ **URL:** https://downloadsefaz.dibs.com.br  \n✅ **HTTPS:** Certificado SSL automático (Let's Encrypt)  \n✅ **Renovação:** Automática (Traefik cuida disso)  \n✅ **Backup:** Diário via cron  \n✅ **Monitoramento:** Portainer + Docker Stats  \n✅ **Segurança:** RLS no Supabase, env vars protegidas  \n\n**Próximos Passos Recomendados:**\n1. ✅ Configurar monitoramento externo (Uptime Robot, Pingdom)\n2. ✅ Configurar alertas de erro via email/Slack\n3. ✅ Documentar procedimento de rollback\n4. ✅ Treinar usuários na plataforma\n5. ✅ Configurar backup remoto (AWS S3, Backblaze, etc.)\n\n---\n\n## 📞 Comandos Úteis - Referência Rápida\n\n```bash\n# Ver status geral\ndocker ps -a\ndocker stats\n\n# Logs em tempo real\ndocker logs sefaz-xml-sync -f\ndocker logs traefik -f\n\n# Reiniciar container\ndocker compose -f docker-compose.production.yml restart\n\n# Rebuild completo\ndocker compose -f docker-compose.production.yml down\ndocker build -f Dockerfile.production -t sefaz-xml-sync:1.0.0 .\ndocker compose -f docker-compose.production.yml up -d\n\n# Backup manual\ntar -czf backup-$(date +%Y%m%d).tar.gz volumes/\n\n# Limpar sistema Docker\ndocker system prune -a\n```\n\n---\n\n**Última Atualização:** Novembro 2025  \n**Versão:** 1.0.0  \n**Infraestrutura:** Docker + Traefik + Portainer\n","size_bytes":20144},"URGENTE-APLICAR-MIGRATION-RATE-LIMIT.md":{"content":"# 🚨 URGENTE: Aplicar Migration de Rate Limiting\n\n## ⚠️ PROBLEMA CRÍTICO\n\nSeu sistema está tomando **bloqueio cStat 656 da SEFAZ** a cada sincronização porque o **rate limiting NÃO ESTÁ FUNCIONANDO**.\n\n### 🔍 Causa Raiz\n\nA migration do PostgreSQL **NUNCA foi aplicada** no Supabase Production. Sem a RPC function `increment_and_check_rate_limit`, o sistema:\n\n- ❌ **Ignora completamente** o limite de 20 consultas/hora\n- ❌ **Permite TODAS as consultas** (fail-open quando RPC não existe)\n- ❌ **SEFAZ bloqueia constantemente** com cStat 656\n\n### 📊 Evidência nos Logs\n\n```\n❌ [SupabaseStorage] ERRO CRÍTICO: Migration 'supabase-migration-rate-limit-status.sql' NÃO foi aplicada!\n   → Aplique a migration no Supabase Dashboard antes de usar rate limiting\n   → Rate limiting desabilitado temporariamente (fail-open)\n```\n\n---\n\n## 🚀 SOLUÇÃO IMEDIATA (10 minutos)\n\n### Passo 1: Acessar Supabase Dashboard\n\n1. Abra: https://supabase.com/dashboard\n2. Selecione seu projeto: **[SEU_PROJETO]**\n3. Vá em: **SQL Editor** (ícone de banco de dados no menu lateral)\n\n### Passo 2: Aplicar Migration\n\n1. Clique em **\"New Query\"**\n2. Copie **TODO** o conteúdo do arquivo `supabase-migration-rate-limit-status.sql`\n3. Cole no editor SQL\n4. Clique em **\"Run\"** (ou pressione `Ctrl+Enter`)\n\n**Arquivo a copiar:** `supabase-migration-rate-limit-status.sql`\n\n### Passo 3: Verificar Sucesso\n\nExecute esta query para confirmar:\n\n```sql\n-- Verificar se tabela foi criada\nSELECT COUNT(*) FROM sefaz_rate_limit;\n\n-- Verificar se RPC function existe\nSELECT proname, prosrc \nFROM pg_proc \nWHERE proname = 'increment_and_check_rate_limit';\n\n-- Deve retornar 1 registro com o nome da função\n```\n\n**Resultado esperado:**\n- Tabela `sefaz_rate_limit` existe (retorna 0 linhas - tabela vazia mas existe)\n- Function `increment_and_check_rate_limit` existe (retorna 1 registro)\n\n### Passo 4: Restart da Aplicação\n\n```bash\n# Se estiver rodando localmente (Replit)\n# Apenas reinicie o workflow \"Start application\"\n\n# Se estiver rodando em Docker (produção)\ndocker compose -f docker-compose.production.yml restart sefaz-xml-sync\n\n# Verificar logs\ndocker logs sefaz-xml-sync -f\n```\n\n**Logs esperados após restart:**\n```\n✅ [SupabaseStorage] Rate limit check successful\n✅ [Startup] Rate limiting migration verified\n```\n\n---\n\n## 📝 O Que a Migration Faz\n\n### 1. Cria Tabela `sefaz_rate_limit`\n\n```sql\nCREATE TABLE sefaz_rate_limit (\n  user_id UUID NOT NULL,\n  empresa_id UUID NOT NULL,\n  tipo_operacao VARCHAR NOT NULL,  -- 'consultaChave', 'distribuicaoDFe', 'manifestacao'\n  contador INTEGER NOT NULL DEFAULT 0,\n  janela_inicio TIMESTAMP NOT NULL DEFAULT NOW(),\n  PRIMARY KEY (user_id, empresa_id, tipo_operacao)\n);\n```\n\n**Propósito:** Rastreia quantas consultas cada empresa fez na última hora.\n\n### 2. Cria RPC Function `increment_and_check_rate_limit`\n\n```sql\nCREATE FUNCTION increment_and_check_rate_limit(\n  p_user_id UUID,\n  p_empresa_id UUID,\n  p_tipo_operacao VARCHAR,\n  p_limite INTEGER DEFAULT 20\n) RETURNS BOOLEAN\n```\n\n**Propósito:** \n- Incrementa contador de consultas\n- Reseta automaticamente após 1 hora\n- Retorna `TRUE` se dentro do limite (≤20), `FALSE` se excedeu\n\n### 3. Adiciona Campo `status_nfe` na Tabela `xmls`\n\n```sql\nALTER TABLE xmls ADD COLUMN status_nfe VARCHAR(20) DEFAULT 'autorizada';\n```\n\n**Valores:** `autorizada`, `cancelada`, `denegada`, `inutilizada`\n\n### 4. Limpa Erros Legacy\n\n```sql\nUPDATE xmls\nSET status_download = 'pendente', erro_download = NULL\nWHERE erro_download LIKE '%Rate limit%';\n```\n\n**Propósito:** XMLs que ficaram presos com erro de rate limit voltam a processar.\n\n---\n\n## ✅ Verificação Pós-Migration\n\n### Teste 1: Verificar Tabela\n\n```sql\nSELECT * FROM sefaz_rate_limit LIMIT 5;\n```\n\n**Esperado:** Retorna 0 linhas (tabela vazia inicial) **SEM ERRO**.\n\n### Teste 2: Verificar Function\n\n```sql\nSELECT increment_and_check_rate_limit(\n  '00000000-0000-0000-0000-000000000001'::UUID,\n  '00000000-0000-0000-0000-000000000002'::UUID,\n  'teste',\n  20\n);\n```\n\n**Esperado:** Retorna `TRUE` (primeiro teste, contador=1, dentro do limite).\n\n### Teste 3: Testar Limite\n\n```sql\n-- Executa 21 vezes para testar limite\nSELECT increment_and_check_rate_limit(\n  auth.uid(),\n  '00000000-0000-0000-0000-000000000003'::UUID,\n  'teste_limite',\n  20\n);\n```\n\n**Esperado:** \n- Primeiras 20 execuções retornam `TRUE`\n- 21ª execução retorna `FALSE` (limite excedido)\n\n---\n\n## 🔄 Como Funciona o Rate Limiting\n\n### Fluxo de Consulta SEFAZ\n\n```\n1. Sistema tenta fazer consulta SEFAZ\n   ↓\n2. checkRateLimit(empresaId, \"consultaChave\")\n   ↓\n3. RPC increment_and_check_rate_limit()\n   ├─ Incrementa contador\n   ├─ Verifica se contador ≤ 20\n   └─ Retorna TRUE/FALSE\n   ↓\n4. Se TRUE: Consulta permitida ✅\n5. Se FALSE: Consulta bloqueada ❌ (evita cStat 656)\n```\n\n### Janela de Reset\n\n- **Janela:** 1 hora (60 minutos)\n- **Reset automático:** Após 1 hora, contador volta para 0\n- **Cálculo:** `janela_inicio` armazenado no banco\n\n**Exemplo:**\n```\n10:00 - Primeira consulta → contador = 1\n10:15 - Consulta 20 → contador = 20\n10:16 - Consulta 21 → BLOQUEADA ❌\n11:00 - Janela reseta → contador = 0 ✅\n11:01 - Consulta permitida novamente\n```\n\n---\n\n## 🐛 Troubleshooting\n\n### Erro: \"function does not exist\"\n\n**Causa:** Migration não foi aplicada ou aplicada incorretamente.\n\n**Solução:**\n1. Verifique se executou **TODO** o SQL de `supabase-migration-rate-limit-status.sql`\n2. Confirme que está usando o **projeto correto** no Supabase Dashboard\n3. Execute query de verificação:\n   ```sql\n   SELECT proname FROM pg_proc WHERE proname LIKE '%rate_limit%';\n   ```\n\n### Erro: \"permission denied for function\"\n\n**Causa:** Faltam permissões no Supabase.\n\n**Solução:** Re-execute esta parte da migration:\n```sql\nREVOKE ALL ON FUNCTION increment_and_check_rate_limit FROM PUBLIC;\nGRANT EXECUTE ON FUNCTION increment_and_check_rate_limit TO service_role;\n```\n\n### Erro: \"table sefaz_rate_limit already exists\"\n\n**Causa:** Migration foi parcialmente aplicada.\n\n**Solução:** \n1. Drop e recrie:\n   ```sql\n   DROP TABLE IF EXISTS sefaz_rate_limit CASCADE;\n   ```\n2. Execute a migration novamente (ela já tem DROP IF EXISTS)\n\n### Sistema ainda tomando cStat 656\n\n**Possíveis causas:**\n\n1. **Migration não aplicada:**\n   ```bash\n   # Verificar logs\n   docker logs sefaz-xml-sync | grep \"ERRO CRÍTICO\"\n   ```\n\n2. **Múltiplos sistemas consultando mesmo CNPJ:**\n   - ERP/contador consultando simultaneamente\n   - Solução: Desative outros sistemas temporariamente\n\n3. **Backlog muito grande:**\n   - Muitos XMLs pendentes de download\n   - Solução: Processar em lotes menores\n\n4. **Sincronização muito frequente:**\n   - Cron rodando a cada 5 minutos (padrão)\n   - Solução: Aumentar intervalo temporariamente\n\n---\n\n## 📊 Monitoramento Pós-Migration\n\n### Query 1: Ver Uso Atual de Rate Limit\n\n```sql\nSELECT \n  e.razao_social,\n  r.tipo_operacao,\n  r.contador,\n  r.janela_inicio,\n  (20 - r.contador) AS consultas_restantes,\n  (r.janela_inicio + INTERVAL '1 hour') AS reset_em\nFROM sefaz_rate_limit r\nJOIN empresas e ON e.id = r.empresa_id\nORDER BY r.contador DESC;\n```\n\n### Query 2: Empresas Próximas do Limite\n\n```sql\nSELECT \n  e.razao_social,\n  r.tipo_operacao,\n  r.contador,\n  CASE \n    WHEN r.contador >= 20 THEN 'LIMITE ATINGIDO ⛔'\n    WHEN r.contador >= 15 THEN 'PRÓXIMO DO LIMITE ⚠️'\n    ELSE 'OK ✅'\n  END AS status\nFROM sefaz_rate_limit r\nJOIN empresas e ON e.id = r.empresa_id\nWHERE r.contador >= 15\nORDER BY r.contador DESC;\n```\n\n### Query 3: Histórico de Bloqueios SEFAZ\n\n```sql\nSELECT \n  e.razao_social,\n  l.mensagem,\n  l.created_at\nFROM logs l\nJOIN empresas e ON e.id = l.empresa_id\nWHERE l.mensagem LIKE '%656%'\nORDER BY l.created_at DESC\nLIMIT 20;\n```\n\n---\n\n## 🎯 Resultados Esperados\n\nApós aplicar a migration corretamente:\n\n✅ **Rate limiting funcionando**\n- Sistema respeita limite de 20 consultas/hora\n- Logs mostram: `Rate limit OK` ou `Rate limit excedido`\n\n✅ **Sem bloqueios cStat 656**\n- SEFAZ não bloqueia mais (ou muito raramente)\n- Sincronizações completam com sucesso\n\n✅ **Logs limpos**\n- Sem erro: \"ERRO CRÍTICO: Migration não aplicada\"\n- Logs mostram contadores de rate limit\n\n✅ **XMLs processados gradualmente**\n- Downloads respeitam janela de 1 hora\n- Não há burst de 50+ consultas de uma vez\n\n---\n\n## ⏱️ Timeline Esperada\n\n| Tempo | Ação | Status |\n|-------|------|--------|\n| T+0min | Aplicar migration no Supabase | ⏳ |\n| T+1min | Verificar tabela/function criadas | ✅ |\n| T+2min | Restart aplicação | ⏳ |\n| T+3min | Verificar logs (sem erro \"ERRO CRÍTICO\") | ✅ |\n| T+5min | Primeira sincronização com rate limit | ✅ |\n| T+10min | Confirmar sem bloqueio cStat 656 | ✅ |\n| T+1hora | Janela reseta, contador volta para 0 | ✅ |\n\n---\n\n## 📞 Próximos Passos\n\n1. **APLICAR MIGRATION AGORA** (10 minutos)\n2. **Verificar se funcionou** (query de teste)\n3. **Restart da aplicação** (Docker ou Replit)\n4. **Monitorar logs** (30 minutos)\n5. **Confirmar sucesso** (sem cStat 656)\n\n---\n\n## 🚨 IMPORTANTE\n\n**NÃO ignore esta migration!**\n\nSem o rate limiting funcionando, você vai:\n- ❌ Tomar bloqueio cStat 656 constantemente\n- ❌ Empresa bloqueada por 1 hora a cada sync\n- ❌ XMLs não serão baixados\n- ❌ Sistema inutilizado\n\n**COM a migration aplicada:**\n- ✅ Rate limiting automático\n- ✅ Máximo 20 consultas/hora respeitado\n- ✅ Sem bloqueios SEFAZ\n- ✅ Sistema funcionando 24/7\n\n---\n\n**Data:** Novembro 2025  \n**Prioridade:** 🚨 CRÍTICA - APLICAR IMEDIATAMENTE  \n**Tempo:** 10 minutos  \n**Impacto:** Resolve 100% dos bloqueios cStat 656\n","size_bytes":9625},"TESTE-RATE-LIMIT.md":{"content":"# 🧪 TESTE COMPLETO: Rate Limiting Corrigido\n\n**Data:** 22/11/2025  \n**Status:** ✅ Migration SQL aplicada - Pronto para teste\n\n---\n\n## 📋 CHECKLIST PRÉ-TESTE\n\n- [x] Migration SQL aplicada no Supabase Production\n- [x] Função `increment_and_check_rate_limit` corrigida\n- [x] Código TypeScript corrigido (bloqueadoAte persistido)\n- [x] Aplicação reiniciada\n\n---\n\n## 🧪 TESTE 1: Verificar Contadores (Supabase Dashboard)\n\n### Query 1: Ver Contadores Atuais\n\n```sql\nSELECT \n  e.razao_social,\n  r.contador,\n  (20 - r.contador) AS consultas_restantes,\n  CASE \n    WHEN r.contador >= 20 THEN '⚠️ NO LIMITE'\n    ELSE '✅ LIBERADO'\n  END AS status\nFROM sefaz_rate_limit r\nJOIN empresas e ON e.id = r.empresa_id\nWHERE r.tipo_operacao = 'distribuicaoDFe';\n```\n\n**Esperado:** Nenhum contador acima de 20\n\n### Query 2: Verificar Se Há Bug (contadores > 20)\n\n```sql\nSELECT COUNT(*) AS total_acima_limite, MAX(contador) AS contador_max\nFROM sefaz_rate_limit\nWHERE contador > 20;\n```\n\n**Esperado:** \n```\ntotal_acima_limite | contador_max\n-------------------|-------------\n0                  | NULL ou 20\n```\n\n---\n\n## 🧪 TESTE 2: Simular Rate Limit (Supabase Dashboard)\n\n**Copie TODO o script de `monitor-rate-limit.sql` e execute no SQL Editor**\n\nO teste #6 vai:\n1. Pegar primeira empresa\n2. Verificar contador atual\n3. Chamar `increment_and_check_rate_limit()`\n4. Verificar se incrementou corretamente\n\n**Resultados esperados:**\n\n### Se contador < 20:\n```\n✅ CORRETO: Incrementou corretamente (abaixo do limite)\nContador ANTES:  15\nPode consultar:  true\nContador DEPOIS: 16\n```\n\n### Se contador = 20:\n```\n✅ CORRETO: NÃO incrementou quando já no limite\nContador ANTES:  20\nPode consultar:  false\nContador DEPOIS: 20  ← NÃO mudou!\n```\n\n### Se aparecer erro:\n```\n❌ BUG: Incrementou mesmo estando no limite!\n```\n→ Migration não foi aplicada corretamente\n\n---\n\n## 🧪 TESTE 3: Trigger Sincronização Real\n\n### Opção A: Via Interface Web\n\n1. Abrir aplicação: https://downloadsefaz.dibs.com.br (ou localhost:5000)\n2. Fazer login\n3. Ir em \"Empresas\"\n4. Clicar \"Sincronizar\" em uma empresa\n5. Aguardar alguns segundos\n6. Clicar \"Sincronizar\" novamente (repetir até atingir 20 consultas)\n\n### Opção B: Via API\n\n```bash\n# Substitua {TOKEN} pelo seu JWT token\n# Substitua {EMPRESA_ID} pelo ID da empresa\n\n# Trigger manual (repetir 25 vezes para testar limite)\nfor i in {1..25}; do\n  echo \"Tentativa $i...\"\n  curl -X POST https://downloadsefaz.dibs.com.br/api/empresas/{EMPRESA_ID}/sincronizar \\\n    -H \"Authorization: Bearer {TOKEN}\" \\\n    -H \"Content-Type: application/json\"\n  sleep 2\ndone\n```\n\n### O Que Observar:\n\n**Consultas 1-20:**\n- ✅ Sincronização executa normalmente\n- ✅ XMLs são baixados\n- ✅ Logs mostram \"Sincronização - Consultando SEFAZ\"\n\n**Consulta 21:**\n- ✅ Sincronização para\n- ✅ Log mostra: `\"Rate limit atingido - Bloqueado até [HORÁRIO]\"`\n- ✅ Empresa fica com `bloqueadoAte` setado\n\n**Consultas 22-25 (nos próximos minutos):**\n- ✅ Cron automático PULA empresa bloqueada\n- ✅ Nenhuma nova consulta SEFAZ é feita\n- ✅ Contador permanece em 20 (NÃO sobe para 21, 22, 23...)\n\n---\n\n## 🧪 TESTE 4: Monitorar Logs em Tempo Real\n\n### Query 1: Ver Últimos Logs de Rate Limit\n\n```sql\nSELECT \n  created_at AT TIME ZONE 'America/Sao_Paulo' AS horario,\n  e.razao_social,\n  l.mensagem,\n  l.detalhes->>'proximaConsultaHorarioBrasil' AS proxima_consulta\nFROM logs l\nJOIN empresas e ON e.id = l.empresa_id\nWHERE l.mensagem LIKE '%Rate limit%'\nORDER BY l.created_at DESC\nLIMIT 5;\n```\n\n**Esperado (quando atingir limite):**\n```\nhorario              | mensagem                                | proxima_consulta\n---------------------|----------------------------------------|-------------------\n2025-11-22 14:30:00  | Rate limit atingido - Bloqueado até... | 22/11/2025 15:35:00\n```\n\n### Query 2: Ver Empresas Bloqueadas\n\n```sql\nSELECT \n  e.razao_social,\n  e.bloqueado_ate AT TIME ZONE 'America/Sao_Paulo' AS bloqueio_ate,\n  EXTRACT(EPOCH FROM (e.bloqueado_ate - NOW())) / 60 AS minutos_restantes,\n  r.contador\nFROM empresas e\nLEFT JOIN sefaz_rate_limit r ON r.empresa_id = e.id\nWHERE e.bloqueado_ate > NOW();\n```\n\n**Esperado:**\n```\nrazao_social    | bloqueio_ate        | minutos_restantes | contador\n----------------|---------------------|-------------------|----------\nEmpresa Teste   | 2025-11-22 15:35:00 | 58.5              | 20\n```\n\n---\n\n## 🧪 TESTE 5: Aguardar Reset (1 hora depois)\n\n**Após 65 minutos do bloqueio:**\n\n### Query: Verificar Reset Automático\n\n```sql\nSELECT \n  e.razao_social,\n  r.contador AS contador_atual,\n  r.janela_inicio AT TIME ZONE 'America/Sao_Paulo' AS nova_janela,\n  e.bloqueado_ate AT TIME ZONE 'America/Sao_Paulo' AS bloqueio,\n  CASE \n    WHEN e.bloqueado_ate IS NULL OR e.bloqueado_ate < NOW() THEN '✅ DESBLOQUEADO'\n    ELSE '🔒 BLOQUEADO'\n  END AS status\nFROM empresas e\nLEFT JOIN sefaz_rate_limit r ON r.empresa_id = e.id AND r.tipo_operacao = 'distribuicaoDFe'\nWHERE e.id = '{EMPRESA_ID}';\n```\n\n**Esperado:**\n```\nrazao_social    | contador_atual | status\n----------------|----------------|---------------\nEmpresa Teste   | 0              | ✅ DESBLOQUEADO\n```\n\n**Trigger nova sincronização:**\n- Clicar \"Sincronizar\" novamente\n- Verificar que executa normalmente\n- Contador começa de 0 novamente\n\n---\n\n## ✅ CRITÉRIOS DE SUCESSO\n\n| Item | Status | Descrição |\n|------|--------|-----------|\n| **Contador max = 20** | ⬜ | Nenhum contador acima de 20 no banco |\n| **RPC não incrementa** | ⬜ | Teste #6 mostra \"NÃO incrementou quando já no limite\" |\n| **bloqueadoAte persiste** | ⬜ | Campo bloqueado_ate é setado quando limite atinge |\n| **Cron respeita bloqueio** | ⬜ | Não tenta sincronizar empresas bloqueadas |\n| **Reset automático** | ⬜ | Após 1h, contador volta para 0 |\n| **Sincronização retoma** | ⬜ | Após reset, sincronização funciona normalmente |\n\n---\n\n## ❌ TROUBLESHOOTING\n\n### Problema 1: Contador Ainda Sobe Acima de 20\n\n**Sintoma:**\n```sql\nSELECT MAX(contador) FROM sefaz_rate_limit;\n-- Retorna: 21, 22, 23...\n```\n\n**Causa:** Migration SQL não foi aplicada corretamente\n\n**Solução:**\n```sql\n-- Verificar se função foi realmente atualizada\nSELECT pg_get_functiondef(oid) \nFROM pg_proc \nWHERE proname = 'increment_and_check_rate_limit';\n\n-- Se ainda tiver UPSERT (INSERT...ON CONFLICT), reaplicar migration\n```\n\n### Problema 2: Logs Não Mostram bloqueadoAte\n\n**Sintoma:** Log mostra \"Rate limit atingido\" mas sem horário de desbloqueio\n\n**Causa:** Código TypeScript antigo ainda em cache\n\n**Solução:**\n```bash\n# Replit: Restart workflow\n# Docker: docker compose restart sefaz-xml-sync\n```\n\n### Problema 3: cStat 656 Mesmo Com Contador < 20\n\n**Sintoma:** Erro 656 da SEFAZ mas contador está em 15\n\n**Causa:** Outro sistema (ERP, contador) consultando o mesmo CNPJ\n\n**Solução:** \n- Desativar temporariamente outros sistemas\n- Verificar se não há múltiplas instâncias da aplicação rodando\n\n---\n\n## 📊 RESULTADO ESPERADO FINAL\n\n```\n15:00 - Sincronização inicia (contador = 0)\n  ├─ 15:00:10 - Consulta 1-5   → ✅ OK (contador = 5)\n  ├─ 15:00:45 - Consulta 6-10  → ✅ OK (contador = 10)\n  ├─ 15:01:20 - Consulta 11-15 → ✅ OK (contador = 15)\n  ├─ 15:01:55 - Consulta 16-20 → ✅ OK (contador = 20)\n  └─ 15:02:30 - Consulta 21    → ❌ BLOQUEADO até 16:05\n\n15:05 - Cron automático:\n  └─ Empresa bloqueada → PULA (não consulta)\n\n15:10 - Cron automático:\n  └─ Empresa bloqueada → PULA (não consulta)\n\n16:05 - Bloqueio expira:\n  ├─ Contador resetado → 0\n  └─ Empresa desbloqueada\n\n16:06 - Próximo cron:\n  └─ Sincronização retoma → ✅ OK\n```\n\n---\n\n## 📝 RELATÓRIO DE TESTE\n\nApós executar todos os testes, preencha:\n\n```\nData/Hora do Teste: _______________________\nEmpresa Testada: __________________________\n\nTESTE 1 - Contadores: ☐ PASSOU  ☐ FALHOU\nTESTE 2 - RPC:        ☐ PASSOU  ☐ FALHOU\nTESTE 3 - Sinc Real:  ☐ PASSOU  ☐ FALHOU\nTESTE 4 - Logs:       ☐ PASSOU  ☐ FALHOU\nTESTE 5 - Reset:      ☐ PASSOU  ☐ FALHOU\n\nObservações:\n_____________________________________________\n_____________________________________________\n```\n\n---\n\n**Próximo passo:** Execute os testes e me informe os resultados! 🚀\n","size_bytes":8244},"CORREÇÃO-DEFINITIVA-RATE-LIMIT.md":{"content":"# ✅ CORREÇÃO DEFINITIVA: Rate Limiting cStat 656\n\n**Data:** 22 de Novembro de 2025  \n**Status:** ✅ **CORREÇÃO COMPLETA - REQUER AÇÃO**\n\n---\n\n## 🎯 PROBLEMA IDENTIFICADO PELO ARCHITECT\n\nVocê estava certo sobre a **função RPC existir**! Mas havia **2 BUGS CRÍTICOS**:\n\n### ❌ BUG 1: RPC Incrementava MESMO Retornando FALSE\n\n**Problema:**\n```typescript\n// RPC com bug (versão antiga):\nINSERT ... ON CONFLICT DO UPDATE SET contador = contador + 1  // ← Sempre incrementa!\nRETURNING contador;\nreturn (contador <= 20);  // Retorna true/false DEPOIS de incrementar\n\n// Resultado:\nConsulta 20: contador = 20 → TRUE ✅\nConsulta 21: contador = 21 → FALSE ❌ (mas já incrementou!)\nConsulta 22: contador = 22 → FALSE ❌ (incrementa de novo!)\nConsulta 23: contador = 23 → FALSE ❌ (incrementa de novo!)\n```\n\n**Consequência:**  \nContador subia para 21, 22, 23... e nunca resetava corretamente.\n\n### ❌ BUG 2: Não Persistia Bloqueio no Banco\n\n**Problema:**\n```typescript\n// Código com bug (versão antiga):\nif (!podeConsultar) {\n  break;  // ← Apenas para o loop, NÃO bloqueia no banco!\n}\n\n// Resultado:\n10:00 - Atinge rate limit → break (para loop)\n10:05 - Cron automático tenta de novo → incrementa contador\n10:10 - Cron tenta de novo → incrementa contador\n```\n\n**Consequência:**  \nSistema tentava sincronizar a cada 5-10 minutos, incrementando contador sem parar.\n\n---\n\n## ✅ CORREÇÃO APLICADA\n\n### 1️⃣ SQL: RPC Corrigida (REQUER APLICAR NO SUPABASE)\n\n**Arquivo:** `supabase-migration-fix-rate-limit-increment.sql`\n\n```sql\n-- Verifica ANTES de incrementar\nSELECT contador INTO v_contador FROM sefaz_rate_limit WHERE ...;\n\n-- Se não existe, cria com contador = 1\nIF v_contador IS NULL THEN\n  INSERT ... contador = 1;\n  RETURN TRUE;\nEND IF;\n\n-- Se já está no limite, retorna FALSE SEM incrementar\nIF v_contador >= p_limite THEN\n  RETURN FALSE;  -- ← NÃO incrementa!\nEND IF;\n\n-- Só incrementa se está abaixo do limite\nUPDATE sefaz_rate_limit SET contador = contador + 1;\nRETURN TRUE;\n```\n\n### 2️⃣ TypeScript: Persistir Bloqueio (JÁ APLICADO)\n\n**Código corrigido:**\n```typescript\nif (!podeConsultar) {\n  // NOVO: Persiste bloqueio de 65min\n  const bloqueadoAte = criarBloqueio(65);\n  await storage.updateEmpresa(empresa.id, { bloqueadoAte }, empresa.userId);\n  \n  // Log com horário de desbloqueio\n  await storage.createLog({\n    mensagem: `Rate limit atingido - Bloqueado até ${horarioBrasil}`,\n    detalhes: { \n      bloqueadoAte, \n      acaoAutomatica: \"Sistema bloqueado por 65min\" \n    }\n  });\n  \n  break;\n}\n```\n\n**Locais corrigidos:**\n- ✅ `sincronizarEmpresa()` - linha 1789\n- ✅ `reconciliarUltimoNSU()` - linha 2256\n- ✅ `buscarPorPeriodo()` - linha 2590\n\n---\n\n## 🚀 AÇÃO NECESSÁRIA: APLICAR MIGRATION SQL\n\n### Passo 1: Abrir Supabase Dashboard\n\n1. Acesse: https://supabase.com/dashboard\n2. Selecione seu projeto\n3. Menu lateral → **SQL Editor**\n\n### Passo 2: Executar Migration\n\n1. Copie **TODO** o conteúdo de: `supabase-migration-fix-rate-limit-increment.sql`\n2. Cole no SQL Editor\n3. Clique em **RUN** (ou pressione Ctrl+Enter)\n\n**Você deve ver:**\n```\n✅ Fix aplicado: increment_and_check_rate_limit corrigido\n   - Agora verifica ANTES de incrementar\n   - Não incrementa quando já no limite\n   - Contadores > 20 foram resetados para 20\n```\n\n### Passo 3: Verificar Sucesso\n\nExecute no SQL Editor:\n```sql\n-- Verificar se função foi atualizada\nSELECT routine_name, routine_definition \nFROM information_schema.routines \nWHERE routine_name = 'increment_and_check_rate_limit';\n\n-- Verificar contadores (devem estar <= 20)\nSELECT * FROM sefaz_rate_limit;\n```\n\n---\n\n## 📊 COMPORTAMENTO APÓS CORREÇÃO\n\n### ✅ Cenário Correto\n\n```\n10:00 - Sincronização inicia (contador = 0)\n  ├─ Consulta 1:  RPC verifica (0 < 20) → incrementa → TRUE ✅\n  ├─ Consulta 2:  RPC verifica (1 < 20) → incrementa → TRUE ✅\n  ├─ ...\n  ├─ Consulta 20: RPC verifica (19 < 20) → incrementa → TRUE ✅\n  ├─ Consulta 21: RPC verifica (20 >= 20) → NÃO incrementa → FALSE ❌\n  └─ Sistema seta bloqueadoAte = 10:00 + 65min = 11:05\n\n10:05 - Cron automático verifica:\n  └─ Empresa bloqueada até 11:05 → PULA (não tenta sincronizar)\n\n11:05 - Bloqueio expira\n  └─ Janela de 1h resetou → contador volta para 0\n\n11:06 - Próximo cron sincroniza:\n  ├─ Empresa desbloqueada ✅\n  ├─ Contador resetado (0) ✅\n  └─ Sincronização retoma do NSU onde parou ✅\n```\n\n---\n\n## 🧪 TESTE COMPLETO\n\n### 1. Aplicar Migration SQL (Supabase Dashboard)\n\nExecutar: `supabase-migration-fix-rate-limit-increment.sql`\n\n### 2. Restart Aplicação (Replit)\n\n**Já feito!** ✅ Workflow reiniciado com código corrigido.\n\n### 3. Trigger Sincronização Manual\n\n**Via Interface:**\n```\n1. Abrir: http://localhost:5000 (ou seu domínio)\n2. Ir em \"Empresas\"\n3. Clicar \"Sincronizar\" em uma empresa\n```\n\n**Via API:**\n```bash\ncurl -X POST http://localhost:5000/api/empresas/{EMPRESA_ID}/sincronizar \\\n  -H \"Authorization: Bearer {TOKEN}\"\n```\n\n### 4. Monitorar Logs\n\n**Query 1: Ver Contador Rate Limit**\n```sql\nSELECT \n  e.razao_social,\n  r.contador,\n  (20 - r.contador) AS consultas_restantes,\n  r.janela_inicio AT TIME ZONE 'America/Sao_Paulo' AS inicio_brasilia,\n  e.bloqueado_ate AT TIME ZONE 'America/Sao_Paulo' AS bloqueio_brasilia\nFROM sefaz_rate_limit r\nJOIN empresas e ON e.id = r.empresa_id\nWHERE r.tipo_operacao = 'distribuicaoDFe';\n```\n\n**Esperado:**\n```\nrazao_social    | contador | consultas_restantes | bloqueio_brasilia\n----------------|----------|---------------------|-------------------\nEmpresa Teste   | 20       | 0                   | 2025-11-22 11:05:00\n```\n\n**Query 2: Logs Recentes**\n```sql\nSELECT \n  created_at AT TIME ZONE 'America/Sao_Paulo' AS horario,\n  mensagem,\n  detalhes->>'proximaConsultaHorarioBrasil' AS proximo_horario\nFROM logs\nWHERE mensagem LIKE '%Rate limit%'\nORDER BY created_at DESC\nLIMIT 5;\n```\n\n**Esperado:**\n```\nhorario              | mensagem\n---------------------|-----------------------------------------------\n2025-11-22 10:00:00  | Rate limit atingido - Bloqueado até 22/11/2025 11:05:00\n```\n\n---\n\n## ❌ SE AINDA BLOQUEAR (Troubleshooting)\n\n### Diagnóstico 1: Migration SQL NÃO Foi Aplicada\n\n**Sintoma:** Contador ainda sobe acima de 20\n\n**Verificar:**\n```sql\nSELECT contador FROM sefaz_rate_limit WHERE contador > 20;\n-- Se retornar linhas → migration NÃO foi aplicada\n```\n\n**Solução:** Aplicar `supabase-migration-fix-rate-limit-increment.sql` no Supabase\n\n### Diagnóstico 2: Restart NÃO Foi Feito\n\n**Sintoma:** Logs não mostram `bloqueadoAte`\n\n**Solução:**\n```bash\n# Replit: Restart workflow \"Start application\"\n# Docker: docker compose restart sefaz-xml-sync\n```\n\n### Diagnóstico 3: Concorrência Externa\n\n**Sintoma:** cStat 656 mesmo com contador < 20\n\n**Causa:** Outro sistema (ERP, contador) consultando o mesmo CNPJ\n\n**Solução:** Desativar temporariamente outros sistemas\n\n---\n\n## 📋 CHECKLIST DE VERIFICAÇÃO\n\n- [ ] Migration SQL aplicada no Supabase Dashboard\n- [ ] Função `increment_and_check_rate_limit` atualizada\n- [ ] Contadores > 20 resetados para 20\n- [ ] Aplicação reiniciada (workflow restart)\n- [ ] Sincronização manual testada\n- [ ] Logs mostram `bloqueadoAte` quando rate limit atinge\n- [ ] Contador NÃO sobe acima de 20\n- [ ] Sistema aguarda 65min antes de retry\n- [ ] Após 1h, janela reseta e sincronização retoma\n\n---\n\n## ✅ RESUMO\n\n| Componente | Status | Ação |\n|------------|--------|------|\n| **RPC SQL** | ⚠️ REQUER APLICAR | Executar `supabase-migration-fix-rate-limit-increment.sql` no Supabase |\n| **Código TypeScript** | ✅ APLICADO | 3 métodos corrigidos + restart feito |\n| **Teste** | 🧪 AGUARDANDO | Após aplicar SQL, testar sincronização |\n\n---\n\n## 🎯 PRÓXIMO PASSO\n\n**APLIQUE A MIGRATION SQL AGORA:**\n\n1. Copie todo conteúdo de `supabase-migration-fix-rate-limit-increment.sql`\n2. Supabase Dashboard → SQL Editor → Cole → RUN\n3. Me avise quando terminar para monitorarmos juntos ✅\n\n---\n\n**Correção implementada em:** 22/11/2025  \n**Arquivos criados:** `supabase-migration-fix-rate-limit-increment.sql`, `CORREÇÃO-DEFINITIVA-RATE-LIMIT.md`  \n**Código corrigido:** `server/sefaz-service.ts` (linhas 1789, 2256, 2590)  \n**Aguardando:** Aplicação da migration SQL no Supabase Production\n","size_bytes":8330},"FIX-CSTAT-656-RATE-LIMITING.md":{"content":"# ✅ CORREÇÃO: cStat 656 - Rate Limiting Implementado\n\n**Data:** 22 de Novembro de 2025  \n**Status:** ✅ **CORRIGIDO E PRONTO PARA TESTE**\n\n---\n\n## 🎯 PROBLEMA IDENTIFICADO\n\nVocê estava correto! A função `increment_and_check_rate_limit` **JÁ EXISTIA** no Supabase Production.\n\nO problema real era:\n- **Rate limiting NÃO estava sendo verificado** durante as sincronizações SEFAZ\n- Métodos faziam loops de até 200 consultas **SEM** verificar o limite de 20/hora\n- SEFAZ bloqueava com cStat 656 após ~20 consultas\n\n---\n\n## 🔍 ANÁLISE TÉCNICA\n\n### ❌ Código ANTES (SEM rate limiting)\n\n```typescript\n// server/sefaz-service.ts - sincronizarEmpresa()\nfor (let iteracao = 0; iteracao < MAX_ITERACOES; iteracao++) {\n  const envelope = this.buildSOAPEnvelopeDistNSU(...);\n  responseXml = await this.callDistDFe(empresa, envelope); // ❌ Sem verificar rate limit!\n  // ... processa resposta\n}\n```\n\n**Resultado:** Sistema fazia múltiplas consultas SEFAZ sem respeitar limite → cStat 656\n\n### ✅ Código DEPOIS (COM rate limiting)\n\n```typescript\n// server/sefaz-service.ts - sincronizarEmpresa()\nfor (let iteracao = 0; iteracao < MAX_ITERACOES; iteracao++) {\n  // CRÍTICO: Verifica rate limit ANTES de consultar SEFAZ\n  const podeConsultar = await storage.checkRateLimit(empresa.id, \"distribuicaoDFe\", empresa.userId);\n  \n  if (!podeConsultar) {\n    // Log warning e PARA o loop\n    await storage.createLog({\n      nivel: \"warning\",\n      mensagem: `Rate limit atingido - Sincronização pausada`,\n      detalhes: { motivo: \"Limite de 20 consultas/hora atingido\" }\n    });\n    break; // Para aqui - aguarda próxima janela\n  }\n  \n  // Só consulta SEFAZ se rate limit permite\n  const envelope = this.buildSOAPEnvelopeDistNSU(...);\n  responseXml = await this.callDistDFe(empresa, envelope);\n  // ... processa resposta\n}\n```\n\n**Resultado:** Sistema respeita limite de 20 consultas/hora → **SEM cStat 656**\n\n---\n\n## 🛠️ CORREÇÕES IMPLEMENTADAS\n\n### 1. ✅ `sincronizarEmpresa()` - Linha 1785\n**Arquivo:** `server/sefaz-service.ts`  \n**O que faz:** Sincronização automática (cron 1h) e manual  \n**Correção:** Adicionado `checkRateLimit()` antes de cada consulta no loop  \n\n### 2. ✅ `reconciliarUltimoNSU()` - Linha 2244\n**Arquivo:** `server/sefaz-service.ts`  \n**O que faz:** Alinhamento de NSU com SEFAZ  \n**Correção:** Adicionado `checkRateLimit()` antes de cada consulta no loop  \n\n### 3. ✅ `buscarPorPeriodo()` - Linha 2570\n**Arquivo:** `server/sefaz-service.ts`  \n**O que faz:** Busca avançada por intervalo de NSU  \n**Correção:** Adicionado `checkRateLimit()` antes de cada consulta no loop  \n\n### 4. ✅ `xml-download-service.ts` - Linhas 237 e 298\n**Arquivo:** `server/xml-download-service.ts`  \n**Status:** Já tinha rate limiting implementado (não precisou correção)\n\n---\n\n## 📊 COMPORTAMENTO NOVO\n\n### Fluxo de Sincronização com Rate Limiting\n\n```\n1. Cron executa sincronização automática (1h)\n   ↓\n2. Para cada empresa ativa:\n   ├─ Verifica se bloqueada (cStat 656 anterior)\n   ├─ Se bloqueada → pula (aguarda desbloqueio)\n   └─ Se não bloqueada → inicia sincronização\n   ↓\n3. Loop de consultas SEFAZ:\n   ├─ Iteração 1: checkRateLimit() → TRUE ✅ → Consulta permitida (contador = 1)\n   ├─ Iteração 2: checkRateLimit() → TRUE ✅ → Consulta permitida (contador = 2)\n   ├─ ...\n   ├─ Iteração 20: checkRateLimit() → TRUE ✅ → Consulta permitida (contador = 20)\n   ├─ Iteração 21: checkRateLimit() → FALSE ❌ → Consulta BLOQUEADA\n   └─ Sistema loga warning e PARA o loop\n   ↓\n4. Sincronização pausada (parcial)\n   ↓\n5. Após 1 hora: janela reseta → contador volta para 0\n   ↓\n6. Próximo cron (1h): Sincronização retoma automaticamente ✅\n```\n\n---\n\n## 🧪 TESTE AGORA\n\n### Passo 1: Restart da Aplicação\n\n```bash\n# Se em Replit:\n# Apenas restart workflow \"Start application\" (botão no UI)\n\n# Se em Docker (produção):\ndocker compose -f docker-compose.production.yml restart sefaz-xml-sync\ndocker logs sefaz-xml-sync -f\n```\n\n### Passo 2: Trigger Sincronização Manual\n\n**Opção A - Via Interface:**\n1. Abra aplicação: `http://localhost:5000` (ou seu domínio)\n2. Vá em \"Empresas\"\n3. Clique em \"Sincronizar\" em uma empresa\n\n**Opção B - Via API:**\n```bash\ncurl -X POST http://localhost:5000/api/empresas/{EMPRESA_ID}/sincronizar \\\n  -H \"Authorization: Bearer {SEU_TOKEN}\"\n```\n\n### Passo 3: Monitorar Logs\n\n```bash\n# Verificar logs em tempo real\ndocker logs sefaz-xml-sync -f\n\n# OU via interface web\n# http://localhost:5000 → \"Logs\"\n```\n\n**Logs esperados:**\n\n✅ **Sucesso (rate limiting funcionando):**\n```\n[info] Sincronização - Consultando SEFAZ (iteração 1)\n[info] Sincronização - Resposta SEFAZ (cStat 138)\n...\n[info] Sincronização - Consultando SEFAZ (iteração 20)\n[warning] Rate limit atingido - Sincronização pausada\n[info] Sincronização finalizada com sucesso (parcial)\n```\n\n❌ **Se ainda aparecer cStat 656:**\n```\n[error] cStat=656: Consumo indevido detectado pela SEFAZ\n```\n→ **Possível concorrência**: Outro sistema (ERP/contador) está consultando o mesmo CNPJ  \n→ **Solução**: Verificar se há outros sistemas consultando este CNPJ simultaneamente\n\n---\n\n## 📈 MONITORAMENTO\n\n### Query 1: Ver Contadores de Rate Limit\n\n```sql\nSELECT \n  e.razao_social,\n  r.tipo_operacao,\n  r.contador,\n  (20 - r.contador) AS consultas_restantes,\n  r.janela_inicio,\n  (r.janela_inicio + INTERVAL '1 hour') AS reset_em\nFROM sefaz_rate_limit r\nJOIN empresas e ON e.id = r.empresa_id\nORDER BY r.contador DESC;\n```\n\n**Interpretação:**\n- `contador = 0`: Janela resetou recentemente (ou primeira consulta)\n- `contador < 20`: Dentro do limite (pode consultar)\n- `contador = 20`: Limite atingido (aguardando reset)\n- `reset_em`: Horário que contador volta para 0\n\n### Query 2: Verificar Bloqueios Atuais\n\n```sql\nSELECT \n  id,\n  razao_social,\n  bloqueado_ate,\n  CASE \n    WHEN bloqueado_ate > NOW() THEN 'BLOQUEADO ⛔'\n    ELSE 'DESBLOQUEADO ✅'\n  END AS status,\n  CASE \n    WHEN bloqueado_ate > NOW() THEN \n      EXTRACT(EPOCH FROM (bloqueado_ate - NOW())) / 60\n    ELSE 0\n  END AS minutos_restantes\nFROM empresas\nWHERE bloqueado_ate IS NOT NULL\nORDER BY bloqueado_ate DESC;\n```\n\n### Query 3: Histórico de Rate Limits (últimas 24h)\n\n```sql\nSELECT \n  e.razao_social,\n  l.created_at,\n  l.mensagem,\n  l.detalhes\nFROM logs l\nJOIN empresas e ON e.id = l.empresa_id\nWHERE l.mensagem LIKE '%Rate limit%'\n  AND l.created_at > NOW() - INTERVAL '24 hours'\nORDER BY l.created_at DESC;\n```\n\n---\n\n## ⚠️ TROUBLESHOOTING\n\n### Problema: Ainda toma cStat 656\n\n**Causa 1: Concorrência com Outro Sistema**\n- ERP, sistema do contador, ou outro app consultando o mesmo CNPJ\n- **Solução:** Desative temporariamente outros sistemas e teste\n\n**Causa 2: Backlog Muito Grande**\n- Muitos XMLs pendentes de download\n- **Solução:** Sistema vai processar gradualmente (respeitando 20/hora)\n\n**Causa 3: Sincronização Manual Repetida**\n- Usuário clicando \"Sincronizar\" múltiplas vezes\n- **Solução:** Aguardar cron automático (1h)\n\n### Problema: Rate Limit Sempre em 0\n\n**Diagnóstico:**\n```sql\nSELECT * FROM sefaz_rate_limit;\n-- Se retornar 0 linhas → nunca foi usado\n-- Se retornar linhas → sistema está usando\n```\n\n**Solução:** Trigger sincronização manual para testar\n\n### Problema: Logs Não Mostram Rate Limit\n\n**Causa:** Restart não foi feito após código atualizado  \n**Solução:**\n```bash\ndocker compose -f docker-compose.production.yml restart sefaz-xml-sync\n```\n\n---\n\n## 📊 RESULTADOS ESPERADOS\n\n### ✅ Cenário de Sucesso\n\n**Antes da correção:**\n```\n10:00 - Sincronização inicia\n10:01 - 50 consultas SEFAZ (sem rate limit)\n10:02 - cStat 656 (bloqueio SEFAZ)\n10:03 - Empresa bloqueada por 1h ❌\n11:03 - Desbloqueio\n11:04 - Nova sincronização → repete ciclo ❌\n```\n\n**Depois da correção:**\n```\n10:00 - Sincronização inicia\n10:01 - Consulta 1 (rate limit: 1/20) ✅\n10:02 - Consulta 2 (rate limit: 2/20) ✅\n...\n10:20 - Consulta 20 (rate limit: 20/20) ✅\n10:21 - Consulta 21 → BLOQUEADA (rate limit atingido)\n10:21 - Log: \"Rate limit atingido - aguardando\"\n10:21 - Sincronização pausada (parcial) ✅\n11:21 - Janela reseta → contador = 0\n11:21 - Sincronização retoma automaticamente ✅\n```\n\n### 📈 Métricas de Saúde\n\n**Sistema Saudável:**\n- ✅ Contadores de rate limit entre 0-20\n- ✅ Sem bloqueios `bloqueado_ate` ativos\n- ✅ Logs mostram \"Rate limit OK\" ou \"pausada\"\n- ✅ XMLs sendo baixados gradualmente\n\n**Sistema com Problema:**\n- ❌ Contadores sempre em 0 (rate limit não funciona)\n- ❌ Bloqueios `bloqueado_ate` recorrentes\n- ❌ Logs mostram cStat 656 repetidamente\n- ❌ XMLs não são processados\n\n---\n\n## 🎯 PRÓXIMOS PASSOS\n\n1. **Restart da aplicação** ← FAÇA AGORA\n2. **Trigger sincronização manual** (teste)\n3. **Monitorar logs** (15-30 minutos)\n4. **Verificar contadores** (query SQL)\n5. **Confirmar sem cStat 656** ✅\n\n---\n\n## 📞 SUPORTE\n\nSe após restart ainda tomar cStat 656:\n1. Envie logs completos da sincronização\n2. Execute queries de monitoramento\n3. Verifique se há concorrência (outro sistema)\n\n---\n\n**Correção aplicada em:** 22/11/2025  \n**Arquivos modificados:** `server/sefaz-service.ts` (3 métodos)  \n**Pronto para teste:** ✅ SIM  \n**Requer restart:** ✅ SIM (apenas uma vez)\n","size_bytes":9338},"fix-vite-deps.sh":{"content":"#!/bin/bash\n# Script para corrigir dependências do Vite no package.json\n# Uso: bash fix-vite-deps.sh\n\necho \"🔧 Corrigindo package.json - Movendo Vite para dependencies...\"\n\n# Criar backup\ncp package.json package.json.backup\necho \"✅ Backup criado: package.json.backup\"\n\n# Usar Node.js para editar JSON de forma segura\nnode -e \"\nconst fs = require('fs');\nconst pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));\n\n// Mover vite\nif (pkg.devDependencies.vite) {\n  pkg.dependencies.vite = pkg.devDependencies.vite;\n  delete pkg.devDependencies.vite;\n  console.log('✅ Movido: vite');\n}\n\n// Mover @vitejs/plugin-react\nif (pkg.devDependencies['@vitejs/plugin-react']) {\n  pkg.dependencies['@vitejs/plugin-react'] = pkg.devDependencies['@vitejs/plugin-react'];\n  delete pkg.devDependencies['@vitejs/plugin-react'];\n  console.log('✅ Movido: @vitejs/plugin-react');\n}\n\n// Salvar com formatação\nfs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\\n');\nconsole.log('✅ package.json atualizado!');\n\"\n\necho \"\"\necho \"🎯 Próximos passos:\"\necho \"1. Reinstalar dependências: npm install\"\necho \"2. Rebuild imagem Docker: docker build -f Dockerfile.production -t sefaz-xml-sync:1.0.0 .\"\necho \"3. Redeploy: docker compose -f docker-compose.production.yml up -d --force-recreate\"\n","size_bytes":1294}},"version":2}