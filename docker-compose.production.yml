# ============================================================================
# Docker Compose - SEFAZ XML Sync PRODUÇÃO
# URL: downloadsefaz.dibs.com.br
# Infraestrutura: Docker Standalone + Traefik + Portainer
# ============================================================================
version: '3.8'

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  traefik-proxy:
    external: true
    name: traefik-proxy

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  xmls-data:
    driver: local
  certificados-data:
    driver: local

# ============================================================================
# SERVICES
# ============================================================================
services:
  # ==========================================================================
  # SEFAZ XML Sync - Aplicação Principal
  # ==========================================================================
  sefaz-xml-sync:
    image: sefaz-xml-sync:1.0.0
    container_name: sefaz-xml-sync
    restart: unless-stopped
    
    build:
      context: .
      dockerfile: Dockerfile.production
      target: production
    
    # Expõe porta 5000 internamente (apenas para Traefik)
    # NÃO expõe publicamente - Traefik gerencia isso
    expose:
      - 5000
    
    # Variáveis de ambiente (carregadas de .env.production)
    env_file:
      - .env.production
    
    environment:
      - NODE_ENV=production
      - PORT=5000
      - TZ=America/Sao_Paulo
    
    # Volumes persistentes
    volumes:
      - xmls-data:/app/xmls
      - certificados-data:/app/certificados
    
    # Labels do Traefik - CERTIFICADO SSL AUTOMÁTICO
    labels:
      # Habilita Traefik para este container
      - "traefik.enable=true"
      
      # Define a rede do Traefik
      - "traefik.docker.network=traefik-proxy"
      
      # ROUTER: Configuração de roteamento HTTP/HTTPS
      - "traefik.http.routers.sefaz-xml-sync.rule=Host(`downloadsefaz.dibs.com.br`)"
      - "traefik.http.routers.sefaz-xml-sync.entrypoints=websecure"
      - "traefik.http.routers.sefaz-xml-sync.tls=true"
      - "traefik.http.routers.sefaz-xml-sync.tls.certresolver=leresolver"
      
      # SERVICE: Porta interna do container
      - "traefik.http.services.sefaz-xml-sync.loadbalancer.server.port=5000"
      
      # Associa router ao service
      - "traefik.http.routers.sefaz-xml-sync.service=sefaz-xml-sync"
      
      # OPCIONAL: Middleware de compressão (melhora performance)
      # - "traefik.http.routers.sefaz-xml-sync.middlewares=compress@docker"
      # - "traefik.http.middlewares.compress.compress=true"
      
      # OPCIONAL: Security headers
      # - "traefik.http.routers.sefaz-xml-sync.middlewares=security-headers@docker"
      # - "traefik.http.middlewares.security-headers.headers.sslredirect=true"
      # - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      # - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
    
    networks:
      - traefik-proxy
    
    # Health check (Docker monitora saúde do container)
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Limites de recursos (ajuste conforme necessário)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
