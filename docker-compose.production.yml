# ============================================================================
# Docker Compose - SEFAZ XML Sync PRODUÇÃO
# URL: downloadsefaz.dibs.com.br
# Infraestrutura: Docker Standalone + Traefik + Portainer
# ============================================================================
version: '3.8'

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  downloadsefaz:
    external: true

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  xmls-data:
    driver: local
  certificados-data:
    driver: local

# ============================================================================
# SERVICES
# ============================================================================
services:
  # ==========================================================================
  # SEFAZ XML Sync - Aplicação Principal
  # ==========================================================================
  sefaz-xml-sync:
    image: sefaz-xml-sync:1.0.0
    container_name: sefaz-xml-sync
    restart: unless-stopped
    
    build:
      context: .
      dockerfile: Dockerfile.production
      target: production
    
    # Expõe porta 5000 internamente (apenas para Traefik)
    # NÃO expõe publicamente - Traefik gerencia isso
    expose:
      - 5000

    networks:
      - downloadsefaz
    
    # Variáveis de ambiente (antes vinham do .env.production)
    environment:
      - NODE_ENV=production
      - PORT=5000
      - TZ=America/Sao_Paulo
      - SUPABASE_URL=https://zwwtysvyyubraupzlppr.supabase.co
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3d3R5c3Z5eXVicmF1cHpscHByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTcxOTUsImV4cCI6MjA3ODYzMzE5NX0.osDMS4frqaDsuRswlaIm721PyRSE-bnk01VBJgc9mfo
      - SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3d3R5c3Z5eXVicmF1cHpscHByIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzA1NzE5NSwiZXhwIjoyMDc4NjMzMTk1fQ.5Ddq5f3qjpuZV1384K1LvuRAkLXb4BbWJnA6dgPH1R0
      - SESSION_SECRET=dpCW6vMLfsae76yeHvsk4PK5+bI205Uon5YX/ynRNXY=
      - SEFAZ_AMBIENTE=1
      - SEFAZ_TIMEOUT=30000
      - SYNC_INTERVAL=60
      - STORAGE_TYPE=local
      - LOG_LEVEL=info
      - CORS_ORIGINS=https://downloadsefaz.dibs.com.br
      - RATE_LIMIT_MAX=100
    
    # Volumes persistentes
    volumes:
      - xmls-data:/app/xmls
      - certificados-data:/app/certificados
    
    # Labels do Traefik - CERTIFICADO SSL AUTOMÁTICO
    labels:
      # Habilita Traefik para este container
      - "traefik.enable=true"
      
      # Define a rede do Traefik
      - "traefik.docker.network=downloadsefaz"
      
      # ROUTER: Configuração de roteamento HTTP/HTTPS
      - "traefik.http.routers.sefaz-xml-sync.rule=Host(`downloadsefaz.dibs.com.br`)"
      - "traefik.http.routers.sefaz-xml-sync.entrypoints=websecure"
      - "traefik.http.routers.sefaz-xml-sync.tls=true"
      - "traefik.http.routers.sefaz-xml-sync.tls.certresolver=leresolver"
      
      # SERVICE: Porta interna do container
      - "traefik.http.services.sefaz-xml-sync.loadbalancer.server.port=5000"
      
      # Associa router ao service
      - "traefik.http.routers.sefaz-xml-sync.service=sefaz-xml-sync"
      
      # OPCIONAL: Middleware de compressão (melhora performance)
      - "traefik.http.routers.sefaz-xml-sync.middlewares=compress@docker"
      - "traefik.http.middlewares.compress.compress=true"
      
      # OPCIONAL: Security headers
      # - "traefik.http.routers.sefaz-xml-sync.middlewares=security-headers@docker"
      # - "traefik.http.middlewares.security-headers.headers.sslredirect=true"
      # - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
