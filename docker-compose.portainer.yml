version: '3.8'

# SEFAZ XML Sync - Docker Compose para Portainer + Traefik
# ========================================================
# Deploy via Portainer Stack com Traefik como reverse proxy
# SSL/HTTPS automático via Let's Encrypt (gerenciado pelo Traefik)

services:
  app:
    # Build a partir do código (ou use imagem pre-built)
    build:
      context: .
      dockerfile: Dockerfile
    # OU use imagem pre-built (se você fizer push para um registry):
    # image: seu-registry/sefaz-xml-sync:latest
    
    container_name: sefaz-xml-sync
    restart: unless-stopped
    
    # Variáveis de ambiente (serão definidas no Portainer UI)
    environment:
      - NODE_ENV=production
      - PORT=5000
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SESSION_SECRET=${SESSION_SECRET}
      - XML_DEST_PATH=/app/xmls
      - ALLOW_SEFAZ_SIMULATION=${ALLOW_SEFAZ_SIMULATION:-false}
    
    # Volumes para persistência de dados
    volumes:
      # Certificados digitais .pfx
      - ${CERTIFICADOS_PATH:-./certificados}:/app/certificados
      # XMLs baixados da SEFAZ
      - ${XMLS_PATH:-./xmls}:/app/xmls
    
    # Expõe porta internamente (não precisa mapear para host)
    expose:
      - "5000"
    
    # Labels do Traefik para roteamento e SSL automático
    labels:
      # Habilita Traefik para este container
      - "traefik.enable=true"
      
      # Nome do serviço (usado internamente pelo Traefik)
      - "traefik.http.services.sefaz-xml-sync.loadbalancer.server.port=5000"
      
      # Regra de roteamento (SUBSTITUA pelo seu domínio real)
      - "traefik.http.routers.sefaz-xml-sync.rule=Host(`${DOMAIN}`)"
      
      # Usa entrypoint HTTPS (websecure)
      - "traefik.http.routers.sefaz-xml-sync.entrypoints=websecure"
      
      # Certificado SSL via Let's Encrypt (cert resolver do Traefik)
      - "traefik.http.routers.sefaz-xml-sync.tls=true"
      - "traefik.http.routers.sefaz-xml-sync.tls.certresolver=${CERT_RESOLVER:-le}"
      
      # Middleware de redirecionamento HTTP -> HTTPS (se necessário)
      # Descomente se quiser forçar HTTPS
      # - "traefik.http.routers.sefaz-xml-sync-http.rule=Host(`${DOMAIN}`)"
      # - "traefik.http.routers.sefaz-xml-sync-http.entrypoints=web"
      # - "traefik.http.routers.sefaz-xml-sync-http.middlewares=redirect-to-https"
      # - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Rede do Traefik (DEVE EXISTIR - criada pelo Traefik)
    networks:
      - traefik-proxy

networks:
  traefik-proxy:
    external: true
